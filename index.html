<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ (Aurora Edition)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke.">
  <meta name="theme-color" content="#0f172a">
  
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      /* --- AURORA PALETTE --- */
      --bg-dark: #020617; /* Very dark blue/slate */
      
      /* Aurora Blobs Colors */
      --blob-1: #7c3aed; /* Violet */
      --blob-2: #db2777; /* Pink */
      --blob-3: #2563eb; /* Blue */
      
      /* Glassmorphism Variables */
      --glass-surface: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.08);
      --glass-blur: 20px;
      
      /* Text Colors */
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      
      /* Brand Colors */
      --primary: #f472b6; /* Pink Light */
      --primary-gradient: linear-gradient(135deg, #c084fc 0%, #ec4899 100%); /* Purple to Pink */
      --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); /* Blue to Cyan */
      
      --success: #34d399; 
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #38bdf8;

      --card-radius: 24px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-glow: 0 0 30px rgba(124, 58, 237, 0.3);
    }

    /* Light Mode Override (Optional integration) */
    [data-theme="light"] {
       --bg-dark: #f0fdfa;
       --blob-1: #a78bfa; --blob-2: #f472b6; --blob-3: #60a5fa;
       --glass-surface: rgba(255, 255, 255, 0.65);
       --glass-border: rgba(0, 0, 0, 0.05);
       --text-main: #1e293b;
       --text-muted: #64748b;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease;
    }

    /* --- AURORA BACKGROUND ANIMATION --- */
    .aurora-container {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1; overflow: hidden; pointer-events: none;
      background: var(--bg-dark);
    }
    .aurora-blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
      animation: float 10s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--blob-1); animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: var(--blob-2); animation-delay: -5s; }
    .blob-3 { top: 40%; left: 30%; width: 40vw; height: 40vw; background: var(--blob-3); animation-delay: -8s; opacity: 0.4; }

    @keyframes float {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, 50px) scale(1.1); }
    }

    /* --- GLASS CARDS --- */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-top: 1px solid var(--glass-highlight);
      border-radius: var(--card-radius);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .container {
      max-width: 1000px; margin: 0 auto;
      padding: 40px 20px;
      display: flex; flex-direction: column; gap: 32px;
      position: relative; z-index: 10;
    }

    /* --- HEADER --- */
    header { text-align: center; padding: 20px; position: relative; }
    .logo {
      display: inline-flex; align-items: center; justify-content: center; gap: 12px;
    }
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin: 0;
      filter: drop-shadow(0 0 15px rgba(192, 132, 252, 0.4));
    }
    .tagline { color: var(--text-muted); font-size: 1rem; margin-top: 5px; }

    /* --- BUTTONS & CONTROLS --- */
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--glass-surface); border: 1px solid var(--glass-border);
      color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.3s; font-size: 1.2rem;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.15); transform: scale(1.1); }

    .tabs {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;
      background: rgba(0,0,0,0.2); padding: 5px; border-radius: 20px; width: fit-content; margin: 0 auto;
      border: 1px solid var(--glass-border);
    }
    .tab {
      padding: 10px 24px; border-radius: 15px; border: none;
      background: transparent; color: var(--text-muted);
      font-weight: 600; cursor: pointer; transition: 0.3s;
    }
    .tab.active {
      background: var(--glass-surface); color: var(--text-main);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
    }

    /* --- SETUP GRID --- */
    .setup-grid {
      padding: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;
    }
    .setup-item {
      background: rgba(0,0,0,0.2); border-radius: var(--btn-radius);
      padding: 20px; border: 1px solid var(--glass-border);
    }
    .setup-item h3 {
      font-size: 1rem; margin-bottom: 12px; color: var(--primary);
      text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
    }

    select, input[type="text"], textarea {
      width: 100%; padding: 12px 16px;
      background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
      border-radius: 12px; color: var(--text-main); font-family: var(--font-main);
      transition: 0.3s; outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: var(--primary); box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.2);
    }
    option { background: #1e293b; color: white; }

    /* --- START BUTTON --- */
    .start-btn {
      grid-column: 1/-1; width: 100%; padding: 20px;
      background: var(--primary-gradient);
      color: white; font-weight: 800; font-size: 1.2rem;
      border: none; border-radius: var(--btn-radius);
      cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
      box-shadow: 0 10px 30px rgba(236, 72, 153, 0.4);
      transition: 0.3s; position: relative; overflow: hidden;
    }
    .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(236, 72, 153, 0.6); }
    .start-btn::after {
      content: ''; position: absolute; top:0; left:-100%; width:100%; height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shine 3s infinite;
    }
    @keyframes shine { 100% { left: 100%; } }

    /* --- PRACTICE AREA --- */
    .segment-box {
      font-size: 1.6rem; line-height: 1.8; text-align: center;
      min-height: 150px; padding: 40px;
      background: rgba(0,0,0,0.2); border-radius: 20px;
      border: 2px dashed rgba(255,255,255,0.1); margin-bottom: 24px;
      color: var(--text-main); font-weight: 500;
    }
    
    .karaoke-word { padding: 2px 4px; border-radius: 6px; transition: 0.2s; position: relative; }
    .karaoke-active {
      background: var(--primary); color: white;
      box-shadow: 0 0 15px var(--primary); transform: scale(1.1);
    }
    
    #userInput {
      font-size: 1.4rem; padding: 20px; text-align: center;
      background: rgba(255,255,255,0.05); border: 2px solid var(--glass-border);
    }
    
    .feedback-area {
      min-height: 40px; text-align: center; margin-bottom: 20px; font-family: monospace; font-size: 1.1rem;
    }
    .correct { color: var(--success); text-shadow: 0 0 10px rgba(52, 211, 153, 0.4); }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* --- LEADERBOARD STYLE --- */
    .rank-table {
        width: 100%; border-collapse: separate; border-spacing: 0 10px;
    }
    .rank-table th {
        text-align: left; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; padding: 0 15px;
    }
    .rank-item {
        background: rgba(255,255,255,0.03); 
        transition: 0.2s;
    }
    .rank-item td {
        padding: 15px; border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border);
    }
    .rank-item td:first-child { border-left: 1px solid var(--glass-border); border-radius: 12px 0 0 12px; font-weight: bold; width: 50px; text-align: center;}
    .rank-item td:last-child { border-right: 1px solid var(--glass-border); border-radius: 0 12px 12px 0; font-weight: bold; color: var(--warning); text-align: right;}
    .rank-item:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }

    .rank-1 .rank-num { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; font-size: 1.2rem; }
    .rank-2 .rank-num { color: #94a3b8; font-size: 1.1rem; }
    .rank-3 .rank-num { color: #b45309; font-size: 1.1rem; }

    .stat-card {
        background: var(--secondary-gradient); padding: 20px; border-radius: 20px; text-align: center; color: white;
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }

    /* --- MODAL --- */
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: #1e293b; border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 32px; width: 90%; max-width: 400px;
      text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }

    .hidden { display: none !important; }
    
    /* Mic Button Animation */
    .mic-btn {
      width: 60px; height: 60px; border-radius: 50%; background: var(--danger); color: white;
      font-size: 1.5rem; border: none; cursor: pointer; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
      transition: 0.3s; box-shadow: 0 0 20px rgba(248, 113, 113, 0.4);
    }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }
    
    .action-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
    .action-btn {
        padding: 12px 24px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; color: white;
        transition: 0.2s;
    }
    .btn-next { background: var(--success); box-shadow: 0 4px 15px rgba(52, 211, 153, 0.3); }
    .btn-replay { background: var(--warning); box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); color: #000; }
    .btn-exit { background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); }
    .btn-exit:hover { background: rgba(255,255,255,0.1); color: white; }

  </style>
</head>
<body>

  <div class="aurora-container">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>

  <div class="container">
    
    <header>
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t" style="color: var(--danger);">üö™</button>
            <button class="icon-btn" id="themeBtn">üåì</button>
        </div>
        <div class="logo">
            <h1>HiHi</h1>
            <span style="background:var(--secondary-gradient); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; margin-bottom: 20px;">PRO</span>
        </div>
        <p class="tagline">Luy·ªán ch√≠nh t·∫£ & Ngo·∫°i ng·ªØ phong c√°ch m·ªõi üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">B·∫£ng X·∫øp H·∫°ng</button>
    </div>

    <div class="glass-card">
        
        <div id="setupPanel" class="tab-content">
            <div style="text-align: center; padding-top: 20px;">
                <input type="text" id="playerNameDisplay" readonly style="width: auto; text-align: center; border: none; background: transparent; font-size: 1.2rem; font-weight: bold; color: var(--primary);" value="Ch√†o b·∫°n!">
            </div>

            <div class="setup-grid">
                <div class="setup-item">
                    <h3>üåç Ng√¥n ng·ªØ</h3>
                    <select id="globalLang">
                        <option value="vi-VN">Ti·∫øng Vi·ªát</option>
                        <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
                        <option value="id-ID">Ti·∫øng Indonesia</option>
                        <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
                        <option value="it-IT">Ti·∫øng √ù</option>
                        <option value="la-VA">Ti·∫øng Latin</option>
                    </select>
                </div>

                <div class="setup-item">
                    <h3>üéÆ Ch·∫ø ƒë·ªô</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="radio" name="mode" value="read-write" checked> Nh√¨n & G√µ</label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="radio" name="mode" value="listen-write"> Nghe & G√µ</label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="radio" name="mode" value="read-listen-write"> Nghe - Nh√¨n - G√µ</label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="radio" name="mode" value="read-only"> Luy·ªán N√≥i (Mic)</label>
                    </div>
                </div>

                <div class="setup-item">
                     <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
                     <select id="voiceSelect" style="margin-bottom: 10px;"></select>
                     <div style="display: flex; gap: 10px;">
                         <select id="voiceRateSelect">
                             <option value="0.75">0.75x (Ch·∫≠m)</option>
                             <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                             <option value="1.25">1.25x (Nhanh)</option>
                         </select>
                         <button id="previewVoice" class="icon-btn" style="border-radius:12px; font-size:1rem; width: auto; padding: 0 15px;">Th·ª≠</button>
                     </div>
                </div>

                <div class="setup-item" style="grid-column: 1/-1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                        <h3>‚úçÔ∏è D·ªØ li·ªáu b√†i t·∫≠p</h3>
                        <button id="randomTextBtn" style="background:var(--secondary-gradient); border:none; color:white; padding:5px 15px; border-radius:10px; cursor:pointer; font-size:0.9rem;">üé≤ L·∫•y b√†i m·∫´u</button>
                    </div>
                    <textarea id="sampleText" rows="5" placeholder="Nh·∫≠p vƒÉn b·∫£n v√†o ƒë√¢y ho·∫∑c b·∫•m n√∫t 'L·∫•y b√†i m·∫´u' ƒë·ªÉ h·ªá th·ªëng t·ª± ch·ªçn..."></textarea>
                </div>

                <button class="start-btn" id="startBtn">B·∫Øt ƒë·∫ßu ngay</button>
            </div>
        </div>

        <div id="rankPanel" class="tab-content hidden" style="padding: 40px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div class="stat-card">
                    <div style="font-size: 0.9rem; opacity: 0.8;">ƒêi·ªÉm cao nh·∫•t c·ªßa b·∫°n</div>
                    <div style="font-size: 2.5rem; font-weight: 800; font-family: var(--font-display);" id="myBestScore">0</div>
                </div>
                <div class="stat-card" style="background: var(--primary-gradient);">
                    <div style="font-size: 0.9rem; opacity: 0.8;">T·ªëc ƒë·ªô (WPM) Max</div>
                    <div style="font-size: 2.5rem; font-weight: 800; font-family: var(--font-display);" id="myMaxWPM">0</div>
                </div>
            </div>

            <h3 style="color: var(--primary); text-align: center; font-family: var(--font-display); font-size: 1.5rem; margin-bottom: 20px;">üèÜ B·∫£ng X·∫øp H·∫°ng To√†n C·∫ßu</h3>
            <div style="overflow-x: auto;">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>H·∫°ng</th>
                            <th>T√™n ng∆∞·ªùi ch∆°i</th>
                            <th style="text-align: right;">WPM</th>
                            <th style="text-align: right;">ƒêi·ªÉm s·ªë</th>
                        </tr>
                    </thead>
                    <tbody id="globalLeaderboardBody">
                        <tr><td colspan="4" style="text-align:center; padding: 20px; color: var(--text-muted);">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="practiceArea" class="tab-content hidden" style="padding: 40px;">
            <div style="display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                <span id="progressText">0% Ho√†n th√†nh</span>
                <span id="timerDisplay">00:00</span>
            </div>
            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-bottom: 30px;">
                <div id="progressBar" style="height: 100%; width: 0%; background: var(--success); transition: width 0.3s;"></div>
            </div>

            <div class="segment-box" id="currentSegment"></div>

            <div id="micBox" class="hidden">
                <button class="mic-btn" id="micBtn">üéôÔ∏è</button>
                <p style="text-align: center; color: var(--text-muted);">Nh·∫•n mic ƒë·ªÉ n√≥i</p>
            </div>

            <div id="fullText" style="text-align: center; color: var(--info); font-style: italic; margin-bottom: 15px; font-size: 0.9rem;"></div>

            <input type="text" id="userInput" placeholder="G√µ n·ªôi dung t·∫°i ƒë√¢y..." autocomplete="off">
            <div class="feedback-area" id="liveFeedback"></div>

            <div class="action-row">
                <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
                <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
                <button class="action-btn btn-exit" id="exitBtn">Tho√°t</button>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 30px; margin-top: 30px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">WPM</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);" id="liveWPM">0</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Ch√≠nh x√°c</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);" id="liveAcc">100%</div>
                </div>
            </div>
        </div>

    </div> <footer style="text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.8rem;">
        HiHi App Aurora ¬© 2025. Code with ‚ù§Ô∏è by H·∫£i & Gemini.
    </footer>

  </div>

  <div class="modal" id="loginModal">
      <div class="modal-content">
          <h2 style="color: var(--primary); margin-bottom: 10px;">Xin Ch√†o!</h2>
          <p style="color: var(--text-muted); margin-bottom: 20px;">Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ l∆∞u danh tr√™n b·∫£ng v√†ng.</p>
          <input type="text" id="usernameInput" placeholder="T√™n c·ªßa b·∫°n..." maxlength="15" style="text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
          <button class="start-btn" id="loginBtn" style="padding: 15px;">V√†o ngay</button>
      </div>
  </div>

  <script type="module">
    // --- 1. FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75",
      measurementId: "G-NCC6MG2HMM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 2. GAME VARIABLES & DATA ---
    const SAMPLE_LIBRARY = {
        'vi-VN': [
          "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i.",
          "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.",
          "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y.",
          "B·ªóng nh·∫≠n ra h∆∞∆°ng ·ªïi. Ph·∫£ v√†o trong gi√≥ se. S∆∞∆°ng ch√πng ch√¨nh qua ng√µ. H√¨nh nh∆∞ thu ƒë√£ v·ªÅ.",
          "M·ªói nƒÉm hoa ƒë√†o n·ªü. L·∫°i th·∫•y √¥ng ƒë·ªì gi√†. B√†y m·ª±c t√†u gi·∫•y ƒë·ªè. B√™n ph·ªë ƒë√¥ng ng∆∞·ªùi qua.",
          "L√≤ng m·∫π bao la nh∆∞ bi·ªÉn th√°i b√¨nh d·∫°t d√†o. T√¨nh m·∫π tha thi·∫øt nh∆∞ d√≤ng su·ªëi hi·ªÅn ng·ªçt ng√†o.",
          "C√¥ng cha nh∆∞ n√∫i Th√°i S∆°n. Nghƒ©a m·∫π nh∆∞ n∆∞·ªõc trong ngu·ªìn ch·∫£y ra.",
          "Vi·ªát Nam ƒë·∫•t n∆∞·ªõc ta ∆°i. M√™nh m√¥ng bi·ªÉn l√∫a ƒë√¢u tr·ªùi ƒë·∫πp h∆°n."
        ],
        'en-US': [
          "The quick brown fox jumps over the lazy dog.",
          "To be, or not to be, that is the question.",
          "I have a dream that one day this nation will rise up.",
          "Life is what happens when you're busy making other plans.",
          "Success is not final, failure is not fatal: it is the courage to continue that counts."
        ]
    };

    // Global State
    let playerName = '';
    let globalLang = 'vi-VN';
    let currentSegments = [];
    let currentIdx = 0;
    let currentMode = 'read-write';
    
    // Stats tracking
    let startTime = 0;
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let timerInterval = null;
    
    // Voice & Speech
    let voices = [];
    let selectedVoice = null;
    let recognition = null;
    let isListening = false;
    let karaokeElements = [];

    // DOM Elements
    const els = {
        setup: document.getElementById('setupPanel'),
        practice: document.getElementById('practiceArea'),
        rank: document.getElementById('rankPanel'),
        tabs: document.querySelectorAll('.tab'),
        contents: document.querySelectorAll('.tab-content'),
        
        sampleText: document.getElementById('sampleText'),
        segment: document.getElementById('currentSegment'),
        input: document.getElementById('userInput'),
        feedback: document.getElementById('liveFeedback'),
        fullText: document.getElementById('fullText'),
        
        progressText: document.getElementById('progressText'),
        progressBar: document.getElementById('progressBar'),
        timer: document.getElementById('timerDisplay'),
        liveWPM: document.getElementById('liveWPM'),
        liveAcc: document.getElementById('liveAcc'),
        
        micBtn: document.getElementById('micBtn'),
        nextBtn: document.getElementById('nextBtn'),
        
        leaderboard: document.getElementById('globalLeaderboardBody'),
        myBestScore: document.getElementById('myBestScore'),
        myMaxWPM: document.getElementById('myMaxWPM')
    };

    // --- 3. FUNCTIONS ---

    // Login Handling
    function checkLogin() {
        const stored = localStorage.getItem('hihiUser');
        if (stored) {
            const data = JSON.parse(stored);
            playerName = data.name;
            document.getElementById('playerNameDisplay').value = `Ch√†o, ${playerName} ‚úåÔ∏è`;
            document.getElementById('loginModal').classList.remove('show');
            loadMyStats();
        } else {
            document.getElementById('loginModal').classList.add('show');
        }
    }

    document.getElementById('loginBtn').addEventListener('click', () => {
        const name = document.getElementById('usernameInput').value.trim();
        if (name) {
            playerName = name;
            localStorage.setItem('hihiUser', JSON.stringify({ name }));
            document.getElementById('playerNameDisplay').value = `Ch√†o, ${playerName} ‚úåÔ∏è`;
            document.getElementById('loginModal').classList.remove('show');
            loadMyStats();
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('hihiUser');
        location.reload();
    });

    // Theme Toggle
    document.getElementById('themeBtn').addEventListener('click', () => {
        const current = document.body.getAttribute('data-theme');
        document.body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    });

    // Tab Switching
    els.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            els.tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            els.contents.forEach(c => c.classList.add('hidden'));
            document.getElementById(tab.dataset.tab).classList.remove('hidden');
        });
    });

    // Voice Setup
    function loadVoices() {
        voices = speechSynthesis.getVoices();
        const langCode = globalLang.split('-')[0];
        const relevant = voices.filter(v => v.lang.startsWith(langCode));
        const select = document.getElementById('voiceSelect');
        
        if (relevant.length) {
            select.innerHTML = relevant.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
            selectedVoice = relevant[0];
        } else {
            select.innerHTML = '<option>Kh√¥ng t√¨m th·∫•y gi·ªçng ph√π h·ª£p</option>';
        }
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    document.getElementById('voiceSelect').addEventListener('change', (e) => {
        selectedVoice = voices.find(v => v.name === e.target.value);
    });

    document.getElementById('previewVoice').addEventListener('click', () => {
        const msg = new SpeechSynthesisUtterance("Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.");
        if (globalLang.startsWith('en')) msg.text = "Hello, this is a test voice.";
        msg.voice = selectedVoice;
        msg.rate = parseFloat(document.getElementById('voiceRateSelect').value);
        speechSynthesis.speak(msg);
    });

    // Game Logic
    document.getElementById('randomTextBtn').addEventListener('click', () => {
        const lib = SAMPLE_LIBRARY[document.getElementById('globalLang').value] || SAMPLE_LIBRARY['vi-VN'];
        els.sampleText.value = lib[Math.floor(Math.random() * lib.length)];
    });

    document.getElementById('startBtn').addEventListener('click', () => {
        const text = els.sampleText.value.trim();
        if (!text) return alert("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ho·∫∑c ch·ªçn b√†i m·∫´u!");
        
        currentSegments = text.split(/(?<=[.!?])\s+|\n+/).filter(s => s.trim());
        globalLang = document.getElementById('globalLang').value;
        currentMode = document.querySelector('input[name="mode"]:checked').value;
        
        currentIdx = 0;
        typedWords = 0;
        totalCorrectWords = 0;
        startTime = Date.now();
        
        els.setup.classList.add('hidden');
        els.practice.classList.remove('hidden');
        
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
        
        loadSegment();
    });

    function loadSegment() {
        const txt = currentSegments[currentIdx];
        els.input.value = '';
        els.input.focus();
        els.feedback.innerHTML = '...';
        els.nextBtn.disabled = true;
        
        // UI Setup based on mode
        const isRead = currentMode.includes('read');
        const isListen = currentMode.includes('listen');
        const isMic = currentMode === 'read-only';
        
        document.getElementById('micBox').classList.toggle('hidden', !isMic);
        els.input.classList.toggle('hidden', isMic);
        
        // Build Karaoke HTML
        els.segment.innerHTML = '';
        if (isRead) {
            const words = txt.split(' ');
            let charCount = 0;
            karaokeElements = [];
            words.forEach(w => {
                const span = document.createElement('span');
                span.textContent = w + ' ';
                span.className = 'karaoke-word';
                span.dataset.start = charCount;
                span.dataset.end = charCount + w.length;
                els.segment.appendChild(span);
                karaokeElements.push(span);
                charCount += w.length + 1;
            });
        } else {
            els.segment.innerHTML = '<i>(ƒêo·∫°n vƒÉn b·ªã ·∫©n, h√£y nghe v√† ch√©p l·∫°i...)</i>';
        }

        // Translate helper
        if (globalLang !== 'vi-VN') {
             fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=${globalLang.split('-')[0]}|vi`)
             .then(res => res.json())
             .then(data => els.fullText.textContent = "T·∫°m d·ªãch: " + (data.responseData.translatedText || '...'));
        } else {
            els.fullText.textContent = '';
        }

        // Auto speak if listen mode
        if (isListen && !isMic) {
            setTimeout(() => speak(txt), 500);
        }
    }

    function speak(text) {
        speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(text);
        utt.voice = selectedVoice;
        utt.rate = parseFloat(document.getElementById('voiceRateSelect').value);
        
        // Karaoke highlighting effect
        utt.onboundary = (event) => {
            if (event.name === 'word' && currentMode.includes('read')) {
                const charIndex = event.charIndex;
                karaokeElements.forEach(el => el.classList.remove('karaoke-active'));
                const active = karaokeElements.find(el => {
                    const start = parseInt(el.dataset.start);
                    // Simple estimation
                    return charIndex >= start && charIndex < (start + 10); 
                });
                if (active) active.classList.add('karaoke-active');
            }
        };
        
        speechSynthesis.speak(utt);
    }

    // Input Checking
    els.input.addEventListener('input', () => {
        const target = currentSegments[currentIdx];
        const val = els.input.value;
        const targetWords = target.toLowerCase().split(/\s+/).filter(x=>x);
        const inputWords = val.toLowerCase().trim().split(/\s+/);
        
        let html = '';
        let correctCount = 0;

        inputWords.forEach((w, i) => {
            if (!targetWords[i]) return;
            const cleanT = targetWords[i].replace(/[.,!?;:]/g, '');
            const cleanI = w.replace(/[.,!?;:]/g, '');
            
            if (cleanT === cleanI) {
                html += `<span class="correct">${target.split(' ')[i]}</span> `;
                correctCount++;
            } else {
                html += `<span class="wrong">${w}</span> `;
            }
        });
        
        correctWords = correctCount;
        els.feedback.innerHTML = html;

        // Check completion
        const cleanTarget = target.trim().toLowerCase().replace(/[.,!?;:]/g, '');
        const cleanVal = val.trim().toLowerCase().replace(/[.,!?;:]/g, '');
        
        if (cleanTarget === cleanVal) {
            els.nextBtn.disabled = false;
            els.feedback.innerHTML += ' ‚úÖ';
        }
    });

    els.nextBtn.addEventListener('click', () => {
        totalCorrectWords += correctWords;
        typedWords += currentSegments[currentIdx].split(' ').length;
        
        currentIdx++;
        const pct = Math.round((currentIdx / currentSegments.length) * 100);
        els.progressBar.style.width = pct + '%';
        els.progressText.textContent = pct + '% Ho√†n th√†nh';

        if (currentIdx >= currentSegments.length) {
            endGame();
        } else {
            loadSegment();
        }
    });

    document.getElementById('replayBtn').addEventListener('click', () => speak(currentSegments[currentIdx]));
    document.getElementById('exitBtn').addEventListener('click', () => location.reload());

    // Timer & Stats
    function updateTimer() {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        els.timer.textContent = `${m}:${s}`;
        
        // Live WPM
        const mins = diff / 60;
        if (mins > 0) {
            const wpm = Math.round((typedWords + correctWords) / mins);
            els.liveWPM.textContent = wpm;
        }
    }

    function endGame() {
        clearInterval(timerInterval);
        const diff = (Date.now() - startTime) / 1000 / 60;
        const wpm = Math.round(typedWords / diff) || 0;
        const score = Math.round(wpm * 10 + (totalCorrectWords * 5));
        
        alert(`üéâ Ch√∫c m·ª´ng ${playerName}!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêi·ªÉm s·ªë: ${score}`);
        
        // Save to Firebase
        saveScore(playerName, wpm, score);
        location.reload();
    }

    // --- 4. FIREBASE LOGIC (THE "X·ªäN" PART) ---

    function saveScore(name, wpm, score) {
        const scoresRef = ref(db, 'leaderboard');
        const newScoreRef = push(scoresRef);
        newScoreRef.set({
            name: name,
            wpm: wpm,
            score: score,
            date: new Date().toISOString()
        });
        
        // Save local best
        const myBest = JSON.parse(localStorage.getItem('myStats')) || { score: 0, wpm: 0 };
        if (score > myBest.score) myBest.score = score;
        if (wpm > myBest.wpm) myBest.wpm = wpm;
        localStorage.setItem('myStats', JSON.stringify(myBest));
    }

    function loadMyStats() {
        const myBest = JSON.parse(localStorage.getItem('myStats')) || { score: 0, wpm: 0 };
        els.myBestScore.textContent = myBest.score;
        els.myMaxWPM.textContent = myBest.wpm;
    }

    // Realtime Leaderboard Listener
    function initLeaderboard() {
        const topScoresQuery = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(10));
        
        onValue(topScoresQuery, (snapshot) => {
            const data = snapshot.val();
            els.leaderboard.innerHTML = '';
            
            if (!data) {
                els.leaderboard.innerHTML = '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            const sorted = Object.values(data).sort((a, b) => b.score - a.score);
            
            sorted.forEach((item, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                const icon = index === 0 ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index+1}`;
                
                const tr = document.createElement('tr');
                tr.className = `rank-item ${rankClass}`;
                tr.innerHTML = `
                    <td><span class="rank-num">${icon}</span></td>
                    <td>${item.name}</td>
                    <td style="text-align:right; font-family:monospace;">${item.wpm}</td>
                    <td style="text-align:right;">${item.score}</td>
                `;
                els.leaderboard.appendChild(tr);
            });
        });
    }

    // --- 5. INITIALIZATION ---
    window.onload = () => {
        checkLogin();
        loadVoices();
        initLeaderboard();
        
        // Mic Logic (Simple version for demo)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'vi-VN';
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                els.input.value = transcript;
                els.input.dispatchEvent(new Event('input'));
                els.micBtn.classList.remove('listening');
            };
            els.micBtn.addEventListener('click', () => {
                recognition.start();
                els.micBtn.classList.add('listening');
            });
        }
    };

  </script>
</body>
</html>
