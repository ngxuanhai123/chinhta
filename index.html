<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HiHi Spelling - Ultimate Sync</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&family=Poppins:wght@300;400;600;700;800&family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

<style>
  :root {
    --glass-bg: rgba(15, 23, 42, 0.65); /* Darker glass for better text contrast */
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --accent-color: #38bdf8;
    --success-color: #34d399;
    --error-color: #f87171;
    --text-color: #ffffff;
    --radius: 24px;
    --font-main: 'Be Vietnam Pro', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }

  body {
    font-family: var(--font-main);
    background: #0f172a;
    color: var(--text-color);
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding-bottom: 110px;
    overflow-x: hidden;
    position: relative;
  }

  /* --- AURORA BACKGROUND (From Tu Vung) --- */
  .aurora-bg {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
    background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* PARTICLES & SNOW */
  .particle { position: absolute; border-radius: 50%; background: white; opacity: 0.3; animation: floatUp linear infinite; z-index: -1; }
  @keyframes floatUp { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }
  .snowflake { position: fixed; top: -20px; z-index: 9999; color: #fff; font-size: 1em; opacity: 0.5; pointer-events: none; animation: fall linear forwards; }
  @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

  /* --- COMMON UI COMPONENTS --- */
  .glass-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    transition: transform 0.3s;
    width: 100%;
  }

  .btn-primary {
    position: relative; overflow: hidden; border: none;
    background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%);
    color: white; font-weight: 700; padding: 16px 24px; border-radius: 20px;
    cursor: pointer; width: 100%; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); transition: all 0.2s;
  }
  .btn-primary:active { transform: scale(0.96); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

  .input-glass {
    width: 100%; padding: 16px; border-radius: 16px;
    border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: white;
    font-size: 1rem; margin-bottom: 15px; font-family: var(--font-main);
  }
  .input-glass:focus { background: rgba(0,0,0,0.5); border-color: var(--accent-color); }

  /* --- LAYOUT --- */
  header { margin: 40px 0 20px 0; text-align: center; width: 100%; padding: 0 20px; z-index: 2; }
  h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 5px; color: white; text-shadow: 0 0 20px rgba(56, 189, 248, 0.6); }

  .view-container { width: 92%; max-width: 600px; z-index: 2; position: relative; padding-bottom: 20px; display: none; }
  .animate__fadeIn { animation-duration: 0.5s; }

  /* --- LOGIN SECTION --- */
  .user-badge {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; cursor: pointer;
  }
  .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; }

  /* --- SETUP PANEL STYLES --- */
  .setup-grid { display: grid; gap: 15px; }
  .radio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .radio-label {
    background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px;
    border: 1px solid transparent; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
  }
  .radio-label:has(input:checked) {
    background: rgba(56, 189, 248, 0.15); border-color: var(--accent-color); font-weight: 700;
  }
  input[type="radio"] { display: none; }

  select.input-glass option { background: #0f172a; }

  /* --- PRACTICE AREA STYLES --- */
  .progress-box { margin-bottom: 20px; }
  .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top:5px; }
  .progress-fill { height: 100%; background: var(--success-color); width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--success-color); }

  .segment-box {
    font-size: 1.4rem; line-height: 1.8; text-align: center;
    min-height: 140px; padding: 25px;
    background: rgba(0,0,0,0.2); border-radius: 20px;
    border: 1px solid var(--glass-border); margin-bottom: 20px;
    display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 6px;
  }
  
  .karaoke-word { padding: 2px 6px; border-radius: 6px; transition: 0.2s; border: 1px solid transparent; }
  .karaoke-active {
    background: var(--accent-color); color: #000; font-weight: 800;
    transform: scale(1.1); box-shadow: 0 0 15px var(--accent-color);
  }

  .mic-btn {
    width: 70px; height: 70px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
    color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s; margin: 0 auto 20px;
  }
  .mic-btn.listening { background: var(--error-color); animation: pulseMic 1.5s infinite; border-color: transparent; }
  @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); } 100% { box-shadow: 0 0 0 20px transparent; } }

  .input-wrapper { position: relative; margin-bottom: 20px; }
  #userInput { font-size: 1.2rem; padding-right: 50px; }
  .hint-btn {
    position: absolute; right: 10px; top: 50%; transform: translateY(-65%);
    background: rgba(251, 191, 36, 0.2); color: #fbbf24;
    width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: 1px solid rgba(251, 191, 36, 0.4);
  }

  .feedback-area { font-family: monospace; text-align: center; margin-bottom: 20px; min-height: 24px; font-size: 1.1rem; }
  .correct { color: var(--success-color); font-weight: bold; }
  .wrong { color: var(--error-color); text-decoration: line-through; opacity: 0.7; }

  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
  .stat-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; }
  .stat-val { font-size: 1.2rem; font-weight: 800; color: var(--accent-color); }
  .stat-label { font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; }

  /* --- LEADERBOARD --- */
  .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
  .leaderboard-table th { text-align: left; padding: 12px; color: rgba(255,255,255,0.6); border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
  .leaderboard-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .rank-1 { color: #fbbf24; font-weight: bold; }
  .rank-2 { color: #94a3b8; font-weight: bold; }
  .rank-3 { color: #b45309; font-weight: bold; }

  /* --- TAB BAR --- */
  .tab-bar {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: 95%; max-width: 450px; height: 70px;
    background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.2); border-radius: 40px;
    display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    box-shadow: 0 15px 40px rgba(0,0,0,0.5);
  }
  .tab-item {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.5); font-size: 0.75rem; font-weight: 600; transition: 0.3s; cursor: pointer;
  }
  .tab-item i { font-size: 1.5rem; margin-bottom: 5px; transition: 0.3s; }
  .tab-item.active { color: var(--accent-color); }
  .tab-item.active i { transform: translateY(-5px); text-shadow: 0 0 10px rgba(56, 189, 248, 0.8); }

  /* --- TOAST --- */
  #toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%);
    background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 50px;
    font-weight: 600; z-index: 3000; transition: transform 0.4s;
    border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px);
  }
  #toast.show { transform: translateX(-50%) translateY(20px); }

  .hidden { display: none !important; }
</style>
</head>
<body onload="initApp()">

<div class="aurora-bg"></div>
<div id="particles"></div>

<header>
  <h1>HiHi Spelling</h1>
  <div style="font-size:0.9rem; opacity:0.8; font-weight: 600;">Luy·ªán Ch√≠nh T·∫£ & Gi·ªçng N√≥i</div>
</header>

<div id="appContainer" style="width: 100%; display: flex; justify-content: center;">

    <div id="view-home" class="view-container animate__animated animate__fadeIn">
        <div id="userSection" style="display: flex; flex-direction: column; align-items: center;">
            <div id="requireLoginMsg" style="text-align:center; margin-top:50px; padding:20px; display:block;">
                <i class="fas fa-lock" style="font-size:3rem; margin-bottom:15px; opacity:0.7; color: var(--accent-color);"></i>
                <div style="font-weight:600; margin-bottom: 20px;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu luy·ªán t·∫≠p.</div>
                <button id="btnLogin" class="btn-primary" onclick="loginGoogle()">
                    <i class="fab fa-google"></i> &nbsp; ƒêƒÉng nh·∫≠p v·ªõi Google
                </button>
            </div>

            <div id="loggedInContent" style="width: 100%; display: none;">
                <div id="userProfile" class="user-badge" onclick="logoutGoogle()" style="width: fit-content; margin: 0 auto 20px;">
                    <img id="userImg" src="" class="user-avatar" alt="Avt">
                    <div style="text-align: left;">
                        <div id="userName" style="font-weight: 700; font-size: 0.9rem;">User</div>
                        <div style="font-size: 0.7rem; opacity: 0.8;">Nh·∫•n ƒë·ªÉ ƒëƒÉng xu·∫•t</div>
                    </div>
                </div>

                <div class="glass-panel" style="padding: 24px;">
                    <h3 style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">C·∫•u h√¨nh luy·ªán t·∫≠p</h3>
                    
                    <div class="setup-grid">
                        <div>
                            <label style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 5px; display: block;">Ng√¥n ng·ªØ</label>
                            <select id="globalLang" class="input-glass">
                                <option value="vi-VN">Ti·∫øng Vi·ªát</option>
                                <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
                                <option value="id-ID">Ti·∫øng Indonesia</option>
                                <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
                            </select>
                        </div>

                        <div>
                            <label style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 5px; display: block;">Ch·∫ø ƒë·ªô</label>
                            <div class="radio-group">
                                <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <i class="fas fa-eye"></i> Nh√¨n & Ch√©p</label>
                                <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <i class="fas fa-headphones"></i> Nghe & Ch√©p</label>
                                <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <i class="fas fa-sync"></i> T·ªïng h·ª£p</label>
                                <label class="radio-label"><input type="radio" name="mode" value="read-only"> <i class="fas fa-microphone"></i> Luy·ªán ƒê·ªçc</label>
                            </div>
                        </div>

                        <div>
                            <label style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 5px; display: block;">Gi·ªçng ƒë·ªçc AI</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="voiceSelect" class="input-glass" style="flex: 1; margin-bottom:0;"></select>
                                <select id="voiceRateSelect" class="input-glass" style="width: 80px; margin-bottom:0;">
                                    <option value="0.75">0.75x</option>
                                    <option value="1.00" selected>1.0x</option>
                                    <option value="1.25">1.25x</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                                <label style="font-size: 0.85rem; opacity: 0.8;">N·ªôi dung luy·ªán</label>
                                <span style="font-size: 0.75rem; color: var(--accent-color); cursor: pointer;" onclick="setRandomText()">üé≤ L·∫•y b√†i m·∫´u</span>
                            </div>
                            <textarea id="sampleText" class="input-glass" rows="4" placeholder="Nh·∫≠p vƒÉn b·∫£n ho·∫∑c nh·∫•n 'L·∫•y b√†i m·∫´u'..." spellcheck="false"></textarea>
                        </div>

                        <button class="btn-primary animate__animated animate__pulse animate__infinite" onclick="startPractice()">
                            <i class="fas fa-play"></i> B·∫ÆT ƒê·∫¶U LUY·ªÜN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-practice" class="view-container animate__animated animate__fadeIn">
        <div class="glass-panel" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button onclick="endPractice()" style="background: none; border: none; color: white; opacity: 0.7;"><i class="fas fa-arrow-left"></i> Tho√°t</button>
                <div style="font-weight: 700; color: var(--success-color);" id="progressText">0%</div>
            </div>
            <div class="progress-box">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>

            <div class="segment-box" id="currentSegment"></div>

            <div id="fullText" style="color:var(--accent-color); font-style:italic; text-align:center; margin-bottom:15px; font-size: 0.9rem; min-height: 20px;"></div>

            <div id="micBox" class="hidden">
                <button class="mic-btn" id="micBtn"><i class="fas fa-microphone"></i></button>
                <p style="text-align:center; font-size:0.8rem; opacity:0.7;">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
            </div>

            <div class="input-wrapper" id="inputWrapper">
                <input type="text" id="userInput" class="input-glass" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off">
                <button class="hint-btn" id="hintBtn"><i class="fas fa-lightbulb"></i></button>
            </div>

            <div class="feedback-area" id="liveFeedback"></div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-primary" style="background: rgba(255,255,255,0.1); flex: 1;" onclick="speakCurrentSegment()"><i class="fas fa-volume-up"></i> Nghe l·∫°i</button>
                <button class="btn-primary" id="nextBtn" style="flex: 2;" disabled onclick="nextSegment()">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
            </div>

            <div class="stats-row">
                <div class="stat-item"><div class="stat-val" id="wpm">0</div><div class="stat-label">WPM</div></div>
                <div class="stat-item"><div class="stat-val" id="accuracy">100%</div><div class="stat-label">ƒê√∫ng</div></div>
                <div class="stat-item"><div class="stat-val" id="time">0s</div><div class="stat-label">Th·ªùi gian</div></div>
                <div class="stat-item"><div class="stat-val" id="score">0</div><div class="stat-label">ƒêi·ªÉm</div></div>
            </div>
        </div>
    </div>

    <div id="view-leaderboard" class="view-container animate__animated animate__fadeIn">
        <h2 style="text-align: center; margin-bottom: 5px;">B·∫£ng X·∫øp H·∫°ng <span id="currentMonthDisplay"></span></h2>
        <div style="text-align:center; font-size:0.8rem; opacity:0.7; margin-bottom: 20px;">(WPM: T·ªëc ƒë·ªô g√µ - Acc: ƒê·ªô ch√≠nh x√°c)</div>

        <div class="glass-panel" style="padding: 0; overflow: hidden;">
             <table class="leaderboard-table">
                 <thead>
                     <tr>
                         <th style="padding-left: 20px;">#</th>
                         <th>Th√†nh vi√™n</th>
                         <th>WPM</th>
                         <th>Acc</th>
                         <th>ƒêi·ªÉm</th>
                     </tr>
                 </thead>
                 <tbody id="leaderboardBody">
                     <tr><td colspan="5" style="text-align:center; padding: 20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                 </tbody>
             </table>
        </div>
    </div>

</div>

<div class="tab-bar">
  <div class="tab-item active" data-target="view-home" onclick="navTo('view-home')">
    <i class="fas fa-home"></i> <span>Setup</span>
  </div>
  <div class="tab-item" data-target="view-practice" onclick="navTo('view-practice')">
    <i class="fas fa-keyboard"></i> <span>Luy·ªán t·∫≠p</span>
  </div>
  <div class="tab-item" data-target="view-leaderboard" onclick="navTo('view-leaderboard')">
    <i class="fas fa-trophy"></i> <span>X·∫øp h·∫°ng</span>
  </div>
</div>

<div id="toast"><span id="toast-msg">Message</span></div>
<a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
    <span>Trang ch·ªß</span>
</a>

<style>
    .floating-home-btn {
        position: fixed; top: 20px; left: 20px; z-index: 5000;
        display: flex; align-items: center; gap: 10px; padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px; color: white; text-decoration: none;
        font-family: 'Poppins', sans-serif; font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;
    }
    .floating-home-btn:hover { background: linear-gradient(90deg, #38bdf8, #2563eb); border-color: transparent; }
    .floating-home-btn svg { width: 24px; height: 24px; }
    @media (max-width: 640px) { .floating-home-btn span { display: none; } .floating-home-btn { padding: 12px; border-radius: 50%; } }
</style>

<script type="module">
// --- FIREBASE CONFIG (Gi·ªØ nguy√™n logic Realtime DB c·ªßa file Ch√≠nh t·∫£) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, onValue, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtaVYb_72YvoGzvcERJZypUGS-u3skz2M",
  authDomain: "tuvung-88e8d.firebaseapp.com",
  databaseURL: "https://tuvung-88e8d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tuvung-88e8d",
  storageBucket: "tuvung-88e8d.firebasestorage.app",
  messagingSenderId: "722559465686",
  appId: "1:722559465686:web:bae1a77791205d372db177"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

window.currentUser = null;

// --- AUTH LOGIC ---
window.loginGoogle = () => {
    signInWithPopup(auth, provider).catch(error => showToast("L·ªói: " + error.message));
};

window.logoutGoogle = () => {
    if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) signOut(auth);
};

onAuthStateChanged(auth, (user) => {
    const loginMsg = document.getElementById('requireLoginMsg');
    const content = document.getElementById('loggedInContent');
    
    if (user) {
        window.currentUser = { uid: user.uid, name: user.displayName, photo: user.photoURL };
        loginMsg.style.display = 'none';
        content.style.display = 'block';
        document.getElementById('userImg').src = user.photoURL;
        document.getElementById('userName').innerText = user.displayName;
        loadLeaderboard(); // Load BXH khi ƒë√£ login
    } else {
        window.currentUser = null;
        loginMsg.style.display = 'block';
        content.style.display = 'none';
        // N·∫øu ƒëang ·ªü m√†n ch∆°i m√† logout th√¨ ƒë√° v·ªÅ home
        navTo('view-home');
    }
});

// --- HELPER: LEADERBOARD ---
function getMonthKey() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
}
document.getElementById('currentMonthDisplay').textContent = getMonthKey();

window.saveScoreToFirebase = function(gameData) {
    if (!window.currentUser) return;
    const user = window.currentUser;
    const monthKey = getMonthKey();
    const userScoreRef = ref(db, `leaderboard/${monthKey}/${user.uid}`);

    runTransaction(userScoreRef, (currentData) => {
        if (currentData === null) {
            return {
                name: user.name,
                photo: user.photo,
                score: gameData.score,
                wpm: gameData.wpm,
                acc: gameData.acc,
                lastPlayed: Date.now()
            };
        } else {
            return {
                name: user.name,
                photo: user.photo,
                score: (currentData.score || 0) + gameData.score,
                wpm: Math.max(currentData.wpm || 0, gameData.wpm),
                acc: Math.max(currentData.acc || 0, gameData.acc),
                lastPlayed: Date.now()
            };
        }
    });
}

function loadLeaderboard() {
    const monthKey = getMonthKey();
    const lbRef = query(ref(db, `leaderboard/${monthKey}`), orderByChild('score'), limitToLast(20));
    
    onValue(lbRef, (snapshot) => {
        const lbBody = document.getElementById('leaderboardBody');
        lbBody.innerHTML = '';
        const data = [];
        snapshot.forEach(child => data.push(child.val()));
        data.reverse();

        if (data.length === 0) {
            lbBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†y.</td></tr>';
            return;
        }

        data.forEach((item, index) => {
            let rankClass = '';
            if(index === 0) rankClass = 'rank-1';
            else if(index === 1) rankClass = 'rank-2';
            else if(index === 2) rankClass = 'rank-3';

            const row = `
                <tr>
                    <td class="${rankClass}" style="padding-left: 20px;">${index + 1}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${item.photo}" style="width:25px; height:25px; border-radius:50%;">
                            <span>${item.name}</span>
                        </div>
                    </td>
                    <td>${item.wpm}</td>
                    <td>${item.acc}%</td>
                    <td style="font-weight:bold; color:var(--success-color);">${item.score}</td>
                </tr>
            `;
            lbBody.insertAdjacentHTML('beforeend', row);
        });
    });
}

// --- GAME LOGIC ---
const SAMPLE_LIBRARY = {
    'vi-VN': [
      "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i. S√†i Khao s∆∞∆°ng l·∫•p ƒëo√†n qu√¢n m·ªèi, M∆∞·ªùng L√°t hoa v·ªÅ trong ƒë√™m h∆°i.", 
      "M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ ta? M∆∞·ªùi lƒÉm nƒÉm ·∫•y thi·∫øt tha m·∫∑n n·ªìng. M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ kh√¥ng, Nh√¨n c√¢y nh·ªõ n√∫i, nh√¨n s√¥ng nh·ªõ ngu·ªìn?", 
      "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau. Tr·∫£i qua m·ªôt cu·ªôc b·ªÉ d√¢u, nh·ªØng ƒëi·ªÅu tr√¥ng th·∫•y m√† ƒëau ƒë·ªõn l√≤ng.", 
      "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y. Qu√™ h∆∞∆°ng l√† ƒë∆∞·ªùng ƒëi h·ªçc. Con v·ªÅ r·ª£p b∆∞·ªõm v√†ng bay.", 
      "B∆∞·ªõc t·ªõi ƒê√®o Ngang b√≥ng x·∫ø t√†. C·ªè c√¢y chen ƒë√° l√° chen hoa. Lom khom d∆∞·ªõi n√∫i ti√™m v√†i ch√∫. L√°c ƒë√°c b√™n s√¥ng ch·ª£ m·∫•y nh√†."
    ],
    'en-US': [
        "The quick brown fox jumps over the lazy dog. Success is not final, failure is not fatal: it is the courage to continue that counts.",
        "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer the slings and arrows of outrageous fortune.",
        "I wandered lonely as a cloud that floats on high o'er vales and hills, when all at once I saw a crowd, a host, of golden daffodils."
    ],
    'id-ID': ["Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia. Maknanya adalah berbeda-beda tetapi tetap satu."],
    'es-ES': ["Caminante, no hay camino, se hace camino al andar."]
};

let segments = [];
let currentIdx = 0;
let typedWords = 0, correctWords = 0, totalCorrectWords = 0, hintsUsed = 0;
let startTime = 0, timer = null;
let currentMode = 'read-write';
let recognition = null, isListening = false;
let voices = [], selectedVoice = null;
let globalLang = 'vi-VN';

window.initApp = function() {
    createParticles();
    navTo('view-home');
    if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
}

function createParticles() {
    const container = document.getElementById('particles');
    for(let i=0; i<15; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.width = Math.random() * 5 + 2 + 'px';
        p.style.height = p.style.width;
        p.style.animationDuration = Math.random() * 10 + 10 + 's';
        p.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(p);
    }
}

window.navTo = function(viewId) {
    if (viewId !== 'view-home' && !window.currentUser) {
        showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
        return;
    }
    document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');
    document.getElementById(viewId).style.display = 'block';
    
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab-item[data-target="${viewId}"]`)?.classList.add('active');
}

// TTS & Voice Logic
function loadVoices() {
    globalLang = document.getElementById('globalLang').value;
    const targetCode = globalLang.split('-')[0];
    voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(targetCode));
    if (voices.length === 0 && (globalLang.startsWith('id') || globalLang.startsWith('es'))) {
        voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
    }
    const select = document.getElementById('voiceSelect');
    select.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('') : '<option>M·∫∑c ƒë·ªãnh</option>';
    selectedVoice = voices[0];
}

document.getElementById('globalLang').addEventListener('change', loadVoices);
document.getElementById('voiceSelect').addEventListener('change', (e) => {
    selectedVoice = voices.find(v => v.name === e.target.value);
});

function speak(text, onWord) {
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    if(selectedVoice) u.voice = selectedVoice;
    u.rate = parseFloat(document.getElementById('voiceRateSelect').value);
    u.lang = globalLang;
    if(onWord) {
        u.onboundary = (e) => { if(e.name === 'word') onWord(e.charIndex, e.charLength); };
    }
    speechSynthesis.speak(u);
}

// Game Functions
window.setRandomText = function() {
    globalLang = document.getElementById('globalLang').value;
    const lib = SAMPLE_LIBRARY[globalLang] || SAMPLE_LIBRARY['vi-VN'];
    document.getElementById('sampleText').value = lib[Math.floor(Math.random() * lib.length)];
}

window.startPractice = function() {
    const text = document.getElementById('sampleText').value.trim();
    if (!text) return showToast("Vui l√≤ng nh·∫≠p ho·∫∑c ch·ªçn b√†i m·∫´u!");
    
    segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
    currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0;
    currentMode = document.querySelector('input[name="mode"]:checked').value;
    
    startTime = Date.now();
    if(timer) clearInterval(timer);
    timer = setInterval(updateStats, 1000);
    
    navTo('view-practice');
    showSegment();
}

window.endPractice = function() {
    clearInterval(timer);
    if(recognition) recognition.stop();
    speechSynthesis.cancel();
    navTo('view-home');
}

async function showSegment() {
    const text = segments[currentIdx];
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.disabled = true;
    
    const input = document.getElementById('userInput');
    input.value = ''; input.style.borderColor = '';
    
    const isReadOnly = currentMode === 'read-only';
    document.getElementById('micBox').className = isReadOnly ? '' : 'hidden';
    document.getElementById('inputWrapper').className = isReadOnly ? 'hidden' : 'input-wrapper';
    
    // Translate if needed
    const fullTextEl = document.getElementById('fullText');
    if(globalLang !== 'vi-VN') {
        fullTextEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang d·ªãch...';
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${globalLang.split('-')[0]}|vi`);
            const data = await res.json();
            fullTextEl.innerText = data.responseData.translatedText;
        } catch(e) { fullTextEl.innerText = ""; }
    } else { fullTextEl.innerText = ""; }

    // Render Karaoke Text
    const segBox = document.getElementById('currentSegment');
    segBox.innerHTML = '';
    
    if (currentMode === 'listen-write') {
        segBox.innerHTML = '<em style="opacity:0.6"><i class="fas fa-headphones"></i> H√£y nghe v√† ch√©p l·∫°i...</em>';
        setTimeout(() => speak(text), 500);
    } else {
        const words = text.split(/(\s+)/);
        let charIdx = 0;
        words.forEach(part => {
             const span = document.createElement('span');
             if(!/^\s+$/.test(part)) {
                 span.className = 'karaoke-word';
                 span.innerText = part;
                 span.dataset.start = charIdx;
                 span.dataset.end = charIdx + part.length;
                 segBox.appendChild(span);
             } else {
                 segBox.appendChild(document.createTextNode(part));
             }
             charIdx += part.length;
        });
        if(currentMode === 'read-listen-write') setTimeout(() => speak(text, highlightWord), 500);
    }
    
    if(!isReadOnly) input.focus();
    else initSpeechRecognition();
    
    updateFeedback();
}

function highlightWord(idx) {
    document.querySelectorAll('.karaoke-word').forEach(el => el.classList.remove('karaoke-active'));
    const els = document.querySelectorAll('.karaoke-word');
    for(let el of els) {
        const start = parseInt(el.dataset.start);
        const end = parseInt(el.dataset.end);
        if(idx >= start && idx < end) {
            el.classList.add('karaoke-active');
            break;
        }
    }
}

window.speakCurrentSegment = function() {
    speak(segments[currentIdx], currentMode !== 'listen-write' ? highlightWord : null);
}

// Input Logic
document.getElementById('userInput').addEventListener('input', updateFeedback);
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !document.getElementById('nextBtn').disabled) window.nextSegment();
});

document.getElementById('hintBtn').addEventListener('click', () => {
    const orig = segments[currentIdx].split(/\s+/).filter(w=>w);
    const val = document.getElementById('userInput').value.trim();
    const count = val ? val.split(/\s+/).length : 0;
    if(count < orig.length) {
        document.getElementById('liveFeedback').innerHTML += ` <span style="color:var(--accent-color)">‚Üí ${orig[count]}</span>`;
        hintsUsed++;
    }
});

function normalize(str) { return str.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase(); }

function updateFeedback() {
    const orig = segments[currentIdx];
    const val = document.getElementById('userInput').value;
    const fb = document.getElementById('liveFeedback');
    
    const oWords = orig.split(/\s+/).filter(w=>w);
    const iWords = val.replace(/ $/, ' \u00A0').split(/\s+/).filter(w=>w);
    
    let html = '', correct = 0;
    iWords.forEach((w, i) => {
        if(i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else {
            if(normalize(w) === normalize(oWords[i])) { correct++; html += `<span class="correct">${w}</span> `; }
            else html += `<span class="wrong">${w}</span> `;
        }
    });
    fb.innerHTML = html;
    correctWords = correct;
    
    if(normalize(val) === normalize(orig)) {
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('userInput').style.borderColor = 'var(--success-color)';
    }
}

window.nextSegment = function() {
    const wordsInSeg = segments[currentIdx].trim().split(/\s+/).length;
    typedWords += wordsInSeg;
    totalCorrectWords += correctWords;
    currentIdx++;
    
    const pct = Math.round((currentIdx / segments.length) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').innerText = pct + '%';
    
    if(currentIdx >= segments.length) finishGame();
    else showSegment();
}

function updateStats() {
    const s = (Date.now() - startTime) / 1000;
    const min = s / 60;
    const wpm = min > 0 ? Math.round(typedWords / min) : 0;
    const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
    
    document.getElementById('time').innerText = Math.round(s) + 's';
    document.getElementById('wpm').innerText = wpm;
    document.getElementById('accuracy').innerText = acc + '%';
    // Score Formula: WPM*2 + Acc - Hints*5
    const score = Math.max(0, Math.round(wpm * 2 + acc - hintsUsed * 5));
    document.getElementById('score').innerText = score;
}

function finishGame() {
    clearInterval(timer);
    const wpm = parseInt(document.getElementById('wpm').innerText);
    const acc = parseInt(document.getElementById('accuracy').innerText);
    const score = parseInt(document.getElementById('score').innerText);
    
    saveScoreToFirebase({ wpm, acc, score });
    
    showToast(`Ho√†n th√†nh! ƒêi·ªÉm: ${score}`, "success");
    setTimeout(() => {
        navTo('view-leaderboard');
    }, 1500);
}

// Mic Logic
function initSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) return;
    recognition = new webkitSpeechRecognition();
    recognition.lang = globalLang;
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => { document.getElementById('micBtn').classList.add('listening'); isListening = true; };
    recognition.onend = () => { document.getElementById('micBtn').classList.remove('listening'); isListening = false; };
    
    recognition.onresult = (e) => {
        let transcript = '';
        for (let i = e.resultIndex; i < e.results.length; ++i) {
             if (e.results[i].isFinal) transcript += e.results[i][0].transcript;
        }
        if(transcript) {
            const normTrans = normalize(transcript);
            const normTgt = normalize(segments[currentIdx]);
            if(normTrans.includes(normTgt) || normTgt.includes(normTrans)) { // Leniency
                 document.getElementById('liveFeedback').innerHTML = `<span class="correct">${segments[currentIdx]}</span>`;
                 document.getElementById('nextBtn').disabled = false;
                 setTimeout(window.nextSegment, 1000);
            } else {
                 document.getElementById('liveFeedback').innerHTML = `<span class="wrong">${transcript}</span>`;
            }
        }
    };
    
    document.getElementById('micBtn').onclick = () => {
        if(isListening) recognition.stop(); else recognition.start();
    }
}

function showToast(msg, type) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = msg;
    if(type === 'success') t.style.borderColor = 'var(--success-color)';
    else t.style.borderColor = 'rgba(255,255,255,0.2)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
