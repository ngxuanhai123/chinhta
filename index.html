<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Gradient Master Edition (Sync Realtime)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, b·∫£ng x·∫øp h·∫°ng online.">
  <meta name="theme-color" content="#0f172a">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- GLOBAL VARIABLES --- */
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --shadow-lg: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      
      /* Default Dark Theme Colors (Deep Universe) */
      --bg-gradient: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #4c1d95, #0f172a);
      --text: #f8fafc;
      --text-dim: #cbd5e1;
      
      --glass-surface: rgba(15, 23, 42, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.15);
      --glass-blur: 40px;
      
      --primary: #38bdf8;
      --primary-gradient: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      --primary-shadow: rgba(56, 189, 248, 0.5);
      
      --secondary: #c084fc;
      --success: #34d399;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #22d3ee;
      
      /* Blob Colors */
      --blob-1: #7e22ce; /* Purple */
      --blob-2: #0ea5e9; /* Sky */
      --blob-3: #ec4899; /* Pink */
      --blob-blend: screen;
    }

    /* --- NEW LIGHT MODE (Nordic Clean) --- */
    [data-theme="light"] {
      /* N·ªÅn s√°ng s·∫°ch, chuy√™n nghi·ªáp h∆°n m√†u pastel c≈© */
      --bg-gradient: linear-gradient(-45deg, #f1f5f9, #e2e8f0, #cbd5e1, #f8fafc); 
      --text: #0f172a; /* Ch·ªØ ƒë·∫≠m m√†u ƒëen xanh */
      --text-dim: #475569;
      
      --glass-surface: rgba(255, 255, 255, 0.75); /* K√≠nh tr·∫Øng ƒë·ª•c */
      --glass-border: rgba(255, 255, 255, 0.9);
      --glass-highlight: #ffffff;
      
      --primary: #0284c7; /* Xanh d∆∞∆°ng ƒë·∫≠m */
      --primary-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
      --primary-shadow: rgba(2, 132, 199, 0.3);
      
      --blob-1: #bfdbfe; /* Xanh nh·∫°t */
      --blob-2: #ddd6fe; /* T√≠m nh·∫°t */
      --blob-3: #bae6fd; /* Cyan nh·∫°t */
      --blob-blend: multiply;
    }

    /* --- HOLIDAY MODE (Christmas Spirit) --- */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #dc2626 0%, #16a34a 100%);
      --primary: #ef4444;
      --font-display: 'Mountains of Christmas', cursive;
    }
    
    [data-theme="holiday-dark"], [data-theme="holiday"] {
      --bg-gradient: linear-gradient(-45deg, #020617, #14532d, #7f1d1d, #020617);
      --text: #f1f5f9;
      --glass-surface: rgba(0, 0, 0, 0.7);
      --glass-border: rgba(255, 215, 0, 0.2); /* Gold border */
      
      --blob-1: #991b1b; /* Red */
      --blob-2: #166534; /* Green */
      --blob-3: #eab308; /* Gold */
      --blob-blend: screen;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
    }

    /* === ANIMATED GRADIENT BACKGROUND === */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1; overflow: hidden; pointer-events: none;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientFlow 15s ease infinite;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* === GLOWING BLOBS === */
    .aurora-blob {
      position: absolute; 
      border-radius: 50%;
      filter: blur(80px); 
      opacity: 0.8;
      mix-blend-mode: var(--blob-blend);
      animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }

    .blob-1 { top: 0%; left: 0%; width: 50vw; height: 50vw; background: var(--blob-1); animation-delay: 0s; transform-origin: top left; }
    .blob-2 { bottom: 0%; right: 0%; width: 50vw; height: 50vw; background: var(--blob-2); animation-delay: -5s; transform-origin: bottom right; }
    .blob-3 { top: 30%; left: 40%; width: 40vw; height: 40vw; background: var(--blob-3); animation-delay: -10s; }
    
    @keyframes floatBlob {
      0% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
      100% { transform: translate(0, 0) scale(1); }
    }

    /* Snow - Always Active */
    .snowflake {
      position: fixed; top: -10px; z-index: 999; color: #fff; 
      text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none;
      animation: fall linear forwards; display: block; /* Lu√¥n hi·ªán */
    }
    /* Ch·ªânh m√†u tuy·∫øt t·ªëi h∆°n m·ªôt ch√∫t ·ªü Light Mode ƒë·ªÉ d·ªÖ th·∫•y */
    [data-theme="light"] .snowflake { color: #bae6fd; text-shadow: none; }
    
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* === CONTAINER & ENHANCED GLASS CARD === */
    .container {
      max-width: 1000px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 32px;
      position: relative; z-index: 10;
      padding-top: 40px;
    }

    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-top: 1px solid var(--glass-highlight);
      border-left: 1px solid var(--glass-highlight); /* Light coming from top-left */
      border-radius: var(--card-radius);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    /* Shine Effect */
    .glass-card::after {
        content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
        background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
        transform: translateX(-100%); transition: 0.6s; pointer-events: none;
    }
    .glass-card:hover { 
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
      border-color: var(--primary);
    }
    .glass-card:hover::after { transform: translateX(100%); }

    /* === HEADER === */
    header { padding: 40px 30px; text-align: center; }
    
    .logo {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      margin-bottom: 8px;
    }
    .logo svg { 
        width: 56px; height: 56px; fill: url(#grad1); 
        filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.6)); 
        animation: floatLogo 6s ease-in-out infinite; 
    }
    
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 20px rgba(56, 189, 248, 0.5));
      line-height: 1.1;
    }
    .tagline {
      color: var(--text-dim); font-size: 1.1rem; font-weight: 500; letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px) rotate(5deg)} }

    /* === BUTTONS & CONTROLS === */
    .theme-toggle-wrapper {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%; 
      background: rgba(255,255,255,0.1); color: var(--text);
      border: 1px solid var(--glass-border); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s; backdrop-filter: blur(5px);
      font-size: 1.2rem;
    }
    .icon-btn:hover {
        background: var(--text); color: var(--bg-color); /* Invert color */
        box-shadow: 0 0 20px var(--primary);
        transform: rotate(15deg) scale(1.1);
    }
    
    #logoutBtn { color: var(--danger); border-color: rgba(248, 113, 113, 0.3); }
    #logoutBtn:hover { background: var(--danger); color: white; }
    #holidayBtn { color: #34d399; }
    [data-theme*="holiday"] #holidayBtn { background: #ef4444; color: #fff; border-color: gold; box-shadow: 0 0 15px #ef4444; }

    /* Tabs */
    .tabs {
      display: inline-flex; background: rgba(0,0,0,0.3);
      padding: 6px; border-radius: 20px; border: 1px solid var(--glass-border);
      margin: 0 auto; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }
    [data-theme="light"] .tabs { background: rgba(255,255,255,0.5); }

    .tab {
      padding: 10px 32px; border-radius: 14px; border: none;
      background: transparent; color: var(--text-dim);
      font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: 0.3s; font-family: var(--font-main);
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      background: var(--primary-gradient); color: white;
      box-shadow: 0 4px 20px var(--primary-shadow);
    }

    .user-info-bar { 
        text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--primary); box-shadow: 0 0 10px var(--primary-shadow); }
    .name-display {
      font-size: 1.2rem; color: var(--text); font-weight: 700;
      font-family: var(--font-display); text-shadow: 0 0 10px rgba(255,255,255,0.2);
    }
    [data-theme="light"] .name-display { text-shadow: none; }

    /* Inputs & Setup */
    .setup-grid {
      padding: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;
    }
    .setup-item {
      background: rgba(255,255,255,0.03); border-radius: var(--input-radius);
      padding: 24px; border: 1px solid var(--glass-border);
      transition: 0.3s;
    }
    [data-theme="light"] .setup-item { background: rgba(0,0,0,0.02); border-color: rgba(0,0,0,0.05); }

    .setup-item:hover { background: rgba(255,255,255,0.06); border-color: var(--primary); }
    
    .setup-item h3 {
      font-size: 1.1rem; margin-bottom: 16px; color: var(--primary);
      display: flex; align-items: center; justify-content: space-between; gap: 8px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
      text-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
    }
    
    select, textarea, input[type="text"] {
      width: 100%; padding: 14px 16px;
      border: 1px solid var(--glass-border); border-radius: var(--input-radius);
      background: rgba(0, 0, 0, 0.3); color: var(--text); 
      font-family: var(--font-main); font-size: 1rem; transition: 0.3s;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] select, [data-theme="light"] textarea, [data-theme="light"] input[type="text"] { 
        background: rgba(255,255,255,0.8); color: #0f172a; border-color: #cbd5e1;
    }

    select:focus, textarea:focus, input[type="text"]:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-shadow);
      background: rgba(0, 0, 0, 0.5);
    }
    [data-theme="light"] select:focus, [data-theme="light"] textarea:focus { background: white; }

    /* Radio Custom */
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent; color: var(--text);
      background: rgba(255,255,255,0.02);
    }
    [data-theme="light"] .radio-label { background: rgba(0,0,0,0.03); }

    .radio-label:hover { background: rgba(255, 255, 255, 0.1); }
    .radio-label:has(input:checked) {
      background: rgba(56, 189, 248, 0.15); border-color: var(--primary); font-weight: 600;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
    }
    input[type="radio"] { accent-color: var(--primary); width: 18px; height: 18px; }

    /* Main Start Button */
    .start-btn {
      grid-column: 1/-1;
      margin-top: 10px; padding: 22px;
      background: var(--primary-gradient);
      color: white; font-weight: 800; font-size: 1.3rem;
      border: none; border-radius: var(--btn-radius);
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 0 30px var(--primary-shadow);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-transform: uppercase; letter-spacing: 2px;
      position: relative; overflow: hidden;
    }
    .start-btn::before {
        content:''; position: absolute; top:0; left:-100%; width:100%; height:100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        transition: 0.5s;
    }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 0 50px var(--primary-shadow); }
    .start-btn:hover::before { left: 100%; }
    .start-btn:active { transform: translateY(-1px); }

    .btn-small-action {
        font-size: 0.85rem; padding: 6px 12px; border-radius: 10px; cursor: pointer; border: none; font-weight: 600; transition: 0.2s;
        display: inline-flex; align-items: center; gap: 5px;
    }
    .reset-text-btn { color: var(--info); background: rgba(34, 211, 238, 0.15); display: none; }
    .random-text-btn {
        background: var(--secondary); color: white; box-shadow: 0 0 15px rgba(192, 132, 252, 0.4);
    }
    .random-text-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }

    /* === PRACTICE AREA === */
    #practiceArea, #rankPanel { padding: 40px; }
    
    .mode-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
    .mode-btn {
      padding: 8px 24px; border-radius: 30px; border: 1px solid var(--glass-border);
      background: rgba(0,0,0,0.2); color: var(--text-dim); font-weight: 600; cursor: pointer;
      transition: 0.3s; font-size: 0.9rem;
    }
    [data-theme="light"] .mode-btn { background: rgba(255,255,255,0.5); }

    .mode-btn.active { 
        background: var(--text); color: var(--bg-color); 
        box-shadow: 0 0 15px rgba(255,255,255,0.5);
    }
    [data-theme="light"] .mode-btn.active { background: var(--primary); color: white; }

    .progress-box { margin-bottom: 20px; }
    .progress-bar {
      height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    [data-theme="light"] .progress-bar { background: rgba(0,0,0,0.1); }

    .progress-fill {
      height: 100%; background: var(--primary-gradient); width: 0;
      border-radius: 10px; transition: width 0.5s ease;
      box-shadow: 0 0 15px var(--primary);
    }

    .segment-box {
      font-size: 1.7rem; line-height: 1.8; text-align: center;
      min-height: 160px; padding: 40px;
      background: rgba(0,0,0,0.25); border-radius: 20px;
      border: 1px solid var(--glass-border); margin-bottom: 24px;
      color: var(--text); font-weight: 500;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.4);
    }
    [data-theme="light"] .segment-box { background: rgba(255,255,255,0.6); color: #0f172a; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
    
    .karaoke-word {
      padding: 4px 8px; border-radius: 8px; transition: 0.2s; position: relative;
      display: inline-block; white-space: pre-wrap;
    }
    .karaoke-active {
      background: var(--primary); color: #000 !important; transform: scale(1.15);
      box-shadow: 0 0 25px var(--primary); z-index: 10; font-weight: bold;
    }
    [data-theme="light"] .karaoke-active { color: white !important; }

    .word-tooltip {
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
        background: #0f172a; color: var(--primary); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--primary);
        font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.2s;
        white-space: nowrap; z-index: 15; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput {
      font-size: 1.5rem; padding: 24px 60px 24px 24px;
      border-radius: 24px; border: 2px solid var(--glass-border);
      box-shadow: var(--shadow-lg); background: rgba(0,0,0,0.3);
    }
    [data-theme="light"] #userInput { background: white; color: #000; }

    .hint-btn {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.3s;
    }
    .hint-btn:hover { background: var(--warning); color: #000; box-shadow: 0 0 15px var(--warning); }

    #liveFeedback {
      font-family: 'Courier New', monospace; font-size: 1.2rem;
      min-height: 50px; margin-bottom: 30px; color: var(--text-dim);
    }
    .correct { color: var(--success); font-weight: 700; text-shadow: 0 0 10px rgba(52, 211, 153, 0.4); }
    [data-theme="light"] .correct { color: #059669; text-shadow: none; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* Actions */
    .action-row { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .action-btn {
      padding: 16px 32px; border-radius: 16px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: 0.3s;
      color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .action-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }
    .action-btn:hover:not(:disabled) { transform: translateY(-4px); filter: brightness(1.1); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }

    .btn-replay { background: linear-gradient(135deg, #fbbf24, #d97706); box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
    .btn-next { background: linear-gradient(135deg, #34d399, #059669); box-shadow: 0 0 20px rgba(52, 211, 153, 0.4); }
    .btn-reset { background: rgba(255,255,255,0.1); color: var(--text); border: 1px solid var(--glass-border); }
    .btn-reset:hover { background: rgba(255,255,255,0.2); }
    [data-theme="light"] .btn-reset { background: rgba(0,0,0,0.05); color: #000; }
    
    /* Stats */
    .stats-row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px;
    }
    .stat-item {
      background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: 16px; text-align: center;
      backdrop-filter: blur(5px);
    }
    [data-theme="light"] .stat-item { background: rgba(255,255,255,0.6); border-color: rgba(0,0,0,0.1); }

    .stat-item h4 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-item .val { font-size: 2rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); text-shadow: 0 0 20px var(--primary-shadow); }
    [data-theme="light"] .stat-item .val { text-shadow: none; }

    .level-badge {
      display: inline-block; padding: 10px 40px; border-radius: 30px;
      background: var(--primary-gradient); color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
      box-shadow: 0 0 30px var(--primary-shadow); margin-top: 20px;
      animation: pulseBadge 2s infinite;
    }
    @keyframes pulseBadge { 0% { box-shadow: 0 0 20px var(--primary-shadow); } 50% { box-shadow: 0 0 40px var(--primary-shadow); } 100% { box-shadow: 0 0 20px var(--primary-shadow); } }

    /* Modal */
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: rgba(15, 23, 42, 0.95); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 32px; width: 90%; max-width: 450px;
      text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); color: var(--text);
      position: relative; overflow: hidden;
    }
    
    [data-theme="light"] .modal-content { background: rgba(255,255,255,0.95); color: #000; }

    .modal-content::before {
        content:''; position: absolute; top:-50%; left:-50%; width:200%; height:200%;
        background: radial-gradient(circle, var(--primary-shadow) 0%, transparent 60%);
        z-index: -1; animation: spinBg 10s linear infinite;
    }
    @keyframes spinBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .modal h3 { font-family: var(--font-display); font-size: 2rem; margin-bottom: 24px; color: var(--primary); text-shadow: 0 0 15px var(--primary-shadow); }

    /* Login Google Btn */
    .btn-google {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        background: white; color: #333; width: 100%; padding: 12px;
        border-radius: 30px; border: none; font-weight: 600; cursor: pointer;
        transition: 0.3s; margin-bottom: 16px; font-family: var(--font-main);
    }
    .btn-google:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,255,255,0.4); }

    .mic-btn {
      width: 80px; height: 80px; border-radius: 50%; 
      background: rgba(255,255,255,0.05); color: var(--text);
      border: 1px solid var(--glass-border);
      font-size: 2.5rem; cursor: pointer; margin: 0 auto 20px; display: block;
      transition: 0.3s; box-shadow: 0 0 30px rgba(0,0,0,0.2);
    }
    [data-theme="light"] .mic-btn { background: rgba(0,0,0,0.05); color: #000; }
    
    .mic-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); box-shadow: 0 0 30px var(--primary); }
    .mic-btn.listening { 
        background: var(--danger); color: white; border-color: transparent;
        animation: pulseMic 1.5s infinite; 
    }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 30px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    /* Leaderboard Table */
    .leaderboard-table {
        width: 100%; border-collapse: collapse; margin-top: 20px;
        color: var(--text); font-size: 0.95rem;
    }
    .leaderboard-table th {
        text-align: left; padding: 12px; color: var(--text-dim); border-bottom: 1px solid var(--glass-border);
        text-transform: uppercase; font-size: 0.8rem;
    }
    .leaderboard-table td {
        padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle;
    }
    [data-theme="light"] .leaderboard-table td { border-bottom-color: rgba(0,0,0,0.1); }

    .rank-num { font-weight: 800; color: var(--primary); font-family: var(--font-display); font-size: 1.2rem; width: 40px; }
    .lb-user { display: flex; align-items: center; gap: 10px; }
    .lb-avatar { width: 30px; height: 30px; border-radius: 50%; background: #333; }
    .lb-score { font-weight: 700; color: var(--success); }

    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
      #userInput { font-size: 1.2rem; }
    }
    .hidden { display: none !important; }
    .svg-defs { width: 0; height: 0; position: absolute; }
    
    footer .heart-icon { color: var(--danger); animation: heartbeat 1.5s infinite; display: inline-block; filter: drop-shadow(0 0 10px var(--danger)); }
    @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  
  <div id="snowContainer"></div>
  
  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#38bdf8;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#818cf8;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">Sync</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ngo·∫°i ng·ªØ - ƒêua top Realtime ‚ú®</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™ & BXH</button>
    </div>

    <div class="user-info-bar">
      <img id="userAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="user-avatar" alt="User">
      <span class="name-display" id="playerNameDisplay">Kh√°ch (Ch∆∞a ƒëƒÉng nh·∫≠p)</span>
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ luy·ªán</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
            <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
            <option value="it-IT">Ti·∫øng √ù</option>
            <option value="la-VA">Ti·∫øng Latin</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                    <option value="1.50">1.50x (R·∫•t nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <h3>
            <span>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</span>
            <div style="display:flex; gap:10px;">
                <button id="randomTextBtn" class="btn-small-action random-text-btn">üé≤ B√†i m·∫´u ng·∫´u nhi√™n</button>
                <button id="resetTextBtn" class="btn-small-action reset-text-btn">üîÑ Ho√†n t√°c</button>
            </div>
          </h3>
          <textarea id="sampleText" rows="6" spellcheck="false" placeholder="Nh·∫•n n√∫t 'B√†i m·∫´u ng·∫´u nhi√™n' ƒë·ªÉ l·∫•y b√†i vƒÉn m·∫´u ho·∫∑c t·ª± nh·∫≠p n·ªôi dung c·ªßa b·∫°n..."></textarea>
          <div style="font-size:0.85rem; color:var(--text-dim); margin-top:5px; font-style:italic;">
             **** D·ªØ li·ªáu m·∫´u ch·ª©a nhi·ªÅu b√†i th∆°/vƒÉn kinh ƒëi·ªÉn trong SGK v√† vƒÉn h·ªçc th·∫ø gi·ªõi.
          </div>
        </div>

        <button class="start-btn" id="startBtn">
          <svg style="width:24px;height:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
        <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display); text-shadow:0 0 10px var(--primary); margin-bottom: 20px;">
             Th√†nh T√≠ch Th√°ng <span id="currentMonthDisplay">...</span>
        </h2>
        <div style="text-align:center; color:var(--text-dim); margin-bottom:20px; font-size:0.9rem;">
            (ƒêi·ªÉm s·∫Ω reset v√†o ng√†y 1 h√†ng th√°ng)
        </div>

        <div id="personalStats">
          <div class="stats-row" id="personalStatsRow">
            <div class="stat-item"><h4>WPM (Max)</h4><div class="val" id="personalWPM">0</div></div>
            <div class="stat-item"><h4>Ch√≠nh x√°c (Max)</h4><div class="val" id="personalAcc">0%</div></div>
            <div class="stat-item"><h4>T·ªïng c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
            <div class="stat-item"><h4>T·ªïng ƒëi·ªÉm</h4><div class="val" id="personalScore">0</div></div>
          </div>
          <div style="text-align:center; margin-top:20px;"><span class="level-badge" id="personalBadge">T√¢n binh</span></div>
        </div>

        <h2 style="text-align:center; color:var(--warning); font-family:var(--font-display); text-shadow:0 0 10px var(--warning); margin-top: 60px;">üèÜ B·∫£ng X·∫øp H·∫°ng Th√°ng</h2>
        <div id="loadingLeaderboard" style="text-align:center; padding:20px; color:var(--text-dim);">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        <div style="overflow-x:auto;">
            <table class="leaderboard-table" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Th√†nh vi√™n</th>
                        <th>WPM (Max)</th>
                        <th>Acc (Max)</th>
                        <th>T·ªïng ƒêi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:24px; color:var(--text-dim);">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† ƒëua top server.</p>
        
        <button id="googleLoginBtn" class="btn-google">
           <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
           ƒêƒÉng nh·∫≠p v·ªõi Google
        </button>

        <div style="position:relative; margin: 20px 0;">
            <hr style="border:0; border-top:1px solid var(--glass-border);">
            <span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#131d33; padding:0 10px; font-size:0.8rem; color:var(--text-dim);">Ho·∫∑c</span>
        </div>

        <input type="text" id="usernameInput" placeholder="Nh·∫≠p t√™n kh√°ch..." maxlength="20" style="margin-bottom:20px; text-align:center;" />
        
        <div style="display:flex; gap:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">Ch∆°i ngay</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback" style="text-align:center;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div class="action-row">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
        <div id="level" class="hidden"></div> </div>
      <canvas id="mainChart" class="hidden"></canvas>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem; padding-bottom: 20px;">
        HiHi Sync <span class="heart-icon">‚ù§Ô∏è</span> ƒë∆∞·ª£c H·∫£i l√†m t·ª´ c·∫£ tr√°i tim.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDtaVYb_72YvoGzvcERJZypUGS-u3skz2M",
      authDomain: "tuvung-88e8d.firebaseapp.com",
      databaseURL: "https://tuvung-88e8d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tuvung-88e8d",
      storageBucket: "tuvung-88e8d.firebasestorage.app",
      messagingSenderId: "722559465686",
      appId: "1:722559465686:web:bae1a77791205d372db177",
      measurementId: "G-T785TQ3V32"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // --- GLOBAL VARIABLES CHO APP ---
    window.currentUser = null; 
    
    // Helper to get Year-Month key for resetting leaderboard
    function getMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }
    
    document.getElementById('currentMonthDisplay').textContent = getMonthKey();

    // UI Elements for Auth
    const loginModal = document.getElementById('loginModal');
    const googleBtn = document.getElementById('googleLoginBtn');
    const skipBtn = document.getElementById('skipLoginBtn');
    const guestInput = document.getElementById('usernameInput');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutWrapper = document.getElementById('logoutBtnWrapper');
    const userAvatar = document.getElementById('userAvatar');
    const nameDisplay = document.getElementById('playerNameDisplay');
    const lbBody = document.getElementById('leaderboardBody');
    const loadingLb = document.getElementById('loadingLeaderboard');

    // Stats Elements
    const pWPM = document.getElementById('personalWPM');
    const pAcc = document.getElementById('personalAcc');
    const pScore = document.getElementById('personalScore');
    const pSent = document.getElementById('personalSentences');
    const pBadge = document.getElementById('personalBadge');

    // --- AUTH LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUser = {
                uid: user.uid,
                name: user.displayName,
                photo: user.photoURL,
                isAnonymous: false
            };
            updateUserUI(window.currentUser);
            loginModal.classList.remove('show');
            initRealtimeSync(window.currentUser.uid); // B·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu c√° nh√¢n
            loadLeaderboard();
        } else {
            const guest = localStorage.getItem('hihiGuest');
            if (guest) {
                window.currentUser = JSON.parse(guest);
                updateUserUI(window.currentUser);
                loginModal.classList.remove('show');
                loadLeaderboard();
            } else {
                window.currentUser = null;
                updateUserUI(null);
                loginModal.classList.add('show');
            }
        }
    });

    googleBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider)
            .then((result) => {
                localStorage.removeItem('hihiGuest');
            }).catch((error) => {
                alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            });
    });

    skipBtn.addEventListener('click', () => {
        const name = guestInput.value.trim() || "Kh√°ch ·∫®n Danh";
        const guestUser = {
            uid: 'guest_' + Date.now(),
            name: name,
            photo: null,
            isAnonymous: true
        };
        localStorage.setItem('hihiGuest', JSON.stringify(guestUser));
        window.currentUser = guestUser;
        updateUserUI(guestUser);
        loginModal.classList.remove('show');
        loadLeaderboard();
    });

    logoutBtn.addEventListener('click', () => {
        if (auth.currentUser) {
            signOut(auth).then(() => window.location.reload());
        } else {
            localStorage.removeItem('hihiGuest');
            window.location.reload();
        }
    });

    function updateUserUI(user) {
        if (user) {
            nameDisplay.textContent = user.name;
            if (user.photo) userAvatar.src = user.photo;
            logoutWrapper.classList.remove('hidden');
        } else {
            nameDisplay.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
            logoutWrapper.classList.add('hidden');
        }
    }

    // --- REALTIME SYNC LOGIC ---

    // 1. L·∫Øng nghe thay ƒë·ªïi c·ªßa ch√≠nh m√¨nh (ƒë·ªÉ c·∫≠p nh·∫≠t UI real-time)
    function initRealtimeSync(uid) {
        const monthKey = getMonthKey();
        const myStatsRef = ref(db, `leaderboard/${monthKey}/${uid}`);
        
        onValue(myStatsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                pWPM.textContent = data.wpm || 0;
                pAcc.textContent = (data.acc || 0) + '%';
                pScore.textContent = data.score || 0;
                pSent.textContent = data.sentences || 0;
                
                // T√≠nh badge d·ª±a tr√™n WPM max
                const wpm = data.wpm || 0;
                const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";
                pBadge.textContent = badge;
            }
        });
    }

    // 2. H√†m l∆∞u ƒëi·ªÉm (C·ªòNG D·ªíN ƒêI·ªÇM + RESET TH√ÅNG)
    window.saveScoreToFirebase = function(gameData) {
        if (!window.currentUser || window.currentUser.isAnonymous) return;
        
        const user = window.currentUser;
        const monthKey = getMonthKey();
        const userScoreRef = ref(db, `leaderboard/${monthKey}/${user.uid}`);

        // D√πng Transaction ƒë·ªÉ c·ªông d·ªìn ƒëi·ªÉm an to√†n
        runTransaction(userScoreRef, (currentData) => {
            if (currentData === null) {
                // Ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†y -> T·∫°o m·ªõi
                return {
                    name: user.name,
                    photo: user.photo,
                    score: gameData.score,        // ƒêi·ªÉm l·∫ßn n√†y
                    sentences: gameData.sentences, // S·ªë c√¢u l·∫ßn n√†y
                    wpm: gameData.wpm,            // WPM l·∫ßn n√†y
                    acc: gameData.acc,            // Acc l·∫ßn n√†y
                    lastPlayed: Date.now()
                };
            } else {
                // ƒê√£ c√≥ d·ªØ li·ªáu -> C·ªông d·ªìn Score & Sentence, l·∫•y Max WPM & Acc
                return {
                    name: user.name,
                    photo: user.photo,
                    score: (currentData.score || 0) + gameData.score,         // C·ªông d·ªìn ƒëi·ªÉm
                    sentences: (currentData.sentences || 0) + gameData.sentences, // C·ªông d·ªìn s·ªë c√¢u
                    wpm: Math.max(currentData.wpm || 0, gameData.wpm),        // L·∫•y Max WPM
                    acc: Math.max(currentData.acc || 0, gameData.acc),        // L·∫•y Max Acc
                    lastPlayed: Date.now()
                };
            }
        }).then(() => {
            console.log("Transaction commited!");
        }).catch((err) => {
            console.error("Transaction failed: ", err);
        });
    }

    // 3. H√†m t·∫£i BXH (Load theo th√°ng hi·ªán t·∫°i)
    function loadLeaderboard() {
        const monthKey = getMonthKey();
        // L·∫•y 10 ng∆∞·ªùi ƒëi·ªÉm cao nh·∫•t (t·ªïng ƒëi·ªÉm t√≠ch l≈©y)
        const lbRef = query(ref(db, `leaderboard/${monthKey}`), orderByChild('score'), limitToLast(20));
        
        onValue(lbRef, (snapshot) => {
            loadingLb.style.display = 'none';
            lbBody.innerHTML = '';
            
            const data = [];
            snapshot.forEach(child => {
                data.push(child.val());
            });
            
            data.reverse(); // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ cao nh·∫•t l√™n ƒë·∫ßu
            
            if (data.length === 0) {
                lbBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Th√°ng m·ªõi ch∆∞a c√≥ d·ªØ li·ªáu. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                const photoHtml = item.photo 
                    ? `<img src="${item.photo}" class="lb-avatar">` 
                    : `<div class="lb-avatar" style="display:flex;align-items:center;justify-content:center;">${item.name.charAt(0)}</div>`;
                
                let rankColor = 'var(--text)';
                if(index === 0) rankColor = '#fbbf24'; // V√†ng
                else if(index === 1) rankColor = '#94a3b8'; // B·∫°c
                else if(index === 2) rankColor = '#b45309'; // ƒê·ªìng

                tr.innerHTML = `
                    <td class="rank-num" style="color:${rankColor}">${index + 1}</td>
                    <td>
                        <div class="lb-user">
                            ${photoHtml}
                            <span>${item.name}</span>
                        </div>
                    </td>
                    <td>${item.wpm || 0}</td>
                    <td>${item.acc || 0}%</td>
                    <td class="lb-score">${item.score || 0}</td>
                `;
                lbBody.appendChild(tr);
            });
        });
    }
  </script>

  <script>
    // === 1. TH∆Ø VI·ªÜN D·ªÆ LI·ªÜU ƒêA NG√îN NG·ªÆ ===
    const SAMPLE_LIBRARY = {
        'vi-VN': [
          "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i. S√†i Khao s∆∞∆°ng l·∫•p ƒëo√†n qu√¢n m·ªèi, M∆∞·ªùng L√°t hoa v·ªÅ trong ƒë√™m h∆°i.", 
          "M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ ta? M∆∞·ªùi lƒÉm nƒÉm ·∫•y thi·∫øt tha m·∫∑n n·ªìng. M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ kh√¥ng, Nh√¨n c√¢y nh·ªõ n√∫i, nh√¨n s√¥ng nh·ªõ ngu·ªìn?", 
          "B·ªóng nh·∫≠n ra h∆∞∆°ng ·ªïi, Ph·∫£ v√†o trong gi√≥ se, S∆∞∆°ng ch√πng ch√¨nh qua ng√µ, H√¨nh nh∆∞ thu ƒë√£ v·ªÅ.",
          "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau. Tr·∫£i qua m·ªôt cu·ªôc b·ªÉ d√¢u, nh·ªØng ƒëi·ªÅu tr√¥ng th·∫•y m√† ƒëau ƒë·ªõn l√≤ng.", 
          "S√¥ng n√∫i n∆∞·ªõc Nam vua Nam ·ªü. R√†nh r√†nh ƒë·ªãnh ph·∫≠n t·∫°i s√°ch tr·ªùi. C·ªõ sao l≈© gi·∫∑c sang x√¢m ph·∫°m? Ch√∫ng bay s·∫Ω b·ªã ƒë√°nh t∆°i b·ªùi.",
          "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n. B·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non. R·∫Øn n√°t m·∫∑c d·∫ßu tay k·∫ª n·∫∑n. M√† em v·∫´n gi·ªØ t·∫•m l√≤ng son.",
          "M·ªói nƒÉm hoa ƒë√†o n·ªü. L·∫°i th·∫•y √¥ng ƒë·ªì gi√†. B√†y m·ª±c t√†u gi·∫•y ƒë·ªè. B√™n ph·ªë ƒë√¥ng ng∆∞·ªùi qua.", 
          "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y. Qu√™ h∆∞∆°ng l√† ƒë∆∞·ªùng ƒëi h·ªçc. Con v·ªÅ r·ª£p b∆∞·ªõm v√†ng bay.", 
          "B∆∞·ªõc t·ªõi ƒê√®o Ngang b√≥ng x·∫ø t√†. C·ªè c√¢y chen ƒë√° l√° chen hoa. Lom khom d∆∞·ªõi n√∫i ti√™m v√†i ch√∫. L√°c ƒë√°c b√™n s√¥ng ch·ª£ m·∫•y nh√†.", 
          "Sao anh kh√¥ng v·ªÅ ch∆°i th√¥n Vƒ©? Nh√¨n n·∫Øng h√†ng cau n·∫Øng m·ªõi l√™n. V∆∞·ªùn ai m∆∞·ªõt qu√° xanh nh∆∞ ng·ªçc, L√° tr√∫c che ngang m·∫∑t ch·ªØ ƒëi·ªÅn."
        ],
        'en-US': [
            "The quick brown fox jumps over the lazy dog. Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Two roads diverged in a yellow wood, and sorry I could not travel both. And be one traveler, long I stood and looked down one as far as I could.", 
            "I wandered lonely as a cloud that floats on high o'er vales and hills, when all at once I saw a crowd, a host, of golden daffodils.", 
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer the slings and arrows of outrageous fortune."
        ],
        'id-ID': [
            "Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia yang tertulis pada lambang negara Garuda Pancasila. Maknanya adalah berbeda-beda tetapi tetap satu.",
            "Kami putra dan putri Indonesia, mengaku bertumpah darah yang satu, tanah air Indonesia."
        ],
        'es-ES': [
            "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que viv√≠a un hidalgo de los de lanza en astillero.", 
            "Caminante, no hay camino, se hace camino al andar."
        ],
        'it-IT': [
            "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura, ch√© la diritta via era smarrita.", 
            "L'amor che move il sole e l'altre stelle."
        ],
        'la-VA': [
            "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "Veni, vidi, vici. Alea iacta est."
        ]
    };

    // === 2. C·∫§U H√åNH & BI·∫æN ===
    const wordCache = {}; 
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let hintsUsed = 0;
    let totalSentences = 0; 
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;
    let userHasEditedText = false; 

    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      resetTextBtn: document.getElementById('resetTextBtn'),
      randomTextBtn: document.getElementById('randomTextBtn'), 
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
    };

    // === 4. LOGIC CH√çNH ===
    
    // T·∫°o tuy·∫øt r∆°i li√™n t·ª•c
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 40; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '.'][Math.floor(Math.random() * 4)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 15 + 10 + 'px';
            flake.style.opacity = Math.random() * 0.7 + 0.3;
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';

        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        } else {
            // N·∫øu kh√¥ng ph·∫£i holiday, d√πng base theme (light/dark)
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        }

        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'light' ? 'light' : 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        
        const base = localStorage.getItem('baseTheme') || 'dark'; 
        applyTheme(nextState ? 'holiday' : base);
    }

    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'dark'); 
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        const base = localStorage.getItem('baseTheme');
        applyTheme(isHoliday ? 'holiday' : base);
        createSnowflakes(); // Lu√¥n t·∫°o tuy·∫øt
    }

    // Tabs
    function setupTabs(tabButtons, tabContents) {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.tab;
                tabButtons.forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.toggle('hidden', c.id !== targetId));
            });
        });
    }

    // TTS & Translate
    function loadVoices() {
      const targetCode = globalLang.split('-')[0]; 
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(targetCode));
      if (voices.length === 0 && (globalLang.startsWith('la') || globalLang.startsWith('id'))) {
          voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en') || v.lang.startsWith('es'));
      }
      els.voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>M·∫∑c ƒë·ªãnh</option>';
      const saved = localStorage.getItem('voice');
      selectedVoice = voices.find(v => v.name === saved) || voices[0];
      if (selectedVoice) els.voiceSelect.value = selectedVoice.name;
    }

    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      currentUtterance.lang = globalLang;
      if (onWord) {
        currentUtterance.onboundary = (e) => {
          if (e.name === 'word') onWord(e.charIndex, e.charLength);
        };
      }
      speechSynthesis.speak(currentUtterance);
    }
    
    async function translateFull(text, src) {
      if (!text.trim() || globalLang === 'vi-VN') return text;
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch { return text; }
    }

    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const cleanWord = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!cleanWord) return;

        if (wordCache[cleanWord]) {
            targetElement.textContent = wordCache[cleanWord];
            return;
        }

        try {
            const src = globalLang.split('-')[0];
            targetElement.textContent = "..."; 
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanWord)}&langpair=${src}|vi`);
            const data = await res.json();
            const result = data.responseData.translatedText;
            if (result) {
                wordCache[cleanWord] = result;
                targetElement.textContent = result;
            } else targetElement.textContent = "?";
        } catch (e) { targetElement.textContent = "?"; }
    }

    // Display
    async function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      const isReadOnly = currentMode === 'read-only';
      els.input.style.display = isReadOnly ? 'none' : 'block';
      els.hint.style.display = isReadOnly ? 'none' : 'flex';
      els.feedback.style.display = 'block';
      els.feedback.innerHTML = '<em>Nh·∫≠p ho·∫∑c ƒë·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const srcLang = globalLang.split('-')[0];
      if (globalLang !== 'vi-VN') {
          els.fullTrans.innerHTML = '<em>ƒêang d·ªãch...</em>';
          translateFull(text, srcLang).then(trans => { els.fullTrans.textContent = 'T·∫°m d·ªãch: ' + trans; });
      } else els.fullTrans.textContent = '';

      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      const fragment = document.createDocumentFragment();
      const parts = text.split(/(\s+)/);
      let charIndex = 0;
      karaokeWords = [];

      parts.forEach(part => {
          if (!part) return;
          if (/^\s+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
          } else {
              const span = document.createElement('span');
              span.className = 'karaoke-word';
              span.textContent = part;
              span.dataset.start = charIndex;
              span.dataset.end = charIndex + part.length;
              
              if (globalLang !== 'vi-VN') {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'word-tooltip';
                  tooltip.textContent = "";
                  span.appendChild(tooltip);
                  span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
              }

              karaokeWords.push(span);
              fragment.appendChild(span);
              charIndex += part.length;
          }
      });

      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      
      if (currentMode.includes('listen') && currentMode !== 'read-only') {
        setTimeout(() => speak(text, highlightKaraoke), 300);
      }
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => {
          const start = parseInt(w.dataset.start);
          const end = parseInt(w.dataset.end);
          return charIndex >= start && charIndex < end;
      });
      if (word) word.classList.add('karaoke-active');
    }

    function normalizeText(text) {
        if (!text) return "";
        return text.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase();
    }

    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;
      const oWords = orig.split(/\s+/).filter(w => w);
      const iWords = input.replace(/ $/, ' \u00A0').split(/\s+/).filter(w => w);
      let html = '', correct = 0;
      
      iWords.forEach((w, i) => {
        if (i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else {
            const cleanTarget = normalizeText(oWords[i]);
            const cleanInput = normalizeText(w);
            if (cleanInput === cleanTarget) {
                correct++;
                html += `<span class="correct">${w}</span> `;
            } else html += `<span class="wrong">${w}</span> `;
        }
      });

      correctWords = correct;
      els.feedback.innerHTML = html || '<em>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const isContentMatch = normalizeText(input) === normalizeText(orig);
      if (isContentMatch) {
          els.next.disabled = false;
          els.input.style.borderColor = 'var(--success)';
          els.input.style.boxShadow = '0 0 0 4px rgba(52, 211, 153, 0.25)';
      } else {
          els.next.disabled = true;
          els.input.style.borderColor = '';
          els.input.style.boxShadow = '';
      }
    }

    function next() {
      const wordsInSegment = segments[currentIdx].trim().split(/\s+/).length;
      typedWords += wordsInSegment;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const m = s / 60;
      const wpm = m > 0 ? Math.round(typedWords / m) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      els.wpm.textContent = wpm;
      els.acc.textContent = acc + '%';
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      // C√¥ng th·ª©c ƒëi·ªÉm ƒë∆°n gi·∫£n: (WPM * 2) + Acc - Suggest
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";
      
      // === SAVE TO FIREBASE LEADERBOARD ===
      if (window.saveScoreToFirebase) {
          window.saveScoreToFirebase({
              wpm: wpm,
              acc: acc,
              score: score,
              sentences: totalSentences
          });
      }
      
      els.level.textContent = badge; els.levelBadge.textContent = 'ƒê·∫°t c·∫•p: ' + badge;
      els.score.textContent = score; els.wpm.textContent = wpm; els.acc.textContent = acc + '%';
      
      alert(`Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêI·ªÇM C·ªòNG TH√äM: ${score}\nT·ªïng ƒëi·ªÉm t√≠ch l≈©y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n BXH.`);
      
      // Chuy·ªÉn sang tab BXH ƒë·ªÉ xem k·∫øt qu·∫£
      document.querySelector('[data-tab="rankPanel"]').click();
    }

    function initSpeechRecognition() {
      if (recognition) { recognition.onend = null; recognition.stop(); }
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang;
      recognition.continuous = false;
      recognition.interimResults = true;
      
      recognition.onresult = (e) => {
        let finalTranscript = '';
        for (let i = e.resultIndex; i < e.results.length; ++i) {
             if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
        }
        
        const target = segments[currentIdx];
        if (finalTranscript) {
             const normTrans = normalizeText(finalTranscript);
             const normTarget = normalizeText(target);
             if (normTrans === normTarget || normTrans.includes(normTarget)) {
                 els.feedback.innerHTML = `<span class="correct">${finalTranscript}</span> (Ch√≠nh x√°c!)`;
                 els.next.disabled = false;
                 setTimeout(next, 1000);
             } else els.feedback.innerHTML = `<span class="wrong">${finalTranscript}</span> (Th·ª≠ l·∫°i)`;
        }
      };
      
      recognition.onerror = (e) => {
        els.feedback.innerHTML = `<em>L·ªói mic (${e.error}). H√£y nh·∫•n l·∫°i.</em>`;
        els.micBtn.classList.remove('listening');
        isListening = false;
      };
      recognition.onend = () => { els.micBtn.classList.remove('listening'); isListening = false; };
      return true;
    }

    function setRandomText() {
        const library = SAMPLE_LIBRARY[globalLang] || SAMPLE_LIBRARY['vi-VN'];
        const randomText = library[Math.floor(Math.random() * library.length)];
        els.text.value = randomText;
        userHasEditedText = false;
        els.resetTextBtn.style.display = 'none';
    }

    // Event Listeners
    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);

    setupTabs(els.mainTabs(), els.tabContents());

    els.voiceSelect.addEventListener('change', () => {
        selectedVoice = voices.find(v => v.name === els.voiceSelect.value);
        if (selectedVoice) localStorage.setItem('voice', selectedVoice.name);
    });
    els.previewVoice.addEventListener('click', () => speak(globalLang === 'vi-VN' ? 'Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.' : 'Hello, this is a voice preview.'));
    speechSynthesis.onvoiceschanged = loadVoices;

    els.lang.addEventListener('change', () => {
      globalLang = els.lang.value;
      localStorage.setItem('lang', globalLang);
      loadVoices();
    });

    els.text.addEventListener('input', () => {
        userHasEditedText = true;
        els.resetTextBtn.style.display = 'inline-flex';
    });

    els.resetTextBtn.addEventListener('click', () => {
        els.text.value = '';
        els.resetTextBtn.style.display = 'none';
        els.text.focus();
    });

    els.randomTextBtn.addEventListener('click', setRandomText);

    els.start.addEventListener('click', () => {
      const text = els.text.value.trim();
      if (!text) return alert('Vui l√≤ng nh·∫≠p ƒëo·∫°n vƒÉn ho·∫∑c nh·∫•n n√∫t "üé≤ B√†i m·∫´u ng·∫´u nhi√™n"!');
      segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Kh√¥ng c√≥ ƒëo·∫°n h·ª£p l·ªá!');
      
      currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0; totalSentences = segments.length;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
      
      startTime = Date.now(); 
      if (timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('practiceArea').classList.remove('hidden');
      initSpeechRecognition(); 
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); if (!els.next.disabled) next(); } });
    els.hint.addEventListener('click', () => {
      const origWords = segments[currentIdx].split(/\s+/).filter(w => w);
      const typedInput = els.input.value.trim();
      const typedCount = typedInput ? typedInput.split(/\s+/).length : 0;
      if (typedCount < origWords.length) {
        els.feedback.innerHTML += ` <span style="color:var(--info); font-weight:700;">‚Üí ${origWords[typedCount]}</span>`;
        hintsUsed++;
        els.input.focus();
      }
    });
    
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());

    els.modeBtns().forEach(btn => btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
        showSegment();
    }));

    els.micBtn.addEventListener('click', () => {
      if (!recognition) initSpeechRecognition();
      if (isListening) recognition.stop();
      else { 
          try {
              recognition.start(); els.micBtn.classList.add('listening'); isListening = true; 
              els.feedback.innerHTML = '<em>ƒêang nghe... H√£y ƒë·ªçc to!</em>'; 
          } catch(e) { initSpeechRecognition(); }
      }
    });

    initTheme(); 
    els.lang.value = globalLang;
    window.addEventListener('load', loadVoices);
  </script>
  <a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
    <span>Trang ch·ªß</span>
</a>

<style>
    .floating-home-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        color: white;
        text-decoration: none;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    [data-theme="light"] .floating-home-btn {
        background: rgba(0,0,0,0.05); color: #333; border-color: rgba(0,0,0,0.1);
    }
    .floating-home-btn svg { width: 24px; height: 24px; transition: transform 0.3s ease; }
    .floating-home-btn:hover {
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transform: translateY(2px);
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        border-color: transparent;
        color: #0f172a; 
    }
    .floating-home-btn:hover svg { transform: scale(1.1); }
    @media (max-width: 640px) {
        .floating-home-btn span { display: none; }
        .floating-home-btn { padding: 12px; border-radius: 50%; }
    }
</style>
</body>
</html>
