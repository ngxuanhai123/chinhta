<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ Th√¥ng Minh</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, t·∫°o ƒëo·∫°n vƒÉn b·∫±ng AI.">
  <meta name="theme-color" content="#f59e0b">
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
      --bg: #fff7ed; --card: #ffffff; --text: #1e293b; --muted: #64748b; --border: #fed7aa;
      --primary: #f59e0b; --primary-light: #fbbf24; --success: #10b981; --danger: #ef4444;
      --hint: #8b5cf6; --translate: #3b82f6; --glass: rgba(255,255,255,0.95);
      --shadow: 0 20px 40px rgba(245,158,11,0.15); --radius: 28px; --gap: 24px;
      --karaoke: #f59e0b; --karaoke-bg: rgba(245,158,11,0.2);
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --muted: #94a3b8; --border: #334155;
      --glass: rgba(30,41,59,0.9); --shadow: 0 20px 40px rgba(0,0,0,0.3);
      --karaoke-bg: rgba(245,158,11,0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; transition: background-color 0.3s, border-color 0.3s; }
    body {
      font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text);
      min-height: 100vh; padding: 16px; line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: var(--gap); position: relative; }
    
    /* HEADER */
    header {
      background: var(--card); border-radius: var(--radius); padding: 32px 24px;
      text-align: center; box-shadow: var(--shadow); border: 2px solid var(--border);
      position: relative; overflow: hidden;
    }
    header::before {
      content: ''; position: absolute; top:0; left:0; right:0; height:8px;
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #fde68a, #fbbf24, #f59e0b);
    }
    .logo { display: flex; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .logo svg { width: 64px; height: 64px; fill: var(--primary); animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    .logo h1 {
      font-family: 'Poppins', sans-serif; font-size: 2.5rem; font-weight: 700;
      background: linear-gradient(90deg, #f59e0b, #d97706);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    
    /* CONTROLS */
    .top-controls { position: absolute; top: 16px; right: 16px; display: flex; gap: 10px; align-items: center; z-index: 10; }
    .theme-toggle {
      background: var(--primary); color: white; border: 2px solid white;
      width: 44px; height: 44px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 4px 10px rgba(245,158,11,0.4);
    }
    .user-badge {
      background: var(--card); padding: 8px 16px; border-radius: 20px; font-weight: 700;
      border: 2px solid var(--border); display: flex; align-items: center; gap: 8px;
      font-size: 0.9rem; color: var(--primary);
    }

    /* TABS */
    .tabs { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .tab {
      padding: 14px 28px; background: var(--glass); border: 2px solid var(--border);
      border-radius: 18px; font-weight: 600; cursor: pointer; font-size: 1.2rem;
    }
    .tab.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white; border-color: transparent; box-shadow: 0 8px 20px rgba(245,158,11,0.3);
    }

    /* SETUP GRID */
    .setup-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap);
      background: var(--card); border-radius: var(--radius); padding: 32px;
      box-shadow: var(--shadow); border: 2px solid var(--border);
    }
    @media (max-width: 900px) { .setup-grid { grid-template-columns: 1fr; } }
    
    .setup-item { background: var(--glass); border-radius: 20px; padding: 24px; border: 1px solid var(--border); }
    .setup-item h3 { color: var(--primary); font-size: 1.25rem; margin-bottom: 14px; font-weight: 700; display:flex; align-items:center; gap:8px; }
    
    select, textarea {
      width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 14px;
      background: var(--card); color: var(--text); font-size: 1rem; outline: none;
    }
    select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(245,158,11,0.2); }
    
    .radio-group { display: flex; flex-direction: column; gap: 12px; }
    .radio-label {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      background: var(--glass); border: 1px solid var(--border); border-radius: 14px;
      cursor: pointer; transition: 0.2s;
    }
    .radio-label:hover { background: rgba(245,158,11,0.1); border-color: var(--primary); }
    .radio-label input { accent-color: var(--primary); width: 18px; height: 18px; }

    .btn-main {
      width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 1.2rem;
      cursor: pointer; margin-top: 16px; box-shadow: 0 8px 20px rgba(245,158,11,0.4); transition: 0.3s;
    }
    .btn-main:hover { transform: translateY(-3px); }
    .btn-ai {
      background: linear-gradient(135deg, #8b5cf6, #c4b5fd); box-shadow: 0 8px 20px rgba(139,92,246,0.4);
    }

    /* MODALS */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(5px);
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--card); border-radius: 24px; width: 90%; max-width: 450px; padding: 32px;
      box-shadow: var(--shadow); border: 2px solid var(--border); position: relative;
    }
    .modal-close {
      position: absolute; top: 16px; right: 16px; background: none; border: none;
      font-size: 1.5rem; cursor: pointer; color: var(--muted);
    }
    .modal input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 2px solid var(--border); background: var(--bg); color: var(--text); }
    
    .btn-skip {
      background: var(--glass); color: var(--muted); border: 2px dashed var(--border);
      width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; margin-top: 10px; cursor: pointer;
    }
    .btn-skip:hover { background: #fff7ed; color: var(--primary); border-color: var(--primary); }

    /* PRACTICE AREA */
    .practice-box {
      background: var(--card); border-radius: var(--radius); padding: 32px;
      box-shadow: var(--shadow); border: 2px solid var(--border); display: flex; flex-direction: column; gap: 24px;
    }
    .segment-display {
      background: var(--bg); padding: 30px; border-radius: 20px; border: 3px dashed var(--primary);
      font-size: 1.6rem; line-height: 1.8; min-height: 150px; text-align: center;
    }
    .karaoke-word { padding: 2px 4px; border-radius: 6px; transition: 0.2s; }
    .karaoke-active {
      background: var(--primary); color: white; transform: scale(1.1); display: inline-block; font-weight: bold; box-shadow: 0 4px 12px rgba(245,158,11,0.4);
    }
    
    .input-area { position: relative; }
    #userInput {
      width: 100%; padding: 20px 60px 20px 20px; font-size: 1.3rem;
      border: 3px solid var(--border); border-radius: 20px; background: var(--bg);
    }
    #userInput:focus { border-color: var(--primary); }
    .hint-btn {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 50%; background: var(--hint); color: white;
      border: none; cursor: pointer; font-weight: bold; font-size: 1.2rem;
    }

    .feedback { min-height: 30px; font-family: monospace; font-size: 1.1rem; padding: 10px; background: var(--glass); border-radius: 10px; }
    .correct { color: var(--success); font-weight: bold; }
    .wrong { color: var(--danger); text-decoration: line-through; }

    .full-translate {
      background: #eff6ff; color: #1e40af; padding: 16px; border-radius: 16px;
      display: flex; gap: 10px; align-items: center; border: 1px solid #bfdbfe;
    }
    [data-theme="dark"] .full-translate { background: #172554; color: #dbeafe; border-color: #1e3a8a; }

    /* RANKING */
    .rank-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .rank-table th { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 16px; text-align: left; border-radius: 8px 8px 0 0; }
    .rank-table td { padding: 14px; border-bottom: 1px solid var(--border); }
    .rank-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; }
    
    .filter-row { display: flex; gap: 10px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn {
      padding: 8px 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--glass); cursor: pointer; white-space: nowrap;
    }
    .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    .hidden { display: none !important; }
    
    /* MIC BUTTON */
    .mic-btn {
      width: 80px; height: 80px; background: var(--bg); border: 3px solid var(--danger); border-radius: 50%;
      color: var(--danger); font-size: 2rem; display: flex; align-items: center; justify-content: center;
      margin: 0 auto; cursor: pointer; transition: 0.3s;
    }
    .mic-btn.listening { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }

  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div class="top-controls">
        <div id="userBadge" class="user-badge hidden">
          <span>üë§</span> <span id="userNameDisplay">Guest</span>
        </div>
        <button class="theme-toggle" id="logoutBtn" title="ƒêƒÉng xu·∫•t" style="background:var(--danger); display:none;">
            <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        </button>
        <button class="theme-toggle" id="themeBtn">
          <svg style="width:24px;height:24px;fill:white;" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
        </button>
      </div>
      <div class="logo">
        <svg viewBox="0 0 100 100">
          <rect x="20" y="30" width="60" height="40" rx="5" fill="currentColor" />
          <path d="M25 40 h10 v20 h-10 z M40 40 h10 v20 h-10 z M55 40 h10 v20 h-10 z" fill="#fff" />
          <path d="M85 20 L90 70 L95 20" stroke="#fff" stroke-width="5" stroke-linecap="round" />
        </svg>
        <h1>HiHi</h1>
      </div>
      <p style="color:var(--muted); margin-top:8px;">Luy·ªán Ch√≠nh T·∫£ - Nghe, N√≥i, ƒê·ªçc, Vi·∫øt</p>
    </header>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">üõ†Ô∏è C√†i ƒê·∫∑t</button>
      <button class="tab" data-tab="rankPanel">üèÜ X·∫øp H·∫°ng</button>
    </div>

    <!-- SETUP PANEL -->
    <div id="setupPanel" class="tab-content">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåê Ng√¥n Ng·ªØ & Gi·ªçng ƒê·ªçc</h3>
          <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:var(--muted);">Ng√¥n ng·ªØ luy·ªán t·∫≠p:</label>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (English)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
          </select>
          
          <label style="display:block; margin:12px 0 8px; font-size:0.9rem; color:var(--muted);">Ch·ªçn gi·ªçng ƒë·ªçc:</label>
          <select id="voiceSelect"></select>
          <button id="testVoiceBtn" style="margin-top:8px; padding:6px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); cursor:pointer;">üîä Nghe th·ª≠</button>
        </div>
        
        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒê·ªô Luy·ªán</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> üìù Nh√¨n & G√µ L·∫°i</label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> üéß Nghe & G√µ L·∫°i</label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> üëÇ Nghe & Nh√¨n</label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> üéôÔ∏è Luy·ªán ƒê·ªçc (Mic)</label>
          </div>
        </div>
        
        <div class="setup-item" style="grid-column: 1 / -1;">
          <h3>üìÑ N·ªôi Dung Luy·ªán T·∫≠p</h3>
          <textarea id="sampleText" rows="4" placeholder="D√°n vƒÉn b·∫£n v√†o ƒë√¢y ho·∫∑c d√πng AI t·∫°o..."></textarea>
          <div style="display:flex; gap:16px; margin-top:16px;">
            <button class="btn-main btn-ai" id="openAiModal" style="flex:1; margin-top:0;">‚ú® T·∫°o b·∫±ng AI</button>
            <button class="btn-main" id="startBtn" style="flex:2; margin-top:0;">üöÄ B·∫Øt ƒë·∫ßu ngay</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RANK PANEL -->
    <div id="rankPanel" class="tab-content hidden">
      <div class="practice-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="color:var(--primary);">B·∫£ng X·∫øp H·∫°ng</h2>
          <span id="syncStatus" style="font-size:0.9rem; color:var(--success);">‚óè ƒê√£ c·∫≠p nh·∫≠t</span>
        </div>
        
        <div class="filter-row">
          <button class="filter-btn active" onclick="filterRank('all')">T·∫•t c·∫£</button>
          <button class="filter-btn" onclick="filterRank('lang')">Theo ng√¥n ng·ªØ ch·ªçn</button>
          <button class="filter-btn" onclick="filterRank('mine')">C·ªßa t√¥i</button>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="rank-table">
            <thead>
              <tr>
                <th>H·∫°ng</th>
                <th>T√™n</th>
                <th>Ng√¥n ng·ªØ</th>
                <th>WPM</th>
                <th>ƒêi·ªÉm</th>
                <th>Ng√†y</th>
              </tr>
            </thead>
            <tbody id="rankBody">
              <tr><td colspan="6" style="text-align:center; padding:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PRACTICE AREA -->
    <div id="practiceArea" class="tab-content hidden">
      <div class="practice-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <button id="backBtn" style="padding:8px 16px; border-radius:12px; border:1px solid var(--border); background:var(--bg); cursor:pointer;">‚Üê Quay l·∫°i</button>
          <div style="font-weight:bold; color:var(--primary);">Ti·∫øn ƒë·ªô: <span id="progressTxt">0%</span></div>
        </div>

        <div class="segment-display" id="segmentDisplay"></div>
        
        <div class="full-translate hidden" id="translateBox">
          <span style="font-size:1.5rem;">üåê</span>
          <span id="translatedText" style="font-style:italic;">ƒêang d·ªãch...</span>
        </div>

        <div id="micArea" class="hidden" style="text-align:center;">
          <button class="mic-btn" id="micBtn"><svg style="width:32px;height:32px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
          <p style="margin-top:12px;">Nh·∫•n micro ƒë·ªÉ ƒë·ªçc to</p>
        </div>

        <div class="input-area" id="inputArea">
          <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off">
          <button class="hint-btn" id="hintBtn">?</button>
        </div>

        <div class="feedback" id="feedback"></div>

        <div style="display:flex; gap:16px; justify-content:center;">
          <button id="replayBtn" style="padding:12px 24px; background:var(--bg); border:2px solid var(--border); border-radius:14px; font-weight:bold; cursor:pointer;">üîä Nghe l·∫°i</button>
          <button id="nextBtn" disabled style="padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:14px; font-weight:bold; cursor:pointer; opacity:0.5;">Ti·∫øp theo ‚Üí</button>
        </div>
      </div>
    </div>

  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <h2 style="text-align:center; color:var(--primary); margin-bottom:10px;">Xin Ch√†o!</h2>
      <p style="text-align:center; color:var(--muted); margin-bottom:20px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch c·ªßa b·∫°n.</p>
      
      <label>T√™n ng∆∞·ªùi d√πng:</label>
      <input type="text" id="authName" placeholder="V√≠ d·ª•: sieunhan123" maxlength="20">
      
      <label>M·∫≠t kh·∫©u:</label>
      <input type="password" id="authPass" placeholder="******">
      
      <div id="authError" style="color:var(--danger); font-size:0.9rem; min-height:20px; margin-bottom:10px;"></div>
      
      <div style="display:flex; gap:10px;">
        <button class="btn-main" id="btnLogin" style="margin-top:0;">ƒêƒÉng Nh·∫≠p</button>
        <button class="btn-main" id="btnRegister" style="margin-top:0; background:var(--bg); color:var(--text); border:1px solid var(--border);">ƒêƒÉng K√Ω</button>
      </div>
      
      <button class="btn-skip" id="btnGuest">‚ú® B·ªè qua & Ch∆°i ngay (T·∫°o t√™n ng·∫´u nhi√™n)</button>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="modal" id="aiModal">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('aiModal').classList.remove('show')">√ó</button>
      <h3 style="margin-bottom:20px;">T·∫°o B√†i T·∫≠p AI</h3>
      <label>Ch·ªß ƒë·ªÅ:</label>
      <input type="text" id="aiTopic" placeholder="V√≠ d·ª•: Du l·ªãch, C√¥ng ngh·ªá, T√¨nh y√™u...">
      
      <label>S·ªë c√¢u:</label>
      <select id="aiLength">
        <option value="3">Ng·∫Øn (3 c√¢u)</option>
        <option value="5" selected>V·ª´a (5 c√¢u)</option>
        <option value="8">D√†i (8 c√¢u)</option>
      </select>
      
      <button class="btn-main" id="btnGenerateAi">üöÄ T·∫°o ƒëo·∫°n vƒÉn</button>
    </div>
  </div>

  <script>
    // --- C·∫§U H√åNH ---
    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const GROQ_KEY = "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";

    // --- STATE ---
    let currentUser = null;
    let practiceData = {
      segments: [], idx: 0, startTime: 0, 
      typed: 0, correct: 0, hints: 0,
      timer: null
    };
    let rankTimer = null;
    let cachedRank = [];

    // --- DOM SHORTCUTS ---
    const $ = id => document.getElementById(id);
    const els = {
      authModal: $('authModal'), name: $('authName'), pass: $('authPass'),
      setup: $('setupPanel'), rank: $('rankPanel'), practice: $('practiceArea'),
      lang: $('globalLang'), voice: $('voiceSelect'), mode: document.getElementsByName('mode'),
      text: $('sampleText'), input: $('userInput'), segment: $('segmentDisplay'),
      feedback: $('feedback'), transBox: $('translateBox'), transTxt: $('translatedText'),
      micBtn: $('micBtn'), nextBtn: $('nextBtn'), replayBtn: $('replayBtn'),
      rankBody: $('rankBody'), syncStatus: $('syncStatus')
    };

    // --- 1. AUTHENTICATION & GUEST MODE ---
    function initAuth() {
      const saved = localStorage.getItem('hihi_user');
      if (saved) {
        currentUser = JSON.parse(saved);
        loginSuccess();
      } else {
        els.authModal.classList.add('show');
      }
    }

    function loginSuccess() {
      els.authModal.classList.remove('show');
      $('userBadge').classList.remove('hidden');
      $('userNameDisplay').textContent = currentUser.username;
      $('logoutBtn').style.display = 'flex';
      // Start rank sync
      fetchRank();
      startRankSync();
    }

    // Guest Generator (AI Tool gi·∫£ l·∫≠p)
    function generateCuteName() {
      const adjs = ["M√®o", "C√∫n", "G·∫•u", "Th·ªè", "S√≥c", "C√°o", "Heo", "V·ªãt", "Ong", "C·ª´u"];
      const nouns = ["M·∫≠p", "Ng·ªëc", "B√¥ng", "Xinh", "L∆∞·ªùi", "H∆∞", "Ngoan", "B√©o", "C√≤i", "M√∫p"];
      const rand = arr => arr[Math.floor(Math.random() * arr.length)];
      const num = Math.floor(Math.random() * 99);
      return `${rand(adjs)} ${rand(nouns)} ${num}`;
    }

    $('btnGuest').onclick = () => {
      const guestName = generateCuteName();
      currentUser = { username: guestName, isGuest: true };
      localStorage.setItem('hihi_user', JSON.stringify(currentUser));
      loginSuccess();
      alert(`Ch√†o m·ª´ng b·∫°n m·ªõi! T√™n ƒë√°ng y√™u c·ªßa b·∫°n l√†: ${guestName}`);
    };

    $('btnLogin').onclick = async () => {
      const name = els.name.value.trim();
      const pass = els.pass.value;
      if(!name || !pass) return $('authError').textContent = "Nh·∫≠p thi·∫øu th√¥ng tin!";
      
      try {
        const snap = await db.ref('users').orderByChild('username').equalTo(name).once('value');
        let userFound = null;
        snap.forEach(c => { if(c.val().password === pass) userFound = c.val(); });
        
        if(userFound) {
          currentUser = userFound;
          localStorage.setItem('hihi_user', JSON.stringify(currentUser));
          loginSuccess();
        } else {
          $('authError').textContent = "Sai t√™n ho·∫∑c m·∫≠t kh·∫©u!";
        }
      } catch(e) { $('authError').textContent = "L·ªói m·∫°ng!"; }
    };

    $('btnRegister').onclick = async () => {
      const name = els.name.value.trim();
      const pass = els.pass.value;
      if(!name || !pass) return $('authError').textContent = "Nh·∫≠p thi·∫øu th√¥ng tin!";
      
      try {
        const snap = await db.ref('users').orderByChild('username').equalTo(name).once('value');
        if(snap.exists()) return $('authError').textContent = "T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng!";
        
        const newUser = { username: name, password: pass };
        await db.ref('users').push(newUser);
        currentUser = newUser;
        localStorage.setItem('hihi_user', JSON.stringify(currentUser));
        loginSuccess();
      } catch(e) { $('authError').textContent = "L·ªói m·∫°ng!"; }
    };

    $('logoutBtn').onclick = () => {
      localStorage.removeItem('hihi_user');
      location.reload();
    };

    // --- 2. VOICE & SETTINGS ---
    function loadVoices() {
      const allVoices = speechSynthesis.getVoices();
      const langCode = els.lang.value.split('-')[0]; // 'vi', 'en', 'id'
      const filtered = allVoices.filter(v => v.lang.startsWith(langCode));
      
      els.voice.innerHTML = filtered.length 
        ? filtered.map(v => `<option value="${v.name}">${v.name}</option>`).join('')
        : `<option value="">M·∫∑c ƒë·ªãnh (Google)</option>`;
        
      // Restore saved voice
      const saved = localStorage.getItem(`voice_${els.lang.value}`);
      if(saved && filtered.find(v => v.name === saved)) els.voice.value = saved;
    }
    
    speechSynthesis.onvoiceschanged = loadVoices;
    els.lang.addEventListener('change', loadVoices);
    els.voice.addEventListener('change', () => localStorage.setItem(`voice_${els.lang.value}`, els.voice.value));
    
    $('testVoiceBtn').onclick = () => speak("Xin ch√†o, gi·ªçng ƒë·ªçc n√†y th·∫ø n√†o?", false);

    function speak(text, onMark) {
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const vName = els.voice.value;
      const voice = speechSynthesis.getVoices().find(v => v.name === vName);
      if(voice) u.voice = voice;
      u.lang = els.lang.value;
      if(onMark) u.onboundary = e => { if(e.name === 'word') onMark(e.charIndex); };
      speechSynthesis.speak(u);
    }

    // --- 3. RANKING LOGIC (AUTO SYNC + FILTER) ---
    async function fetchRank() {
      els.syncStatus.textContent = "‚è≥ ƒêang c·∫≠p nh·∫≠t...";
      try {
        const snap = await db.ref('rankings').orderByChild('score').limitToLast(100).once('value');
        const list = [];
        snap.forEach(c => list.push(c.val()));
        cachedRank = list.reverse(); // High score first
        renderRank();
        els.syncStatus.textContent = "‚óè ƒê√£ c·∫≠p nh·∫≠t";
      } catch(e) { els.syncStatus.textContent = "‚ö†Ô∏è L·ªói sync"; }
    }

    function startRankSync() {
      if(rankTimer) clearInterval(rankTimer);
      rankTimer = setInterval(() => {
        // Ch·ªâ update t·ª± ƒë·ªông n·∫øu ƒêANG KH√îNG ·ªü tab Rank (ƒë·ªÉ tr√°nh nh·∫£y) 
        // HO·∫∂C theo y√™u c·∫ßu ƒë·ªÅ b√†i: "t·ª± ƒë·ªông m·ªói 120s"
        if($('rankPanel').classList.contains('hidden')) fetchRank();
      }, 120000);
    }

    // Filter Logic
    let currentFilter = 'all';
    window.filterRank = (type) => {
      currentFilter = type;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderRank();
    };

    function renderRank() {
      let data = cachedRank;
      const myLang = els.lang.value;
      
      // Filter Logic
      if(currentFilter === 'lang') {
        // L·ªçc theo ng√¥n ng·ªØ ƒëang ch·ªçn ·ªü tab c√†i ƒë·∫∑t
        data = data.filter(d => d.lang === myLang);
      } else if (currentFilter === 'mine') {
        data = data.filter(d => d.name === currentUser?.username);
      }

      const html = data.map((d, i) => `
        <tr>
          <td>${i+1}</td>
          <td><strong>${d.name}</strong> ${d.name === currentUser?.username ? '(B·∫°n)' : ''}</td>
          <td>${d.lang === 'vi-VN' ? 'üáªüá≥' : d.lang === 'en-US' ? 'üá∫üá∏' : 'üáÆüá©'}</td>
          <td>${d.wpm}</td>
          <td><span class="rank-badge">${d.score}</span></td>
          <td style="color:var(--muted);font-size:0.8rem;">${new Date(d.date).toLocaleDateString('vi')}</td>
        </tr>
      `).join('');
      
      els.rankBody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
    }

    // --- 4. PRACTICE LOGIC ---
    $('startBtn').onclick = () => {
      const txt = els.text.value.trim();
      if(!txt) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");
      
      practiceData.segments = txt.split(/(?<=[.?!])\s+/).filter(s=>s.length>0);
      practiceData.idx = 0;
      practiceData.startTime = Date.now();
      practiceData.typed = 0;
      practiceData.correct = 0;
      practiceData.hints = 0;
      
      // UI Switch
      els.setup.classList.add('hidden');
      els.rank.classList.add('hidden');
      els.practice.classList.remove('hidden');
      
      loadSegment();
    };
    
    $('backBtn').onclick = () => {
      speechSynthesis.cancel();
      els.practice.classList.add('hidden');
      els.setup.classList.remove('hidden');
    };

    async function loadSegment() {
      const txt = practiceData.segments[practiceData.idx];
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const isVi = els.lang.value === 'vi-VN';
      
      // Reset
      els.input.value = '';
      els.feedback.innerHTML = '';
      els.nextBtn.disabled = true;
      els.nextBtn.style.opacity = 0.5;
      
      // Render Karaoke
      const words = txt.split(' ');
      els.segment.innerHTML = words.map((w, i) => 
        `<span class="karaoke-word" id="word-${i}">${w}</span>`
      ).join(' ');
      
      // Translation Logic (Hide if VN)
      if(isVi) {
        els.transBox.classList.add('hidden');
      } else {
        els.transBox.classList.remove('hidden');
        els.transTxt.textContent = "ƒêang d·ªãch...";
        try {
          const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=${els.lang.value.split('-')[0]}|vi`);
          const data = await res.json();
          els.transTxt.textContent = data.responseData.translatedText;
        } catch { els.transTxt.textContent = "L·ªói d·ªãch"; }
      }
      
      // Mode Display
      const isRead = mode === 'read-only';
      $('inputArea').style.display = isRead ? 'none' : 'block';
      $('micArea').style.display = isRead ? 'block' : 'none';
      $('micBtn').classList.remove('listening');
      
      if(mode.includes('listen')) {
        setTimeout(() => speak(txt, highlightWord), 500);
      }
    }

    function highlightWord(charIndex) {
      // Simple approximate highlighter
      const txt = practiceData.segments[practiceData.idx];
      const words = txt.split(' ');
      let count = 0;
      for(let i=0; i<words.length; i++) {
        if(count >= charIndex) {
          const s = document.getElementById(`word-${i}`);
          if(s) {
            s.classList.add('karaoke-active');
            setTimeout(()=>s.classList.remove('karaoke-active'), 600);
          }
          break;
        }
        count += words[i].length + 1;
      }
    }

    // Check Input
    els.input.addEventListener('input', () => {
      const target = practiceData.segments[practiceData.idx];
      const cur = els.input.value;
      
      const tArr = target.split(' ');
      const cArr = cur.split(' ');
      let html = '';
      let matchCount = 0;
      
      cArr.forEach((w, i) => {
        if(!tArr[i]) return;
        const cleanT = tArr[i].replace(/[.,?!]/g, '').toLowerCase();
        const cleanC = w.replace(/[.,?!]/g, '').toLowerCase();
        if(cleanT === cleanC) {
          html += `<span class="correct">${tArr[i]}</span> `;
          matchCount++;
        } else {
          html += `<span class="wrong">${w}</span> `;
        }
      });
      
      els.feedback.innerHTML = html;
      
      if(cur.trim() === target.trim()) {
        els.input.style.borderColor = 'var(--success)';
        els.nextBtn.disabled = false;
        els.nextBtn.style.opacity = 1;
        speak("Ch√≠nh x√°c!");
        practiceData.correct += matchCount;
        practiceData.typed += matchCount;
      } else {
        els.input.style.borderColor = 'var(--border)';
      }
    });
    
    // Hint
    $('hintBtn').onclick = () => {
      const target = practiceData.segments[practiceData.idx];
      const cur = els.input.value.trim();
      const nextWord = target.split(' ')[cur.split(/\s+/).length] || ''; 
      // Bug fix: index based on current words
      const wordsTyped = cur.length ? cur.split(/\s+/).length : 0;
      const actualNext = target.split(' ')[wordsTyped];
      
      if(actualNext) {
        els.input.value += (cur ? ' ' : '') + actualNext;
        els.input.dispatchEvent(new Event('input'));
        practiceData.hints++;
      }
    };
    
    // Mic Logic
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if(SpeechRec) {
      recognition = new SpeechRec();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.onresult = e => {
        const tran = Array.from(e.results).map(r=>r[0].transcript).join('');
        els.feedback.textContent = tran;
        const target = practiceData.segments[practiceData.idx];
        if(tran.toLowerCase().includes(target.toLowerCase().substring(0,10))) {
          els.nextBtn.disabled = false; 
          els.nextBtn.style.opacity = 1;
          els.feedback.innerHTML += ' <span class="correct"> (OK!)</span>';
        }
      };
      recognition.onend = () => $('micBtn').classList.remove('listening');
    }
    
    $('micBtn').onclick = () => {
      if(!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£!");
      recognition.lang = els.lang.value;
      recognition.start();
      $('micBtn').classList.add('listening');
    };

    // Next & Replay
    els.replayBtn.onclick = () => speak(practiceData.segments[practiceData.idx], highlightWord);
    
    els.nextBtn.onclick = () => {
      practiceData.idx++;
      const pct = Math.round((practiceData.idx / practiceData.segments.length) * 100);
      $('progressTxt').textContent = pct + '%';
      
      if(practiceData.idx >= practiceData.segments.length) finishPractice();
      else loadSegment();
    };

    async function finishPractice() {
      const min = (Date.now() - practiceData.startTime) / 60000;
      const wpm = Math.round(practiceData.typed / min) || 0;
      const score = Math.round(wpm * 10 + practiceData.segments.length * 20 - practiceData.hints * 5);
      
      alert(`Ho√†n th√†nh!\nWPM: ${wpm}\nƒêi·ªÉm: ${score}`);
      
      // Save Score
      if(currentUser) {
        await db.ref('rankings').push({
          name: currentUser.username,
          score: score,
          wpm: wpm,
          lang: els.lang.value, // SAVE LANG
          date: new Date().toISOString()
        });
        fetchRank(); // Update list
      }
      $('backBtn').click();
    }

    // --- 5. AI GENERATION ---
    $('openAiModal').onclick = () => $('aiModal').classList.add('show');
    $('btnGenerateAi').onclick = async () => {
      const topic = $('aiTopic').value || 'b·∫•t k·ª≥';
      const len = $('aiLength').value;
      const btn = $('btnGenerateAi');
      
      btn.textContent = "‚è≥ ƒêang vi·∫øt..."; btn.disabled = true;
      const prompt = `Vi·∫øt ƒëo·∫°n vƒÉn ${els.lang.value} g·ªìm ${len} c√¢u v·ªÅ ${topic}. Ch·ªâ tr·∫£ v·ªÅ text.`;
      
      try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"user", content:prompt}] })
        });
        const data = await res.json();
        els.text.value = data.choices[0].message.content;
        $('aiModal').classList.remove('show');
      } catch(e) { alert("L·ªói AI!"); }
      btn.textContent = "üöÄ T·∫°o ƒëo·∫°n vƒÉn"; btn.disabled = false;
    };

    // --- TABS LOGIC (FIX SYNC TRIGGER) ---
    document.querySelectorAll('.tab').forEach(b => {
      b.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        b.classList.add('active');
        const target = $(b.dataset.tab);
        target.classList.remove('hidden');
        
        // Y√™u c·∫ßu: M·ªü tab x·∫øp h·∫°ng -> C·∫≠p nh·∫≠t ngay
        if(b.dataset.tab === 'rankPanel') fetchRank();
      });
    });

    // Theme
    $('themeBtn').onclick = () => {
      const cur = document.body.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
    document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');

    // Init
    window.onload = () => {
      initAuth();
      loadVoices();
    };

  </script>
</body>
</html>
