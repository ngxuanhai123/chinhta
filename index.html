<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HiHi Typhoon - Luy·ªán G√µ & Nghe (Aurora Edition)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      
      --primary: #00d2ff;
      --primary-hover: #3a7bd5;
      --secondary: #9333ea;
      
      --success: #00e676;
      --error: #ff5252;
      --warning: #fbbf24;
      
      --text: #ffffff;
      --text-dim: #94a3b8;
      
      --font-main: 'Poppins', sans-serif;
      --radius: 24px;
    }

    /* DARK SPACE THEME (Default) */
    body {
      background: #0f172a;
      color: var(--text);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding-bottom: 80px; overflow-x: hidden; position: relative;
    }

    /* AURORA BACKGROUND */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      opacity: 0.6;
    }
    @keyframes gradientBG { 
      0% { background-position: 0% 50%; } 
      50% { background-position: 100% 50%; } 
      100% { background-position: 0% 50%; } 
    }

    /* PARTICLES */
    .particle {
      position: absolute; border-radius: 50%; background: white;
      opacity: 0.3; animation: floatUp linear infinite; z-index: -1; pointer-events: none;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      50% { opacity: 0.6; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    /* COMMON UI */
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    .container {
      width: 95%; max-width: 900px;
      z-index: 10; position: relative;
      padding-top: 20px;
    }

    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      padding: 30px; margin-bottom: 25px;
      transition: transform 0.3s ease;
    }

    /* HEADER */
    header { text-align: center; margin-bottom: 30px; position: relative; }
    h1 {
      font-size: 3rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 5px;
      background: linear-gradient(to right, #fff, #b3e5fc); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
    }
    .tagline { opacity: 0.8; font-size: 1rem; font-weight: 300; letter-spacing: 1px; }

    /* BUTTONS */
    .btn {
      border: none; border-radius: 16px; padding: 14px 24px;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn:active { transform: scale(0.96); }

    .btn-primary {
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.4); color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-primary:hover { background: rgba(255,255,255,0.3); box-shadow: 0 0 20px rgba(255,255,255,0.4); }

    .btn-action {
      flex: 1; height: 60px; font-size: 1.1rem;
      backdrop-filter: blur(5px);
    }
    .btn-start {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5); width: 100%;
      font-size: 1.2rem; padding: 18px; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
    }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0, 210, 255, 0.6); }

    /* INPUTS */
    .input-glass {
      width: 100%; padding: 16px; border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(0,0,0,0.2); color: white;
      font-size: 1rem; font-family: var(--font-main);
      transition: 0.3s;
    }
    .input-glass:focus { background: rgba(0,0,0,0.4); border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); }

    /* TABS */
    .tabs {
      display: flex; justify-content: center; gap: 15px; margin-bottom: 25px;
    }
    .tab-btn {
      background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6);
      padding: 10px 25px; border-radius: 30px; border: 1px solid transparent;
      cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    .tab-btn.active {
      background: rgba(0, 210, 255, 0.2); color: #fff;
      border-color: rgba(0, 210, 255, 0.5); box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
    }

    /* PRACTICE AREA */
    .text-display-box {
      font-size: 1.5rem; line-height: 1.8; text-align: center;
      min-height: 150px; padding: 30px; margin-bottom: 20px;
      background: rgba(0,0,0,0.2); border-radius: 20px;
      border: 1px dashed rgba(255,255,255,0.3);
      position: relative; overflow: hidden;
    }

    .karaoke-word {
      padding: 2px 5px; border-radius: 6px; transition: 0.2s; display: inline-block;
    }
    .karaoke-active {
      background: var(--primary); color: #000; font-weight: 700;
      transform: scale(1.1); box-shadow: 0 0 15px var(--primary);
    }

    .main-input {
      font-size: 1.4rem; text-align: center; border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3); margin-bottom: 20px;
    }
    .main-input.correct-border { border-color: var(--success); box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); }
    .main-input.wrong-border { border-color: var(--error); animation: shake 0.4s; }

    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

    .feedback-area {
      min-height: 40px; text-align: center; font-size: 1.1rem; margin-bottom: 20px; font-family: 'Courier New', monospace;
    }
    .fb-correct { color: var(--success); text-shadow: 0 0 10px rgba(0,230,118,0.5); }
    .fb-wrong { color: var(--error); text-decoration: line-through; opacity: 0.7; }

    /* STATS GRID */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px; }
    .stat-card {
      background: rgba(255,255,255,0.05); padding: 15px; border-radius: 18px; text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-val { font-size: 1.8rem; font-weight: 800; color: #fff; }
    .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); margin-top: 5px; }

    /* PROGRESS BAR */
    .progress-track {
      height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 20px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, #00d2ff, #00e676);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
    }

    /* MICROPHONE */
    .mic-btn {
      width: 70px; height: 70px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1); color: white; font-size: 1.8rem;
      cursor: pointer; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
      transition: 0.3s;
    }
    .mic-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
    .mic-btn.listening {
      background: var(--error); border-color: var(--error);
      animation: pulseMic 1.5s infinite; box-shadow: 0 0 20px var(--error);
    }
    @keyframes pulseMic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* UTILS */
    .hidden { display: none !important; }
    .row { display: flex; gap: 10px; }
    
    /* SETTINGS GRID */
    .setup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .setup-item h3 { font-size: 1rem; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

    /* TOAST */
    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%);
      background: rgba(0,0,0,0.85); color: white; padding: 12px 25px; border-radius: 50px;
      font-weight: 600; z-index: 3000; transition: transform 0.4s;
      border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px);
      display: flex; align-items: center; gap: 10px;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      z-index: 2000; display: none; align-items: center; justify-content: center;
    }
    .modal-box {
      background: #1e293b; border: 1px solid var(--glass-border); padding: 40px;
      border-radius: 30px; width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: zoomIn 0.3s;
    }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    @media (max-width: 600px) {
      h1 { font-size: 2rem; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .row { flex-direction: column; }
    }
  </style>
</head>
<body onload="initApp()">

  <div class="aurora-bg"></div>
  <div id="particles"></div>

  <header class="animate__animated animate__fadeInDown">
    <h1>HiHi Typhoon <span style="font-size: 0.4em; vertical-align: super; background: #9333ea; padding: 2px 6px; border-radius: 6px; color: white;">PRO</span></h1>
    <div class="tagline">Luy·ªán G√µ & Nghe ƒêa Ng√¥n Ng·ªØ</div>
    
    <div style="position: absolute; top: 0; right: 20px;">
      <button class="btn" style="background: rgba(255,255,255,0.1); width: 40px; height: 40px; padding: 0;" onclick="toggleSound()" title="B·∫≠t/T·∫Øt √Çm thanh">
        <i id="soundIcon" class="fas fa-volume-up"></i>
      </button>
      <button class="btn" style="background: rgba(255,255,255,0.1); width: 40px; height: 40px; padding: 0; margin-left: 5px;" onclick="handleLogout()" title="ƒêƒÉng xu·∫•t">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </header>

  <div class="container">
    
    <div class="glass-panel animate__animated animate__fadeIn" style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
      <div style="font-weight: 600; font-size: 1.1rem;">
        <i class="fas fa-user-astronaut" style="color: var(--primary); margin-right: 8px;"></i>
        Ch√†o, <span id="displayUser" style="color: var(--success);">Kh√°ch</span>
      </div>
      <div class="level-badge" style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem;">
        <i class="fas fa-trophy" style="color: var(--warning);"></i> <span id="userRank">T√¢n Binh</span>
      </div>
    </div>

    <div class="tabs animate__animated animate__fadeInUp">
      <div class="tab-btn active" onclick="switchTab('setup')"><i class="fas fa-cog"></i> C·∫•u H√¨nh</div>
      <div class="tab-btn" onclick="switchTab('stats')"><i class="fas fa-chart-line"></i> Th·ªëng K√™</div>
    </div>

    <div id="panel-setup" class="glass-panel animate__animated animate__fadeIn">
      <div class="setup-grid">
        <div class="setup-item">
          <h3><i class="fas fa-globe"></i> Ng√¥n ng·ªØ</h3>
          <select id="langSelect" class="input-glass" onchange="changeLang()">
            <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en-US">üá∫üá∏ English (US)</option>
            <option value="id-ID">üáÆüá© Indonesia</option>
            <option value="es-ES">üá™üá∏ Espa√±ol</option>
            <option value="fr-FR">üá´üá∑ Fran√ßais</option>
          </select>
        </div>

        <div class="setup-item">
          <h3><i class="fas fa-gamepad"></i> Ch·∫ø ƒë·ªô ch∆°i</h3>
          <select id="modeSelect" class="input-glass">
            <option value="read-write">üëÅÔ∏è Nh√¨n & Ch√©p (C·ªï ƒëi·ªÉn)</option>
            <option value="listen-write">üéß Nghe & Ch√©p (Luy·ªán nghe)</option>
            <option value="read-only">üé§ Luy·ªán ƒê·ªçc (Mic)</option>
          </select>
        </div>

        <div class="setup-item">
          <h3><i class="fas fa-volume-up"></i> Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display: flex; gap: 5px;">
            <select id="voiceSelect" class="input-glass" style="flex: 2;"></select>
            <button class="btn btn-primary" style="padding: 0 15px;" onclick="testVoice()"><i class="fas fa-play"></i></button>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1 / -1;">
          <h3>
            <i class="fas fa-file-alt"></i> N·ªôi dung luy·ªán t·∫≠p
            <button class="btn" style="font-size: 0.7rem; padding: 4px 10px; margin-left: auto; background: var(--secondary);" onclick="getRandomText()">
              <i class="fas fa-random"></i> L·∫•y b√†i m·∫´u
            </button>
          </h3>
          <textarea id="sourceText" class="input-glass" rows="4" placeholder="Nh·∫≠p vƒÉn b·∫£n b·∫°n mu·ªën luy·ªán v√†o ƒë√¢y..."></textarea>
        </div>
      </div>

      <div style="margin-top: 25px; text-align: center;">
        <button class="btn btn-start" onclick="startPractice()">
          B·∫ÆT ƒê·∫¶U LUY·ªÜN T·∫¨P <i class="fas fa-rocket"></i>
        </button>
      </div>
    </div>

    <div id="panel-practice" class="glass-panel hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button class="btn" onclick="stopPractice()" style="background: rgba(255,255,255,0.1);"><i class="fas fa-arrow-left"></i> Tho√°t</button>
        <div style="font-weight: 700; color: var(--primary);">TI·∫æN ƒê·ªò: <span id="progressTxt">0%</span></div>
      </div>
      
      <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>

      <div id="karaokeBox" class="text-display-box">
        </div>
      
      <div id="translationHint" style="text-align: center; color: var(--warning); font-style: italic; font-size: 0.9rem; margin-bottom: 15px; min-height: 20px;"></div>

      <div id="micContainer" class="hidden">
        <div id="micStatus" style="text-align: center; margin-bottom: 10px; color: var(--text-dim);">Nh·∫•n mic ƒë·ªÉ n√≥i...</div>
        <button id="micBtn" class="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
      </div>

      <input type="text" id="userInput" class="input-glass main-input" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off">

      <div id="feedback" class="feedback-area"></div>

      <div class="row">
        <button class="btn btn-primary btn-action" onclick="replayAudio()"><i class="fas fa-redo"></i> Nghe l·∫°i</button>
        <button class="btn btn-primary btn-action" onclick="skipSegment()" style="background: rgba(255,255,255,0.1); border-color: transparent;">B·ªè qua <i class="fas fa-forward"></i></button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val" id="liveWPM">0</div><div class="stat-label">WPM</div></div>
        <div class="stat-card"><div class="stat-val" id="liveAcc">100%</div><div class="stat-label">Ch√≠nh x√°c</div></div>
        <div class="stat-card"><div class="stat-val" id="liveTime">0s</div><div class="stat-label">Th·ªùi gian</div></div>
        <div class="stat-card"><div class="stat-val" id="liveScore">0</div><div class="stat-label">ƒêi·ªÉm</div></div>
      </div>
    </div>

    <div id="panel-stats" class="glass-panel hidden animate__animated animate__fadeIn">
      <h2 style="text-align: center; margin-bottom: 20px; color: var(--primary);">L·ªãch S·ª≠ ƒê·∫•u</h2>
      <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px;">
        <canvas id="statsChart"></canvas>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <div class="stat-card" style="display: inline-block; min-width: 200px;">
          <div class="stat-label">K·ª∑ l·ª•c WPM</div>
          <div class="stat-val" id="bestWPM" style="color: var(--warning);">0</div>
        </div>
      </div>
    </div>

  </div>

  <div class="modal-overlay" id="loginModal">
    <div class="modal-box">
      <h2 style="margin-bottom: 10px;">Xin Ch√†o! üëã</h2>
      <p style="color: var(--text-dim); margin-bottom: 20px;">Nh·∫≠p bi·ªát danh ƒë·ªÉ l∆∞u th√†nh t√≠ch</p>
      <input type="text" id="usernameInp" class="input-glass" placeholder="Bi·ªát danh..." style="text-align: center; margin-bottom: 20px;">
      <button class="btn btn-start" onclick="login()">V√†o Ngay</button>
    </div>
  </div>

  <div id="toast"><span id="toast-icon"></span> <span id="toast-msg">Msg</span></div>

  <script>
    /* --- AUDIO ENGINE --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false;
    let masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    const SFX = {
        CLICK: 'click', WIN: 'win', CORRECT: 'correct', WRONG: 'wrong', LEVELUP: 'levelup'
    };

    function playTone(freq, type, duration, startTime, vol=0.1) {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, startTime);
        gain.gain.setValueAtTime(vol, startTime);
        gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(startTime);
        osc.stop(startTime + duration);
    }

    function playSound(type) {
        const now = audioCtx.currentTime;
        switch(type) {
            case SFX.CLICK: playTone(600, 'sine', 0.1, now, 0.05); break;
            case SFX.CORRECT: playTone(800, 'sine', 0.2, now, 0.1); playTone(1200, 'sine', 0.2, now+0.1, 0.1); break;
            case SFX.WRONG: playTone(150, 'sawtooth', 0.3, now, 0.1); break;
            case SFX.WIN: 
                [523, 659, 783, 1046].forEach((f,i) => playTone(f, 'square', 0.4, now + i*0.1, 0.1));
                break;
        }
    }

    function toggleSound() {
        isMuted = !isMuted;
        document.getElementById('soundIcon').className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        showToast(isMuted ? "ƒê√£ t·∫Øt √¢m thanh" : "ƒê√£ b·∫≠t √¢m thanh");
    }

    /* --- DATA & VARIABLES --- */
    const SAMPLE_TEXTS = {
        'vi-VN': [
            "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.",
            "S√¥ng n√∫i n∆∞·ªõc Nam vua Nam ·ªü. R√†nh r√†nh ƒë·ªãnh ph·∫≠n t·∫°i s√°ch tr·ªùi.",
            "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n. B·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non.",
            "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt, cho con tr√®o h√°i m·ªói ng√†y."
        ],
        'en-US': [
            "The quick brown fox jumps over the lazy dog.",
            "To be or not to be, that is the question.",
            "All that glitters is not gold.",
            "A journey of a thousand miles begins with a single step."
        ],
        'id-ID': ["Bhinneka Tunggal Ika berbeda-beda tetapi tetap satu."],
        'es-ES': ["Caminante, no hay camino, se hace camino al andar."],
        'fr-FR': ["La vie est belle quand on aime."]
    };

    let appState = {
        user: 'Kh√°ch',
        lang: 'vi-VN',
        mode: 'read-write',
        segments: [],
        currentIdx: 0,
        voices: [],
        selectedVoice: null,
        startTime: 0,
        timer: null,
        stats: { wpm: 0, acc: 0, score: 0 },
        history: JSON.parse(localStorage.getItem('hihi_history')) || []
    };

    let recognition = null;
    let isListening = false;
    let currentUtterance = null;
    let karaokeElements = [];

    /* --- INIT & VISUALS --- */
    function initApp() {
        createParticles();
        checkLogin();
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        renderChart();
    }

    function createParticles() {
        const container = document.getElementById('particles');
        for(let i=0; i<15; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.width = Math.random() * 5 + 2 + 'px';
            p.style.height = p.style.width;
            p.style.animationDuration = Math.random() * 10 + 10 + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            container.appendChild(p);
        }
    }

    /* --- LOGIN SYSTEM --- */
    function checkLogin() {
        const u = localStorage.getItem('hihi_user');
        if(u) {
            appState.user = u;
            document.getElementById('displayUser').innerText = u;
            document.getElementById('loginModal').style.display = 'none';
        } else {
            document.getElementById('loginModal').style.display = 'flex';
        }
    }

    function login() {
        const name = document.getElementById('usernameInp').value.trim() || 'Ng∆∞·ªùi ch∆°i b√≠ ·∫©n';
        localStorage.setItem('hihi_user', name);
        appState.user = name;
        document.getElementById('displayUser').innerText = name;
        document.getElementById('loginModal').style.display = 'none';
        playSound(SFX.CLICK);
    }

    function handleLogout() {
        if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
            localStorage.removeItem('hihi_user');
            location.reload();
        }
    }

    /* --- TABS & NAVIGATION --- */
    function switchTab(tabName) {
        playSound(SFX.CLICK);
        document.querySelectorAll('.glass-panel').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        if (tabName === 'setup') {
            document.getElementById('panel-setup').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else if (tabName === 'stats') {
            document.getElementById('panel-stats').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            renderChart();
        }
    }

    /* --- VOICE & LANGUAGE --- */
    function loadVoices() {
        appState.voices = speechSynthesis.getVoices();
        changeLang(); // Update select based on current lang
    }

    function changeLang() {
        appState.lang = document.getElementById('langSelect').value;
        const code = appState.lang.split('-')[0];
        
        const relevantVoices = appState.voices.filter(v => v.lang.startsWith(code));
        const select = document.getElementById('voiceSelect');
        select.innerHTML = relevantVoices.length 
            ? relevantVoices.map(v => `<option value="${v.name}">${v.name}</option>`).join('')
            : '<option>M·∫∑c ƒë·ªãnh</option>';
        
        appState.selectedVoice = relevantVoices[0];
    }

    function testVoice() {
        const text = appState.lang === 'vi-VN' ? "Xin ch√†o, gi·ªçng ƒë·ªçc ·ªïn kh√¥ng?" : "Hello, checking voice.";
        speak(text);
    }

    function speak(text, onBoundary) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = appState.lang;
        if (document.getElementById('voiceSelect').value) {
            u.voice = appState.voices.find(v => v.name === document.getElementById('voiceSelect').value);
        }
        u.rate = 0.9;
        if(onBoundary) u.onboundary = onBoundary;
        speechSynthesis.speak(u);
    }

    function getRandomText() {
        const lib = SAMPLE_TEXTS[appState.lang] || SAMPLE_TEXTS['en-US'];
        const txt = lib[Math.floor(Math.random() * lib.length)];
        document.getElementById('sourceText').value = txt;
        playSound(SFX.CLICK);
    }

    /* --- PRACTICE LOGIC --- */
    function startPractice() {
        const rawText = document.getElementById('sourceText').value.trim();
        if(!rawText) return showToast("Vui l√≤ng nh·∫≠p n·ªôi dung!", "error");

        appState.segments = rawText.split(/(?<=[.!?])\s+/).filter(s => s.length > 0);
        appState.currentIdx = 0;
        appState.mode = document.getElementById('modeSelect').value;
        appState.stats = { wpm: 0, acc: 0, score: 0, typed: 0, errors: 0 };
        
        document.getElementById('panel-setup').classList.add('hidden');
        document.getElementById('panel-practice').classList.remove('hidden');
        
        // Setup UI based on mode
        const isMicMode = appState.mode === 'read-only';
        document.getElementById('userInput').classList.toggle('hidden', isMicMode);
        document.getElementById('micContainer').classList.toggle('hidden', !isMicMode);
        
        // Reset Timer
        appState.startTime = Date.now();
        if(appState.timer) clearInterval(appState.timer);
        appState.timer = setInterval(updateTimer, 1000);

        playSound(SFX.CLICK);
        loadSegment();
    }

    function stopPractice() {
        clearInterval(appState.timer);
        speechSynthesis.cancel();
        if(recognition) recognition.stop();
        document.getElementById('panel-practice').classList.add('hidden');
        document.getElementById('panel-setup').classList.remove('hidden');
    }

    function loadSegment() {
        const text = appState.segments[appState.currentIdx];
        const display = document.getElementById('karaokeBox');
        const input = document.getElementById('userInput');
        
        input.value = '';
        input.className = 'input-glass main-input'; 
        document.getElementById('feedback').innerHTML = '';
        input.focus();

        // Build Karaoke HTML
        karaokeElements = [];
        display.innerHTML = '';
        
        // Hide text if Listen-Only mode initially
        if(appState.mode === 'listen-write') {
            display.innerHTML = '<i class="fas fa-headphones-alt" style="font-size:3rem; opacity:0.5; margin:20px;"></i><br>Nghe v√† ch√©p l·∫°i...';
            setTimeout(() => speak(text), 500);
        } else {
            // Render Words
            let charCount = 0;
            text.split(/(\s+)/).forEach(part => {
                const span = document.createElement('span');
                span.textContent = part;
                span.className = 'karaoke-word';
                span.dataset.start = charCount;
                span.dataset.end = charCount + part.length;
                display.appendChild(span);
                karaokeElements.push(span);
                charCount += part.length;
            });
            
            // Speak if needed
            if(appState.mode === 'read-write') {
                // Optional: Speak or just Silent
            } else if (appState.mode === 'read-only') {
                 // Wait for mic
            }
        }
        
        updateProgress();
    }

    function replayAudio() {
        const text = appState.segments[appState.currentIdx];
        speak(text, (e) => {
            if(appState.mode !== 'listen-write' && e.name === 'word') {
                const idx = e.charIndex;
                karaokeElements.forEach(el => {
                    const start = parseInt(el.dataset.start);
                    const end = parseInt(el.dataset.end);
                    if(idx >= start && idx < end) el.classList.add('karaoke-active');
                    else el.classList.remove('karaoke-active');
                });
            }
        });
    }

    /* --- INPUT HANDLING --- */
    document.getElementById('userInput').addEventListener('input', function() {
        const currentText = appState.segments[appState.currentIdx];
        const typed = this.value;
        const normalizedTarget = normalize(currentText);
        const normalizedTyped = normalize(typed);

        // Visual Feedback per word
        const targetWords = currentText.split(' ');
        const typedWords = typed.split(' ');
        let fbHtml = '';
        
        typedWords.forEach((w, i) => {
            if(!w) return;
            if(i < targetWords.length) {
                const cleanW = normalize(w);
                const cleanT = normalize(targetWords[i]);
                if(cleanW === cleanT) fbHtml += `<span class="fb-correct">${targetWords[i]} </span>`;
                else fbHtml += `<span class="fb-wrong">${w}</span> `;
            }
        });
        document.getElementById('feedback').innerHTML = fbHtml;

        // Check completion
        if(normalizedTyped === normalizedTarget) {
            this.className = 'input-glass main-input correct-border';
            playSound(SFX.CORRECT);
            appState.stats.typed += targetWords.length;
            setTimeout(nextSegment, 800);
        } else if (normalizedTyped.length > normalizedTarget.length) {
             this.className = 'input-glass main-input wrong-border';
        } else {
            this.className = 'input-glass main-input';
        }
    });

    function normalize(str) {
        return str.toLowerCase().replace(/[.,!?;:"()]/g, '').trim().replace(/\s+/g, ' ');
    }

    function nextSegment() {
        appState.currentIdx++;
        if(appState.currentIdx >= appState.segments.length) {
            finishPractice();
        } else {
            loadSegment();
        }
    }

    function skipSegment() {
        nextSegment();
    }

    function finishPractice() {
        clearInterval(appState.timer);
        playSound(SFX.WIN);
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        
        // Calculate Stats
        const mins = (Date.now() - appState.startTime) / 60000;
        appState.stats.wpm = Math.round(appState.stats.typed / mins) || 0;
        appState.stats.score = appState.stats.wpm * 10;
        
        // Save History
        appState.history.push({ 
            date: new Date().toLocaleDateString(), 
            wpm: appState.stats.wpm, 
            score: appState.stats.score 
        });
        localStorage.setItem('hihi_history', JSON.stringify(appState.history));

        alert(`Ho√†n th√†nh!\nWPM: ${appState.stats.wpm}\nƒêi·ªÉm: ${appState.stats.score}`);
        stopPractice();
        switchTab('stats');
    }

    function updateTimer() {
        const diff = Math.floor((Date.now() - appState.startTime) / 1000);
        document.getElementById('liveTime').innerText = diff + 's';
        
        // Update live WPM approximation
        const mins = diff / 60;
        if(mins > 0) {
            const w = document.getElementById('userInput').value.split(' ').length;
            const liveWpm = Math.round((appState.stats.typed + w) / mins);
            document.getElementById('liveWPM').innerText = liveWpm;
        }
    }

    function updateProgress() {
        const pct = Math.round((appState.currentIdx / appState.segments.length) * 100);
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressTxt').innerText = pct + '%';
    }

    /* --- SPEECH RECOGNITION (MIC) --- */
    function toggleMic() {
        if(!('webkitSpeechRecognition' in window)) return showToast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Mic", "error");
        
        if(isListening) {
            recognition.stop();
            return;
        }

        recognition = new webkitSpeechRecognition();
        recognition.lang = appState.lang;
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isListening = true;
            document.getElementById('micBtn').classList.add('listening');
            document.getElementById('micStatus').innerText = "ƒêang nghe...";
        };

        recognition.onend = () => {
            isListening = false;
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('micStatus').innerText = "Nh·∫•n mic ƒë·ªÉ n√≥i...";
        };

        recognition.onresult = (e) => {
            let transcript = Array.from(e.results).map(r => r[0].transcript).join('');
            document.getElementById('feedback').innerHTML = `<span style="color:#00d2ff">${transcript}</span>`;
            
            const target = normalize(appState.segments[appState.currentIdx]);
            if(normalize(transcript) === target) {
                document.getElementById('feedback').innerHTML = `<span class="fb-correct">${transcript}</span>`;
                playSound(SFX.CORRECT);
                setTimeout(nextSegment, 1000);
            }
        };

        recognition.start();
    }

    /* --- CHART --- */
    function renderChart() {
        const ctx = document.getElementById('statsChart').getContext('2d');
        const data = appState.history.slice(-10); // Last 10 games
        
        // Find best WPM
        const best = Math.max(...appState.history.map(h => h.wpm), 0);
        document.getElementById('bestWPM').innerText = best;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((d, i) => `Game ${i+1}`),
                datasets: [{
                    label: 'WPM',
                    data: data.map(d => d.wpm),
                    borderColor: '#00d2ff',
                    backgroundColor: 'rgba(0, 210, 255, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                    x: { grid: { display: false }, ticks: { color: '#fff' } }
                }
            }
        });
    }

    /* --- UI HELPERS --- */
    function showToast(msg, type='info') {
        const t = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        
        icon.className = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
        t.style.borderColor = type === 'error' ? 'var(--error)' : 'rgba(255,255,255,0.2)';
        
        document.getElementById('toast-msg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
