<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Aurora Ed.</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ - Phi√™n b·∫£n Aurora Glassmorphism.">
  <meta name="theme-color" content="#8b5cf6">
  
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    :root {
      /* --- AURORA PALETTE --- */
      --bg-dark: #0f0c29;
      --bg-aurora-1: #302b63;
      --bg-aurora-2: #24243e;
      
      --glass-surface: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-blur: 20px;
      --glass-highlight: rgba(255, 255, 255, 0.15);

      --text: #ffffff;
      --text-dim: #cbd5e1;
      
      /* Neon Accents */
      --primary: #c084fc; /* T√≠m Neon */
      --primary-glow: 0 0 15px rgba(192, 132, 252, 0.6);
      --secondary: #2dd4bf; /* Xanh Teal Neon */
      
      --success: #34d399; 
      --danger: #f87171;
      --warning: #fbbf24;
      
      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 12px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      --font-tech: 'Orbitron', sans-serif;

      --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.4);
    }

    /* --- THEMES --- */
    [data-theme="light"] {
      --bg-dark: #f0f4f8;
      --bg-aurora-1: #dbeafe;
      --bg-aurora-2: #e0e7ff;
      --glass-surface: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.6);
      --text: #1e293b;
      --text-dim: #64748b;
      --primary: #6366f1;
      --primary-glow: 0 0 15px rgba(99, 102, 241, 0.4);
    }

    /* Reset & Base */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      transition: background 0.5s ease;
    }

    /* --- AURORA ANIMATED BACKGROUND --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1; overflow: hidden; background: var(--bg-dark);
    }
    .orb {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
      animation: floatOrb 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #7c3aed; animation-delay: 0s; }
    .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #2563eb; animation-delay: -5s; }
    .orb-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #db2777; animation-delay: -10s; } /* Pink */
    
    [data-theme="light"] .orb-1 { background: #60a5fa; opacity:0.4; }
    [data-theme="light"] .orb-2 { background: #a78bfa; opacity:0.4; }
    [data-theme="light"] .orb-3 { background: #f472b6; opacity:0.3; }

    @keyframes floatOrb {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, 50px) scale(1.1); }
    }

    .container {
      max-width: 1000px; margin: 0 auto;
      padding: 20px; padding-top: 40px;
      display: flex; flex-direction: column; gap: 24px;
      z-index: 10; position: relative;
    }

    /* --- GLASS CARDS --- */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-top: 1px solid var(--glass-highlight);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
    }
    .glass-card:hover {
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.4);
    }

    /* --- HEADER --- */
    header {
      padding: 30px; text-align: center; position: relative;
    }
    .logo h1 {
      font-family: var(--font-tech); font-size: 3rem; 
      background: linear-gradient(135deg, #fff 0%, #c084fc 50%, #2dd4bf 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(192, 132, 252, 0.5);
      letter-spacing: 2px;
      margin-bottom: 5px;
    }
    [data-theme="light"] .logo h1 {
        background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-shadow: none;
    }

    .toolbar {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;
    }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 12px;
      background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
      color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.3s; font-size: 1.2rem;
    }
    .icon-btn:hover { background: var(--primary); color: #fff; box-shadow: var(--primary-glow); transform: scale(1.1); }

    /* --- TABS --- */
    .tabs {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;
    }
    .tab-btn {
      padding: 10px 24px; border-radius: 20px; border: none;
      background: rgba(0,0,0,0.2); color: var(--text-dim);
      font-weight: 600; cursor: pointer; transition: 0.3s;
      font-family: var(--font-display); letter-spacing: 0.5px;
    }
    [data-theme="light"] .tab-btn { background: rgba(255,255,255,0.5); }
    
    .tab-btn.active {
      background: var(--primary); color: white;
      box-shadow: var(--primary-glow);
    }

    /* --- INPUTS & CONTROLS --- */
    .input-glass {
      width: 100%; padding: 15px; border-radius: var(--input-radius);
      border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
      color: var(--text); font-family: var(--font-main); font-size: 1rem;
      transition: 0.3s;
    }
    [data-theme="light"] .input-glass { background: rgba(255,255,255,0.5); }
    
    .input-glass:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.2);
      background: rgba(0,0,0,0.3);
    }

    /* --- BUTTONS --- */
    .btn-main {
      padding: 16px 32px; border-radius: var(--btn-radius); border: none;
      background: linear-gradient(135deg, var(--primary) 0%, #a855f7 100%);
      color: white; font-weight: 700; font-size: 1.1rem; cursor: pointer;
      box-shadow: var(--primary-glow); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%; text-transform: uppercase; letter-spacing: 1px;
      font-family: var(--font-display);
    }
    .btn-main:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(168, 85, 247, 0.6); }
    .btn-main:active { transform: scale(0.98); }

    .btn-action {
      padding: 12px 24px; border-radius: var(--btn-radius); border: none;
      font-weight: 600; cursor: pointer; transition: 0.2s; color: white;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
    .bg-green { background: var(--success); box-shadow: 0 5px 15px rgba(52, 211, 153, 0.4); }
    .bg-yellow { background: var(--warning); color: #000; box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4); }
    .bg-glass { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); }
    .bg-glass:hover { background: rgba(255,255,255,0.2); }

    /* --- SETUP GRID --- */
    .setup-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 30px;
    }
    .setup-item h3 { margin-bottom: 12px; color: var(--secondary); display:flex; justify-content:space-between; align-items:center; }

    /* --- PRACTICE AREA --- */
    .practice-area { padding: 40px; text-align: center; }
    
    .segment-box {
      font-size: 1.6rem; line-height: 1.8; min-height: 140px;
      margin: 20px 0; padding: 30px;
      border: 2px dashed var(--glass-border); border-radius: 20px;
      background: rgba(0,0,0,0.1); color: var(--text);
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    
    .karaoke-word {
      padding: 4px 8px; border-radius: 8px; transition: 0.2s; position: relative;
    }
    .karaoke-active {
      background: var(--primary); color: white;
      box-shadow: 0 0 15px var(--primary); transform: scale(1.1); z-index: 5;
    }
    
    .user-input-box {
      font-size: 1.5rem; text-align: center;
      background: rgba(0,0,0,0.3); border: 2px solid var(--glass-border);
      color: var(--secondary); padding: 20px; border-radius: 20px;
      width: 100%; margin-bottom: 20px;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }
    .user-input-box:focus { border-color: var(--secondary); box-shadow: 0 0 20px rgba(45, 212, 191, 0.3); }

    /* --- FEEDBACK & STATS --- */
    .feedback-text { height: 30px; margin-bottom: 20px; font-family: monospace; font-size: 1.1rem; }
    .correct { color: var(--success); text-shadow: 0 0 10px var(--success); }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }
    
    .stats-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px;
      border: 1px solid var(--glass-border);
    }
    .stat-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 5px; }
    .stat-val { font-family: var(--font-tech); font-size: 1.5rem; color: var(--text); }
    .stat-val.highlight { color: var(--secondary); text-shadow: 0 0 10px rgba(45, 212, 191, 0.5); }

    /* --- RANK PANEL (LEADERBOARD STYLE) --- */
    .rank-container { padding: 30px; }
    .rank-header {
      display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;
    }
    .rank-badge-lg {
      font-size: 3rem; font-weight: 900; font-family: var(--font-tech);
      background: linear-gradient(to bottom, #fcd34d, #f59e0b);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.5));
    }
    
    .history-list {
      display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;
      padding-right: 10px;
    }
    /* Scrollbar */
    .history-list::-webkit-scrollbar { width: 6px; }
    .history-list::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }

    .history-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px 20px; border-radius: 16px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
      transition: 0.2s;
    }
    .history-item:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
    
    .rank-grade {
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      border-radius: 8px; font-weight: 900; font-family: var(--font-tech); font-size: 1.2rem;
      margin-right: 15px;
    }
    .grade-s { background: linear-gradient(135deg, #fcd34d, #f59e0b); color: #000; box-shadow: 0 0 10px #f59e0b; }
    .grade-a { background: linear-gradient(135deg, #c084fc, #a855f7); color: #fff; }
    .grade-b { background: linear-gradient(135deg, #2dd4bf, #0d9488); color: #fff; }
    .grade-c { background: rgba(255,255,255,0.2); color: #fff; }
    
    .match-info { flex: 1; }
    .match-date { font-size: 0.8rem; color: var(--text-dim); }
    .match-stats { font-weight: 600; color: var(--text); }

    /* --- MODAL --- */
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 999;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-aurora-2); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 30px; width: 90%; max-width: 400px;
      text-align: center; box-shadow: 0 0 50px rgba(192, 132, 252, 0.3);
    }
    
    /* Utilities */
    .hidden { display: none !important; }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    /* Mic Button Pulse */
    .mic-btn {
      width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem;
      background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border);
      margin: 0 auto 15px; cursor: pointer; transition: 0.3s;
    }
    .mic-btn.listening { background: var(--danger); animation: pulseRed 1.5s infinite; color: white; }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <div class="container">
    <header class="glass-card">
      <div class="toolbar">
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán">üåó</button>
        <button class="icon-btn" id="soundBtn" title="B·∫≠t/T·∫Øt √¢m thanh">üîä</button>
        <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t" class="hidden">üö™</button>
      </div>

      <div class="logo">
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8; font-family: var(--font-display);">Aurora</span></h1>
        <p style="color:var(--text-dim);">Luy·ªán ch√≠nh t·∫£ phong c√°ch Cyberpunk</p>
      </div>
      
      <div style="margin-top: 15px;">
        <input type="text" id="playerName" class="input-glass" style="width:auto; text-align:center; border:none; background:transparent; font-weight:700; font-size:1.1rem; color:var(--primary);" readonly placeholder="Kh√°ch" />
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab-btn" data-tab="rankPanel">X·∫øp H·∫°ng</button>
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ</h3>
          <select id="globalLang" class="input-glass">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
            <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
            <option value="la-VA">Ti·∫øng Latin</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô</h3>
          <select id="modeSelect" class="input-glass">
            <option value="read-write">Nh√¨n & G√µ (C∆° b·∫£n)</option>
            <option value="listen-write">Nghe & G√µ (Dictation)</option>
            <option value="read-listen-write">Nghe - Nh√¨n - G√µ (Full)</option>
            <option value="read-only">Luy·ªán ƒê·ªçc (Mic)</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>ü§ñ Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; gap:10px;">
             <select id="voiceSelect" class="input-glass" style="flex:1;"></select>
             <button id="previewVoice" class="btn-action bg-glass">üîä</button>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <h3>
             <span>üìù N·ªôi dung luy·ªán</span>
             <button id="randomTextBtn" class="btn-action bg-glass" style="padding: 5px 12px; font-size:0.8rem;">üé≤ Random</button>
          </h3>
          <textarea id="sampleText" rows="4" class="input-glass" placeholder="Nh·∫≠p vƒÉn b·∫£n ho·∫∑c b·∫•m Random..."></textarea>
        </div>
      </div>
      <div style="padding: 0 30px 30px;">
        <button id="startBtn" class="btn-main">B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p üöÄ</button>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="practice-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:var(--text-dim); font-weight:600;">
           <span>Ti·∫øn tr√¨nh</span>
           <span id="progressText">0%</span>
        </div>
        <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;">
            <div id="progressFill" style="height:100%; background:var(--secondary); width:0%; transition:width 0.3s;"></div>
        </div>

        <div class="segment-box" id="currentSegment">...</div>

        <div id="micControl" class="hidden">
           <button class="mic-btn" id="micBtn">üé§</button>
           <p style="font-size:0.9rem; color:var(--text-dim);">Nh·∫•n mic ƒë·ªÉ n√≥i</p>
        </div>

        <div id="translateBox" style="color:var(--secondary); font-style:italic; margin-bottom:15px; min-height:20px;"></div>

        <input type="text" id="userInput" class="user-input-box" placeholder="G√µ n·ªôi dung t·∫°i ƒë√¢y..." autocomplete="off" />
        
        <div id="liveFeedback" class="feedback-text"></div>

        <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">
            <button class="btn-action bg-yellow" id="replayBtn">üîä Nghe l·∫°i</button>
            <button class="btn-action bg-glass" id="hintBtn">üí° G·ª£i √Ω</button>
            <button class="btn-action bg-green" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
            <button class="btn-action bg-glass" id="exitBtn" style="background:rgba(255,255,255,0.05); color:var(--text-dim);">Tho√°t</button>
        </div>

        <div class="stats-bar">
          <div class="stat-card"><div class="stat-label">Th·ªùi gian</div><div class="stat-val" id="timeVal">0s</div></div>
          <div class="stat-card"><div class="stat-label">T·ªëc ƒë·ªô</div><div class="stat-val highlight" id="wpmVal">0</div></div>
          <div class="stat-card"><div class="stat-label">Ch√≠nh x√°c</div><div class="stat-val" id="accVal">100%</div></div>
          <div class="stat-card"><div class="stat-label">ƒêi·ªÉm</div><div class="stat-val highlight" id="scoreVal">0</div></div>
        </div>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <div class="rank-container">
        <div class="rank-header">
           <div>
             <h2 style="font-family:var(--font-tech); margin-bottom:5px;">H·ªì S∆° Chi·∫øn Binh</h2>
             <p style="color:var(--text-dim);">L·ªãch s·ª≠ c√°c tr·∫≠n ƒë·∫•u g·∫ßn nh·∫•t</p>
           </div>
           <div style="text-align:right;">
             <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-dim);">H·∫°ng cao nh·∫•t</div>
             <div class="rank-badge-lg" id="bestRankBadge">N/A</div>
           </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
           <div class="stat-card" style="text-align:center;">
             <div class="stat-label">WPM K·ª∑ l·ª•c</div>
             <div class="stat-val highlight" id="recordWPM">0</div>
           </div>
           <div class="stat-card" style="text-align:center;">
             <div class="stat-label">T·ªïng tr·∫≠n</div>
             <div class="stat-val" id="totalGames">0</div>
           </div>
        </div>

        <h3 style="margin-bottom:15px; font-size:1rem; color:var(--primary);">L·ªãch s·ª≠ ƒë·∫•u</h3>
        <div class="history-list" id="historyList">
           <div style="text-align:center; color:var(--text-dim); padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        
        <div style="margin-top:30px; height:200px;">
           <canvas id="statsChart"></canvas>
        </div>
      </div>
    </div>

  </div>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h2 style="font-family:var(--font-tech); color:var(--primary); margin-bottom:10px;">WELCOME</h2>
      <p style="margin-bottom:20px; color:var(--text-dim);">Nh·∫≠p danh t√≠nh ƒë·ªÉ l∆∞u chi·∫øn t√≠ch</p>
      <input type="text" id="usernameInput" class="input-glass" placeholder="T√™n c·ªßa b·∫°n..." style="text-align:center; margin-bottom:20px;" maxlength="15"/>
      <div style="display:flex; gap:10px;">
         <button class="btn-action bg-glass" id="skipLogin" style="flex:1; justify-content:center;">B·ªè qua</button>
         <button class="btn-main" id="doLogin" style="flex:1; font-size:1rem;">V√†o ngay</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================
       1. AUDIO ENGINE (Web Audio API - No ext files)
       ========================================= */
    const AudioEngine = {
        ctx: null,
        enabled: true,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        playTone: function(freq, type, duration = 0.1) {
            if(!this.enabled || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },
        playClick: function() { this.playTone(600, 'sine', 0.05); },
        playType: function() { this.playTone(800, 'triangle', 0.05); },
        playError: function() { 
            this.playTone(150, 'sawtooth', 0.2); 
            this.playTone(100, 'sawtooth', 0.2);
        },
        playSuccess: function() {
            this.playTone(1000, 'sine', 0.1);
            setTimeout(() => this.playTone(1500, 'sine', 0.2), 100);
        },
        playWin: function() {
            if(!this.enabled) return;
            const now = this.ctx.currentTime;
            [440, 554, 659, 880].forEach((freq, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.1, now + i*0.1);
                gain.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(now + i*0.1);
                osc.stop(now + i*0.1 + 0.3);
            });
        }
    };

    /* =========================================
       2. DATA & VARIABLES
       ========================================= */
    const SAMPLE_LIBRARY = {
        'vi-VN': [
          "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i.",
          "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.",
          "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n. B·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non.",
          "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y.",
          "M·∫∑t tr·ªùi xu·ªëng bi·ªÉn nh∆∞ h√≤n l·ª≠a. S√≥ng ƒë√£ c√†i then ƒë√™m s·∫≠p c·ª≠a."
        ],
        'en-US': [
          "The quick brown fox jumps over the lazy dog.",
          "To be, or not to be, that is the question.",
          "All the world's a stage, and all the men and women merely players.",
          "Hope is the thing with feathers that perches in the soul."
        ]
    };

    const els = {
        lang: document.getElementById('globalLang'),
        text: document.getElementById('sampleText'),
        start: document.getElementById('startBtn'),
        input: document.getElementById('userInput'),
        feedback: document.getElementById('liveFeedback'),
        segment: document.getElementById('currentSegment'),
        mode: document.getElementById('modeSelect'),
        panels: document.querySelectorAll('.tab-content'),
        tabs: document.querySelectorAll('.tab-btn'),
        theme: document.getElementById('themeBtn'),
        sound: document.getElementById('soundBtn'),
        login: document.getElementById('loginModal'),
        nameInput: document.getElementById('usernameInput'),
        rankList: document.getElementById('historyList'),
        bestRank: document.getElementById('bestRankBadge'),
        recWPM: document.getElementById('recordWPM'),
        totalGames: document.getElementById('totalGames'),
        chart: document.getElementById('statsChart'),
        micBtn: document.getElementById('micBtn'),
        micControl: document.getElementById('micControl')
    };

    let gameState = {
        segments: [],
        currentIdx: 0,
        startTime: 0,
        timer: null,
        typedWords: 0,
        correctWords: 0,
        hints: 0,
        user: { name: '', history: [] },
        voices: [],
        voice: null,
        isListening: false
    };

    let chartInstance = null;

    /* =========================================
       3. CORE LOGIC
       ========================================= */
    
    // --- UI Helpers ---
    function switchTab(tabId) {
        els.panels.forEach(p => p.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        els.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
        if(tabId === 'rankPanel') renderRank();
        AudioEngine.playClick();
    }

    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    function loadUser() {
        const saved = localStorage.getItem('hihiUser_v2');
        if(saved) {
            gameState.user = JSON.parse(saved);
            document.getElementById('playerName').value = gameState.user.name;
            document.getElementById('logoutBtn').classList.remove('hidden');
        } else {
            els.login.classList.add('show');
        }
        
        // Theme
        if(localStorage.getItem('theme') === 'light') document.body.setAttribute('data-theme', 'light');
    }

    // --- Speech Logic ---
    function loadVoices() {
        gameState.voices = speechSynthesis.getVoices();
        const lang = els.lang.value;
        const suitable = gameState.voices.filter(v => v.lang.startsWith(lang.split('-')[0]));
        const select = document.getElementById('voiceSelect');
        select.innerHTML = suitable.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
        if(suitable.length) gameState.voice = suitable[0];
    }
    
    function speak(text) {
        if(!gameState.voice) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.voice = gameState.voice;
        u.rate = 1.0;
        speechSynthesis.speak(u);
    }

    // --- Game Loop ---
    function startGame() {
        const text = els.text.value.trim();
        if(!text) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn Random!");
        
        AudioEngine.init();
        AudioEngine.playClick();
        
        gameState.segments = text.split(/(?<=[.!?])\s+|\n+/).filter(s => s.trim().length > 0);
        gameState.currentIdx = 0;
        gameState.typedWords = 0;
        gameState.correctWords = 0;
        gameState.startTime = Date.now();
        gameState.hints = 0;
        
        document.getElementById('setupPanel').classList.add('hidden');
        document.getElementById('practiceArea').classList.remove('hidden');
        
        gameState.timer = setInterval(updateStats, 1000);
        showSegment();
    }

    function showSegment() {
        const seg = gameState.segments[gameState.currentIdx];
        const mode = els.mode.value;
        
        els.input.value = '';
        els.input.focus();
        els.feedback.innerHTML = '';
        document.getElementById('nextBtn').disabled = true;
        
        // Mode handling
        const isListen = mode.includes('listen');
        const isRead = mode === 'read-only';
        
        els.segment.innerHTML = isListen && !mode.includes('read') ? 
            '<em>(üéß H√£y nghe v√† g√µ l·∫°i...)</em>' : 
            highlightWords(seg);
            
        els.input.style.display = isRead ? 'none' : 'block';
        els.micControl.classList.toggle('hidden', !isRead);
        
        if(els.lang.value !== 'vi-VN') {
             // Mock translation
             document.getElementById('translateBox').textContent = "T·∫°m d·ªãch: (T√≠nh nƒÉng ƒëang c·∫≠p nh·∫≠t cho ng√¥n ng·ªØ n√†y)";
        } else {
             document.getElementById('translateBox').textContent = "";
        }

        if(isListen) setTimeout(() => speak(seg), 500);
    }

    function highlightWords(text) {
        return text.split(' ').map(w => `<span class="karaoke-word">${w}</span>`).join(' ');
    }

    function checkInput() {
        const target = gameState.segments[gameState.currentIdx];
        const input = els.input.value;
        const targetClean = target.replace(/[.,!?;:"()]/g, "").toLowerCase().trim();
        const inputClean = input.replace(/[.,!?;:"()]/g, "").toLowerCase().trim();

        // Feedback visual
        let html = '';
        const targetWords = target.split(' ');
        const inputWords = input.split(' ');
        
        inputWords.forEach((w, i) => {
             if(!targetWords[i]) return;
             const wClean = w.replace(/[.,!?;:"()]/g, "").toLowerCase();
             const tClean = targetWords[i].replace(/[.,!?;:"()]/g, "").toLowerCase();
             if(wClean === tClean) html += `<span class="correct">${targetWords[i]}</span> `;
             else html += `<span class="wrong">${w}</span> `;
        });
        els.feedback.innerHTML = html;

        if(input.length > 0 && input.slice(-1) === ' ') AudioEngine.playType();

        if(targetClean === inputClean) {
            document.getElementById('nextBtn').disabled = false;
            els.input.style.borderColor = 'var(--success)';
            AudioEngine.playSuccess();
        } else {
            els.input.style.borderColor = 'var(--glass-border)';
        }
    }

    function nextSegment() {
        const seg = gameState.segments[gameState.currentIdx];
        gameState.typedWords += seg.split(' ').length; // Approx
        gameState.correctWords += seg.split(' ').length; // Assuming correct to pass
        
        gameState.currentIdx++;
        const pct = Math.round((gameState.currentIdx / gameState.segments.length) * 100);
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = pct + '%';

        if(gameState.currentIdx >= gameState.segments.length) endGame();
        else showSegment();
    }

    function updateStats() {
        const sec = Math.floor((Date.now() - gameState.startTime)/1000);
        document.getElementById('timeVal').textContent = sec + 's';
        const wpm = Math.round(gameState.typedWords / (sec/60)) || 0;
        document.getElementById('wpmVal').textContent = wpm;
    }

    function endGame() {
        clearInterval(gameState.timer);
        AudioEngine.playWin();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        const sec = (Date.now() - gameState.startTime)/1000;
        const wpm = Math.round(gameState.typedWords / (sec/60));
        const score = Math.round(wpm * 10 - gameState.hints * 50);
        
        // Save history
        const record = {
            date: new Date().toLocaleDateString('vi-VN'),
            wpm: wpm,
            score: score > 0 ? score : 0,
            rank: getRank(wpm)
        };
        
        gameState.user.history.unshift(record);
        if(gameState.user.history.length > 20) gameState.user.history.pop();
        localStorage.setItem('hihiUser_v2', JSON.stringify(gameState.user));

        alert(`üèÜ HO√ÄN TH√ÄNH!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêi·ªÉm: ${score}`);
        switchTab('rankPanel');
    }

    function getRank(wpm) {
        if(wpm >= 120) return 'S';
        if(wpm >= 80) return 'A';
        if(wpm >= 40) return 'B';
        return 'C';
    }

    // --- Render Rank ---
    function renderRank() {
        const hist = gameState.user.history;
        const list = els.rankList;
        list.innerHTML = '';

        if(hist.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim);">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o</div>';
            return;
        }

        // Calculate Stats
        let maxWPM = 0;
        hist.forEach(h => { if(h.wpm > maxWPM) maxWPM = h.wpm; });
        els.recWPM.textContent = maxWPM;
        els.totalGames.textContent = hist.length;
        els.bestRank.textContent = getRank(maxWPM);

        // Render List
        hist.forEach(h => {
            const gradeColor = h.rank === 'S' ? 'grade-s' : h.rank === 'A' ? 'grade-a' : h.rank === 'B' ? 'grade-b' : 'grade-c';
            const html = `
                <div class="history-item">
                   <div class="rank-grade ${gradeColor}">${h.rank}</div>
                   <div class="match-info">
                      <div class="match-stats">${h.wpm} WPM <span style="font-weight:400; font-size:0.9em; color:var(--text-dim);">‚Ä¢ ${h.score} pts</span></div>
                      <div class="match-date">${h.date}</div>
                   </div>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', html);
        });

        // Chart
        if(chartInstance) chartInstance.destroy();
        const ctx = els.chart.getContext('2d');
        const recent = hist.slice(0, 10).reverse();
        
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: recent.map((_, i) => i+1),
                datasets: [{
                    label: 'WPM',
                    data: recent.map(r => r.wpm),
                    borderColor: '#2dd4bf',
                    backgroundColor: 'rgba(45, 212, 191, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: {
                    x: { display: false },
                    y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#cbd5e1' } }
                }
            }
        });
    }

    // --- Helper for Random Text ---
    document.getElementById('randomTextBtn').addEventListener('click', () => {
        const lib = SAMPLE_LIBRARY[els.lang.value] || SAMPLE_LIBRARY['vi-VN'];
        els.text.value = lib[Math.floor(Math.random() * lib.length)];
        AudioEngine.playClick();
    });

    /* =========================================
       4. EVENT LISTENERS
       ========================================= */
    els.tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
    
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('nextBtn').addEventListener('click', () => {
        AudioEngine.playClick();
        nextSegment();
    });
    
    document.getElementById('replayBtn').addEventListener('click', () => {
        speak(gameState.segments[gameState.currentIdx]);
    });
    
    document.getElementById('exitBtn').addEventListener('click', () => location.reload());
    
    els.input.addEventListener('input', checkInput);
    els.input.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !document.getElementById('nextBtn').disabled) nextSegment();
    });
    
    document.getElementById('hintBtn').addEventListener('click', () => {
        const seg = gameState.segments[gameState.currentIdx];
        const words = seg.split(' ');
        const inputWords = els.input.value.trim().split(' ').length;
        if(inputWords < words.length) {
            els.input.value += (els.input.value ? ' ' : '') + words[els.input.value ? inputWords : 0];
            checkInput();
            gameState.hints++;
        }
    });

    // Theme & Login
    els.theme.addEventListener('click', toggleTheme);
    document.getElementById('doLogin').addEventListener('click', () => {
        const name = els.nameInput.value || "Kh√°ch";
        gameState.user.name = name;
        localStorage.setItem('hihiUser_v2', JSON.stringify(gameState.user));
        document.getElementById('playerName').value = name;
        els.login.classList.remove('show');
        document.getElementById('logoutBtn').classList.remove('hidden');
        AudioEngine.init();
    });
    
    document.getElementById('skipLogin').addEventListener('click', () => {
        gameState.user.name = "Kh√°ch v√£ng lai";
        document.getElementById('playerName').value = gameState.user.name;
        els.login.classList.remove('show');
        AudioEngine.init();
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('hihiUser_v2');
        location.reload();
    });
    
    document.getElementById('soundBtn').addEventListener('click', function() {
        AudioEngine.enabled = !AudioEngine.enabled;
        this.textContent = AudioEngine.enabled ? 'üîä' : 'üîá';
    });

    speechSynthesis.onvoiceschanged = loadVoices;
    els.lang.addEventListener('change', loadVoices);

    // Init
    window.addEventListener('load', () => {
        loadUser();
        loadVoices();
    });

  </script>
</body>
</html>
