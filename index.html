<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ Th√¥ng Minh</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, t·∫°o ƒëo·∫°n vƒÉn b·∫±ng AI.">
  <meta name="theme-color" content="#f59e0b">
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"HiHi - Luy·ªán Ch√≠nh T·∫£\",
    \"short_name\": \"HiHi\",
    \"start_url\": \".\",
    \"display\": \"standalone\",
    \"background_color\": \"#fff7ed\",
    \"theme_color\": \"#f59e0b\",
    \"icons\": [{\"src\": \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIyMCIgeT0iMzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI0MCIgcng9IjUiIGZpbGw9IiNmNTllMGIiLz48cGF0aCBkPSJNMjUgNDAgaDEwIHYyMCBoLTEwIHogTTQwIDQwIGgxMCB2MjAgaC0xMCB6IE01NSA0MCBoMTAgdjIwIGgtMTAgeiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik04NSAyMCBMOTAgNzAgTDk1IDIwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9zdmc+\",\"sizes\": \"192x192\", \"type\": \"image/svg+xml\"}]
  }">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIyMCIgeT0iMzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI0MCIgcng9IjUiIGZpbGw9IiNmNTllMGIiLz48cGF0aCBkPSJNMjUgNDAgaDEwIHYyMCBoLTEwIHogTTQwIDQwIGgxMCB2MjAgaC0xMCB6IE01NSA0MCBoMTAgdjIwIGgtMTAgeiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik04NSAyMCBMOTAgNzAgTDk1IDIwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9zdmc+">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD_aKqLS7EHEmwxpz4E-aI7YxNdHNIDSKg",
      authDomain: "chinhta-3c3fd.firebaseapp.com",
      databaseURL: "https://chinhta-3c3fd-default-rtdb.firebaseio.com",
      projectId: "chinhta-3c3fd",
      storageBucket: "chinhta-3c3fd.firebasestorage.app",
      messagingSenderId: "199247553396",
      appId: "1:199247553396:web:865372b95dcd5e895a8221",
      measurementId: "G-0FKB3C7XM6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.firebaseApp = app;
    window.db = db;
    window.auth = auth;
  </script>
  <style>
    :root {
      --bg: #fff7ed; --card: #ffffff; --text: #1e293b; --muted: #64748b; --border: #fed7aa;
      --primary: #f59e0b; --primary-light: #fbbf24; --success: #10b981; --danger: #ef4444;
      --hint: #8b5cf6; --translate: #3b82f6; --glass: rgba(255,255,255,0.9);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --radius: 16px; --gap: 16px;
      --karaoke: #f59e0b; --karaoke-bg: rgba(245,158,11,0.2);
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --muted: #94a3b8; --border: #334155;
      --glass: rgba(30,41,59,0.8); --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
      --karaoke-bg: rgba(245,158,11,0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Quicksand', sans-serif; }
    body { background: var(--bg); color: var(--text); min-height: 100vh; padding: 1rem; transition: all 0.3s ease; }
    .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: var(--gap); }
    header { background: var(--card); border-radius: var(--radius); padding: 1.5rem; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
    header::before { content: ''; position: absolute; top:0; left:0; right:0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
    .logo { display: flex; align-items: center; justify-content: center; gap: 1rem; }
    .logo svg { width: 48px; height: 48px; fill: var(--primary); }
    .logo h1 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; background: linear-gradient(90deg, var(--primary), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .tagline { color: var(--muted); font-size: 1rem; }
    .theme-toggle { position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--text); }
    .tabs { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .tab { padding: 0.75rem 1.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    .tab-content { display: none; background: var(--card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .tab-content.active { display: block; }
    .setup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--gap); }
    .setup-item { background: var(--glass); border-radius: var(--radius); padding: 1rem; border: 1px solid var(--border); }
    .setup-item h3 { font-size: 1.1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .setup-item h3 svg { width: 20px; height: 20px; fill: var(--primary); }
    select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); }
    .radio-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .radio-label { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .radio-label:hover { background: rgba(245,158,11,0.1); }
    .radio-label input { accent-color: var(--primary); }
    .ai-btn { margin-top: 0.5rem; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .start-btn { margin-top: 1rem; padding: 1rem; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content { background: var(--card); border-radius: var(--radius); padding: 1.5rem; width: 90%; max-width: 400px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
    .modal-close { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; }
    .modal h3 { text-align: center; margin-bottom: 1rem; color: var(--primary); }
    .modal-input { margin-bottom: 1rem; }
    .modal-input label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .modal-input input, .modal-input select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; }
    .generate-btn { width: 100%; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    #aiResult { margin-top: 1rem; padding: 1rem; background: var(--glass); border-radius: 8px; border: 1px solid var(--border); min-height: 60px; display: none; }
    .progress-box { background: var(--glass); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); }
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0; transition: width 0.3s; }
    .segment-box { background: var(--glass); padding: 1.5rem; border-radius: 12px; border: 2px dashed var(--border); font-size: 1.2rem; line-height: 1.6; text-align: center; min-height: 100px; }
    .karaoke-word { transition: all 0.2s; }
    .karaoke-active { background: var(--karaoke-bg); color: var(--karaoke); font-weight: bold; }
    .mic-box { text-align: center; }
    .mic-btn { padding: 1rem; background: var(--danger); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 1.5rem; margin: 0 auto; display: block; }
    .mic-btn.listening { background: var(--success); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 10px rgba(16,185,129,0); } 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); } }
    .full-translate { background: var(--glass); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); color: var(--translate); }
    .input-box input { width: 100%; padding: 1rem; font-size: 1.2rem; border: 1px solid var(--border); border-radius: 8px; }
    #liveFeedback { margin-top: 0.5rem; padding: 1rem; background: var(--glass); border-radius: 8px; border: 1px solid var(--border); min-height: 40px; }
    .action-row { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .action-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-replay { background: #f97316; color: white; }
    .btn-next { background: var(--primary); color: white; }
    .btn-reset { background: var(--danger); color: white; }
    .mode-switcher { display: flex; gap: 0.5rem; justify-content: center; }
    .mode-btn { padding: 0.5rem 1rem; background: var(--glass); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; }
    .mode-btn.active { background: var(--primary); color: white; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
    .stat-item { background: var(--glass); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
    .stat-item h4 { font-size: 0.9rem; color: var(--muted); }
    .stat-item .val { font-size: 1.5rem; color: var(--primary); }
    .level-badge { padding: 0.75rem 1.5rem; background: var(--primary); color: white; border-radius: 20px; font-weight: 700; text-align: center; }
    canvas { width: 100%; height: 300px; }
    .hidden { display: none; }
    .sub-tabs { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
    .sub-tab-btn { padding: 0.5rem 1rem; background: var(--glass); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; }
    .sub-tab-btn.active { background: var(--primary); color: white; }
    .rank-filter { display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .filter-btn { padding: 0.5rem 1rem; background: var(--glass); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .filter-btn.active { background: var(--primary); color: white; }
    .rank-table { width: 100%; border-collapse: collapse; }
    .rank-table th, .rank-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    .rank-table th { background: var(--primary); color: white; }
    .no-data { text-align: center; padding: 2rem; color: var(--muted); }
    .online-status { text-align: center; color: var(--muted); font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg viewBox="0 0 100 100">
          <rect x="20" y="30" width="60" height="40" rx="5" fill="currentColor" />
          <path d="M25 40 h10 v20 h-10 z M40 40 h10 v20 h-10 z M55 40 h10 v20 h-10 z" fill="#fff" />
          <path d="M85 20 L90 70 L95 20" stroke="#fff" stroke-width="5" stroke-linecap="round" />
        </svg>
        <h1>HiHi</h1>
      </div>
      <p class="tagline">Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, t·∫°o ƒëo·∫°n vƒÉn b·∫±ng AI.</p>
      <div class="top-controls">
        <span id="userInfo" class="user-info-display"></span>
        <button class="theme-toggle" id="themeBtn">
          <svg class="icon" viewBox="0 0 24 24" id="sunIcon"><path d="M12 2a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm0 16a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1zm8-7a1 1 0 0 1 0 2h-2a1 1 0 1 1 0-2h2zm-16 0a1 1 0 0 1 0 2H2a1 1 0 1 1 0-2h2zM5.64 5.64a1 1 0 0 1 1.42 0l1.41 1.41a1 1 0 1 1-1.42 1.42L5.64 6.06a1 1 0 0 1 0-1.42zm12.72 0a1 1 0 0 1 0 1.42l-1.41 1.41a1 1 0 1 1-1.42-1.42l1.41-1.41a1 1 0 0 1 1.42 0zM5.64 18.36a1 1 0 0 1 0-1.42l1.41-1.41a1 1 0 1 1 1.42 1.42l-1.41 1.41a1 1 0 0 1-1.42 0zm12.72 0a1 1 0 0 1-1.42 0l-1.41-1.41a1 1 0 1 1 1.42-1.42l1.41 1.41a1 1 0 0 1 0 1.42zM12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z"/></svg>
          <svg class="icon hidden" viewBox="0 0 24 24" id="moonIcon"><path d="M12 3a9 9 0 1 0 9 9c0-.23-.01-.46-.03-.69a1 1 0 0 0-1.26-.97 5.5 5.5 0 1 1-6.9-6.9 1 1 0 0 0-.97-1.26A8.96 8.96 0 0 0 12 3z"/></svg>
        </button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">X·∫øp H·∫°ng</button>
    </div>

    <div id="setupPanel" class="tab-content active">
      <div class="setup-grid">
        <div class="setup-item">
          <h3><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Ng√¥n ng·ªØ</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
          </select>
        </div>
        <div class="setup-item">
          <h3><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Ch·∫ø ƒë·ªô</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> Ch√©p ch√≠nh t·∫£</label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> Nghe ch√≠nh t·∫£</label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> Nghe-Ch√©p</label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> Luy·ªán ƒë·ªçc</label>
          </div>
        </div>
        <div class="setup-item" style="grid-column: 1/-1;">
          <h3><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg> ƒêo·∫°n vƒÉn</h3>
          <textarea id="sampleText" rows="4" placeholder="Nh·∫≠p ho·∫∑c t·∫°o b·∫±ng AI..."></textarea>
          <button class="ai-btn" id="openAiModal">T·∫°o b·∫±ng AI</button>
          <button class="start-btn" id="startBtn">B·∫Øt ƒë·∫ßu</button>
        </div>
      </div>
    </div>

    <div id="rankPanel" class="tab-content hidden">
      <div class="sub-tabs">
        <button class="sub-tab-btn active" data-subtab="globalRank">X·∫øp H·∫°ng Chung</button>
        <button class="sub-tab-btn" data-subtab="personalStats">Th·ªëng K√™ C√° Nh√¢n</button>
      </div>
      <div id="globalRank" class="sub-tab-content active">
        <div class="rank-filter">
          <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
          <button class="filter-btn" data-filter="day">H√¥m nay</button>
          <button class="filter-btn" data-filter="week">Tu·∫ßn</button>
          <button class="filter-btn" data-filter="month">Th√°ng</button>
          <button class="filter-btn" data-filter="year">NƒÉm</button>
        </div>
        <p class="online-status" id="onlineStatus">ƒêang t·∫£i...</p>
        <table class="rank-table">
          <thead><tr><th>STT</th><th>T√™n</th><th>Ng√†y</th><th>WPM</th><th>Ch√≠nh x√°c</th><th>ƒêi·ªÉm</th><th>Danh hi·ªáu</th></tr></thead>
          <tbody id="rankBody"></tbody>
        </table>
      </div>
      <div id="personalStats" class="sub-tab-content hidden">
        <div class="stats-row">
          <div class="stat-item"><h4>WPM Cao Nh·∫•t</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>ƒêi·ªÉm Cao Nh·∫•t</h4><div class="val" id="personalScore">0</div></div>
          <div class="stat-item"><h4>Danh hi·ªáu</h4><div class="val" id="personalBadge">Newbie</div></div>
        </div>
        <canvas id="personalChart"></canvas>
      </div>
    </div>

    <div class="modal" id="aiModal">
      <div class="modal-content">
        <button class="modal-close" id="closeAiModal">√ó</button>
        <h3>T·∫°o ƒêo·∫°n VƒÉn B·∫±ng AI</h3>
        <div class="modal-input"><label>Ch·ªß ƒë·ªÅ</label><input id="aiTopic" placeholder="V√≠ d·ª•: M√¥i tr∆∞·ªùng..."></div>
        <div class="modal-input"><label>S·ªë c√¢u</label><select id="aiSentences"><option value="3">3</option><option value="5" selected>5</option><option value="8">8</option></select></div>
        <div class="modal-input"><label>Gi·ªçng ƒë·ªçc</label><select id="aiVoice"></select><button class="btn-secondary" id="previewVoice">Nghe th·ª≠</button></div>
        <div class="modal-input"><label>T·ªëc ƒë·ªô</label><select id="aiRateSelect"><option value="0.75">Ch·∫≠m</option><option value="1" selected>Th∆∞·ªùng</option><option value="1.25">Nhanh</option></select></div>
        <button class="generate-btn" id="generateAiBtn">T·∫°o</button>
        <div id="aiResult"></div>
      </div>
    </div>

    <div class="modal" id="authModal">
      <div class="modal-content">
        <button class="modal-close" id="closeAuthModal">√ó</button>
        <h3 id="authTitle">ƒêƒÉng Nh·∫≠p / ƒêƒÉng K√Ω</h3>
        <div class="modal-input"><label>T√™n</label><input id="username" placeholder="T√™n ng∆∞·ªùi d√πng"></div>
        <div class="modal-input"><label>M·∫≠t kh·∫©u</label><input type="password" id="password" placeholder="M·∫≠t kh·∫©u"></div>
        <button class="generate-btn" id="loginBtn">ƒêƒÉng Nh·∫≠p</button>
        <button class="generate-btn" id="registerBtn">ƒêƒÉng K√Ω</button>
        <button class="btn-secondary" id="logoutBtn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
        <p id="authError" style="color:var(--danger); display:none;"></p>
      </div>
    </div>

    <div id="practiceArea" class="tab-content hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>
      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
          <span>Ti·∫øn ƒë·ªô</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      </div>
      <div id="currentSegment" class="segment-box"></div>
      <div id="micBox" class="mic-box hidden">
        <button id="micBtn" class="mic-btn">üé§</button>
        <p>Nh·∫•n ƒë·ªÉ ƒë·ªçc</p>
      </div>
      <div id="fullTranslate" class="full-translate hidden"><span id="fullText">D·ªãch: ...</span></div>
      <div class="input-box"><input id="userInput" placeholder="G√µ v√†o ƒë√¢y..."><button id="hintBtn" class="hint-btn">?</button></div>
      <div id="liveFeedback"></div>
      <div class="action-row">
        <button id="replayBtn" class="action-btn btn-replay">Nghe l·∫°i</button>
        <button id="nextBtn" class="action-btn btn-next" disabled>Ti·∫øp</button>
        <button id="resetBtn" class="action-btn btn-reset">Reset</button>
      </div>
      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>Danh hi·ªáu</h4><div class="val" id="level">Newbie</div></div>
      </div>
      <div class="level-badge" id="levelBadge">Newbie</div>
      <canvas id="mainChart"></canvas>
    </div>
  </div>
  <script>
    const els = {
      globalLang: document.getElementById('globalLang'),
      sampleText: document.getElementById('sampleText'),
      startBtn: document.getElementById('startBtn'),
      currentSegment: document.getElementById('currentSegment'),
      userInput: document.getElementById('userInput'),
      liveFeedback: document.getElementById('liveFeedback'),
      fullText: document.getElementById('fullText'),
      fullTranslate: document.getElementById('fullTranslate'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      accuracy: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      levelBadge: document.getElementById('levelBadge'),
      replayBtn: document.getElementById('replayBtn'),
      hintBtn: document.getElementById('hintBtn'),
      nextBtn: document.getElementById('nextBtn'),
      resetBtn: document.getElementById('resetBtn'),
      themeBtn: document.getElementById('themeBtn'),
      sunIcon: document.getElementById('sunIcon'),
      moonIcon: document.getElementById('moonIcon'),
      aiModal: document.getElementById('aiModal'),
      openAiModal: document.getElementById('openAiModal'),
      closeAiModal: document.getElementById('closeAiModal'),
      aiTopic: document.getElementById('aiTopic'),
      aiSentences: document.getElementById('aiSentences'),
      aiVoice: document.getElementById('aiVoice'),
      previewVoice: document.getElementById('previewVoice'),
      generateAiBtn: document.getElementById('generateAiBtn'),
      aiResult: document.getElementById('aiResult'),
      aiRateSelect: document.getElementById('aiRateSelect'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      rankBody: document.getElementById('rankBody'),
      onlineStatus: document.getElementById('onlineStatus'),
      personalWPM: document.getElementById('personalWPM'),
      personalAcc: document.getElementById('personalAcc'),
      personalScore: document.getElementById('personalScore'),
      personalBadge: document.getElementById('personalBadge'),
      mainChart: document.getElementById('mainChart'),
      personalChart: document.getElementById('personalChart'),
      authModal: document.getElementById('authModal'),
      authTitle: document.getElementById('authTitle'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      registerBtn: document.getElementById('registerBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      authError: document.getElementById('authError'),
      closeAuthModal: document.getElementById('closeAuthModal'),
      userInfo: document.getElementById('userInfo')
    };

    const GROQ_KEY = "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"; // Thay b·∫±ng key th·ª±c
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [], selectedVoice = null;
    let segments = [], currentIdx = 0, startTime, timer;
    let typedWords = 0, correctWords = 0, totalCorrectWords = 0, hintsUsed = 0;
    let onlineHistory = [], personalHistory = [], bestStats = null;
    let mainChart, personalChart;
    let speechRate = 1.0, currentMode = 'read-write';
    let recognition = null, isListening = false;
    let karaokeWords = [];
    let playerName = '', isLoggedIn = false;

    // Theme Toggle
    els.themeBtn.addEventListener('click', () => {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      els.sunIcon.classList.toggle('hidden', !isDark);
      els.moonIcon.classList.toggle('hidden', isDark);
    });
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    els.sunIcon.classList.toggle('hidden', savedTheme === 'dark');
    els.moonIcon.classList.toggle('hidden', savedTheme !== 'dark');

    // Tabs Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'rankPanel') {
          loadOnlineRank();
          loadPersonalStats();
        } else if (!isLoggedIn) {
          els.authModal.classList.add('show');
        }
      });
    });

    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sub-tab-btn').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(btn.dataset.subtab).classList.add('active');
      });
    });

    // Load Voices
    function loadVoices() {
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(globalLang.split('-')[0]));
      els.aiVoice.innerHTML = voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
      selectedVoice = voices[0];
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 100);

    els.aiVoice.addEventListener('change', () => selectedVoice = voices.find(v => v.name === els.aiVoice.value));

    // Speak Function
    function speak(text, onBoundary) {
      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = selectedVoice;
      utterance.rate = speechRate;
      utterance.lang = globalLang;
      if (onBoundary) utterance.onboundary = onBoundary;
      speechSynthesis.speak(utterance);
    }

    els.previewVoice.addEventListener('click', () => speak('Xin ch√†o, ƒë√¢y l√† th·ª≠ nghi·ªám gi·ªçng n√≥i.'));

    // AI Generate
    els.generateAiBtn.addEventListener('click', async () => {
      const topic = els.aiTopic.value.trim() || 'ch·ªß ƒë·ªÅ ng·∫´u nhi√™n';
      const sentences = els.aiSentences.value;
      const langName = globalLang === 'vi-VN' ? 'Ti·∫øng Vi·ªát' : globalLang === 'en-US' ? 'Ti·∫øng Anh' : 'Ti·∫øng Indonesia';
      const prompt = `Vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn b·∫±ng ${langName} g·ªìm ${sentences} c√¢u v·ªÅ "${topic}". Ch·ªâ tr·∫£ v·ªÅ ƒëo·∫°n vƒÉn.`;
      try {
        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${GROQ_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: prompt }] })
        });
        const data = await res.json();
        els.sampleText.value = data.choices[0].message.content.trim();
        els.aiModal.classList.remove('show');
      } catch (err) { alert('L·ªói t·∫°o vƒÉn b·∫£n!'); }
    });

    // Translate
    async function translateFull(text) {
      if (globalLang === 'vi-VN') return '';
      const src = globalLang.split('-')[0];
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText;
      } catch { return 'L·ªói d·ªãch'; }
    }

    // Show Segment
    async function showSegment() {
      const text = segments[currentIdx];
      els.nextBtn.disabled = true;
      els.userInput.value = '';
      els.liveFeedback.innerHTML = '';
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      els.userInput.parentElement.classList.toggle('hidden', currentMode === 'read-only');

      if (globalLang === 'vi-VN') {
        els.fullTranslate.classList.add('hidden');
      } else {
        els.fullTranslate.classList.remove('hidden');
        els.fullText.textContent = await translateFull(text);
      }

      let html = '';
      karaokeWords = text.split(/\s+/).map(word => {
        html += `<span class="karaoke-word">${word}</span> `;
        return word;
      });
      els.currentSegment.innerHTML = html.trim();

      if (currentMode.includes('listen')) speak(text, e => {
        if (e.name === 'word') {
          const words = document.querySelectorAll('.karaoke-word');
          words.forEach(w => w.classList.remove('karaoke-active'));
          words[e.charIndex / text.length * karaokeWords.length | 0].classList.add('karaoke-active');
        }
      });
    }

    // Update Feedback
    els.userInput.addEventListener('input', () => {
      const target = segments[currentIdx].toLowerCase().split(/\s+/);
      const input = els.userInput.value.toLowerCase().split(/\s+/);
      let feedback = '';
      correctWords = 0;
      input.forEach((w, i) => {
        if (i < target.length && w === target[i]) {
          feedback += `<span class="correct">${w}</span> `;
          correctWords++;
        } else {
          feedback += `<span class="wrong">${w}</span> `;
        }
      });
      els.liveFeedback.innerHTML = feedback;
      if (correctWords === target.length && input.length === target.length) els.nextBtn.disabled = false;
    });

    // Next
    els.nextBtn.addEventListener('click', () => {
      totalCorrectWords += correctWords;
      typedWords += segments[currentIdx].split(/\s+/).length;
      currentIdx++;
      els.progressFill.style.width = `${(currentIdx / segments.length) * 100}%`;
      els.progressText.textContent = `${Math.round((currentIdx / segments.length) * 100)}%`;
      if (currentIdx >= segments.length) end();
      else showSegment();
    });

    // Stats
    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = `${s}s`;
      const min = s / 60;
      els.wpm.textContent = min > 0 ? Math.round(typedWords / min) : 0;
      els.accuracy.textContent = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) + '%' : '100%';
    }

    // End
    function end() {
      clearInterval(timer);
      const min = (Date.now() - startTime) / 60000;
      const wpm = min > 0 ? Math.round(typedWords / min) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 30 ? 'Newbie' : wpm < 60 ? 'Apprentice' : wpm < 100 ? 'Expert' : 'Master';
      els.level.textContent = badge;
      els.levelBadge.textContent = badge;
      db.ref('rankings').push({ name: playerName, date: new Date().toISOString(), wpm, acc, score, badge });
      loadOnlineRank();
      loadPersonalStats();
      alert(`Ho√†n th√†nh!\nWPM: ${wpm}\nCh√≠nh x√°c: ${acc}%\nƒêi·ªÉm: ${score}\nDanh hi·ªáu: ${badge}`);
      document.getElementById('practiceArea').classList.remove('active');
      document.getElementById('setupPanel').classList.add('active');
    }

    // Load Rankings
    async function loadOnlineRank() {
      const snapshot = await db.ref('rankings').once('value');
      onlineHistory = Object.values(snapshot.val() || {}).sort((a,b) => b.score - a.score);
      els.onlineStatus.textContent = `ƒê√£ t·∫£i ${onlineHistory.length} k·∫øt qu·∫£`;
      renderRankTable();
    }

    // Render Rank
    function renderRankTable(filter = 'all') {
      const now = new Date();
      const filtered = onlineHistory.filter(h => {
        const d = new Date(h.date);
        if (filter === 'day') return d.toDateString() === now.toDateString();
        if (filter === 'week') return d > new Date(now - 7*86400000);
        if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        if (filter === 'year') return d.getFullYear() === now.getFullYear();
        return true;
      });
      let html = '';
      filtered.forEach((h, i) => {
        html += `<tr><td>${i+1}</td><td>${h.name}</td><td>${new Date(h.date).toLocaleDateString()}</td><td>${h.wpm}</td><td>${h.acc}%</td><td>${h.score}</td><td>${h.badge}</td></tr>`;
      });
      els.rankBody.innerHTML = html || '<tr><td colspan="7" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
    }

    document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => renderRankTable(btn.dataset.filter)));

    // Personal Stats
    async function loadPersonalStats() {
      const snapshot = await db.ref('rankings').orderByChild('name').equalTo(playerName).once('value');
      personalHistory = Object.values(snapshot.val() || {}).sort((a,b) => b.score - a.score);
      bestStats = personalHistory[0] || { wpm: 0, acc: 0, score: 0, badge: 'Newbie' };
      els.personalWPM.textContent = bestStats.wpm;
      els.personalAcc.textContent = `${bestStats.acc}%`;
      els.personalScore.textContent = bestStats.score;
      els.personalBadge.textContent = bestStats.badge;
      const ctx = els.personalChart.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: personalHistory.map((_,i) => `L·∫ßn ${i+1}`),
          datasets: [{ label: 'WPM', data: personalHistory.map(h=>h.wpm), borderColor: var(--primary) }]
        },
        options: { responsive: true }
      });
    }

    // Auth
    els.loginBtn.addEventListener('click', () => {
      auth.signInWithEmailAndPassword(els.username.value, els.password.value).then(user => {
        playerName = user.user.email;
        isLoggedIn = true;
        els.userInfo.textContent = playerName;
        els.userInfo.style.display = 'block';
        els.logoutBtn.style.display = 'block';
        els.loginBtn.style.display = 'none';
        els.registerBtn.style.display = 'none';
        els.authTitle.textContent = 'ƒêƒÉng Xu·∫•t';
        els.authModal.classList.remove('show');
        loadPersonalStats();
      }).catch(err => els.authError.textContent = err.message);
    });

    els.registerBtn.addEventListener('click', () => {
      auth.createUserWithEmailAndPassword(els.username.value, els.password.value).then(user => {
        playerName = user.user.email;
        isLoggedIn = true;
        els.userInfo.textContent = playerName;
        els.userInfo.style.display = 'block';
        els.logoutBtn.style.display = 'block';
        els.loginBtn.style.display = 'none';
        els.registerBtn.style.display = 'none';
        els.authTitle.textContent = 'ƒêƒÉng Xu·∫•t';
        els.authModal.classList.remove('show');
        loadPersonalStats();
      }).catch(err => els.authError.textContent = err.message);
    });

    els.logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        isLoggedIn = false;
        playerName = '';
        els.userInfo.style.display = 'none';
        els.logoutBtn.style.display = 'none';
        els.loginBtn.style.display = 'block';
        els.registerBtn.style.display = 'block';
        els.authTitle.textContent = 'ƒêƒÉng Nh·∫≠p / ƒêƒÉng K√Ω';
        els.authModal.classList.remove('show');
      });
    });

    els.closeAiModal.addEventListener('click', () => els.aiModal.classList.remove('show'));
    els.closeAuthModal.addEventListener('click', () => els.authModal.classList.remove('show'));

    // Start
    els.startBtn.addEventListener('click', () => {
      if (!isLoggedIn) return els.authModal.classList.add('show');
      segments = els.sampleText.value.trim().split(/[\n.?!]+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Nh·∫≠p vƒÉn b·∫£n!');
      currentIdx = 0;
      typedWords = correctWords = totalCorrectWords = hintsUsed = 0;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.aiRateSelect.value);
      startTime = Date.now();
      timer = setInterval(updateStats, 1000);
      document.getElementById('setupPanel').classList.remove('active');
      document.getElementById('practiceArea').classList.add('active');
      showSegment();
    });

    // Init Speech Recognition
    let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = e => {
        const transcript = e.results[0][0].transcript.trim().toLowerCase();
        els.liveFeedback.innerHTML = transcript;
        if (transcript === segments[currentIdx].toLowerCase()) els.nextBtn.disabled = false;
      };
      recognition.onend = () => els.micBtn.classList.remove('listening');
    }

    els.micBtn.addEventListener('click', () => {
      if (recognition) {
        recognition.lang = globalLang;
        recognition.start();
        els.micBtn.classList.add('listening');
      }
    });

    els.hintBtn.addEventListener('click', () => {
      const words = segments[currentIdx].split(/\s+/);
      const typed = els.userInput.value.split(/\s+/);
      if (typed.length < words.length) {
        els.userInput.value += words[typed.length] + ' ';
        els.userInput.dispatchEvent(new Event('input'));
        hintsUsed++;
      }
    });

    els.replayBtn.addEventListener('click', () => speak(segments[currentIdx]));

    els.resetBtn.addEventListener('click', () => {
      clearInterval(timer);
      document.getElementById('practiceArea').classList.remove('active');
      document.getElementById('setupPanel').classList.add('active');
    });

    document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.dataset.mode;
      showSegment();
    }));

    els.globalLang.value = globalLang;
    els.globalLang.addEventListener('change', () => {
      globalLang = els.globalLang.value;
      localStorage.setItem('lang', globalLang);
      location.reload();
    });

    // Load on start
    auth.onAuthStateChanged(user => {
      if (user) {
        playerName = user.email;
        isLoggedIn = true;
        els.userInfo.textContent = playerName;
        els.userInfo.style.display = 'block';
        els.logoutBtn.style.display = 'block';
        els.loginBtn.style.display = 'none';
        els.registerBtn.style.display = 'none';
        els.authTitle.textContent = 'ƒêƒÉng Xu·∫•t';
        loadPersonalStats();
      } else {
        els.authModal.classList.add('show');
      }
    });
  </script>
</body>
</html>
