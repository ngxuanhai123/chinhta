<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HiHi Sync - Luy·ªán Ch√≠nh T·∫£ Pro</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, b·∫£ng x·∫øp h·∫°ng online.">
  <meta name="theme-color" content="#0f172a">
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* --- M√ÄU S·∫ÆC T·ª™ FILE T·ª™ V·ª∞NG --- */
      --glass-bg: rgba(255, 255, 255, 0.15);
      --glass-border: rgba(255, 255, 255, 0.3);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      --accent-color: #00d2ff;
      --success-color: #00e676;
      --error-color: #ff5252;
      --text-color: #ffffff;
      --radius: 28px;
      --font-main: 'Poppins', sans-serif;
      
      /* Mapping variables for Chinh Ta logic */
      --primary: #00d2ff;
      --primary-gradient: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
      --primary-shadow: rgba(0, 210, 255, 0.4);
      --bg-gradient: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      
      --text: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.7);
      --glass-surface: var(--glass-bg);
      --warning: #fbbf24;
      --info: #60a5fa;
    }

    /* Light Mode overrides (Gi·ªØ l·∫°i logic light mode c·ªßa file c≈© nh∆∞ng ch·ªânh m√†u cho h·ª£p style m·ªõi) */
    [data-theme="light"] {
      --bg-gradient: linear-gradient(-45deg, #f1f5f9, #e2e8f0, #cbd5e1, #f8fafc); 
      --text: #1e293b;
      --text-dim: #475569;
      --glass-surface: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(255, 255, 255, 0.6);
      --primary: #0284c7;
    }

    /* Holiday Mode */
    [data-theme*="holiday"] {
      --bg-gradient: linear-gradient(-45deg, #020617, #14532d, #7f1d1d, #020617);
      --primary: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--font-main);
      background: #0f172a;
      color: var(--text-color);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 80px;
      overflow-x: hidden;
      position: relative;
    }

    /* --- AURORA BACKGROUND (Gi·ªëng T·ª´ V·ª±ng) --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      opacity: 0.8;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* PARTICLES */
    .particle {
      position: absolute; border-radius: 50%; background: white;
      opacity: 0.3; animation: floatUp linear infinite; z-index: -1;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      50% { opacity: 0.5; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }
    
    /* SNOWFLAKES */
    .snowflake {
      position: fixed; top: -20px; z-index: 9999; color: #fff;
      font-size: 1em; opacity: 0.8; pointer-events: none;
      user-select: none; animation: fall linear forwards;
      text-shadow: 0 0 5px rgba(255,255,255,0.8);
    }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* --- COMMON COMPONENTS --- */
    .container {
      max-width: 900px; margin: 0 auto;
      position: relative; z-index: 10;
      padding-top: 20px;
      display: flex; flex-direction: column; gap: 24px;
    }

    /* Glass Card Style (Updated to match Tu Vung) */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      padding: 30px;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .glass-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.5); }

    /* Header */
    header { text-align: center; margin-bottom: 10px; }
    .logo h1 {
      font-size: 2.5rem; font-weight: 800; margin-bottom: 5px; letter-spacing: -1px;
      color: white; text-shadow: 0 0 10px rgba(255,255,255,0.5), 0 0 20px rgba(0, 210, 255, 0.5);
      display: inline-block;
    }
    .tagline { opacity: 0.8; font-size: 0.9rem; font-weight: 600; }

    /* Buttons */
    .start-btn, .action-btn {
      position: relative; overflow: hidden;
      border: none;
      background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
      border: 1px solid rgba(255,255,255,0.5);
      color: white; font-weight: 800;
      padding: 18px 28px; border-radius: 20px;
      cursor: pointer; width: 100%;
      font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1.5px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: all 0.2s;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .start-btn:active, .action-btn:active { transform: scale(0.96); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .start-btn:hover, .action-btn:hover { border-color: white; background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 100%); }

    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: rgba(255,255,255,0.1); color: white;
      border: 1px solid rgba(255,255,255,0.3); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(15deg); }

    /* Inputs */
    select, textarea, input[type="text"] {
      width: 100%; padding: 16px; border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(0,0,0,0.3); color: white;
      font-size: 1rem; margin-bottom: 15px; font-family: var(--font-main);
      transition: 0.3s;
    }
    [data-theme="light"] select, [data-theme="light"] textarea, [data-theme="light"] input[type="text"] {
        color: #333; background: rgba(255,255,255,0.6);
    }
    select:focus, textarea:focus, input[type="text"]:focus { 
        background: rgba(0,0,0,0.5); border-color: #fff; 
    }

    /* Tabs */
    .tabs {
        display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;
        background: rgba(0,0,0,0.2); padding: 5px; border-radius: 30px; width: fit-content; margin: 0 auto 20px auto;
    }
    .tab {
        padding: 10px 25px; border-radius: 25px; border: none; background: transparent;
        color: rgba(255,255,255,0.6); font-weight: 700; cursor: pointer; transition: 0.3s;
        font-family: var(--font-main);
    }
    .tab.active { background: white; color: #0f172a; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    /* Specific Elements */
    .setup-grid { display: grid; gap: 20px; }
    .setup-item { margin-bottom: 10px; }
    .setup-item h3 { font-size: 1rem; color: var(--accent-color); margin-bottom: 10px; text-transform: uppercase; font-weight: 700; }

    .radio-group { display: flex; flex-direction: column; gap: 8px; }
    .radio-label {
        display: flex; align-items: center; gap: 10px; padding: 12px;
        background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer;
        border: 1px solid transparent; transition: 0.2s;
    }
    .radio-label:hover { background: rgba(255,255,255,0.1); }
    .radio-label:has(input:checked) { border-color: var(--accent-color); background: rgba(0, 210, 255, 0.1); }
    input[type="radio"] { accent-color: var(--accent-color); width: 18px; height: 18px; }

    /* Practice Area */
    .mode-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .mode-btn {
        padding: 8px 20px; border-radius: 20px; background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7);
        cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    .mode-btn.active { background: var(--accent-color); color: #0f172a; border-color: var(--accent-color); }

    .segment-box {
        font-size: 1.6rem; line-height: 1.6; text-align: center;
        min-height: 140px; padding: 30px;
        background: rgba(0,0,0,0.3); border-radius: 20px;
        border: 1px solid var(--glass-border); margin-bottom: 24px;
        display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 6px;
    }
    [data-theme="light"] .segment-box { color: #333; background: rgba(255,255,255,0.5); }

    .karaoke-word { padding: 4px 8px; border-radius: 8px; transition: 0.2s; }
    .karaoke-active { background: var(--accent-color); color: #0f172a; font-weight: 800; transform: scale(1.1); box-shadow: 0 0 15px var(--accent-color); }

    #userInput { font-size: 1.3rem; padding: 20px; background: rgba(0,0,0,0.4); border: 2px solid var(--glass-border); }
    
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 30px; }
    .stat-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--glass-border); }
    .stat-item h4 { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; margin-bottom: 5px; }
    .stat-item .val { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }

    /* Feedback text */
    .correct { color: var(--success-color); font-weight: 700; }
    .wrong { color: var(--error-color); text-decoration: line-through; opacity: 0.7; }
    
    /* Leaderboard */
    .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: white; }
    [data-theme="light"] .leaderboard-table { color: #333; }
    .leaderboard-table th { text-align: left; padding: 15px; opacity: 0.7; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; text-transform: uppercase; }
    .leaderboard-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 600; }
    
    .rank-num { font-size: 1.2rem; font-weight: 800; color: #ffd700; }
    .lb-user { display: flex; align-items: center; gap: 10px; }
    .lb-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; object-fit: cover; }

    /* Modal */
    .modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
        z-index: 2000; display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
        background: #1e293b; border: 1px solid rgba(255,255,255,0.2);
        padding: 40px; border-radius: 30px; width: 90%; max-width: 400px;
        text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); color: white;
    }
    .btn-google {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        background: white; color: #333; width: 100%; padding: 12px;
        border-radius: 30px; border: none; font-weight: 700; cursor: pointer;
        margin: 20px 0; font-family: var(--font-main);
    }
    
    /* Mic Button */
    .mic-btn {
        width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 20px;
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
        font-size: 2rem; display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.3s; color: white;
    }
    .mic-btn.listening { background: var(--error-color); animation: pulse 1.5s infinite; border-color: transparent; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    .hidden { display: none !important; }
    
    /* User Info Top */
    .user-info-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .user-avatar-top { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--accent-color); }
    .user-name-top { font-weight: 700; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    /* Tooltip */
    .word-tooltip {
        position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
        background: #0f172a; color: var(--accent-color); padding: 5px 10px; border-radius: 8px;
        border: 1px solid var(--accent-color); font-size: 0.8rem; pointer-events: none;
        white-space: nowrap; opacity: 0; transition: 0.2s; z-index: 100;
    }
    .karaoke-word { position: relative; }
    .karaoke-word:hover .word-tooltip { opacity: 1; bottom: 110%; }

    @media (max-width: 600px) {
        .logo h1 { font-size: 1.8rem; }
        .stats-row { grid-template-columns: 1fr 1fr; }
        .tabs { width: 100%; }
        .tab { padding: 8px 15px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>

  <div class="aurora-bg"></div>
  <div id="particles"></div>

  <div class="container">
    
    <div style="position: absolute; top: 0; right: 0; display: flex; gap: 10px; z-index: 20;">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t" style="background: rgba(255, 82, 82, 0.2); border-color: rgba(255, 82, 82, 0.5);">üö™</button>
        </div>
    </div>

    <header class="animate__animated animate__fadeInDown">
      <div class="logo">
        <h1>HiHi Sync</h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & Ngo·∫°i ng·ªØ ‚Ä¢ ƒêua top Realtime ‚ú®</p>
    </header>

    <div class="user-info-bar animate__animated animate__fadeIn">
        <img id="userAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" class="user-avatar-top" alt="User">
        <span class="user-name-top" id="playerNameDisplay">Kh√°ch (Ch∆∞a ƒëƒÉng nh·∫≠p)</span>
    </div>

    <div class="tabs animate__animated animate__fadeInUp">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™ & BXH</button>
    </div>

    <div id="setupPanel" class="tab-content glass-card animate__animated animate__fadeIn">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ luy·ªán</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
            <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
            <option value="it-IT">Ti·∫øng √ù</option>
            <option value="la-VA">Ti·∫øng Latin</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:10px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                    <option value="1.50">1.50x (R·∫•t nhanh)</option>
                  </select>
                  <button id="previewVoice" class="action-btn" style="width:auto; padding:0 20px; font-size:0.9rem;"><i class="fas fa-volume-up"></i></button>
             </div>
          </div>
        </div>

        <div class="setup-item">
          <h3>
            <span>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</span>
          </h3>
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button id="randomTextBtn" class="action-btn" style="background: rgba(192, 132, 252, 0.3); border-color:rgba(192, 132, 252, 0.5); font-size:0.8rem; padding:10px;">üé≤ L·∫•y b√†i m·∫´u ng·∫´u nhi√™n</button>
            <button id="resetTextBtn" class="action-btn" style="background: rgba(34, 211, 238, 0.3); border-color:rgba(34, 211, 238, 0.5); font-size:0.8rem; padding:10px; display:none;">üîÑ X√≥a</button>
          </div>
          <textarea id="sampleText" rows="6" spellcheck="false" placeholder="Nh·∫•n n√∫t 'L·∫•y b√†i m·∫´u' ho·∫∑c t·ª± nh·∫≠p vƒÉn b·∫£n c·ªßa b·∫°n..."></textarea>
        </div>

        <button class="start-btn" id="startBtn">
          <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden animate__animated animate__fadeIn">
        <h2 style="text-align:center; margin-bottom: 5px; text-transform:uppercase; letter-spacing:1px; color:var(--accent-color);">
             Th√†nh T√≠ch Th√°ng <span id="currentMonthDisplay">...</span>
        </h2>
        <div style="text-align:center; opacity:0.6; font-size:0.8rem; margin-bottom:20px;">
            (Reset v√†o ng√†y 1 h√†ng th√°ng)
        </div>

        <div id="personalStats">
          <div class="stats-row" id="personalStatsRow">
            <div class="stat-item"><h4>WPM (Max)</h4><div class="val" id="personalWPM">0</div></div>
            <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
            <div class="stat-item"><h4>T·ªïng c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
            <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="personalScore">0</div></div>
          </div>
          <div style="text-align:center; margin-top:20px;">
              <span style="display:inline-block; padding:5px 15px; background:rgba(255,255,255,0.1); border-radius:20px; border:1px solid rgba(255,255,255,0.2); font-weight:700;" id="personalBadge">T√¢n binh</span>
          </div>
        </div>

        <h3 style="text-align:center; color:#fbbf24; margin-top: 40px; margin-bottom:15px;"><i class="fas fa-crown"></i> B·∫£ng X·∫øp H·∫°ng</h3>
        <div id="loadingLeaderboard" style="text-align:center; padding:20px; opacity:0.7;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>
        
        <div style="overflow-x:auto;">
            <table class="leaderboard-table" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Th√†nh vi√™n</th>
                        <th>WPM</th>
                        <th>Acc</th>
                        <th>ƒêi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden animate__animated animate__zoomIn">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc (Mic)</button>
      </div>

      <div style="margin-bottom: 20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600; font-size:0.8rem; opacity:0.8;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
            <div id="progressFill" style="height: 100%; width: 0; background: var(--accent-color); transition: width 0.3s;"></div>
        </div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn"><i class="fas fa-microphone"></i></button>
        <p style="text-align:center; opacity:0.7; font-size:0.9rem;">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px; font-size:0.9rem;"></div>

      <div style="position: relative; margin-bottom: 20px;">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button id="hintBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-65%); background: rgba(255,255,255,0.1); border:none; color:white; width:30px; height:30px; border-radius:8px; cursor:pointer;"><i class="fas fa-lightbulb"></i></button>
      </div>

      <div id="liveFeedback" style="text-align:center; min-height:30px; font-family: 'Courier New', monospace;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div style="display:flex; gap:15px; justify-content:center; margin-top:20px; flex-wrap:wrap;">
        <button class="action-btn" id="replayBtn" style="width:auto;"><i class="fas fa-volume-up"></i> Nghe l·∫°i</button>
        <button class="action-btn" id="nextBtn" disabled style="width:auto; background: var(--success-color); border-color:var(--success-color);">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
        <button class="action-btn" id="resetBtn" style="width:auto; background:transparent; border-color:rgba(255,255,255,0.3);">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center; margin-top:20px;">
        <div id="levelBadge" style="font-size:0.9rem; opacity:0.8; font-weight:600;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
        <div id="level" class="hidden"></div> 
      </div>
      <canvas id="mainChart" class="hidden"></canvas>
    </div>

    <footer style="text-align:center; margin-top:20px; color:rgba(255,255,255,0.5); font-size:0.8rem;">
        HiHi Sync <i class="fas fa-heart" style="color:#ff5252"></i> by Ngxuanhai123
    </footer>
  </div>

  <div class="modal" id="loginModal">
      <div class="modal-content animate__animated animate__fadeInUp">
        <h3 style="font-size:1.5rem; margin-bottom:10px;">Xin ch√†o! üëã</h3>
        <p style="opacity:0.7; margin-bottom:20px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† ƒëua top server.</p>
        
        <button id="googleLoginBtn" class="btn-google">
           <i class="fab fa-google" style="color:#DB4437"></i> ƒêƒÉng nh·∫≠p v·ªõi Google
        </button>

        <div style="position:relative; margin: 20px 0;">
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1);">
            <span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#1e293b; padding:0 10px; font-size:0.8rem; opacity:0.6;">Ho·∫∑c</span>
        </div>

        <input type="text" id="usernameInput" placeholder="Nh·∫≠p t√™n kh√°ch..." maxlength="20" style="text-align:center; background: rgba(0,0,0,0.2);" />
        
        <button class="action-btn" id="skipLoginBtn" style="background:transparent; border:1px solid rgba(255,255,255,0.2);">Ch∆°i ngay (Kh√¥ng l∆∞u)</button>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDtaVYb_72YvoGzvcERJZypUGS-u3skz2M",
      authDomain: "tuvung-88e8d.firebaseapp.com",
      databaseURL: "https://tuvung-88e8d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tuvung-88e8d",
      storageBucket: "tuvung-88e8d.firebasestorage.app",
      messagingSenderId: "722559465686",
      appId: "1:722559465686:web:bae1a77791205d372db177",
      measurementId: "G-T785TQ3V32"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // --- GLOBAL VARIABLES CHO APP ---
    window.currentUser = null; 
    
    // Helper to get Year-Month key for resetting leaderboard
    function getMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }
    
    document.getElementById('currentMonthDisplay').textContent = getMonthKey();

    // UI Elements for Auth
    const loginModal = document.getElementById('loginModal');
    const googleBtn = document.getElementById('googleLoginBtn');
    const skipBtn = document.getElementById('skipLoginBtn');
    const guestInput = document.getElementById('usernameInput');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutWrapper = document.getElementById('logoutBtnWrapper');
    const userAvatar = document.getElementById('userAvatar');
    const nameDisplay = document.getElementById('playerNameDisplay');
    const lbBody = document.getElementById('leaderboardBody');
    const loadingLb = document.getElementById('loadingLeaderboard');

    // Stats Elements
    const pWPM = document.getElementById('personalWPM');
    const pAcc = document.getElementById('personalAcc');
    const pScore = document.getElementById('personalScore');
    const pSent = document.getElementById('personalSentences');
    const pBadge = document.getElementById('personalBadge');

    // --- AUTH LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUser = {
                uid: user.uid,
                name: user.displayName,
                photo: user.photoURL,
                isAnonymous: false
            };
            updateUserUI(window.currentUser);
            loginModal.classList.remove('show');
            initRealtimeSync(window.currentUser.uid); // B·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu c√° nh√¢n
            loadLeaderboard();
        } else {
            const guest = localStorage.getItem('hihiGuest');
            if (guest) {
                window.currentUser = JSON.parse(guest);
                updateUserUI(window.currentUser);
                loginModal.classList.remove('show');
                loadLeaderboard();
            } else {
                window.currentUser = null;
                updateUserUI(null);
                loginModal.classList.add('show');
            }
        }
    });

    googleBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider)
            .then((result) => {
                localStorage.removeItem('hihiGuest');
            }).catch((error) => {
                alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            });
    });

    skipBtn.addEventListener('click', () => {
        const name = guestInput.value.trim() || "Kh√°ch ·∫®n Danh";
        const guestUser = {
            uid: 'guest_' + Date.now(),
            name: name,
            photo: null,
            isAnonymous: true
        };
        localStorage.setItem('hihiGuest', JSON.stringify(guestUser));
        window.currentUser = guestUser;
        updateUserUI(guestUser);
        loginModal.classList.remove('show');
        loadLeaderboard();
    });

    logoutBtn.addEventListener('click', () => {
        if (auth.currentUser) {
            signOut(auth).then(() => window.location.reload());
        } else {
            localStorage.removeItem('hihiGuest');
            window.location.reload();
        }
    });

    function updateUserUI(user) {
        if (user) {
            nameDisplay.textContent = user.name;
            if (user.photo) userAvatar.src = user.photo;
            logoutWrapper.classList.remove('hidden');
        } else {
            nameDisplay.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
            logoutWrapper.classList.add('hidden');
        }
    }

    // --- REALTIME SYNC LOGIC ---

    // 1. L·∫Øng nghe thay ƒë·ªïi c·ªßa ch√≠nh m√¨nh (ƒë·ªÉ c·∫≠p nh·∫≠t UI real-time)
    function initRealtimeSync(uid) {
        const monthKey = getMonthKey();
        const myStatsRef = ref(db, `leaderboard/${monthKey}/${uid}`);
        
        onValue(myStatsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                pWPM.textContent = data.wpm || 0;
                pAcc.textContent = (data.acc || 0) + '%';
                pScore.textContent = data.score || 0;
                pSent.textContent = data.sentences || 0;
                
                // T√≠nh badge d·ª±a tr√™n WPM max
                const wpm = data.wpm || 0;
                const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";
                pBadge.textContent = badge;
            }
        });
    }

    // 2. H√†m l∆∞u ƒëi·ªÉm (C·ªòNG D·ªíN ƒêI·ªÇM + RESET TH√ÅNG)
    window.saveScoreToFirebase = function(gameData) {
        if (!window.currentUser || window.currentUser.isAnonymous) return;
        
        const user = window.currentUser;
        const monthKey = getMonthKey();
        const userScoreRef = ref(db, `leaderboard/${monthKey}/${user.uid}`);

        // D√πng Transaction ƒë·ªÉ c·ªông d·ªìn ƒëi·ªÉm an to√†n
        runTransaction(userScoreRef, (currentData) => {
            if (currentData === null) {
                // Ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†y -> T·∫°o m·ªõi
                return {
                    name: user.name,
                    photo: user.photo,
                    score: gameData.score,        // ƒêi·ªÉm l·∫ßn n√†y
                    sentences: gameData.sentences, // S·ªë c√¢u l·∫ßn n√†y
                    wpm: gameData.wpm,            // WPM l·∫ßn n√†y
                    acc: gameData.acc,            // Acc l·∫ßn n√†y
                    lastPlayed: Date.now()
                };
            } else {
                // ƒê√£ c√≥ d·ªØ li·ªáu -> C·ªông d·ªìn Score & Sentence, l·∫•y Max WPM & Acc
                return {
                    name: user.name,
                    photo: user.photo,
                    score: (currentData.score || 0) + gameData.score,         // C·ªông d·ªìn ƒëi·ªÉm
                    sentences: (currentData.sentences || 0) + gameData.sentences, // C·ªông d·ªìn s·ªë c√¢u
                    wpm: Math.max(currentData.wpm || 0, gameData.wpm),        // L·∫•y Max WPM
                    acc: Math.max(currentData.acc || 0, gameData.acc),        // L·∫•y Max Acc
                    lastPlayed: Date.now()
                };
            }
        }).then(() => {
            console.log("Transaction commited!");
        }).catch((err) => {
            console.error("Transaction failed: ", err);
        });
    }

    // 3. H√†m t·∫£i BXH (Load theo th√°ng hi·ªán t·∫°i)
    function loadLeaderboard() {
        const monthKey = getMonthKey();
        // L·∫•y 20 ng∆∞·ªùi ƒëi·ªÉm cao nh·∫•t (t·ªïng ƒëi·ªÉm t√≠ch l≈©y)
        const lbRef = query(ref(db, `leaderboard/${monthKey}`), orderByChild('score'), limitToLast(20));
        
        onValue(lbRef, (snapshot) => {
            loadingLb.style.display = 'none';
            lbBody.innerHTML = '';
            
            const data = [];
            snapshot.forEach(child => {
                data.push(child.val());
            });
            
            data.reverse(); // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ cao nh·∫•t l√™n ƒë·∫ßu
            
            if (data.length === 0) {
                lbBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Th√°ng m·ªõi ch∆∞a c√≥ d·ªØ li·ªáu. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                const photoHtml = item.photo 
                    ? `<img src="${item.photo}" class="lb-avatar">` 
                    : `<div class="lb-avatar" style="display:flex;align-items:center;justify-content:center;background:#333;color:white;">${item.name.charAt(0)}</div>`;
                
                let rankColor = 'white';
                if(index === 0) rankColor = '#ffd700'; // V√†ng
                else if(index === 1) rankColor = '#c0c0c0'; // B·∫°c
                else if(index === 2) rankColor = '#cd7f32'; // ƒê·ªìng

                tr.innerHTML = `
                    <td class="rank-num" style="color:${rankColor}">${index + 1}</td>
                    <td>
                        <div class="lb-user">
                            ${photoHtml}
                            <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px;">${item.name}</span>
                        </div>
                    </td>
                    <td>${item.wpm || 0}</td>
                    <td>${item.acc || 0}%</td>
                    <td style="color:var(--success-color)">${item.score || 0}</td>
                `;
                lbBody.appendChild(tr);
            });
        });
    }
  </script>

  <script>
    // === PARTICLE EFFECTS (FROM TUVUNG.HTML) ===
    function createParticles() {
        const container = document.getElementById('particles');
        for(let i=0; i<15; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.width = Math.random() * 5 + 2 + 'px';
            p.style.height = p.style.width;
            p.style.animationDuration = Math.random() * 10 + 10 + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            container.appendChild(p);
        }
    }
    createParticles();
    
    // T·∫°o tuy·∫øt r∆°i
    function createSnowflakes() {
        // Ch·ªâ t·∫°o th√™m n·∫øu ch∆∞a c√≥ (trong style ƒë√£ c√≥ CSS animation r·ªìi)
        // ƒê√¢y l√† t·∫°o element DOM
        for (let i = 0; i < 20; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '.'][Math.floor(Math.random() * 4)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 15 + 10 + 'px';
            flake.style.opacity = Math.random() * 0.7 + 0.3;
            flake.style.animationDelay = Math.random() * 5 + 's';
            document.body.appendChild(flake);
            // Remove after animation
            setTimeout(() => flake.remove(), 7000);
        }
    }
    setInterval(createSnowflakes, 800);

    // === 1. TH∆Ø VI·ªÜN D·ªÆ LI·ªÜU ƒêA NG√îN NG·ªÆ ===
    const SAMPLE_LIBRARY = {
        'vi-VN': [
          "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i. S√†i Khao s∆∞∆°ng l·∫•p ƒëo√†n qu√¢n m·ªèi, M∆∞·ªùng L√°t hoa v·ªÅ trong ƒë√™m h∆°i.", 
          "M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ ta? M∆∞·ªùi lƒÉm nƒÉm ·∫•y thi·∫øt tha m·∫∑n n·ªìng. M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ kh√¥ng, Nh√¨n c√¢y nh·ªõ n√∫i, nh√¨n s√¥ng nh·ªõ ngu·ªìn?", 
          "B·ªóng nh·∫≠n ra h∆∞∆°ng ·ªïi, Ph·∫£ v√†o trong gi√≥ se, S∆∞∆°ng ch√πng ch√¨nh qua ng√µ, H√¨nh nh∆∞ thu ƒë√£ v·ªÅ.",
          "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau. Tr·∫£i qua m·ªôt cu·ªôc b·ªÉ d√¢u, nh·ªØng ƒëi·ªÅu tr√¥ng th·∫•y m√† ƒëau ƒë·ªõn l√≤ng.", 
          "S√¥ng n√∫i n∆∞·ªõc Nam vua Nam ·ªü. R√†nh r√†nh ƒë·ªãnh ph·∫≠n t·∫°i s√°ch tr·ªùi. C·ªõ sao l≈© gi·∫∑c sang x√¢m ph·∫°m? Ch√∫ng bay s·∫Ω b·ªã ƒë√°nh t∆°i b·ªùi.",
          "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n. B·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non. R·∫Øn n√°t m·∫∑c d·∫ßu tay k·∫ª n·∫∑n. M√† em v·∫´n gi·ªØ t·∫•m l√≤ng son.",
          "M·ªói nƒÉm hoa ƒë√†o n·ªü. L·∫°i th·∫•y √¥ng ƒë·ªì gi√†. B√†y m·ª±c t√†u gi·∫•y ƒë·ªè. B√™n ph·ªë ƒë√¥ng ng∆∞·ªùi qua.", 
          "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y. Qu√™ h∆∞∆°ng l√† ƒë∆∞·ªùng ƒëi h·ªçc. Con v·ªÅ r·ª£p b∆∞·ªõm v√†ng bay.", 
          "B∆∞·ªõc t·ªõi ƒê√®o Ngang b√≥ng x·∫ø t√†. C·ªè c√¢y chen ƒë√° l√° chen hoa. Lom khom d∆∞·ªõi n√∫i ti√™m v√†i ch√∫. L√°c ƒë√°c b√™n s√¥ng ch·ª£ m·∫•y nh√†.", 
          "Sao anh kh√¥ng v·ªÅ ch∆°i th√¥n Vƒ©? Nh√¨n n·∫Øng h√†ng cau n·∫Øng m·ªõi l√™n. V∆∞·ªùn ai m∆∞·ªõt qu√° xanh nh∆∞ ng·ªçc, L√° tr√∫c che ngang m·∫∑t ch·ªØ ƒëi·ªÅn."
        ],
        'en-US': [
            "The quick brown fox jumps over the lazy dog. Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Two roads diverged in a yellow wood, and sorry I could not travel both. And be one traveler, long I stood and looked down one as far as I could.", 
            "I wandered lonely as a cloud that floats on high o'er vales and hills, when all at once I saw a crowd, a host, of golden daffodils.", 
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer the slings and arrows of outrageous fortune."
        ],
        'id-ID': [
            "Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia yang tertulis pada lambang negara Garuda Pancasila. Maknanya adalah berbeda-beda tetapi tetap satu.",
            "Kami putra dan putri Indonesia, mengaku bertumpah darah yang satu, tanah air Indonesia."
        ],
        'es-ES': [
            "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que viv√≠a un hidalgo de los de lanza en astillero.", 
            "Caminante, no hay camino, se hace camino al andar."
        ],
        'it-IT': [
            "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura, ch√© la diritta via era smarrita.", 
            "L'amor che move il sole e l'altre stelle."
        ],
        'la-VA': [
            "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "Veni, vidi, vici. Alea iacta est."
        ]
    };

    // === 2. C·∫§U H√åNH & BI·∫æN ===
    const wordCache = {}; 
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let hintsUsed = 0;
    let totalSentences = 0; 
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;
    let userHasEditedText = false; 

    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      resetTextBtn: document.getElementById('resetTextBtn'),
      randomTextBtn: document.getElementById('randomTextBtn'), 
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
    };

    // === 4. LOGIC CH√çNH ===

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';

        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        } else {
            // N·∫øu kh√¥ng ph·∫£i holiday, d√πng base theme (light/dark)
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        }

        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'light' ? 'light' : 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        
        const base = localStorage.getItem('baseTheme') || 'dark'; 
        applyTheme(nextState ? 'holiday' : base);
    }

    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'dark'); 
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        const base = localStorage.getItem('baseTheme');
        applyTheme(isHoliday ? 'holiday' : base);
    }

    // Tabs
    function setupTabs(tabButtons, tabContents) {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.tab;
                tabButtons.forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => {
                     c.classList.add('hidden');
                     c.classList.remove('animate__zoomIn', 'animate__fadeIn');
                });
                
                const target = document.getElementById(targetId);
                target.classList.remove('hidden');
                target.classList.add('animate__animated', 'animate__fadeIn');
            });
        });
    }

    // TTS & Translate
    function loadVoices() {
      const targetCode = globalLang.split('-')[0]; 
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(targetCode));
      if (voices.length === 0 && (globalLang.startsWith('la') || globalLang.startsWith('id'))) {
          voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en') || v.lang.startsWith('es'));
      }
      els.voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>M·∫∑c ƒë·ªãnh</option>';
      const saved = localStorage.getItem('voice');
      selectedVoice = voices.find(v => v.name === saved) || voices[0];
      if (selectedVoice) els.voiceSelect.value = selectedVoice.name;
    }

    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      currentUtterance.lang = globalLang;
      if (onWord) {
        currentUtterance.onboundary = (e) => {
          if (e.name === 'word') onWord(e.charIndex, e.charLength);
        };
      }
      speechSynthesis.speak(currentUtterance);
    }
    
    async function translateFull(text, src) {
      if (!text.trim() || globalLang === 'vi-VN') return text;
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch { return text; }
    }

    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const cleanWord = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!cleanWord) return;

        if (wordCache[cleanWord]) {
            targetElement.textContent = wordCache[cleanWord];
            return;
        }

        try {
            const src = globalLang.split('-')[0];
            targetElement.textContent = "..."; 
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanWord)}&langpair=${src}|vi`);
            const data = await res.json();
            const result = data.responseData.translatedText;
            if (result) {
                wordCache[cleanWord] = result;
                targetElement.textContent = result;
            } else targetElement.textContent = "?";
        } catch (e) { targetElement.textContent = "?"; }
    }

    // Display
    async function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.next.style.opacity = '0.5';
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      const isReadOnly = currentMode === 'read-only';
      els.input.style.display = isReadOnly ? 'none' : 'block';
      els.hint.style.display = isReadOnly ? 'none' : 'block';
      els.feedback.style.display = 'block';
      els.feedback.innerHTML = '<em>Nh·∫≠p ho·∫∑c ƒë·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const srcLang = globalLang.split('-')[0];
      if (globalLang !== 'vi-VN') {
          els.fullTrans.innerHTML = '<em>ƒêang d·ªãch...</em>';
          translateFull(text, srcLang).then(trans => { els.fullTrans.textContent = 'T·∫°m d·ªãch: ' + trans; });
      } else els.fullTrans.textContent = '';

      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<i class="fas fa-headphones" style="font-size:3rem; opacity:0.5; margin-bottom:10px;"></i><br><em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      const fragment = document.createDocumentFragment();
      const parts = text.split(/(\s+)/);
      let charIndex = 0;
      karaokeWords = [];

      parts.forEach(part => {
          if (!part) return;
          if (/^\s+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
          } else {
              const span = document.createElement('span');
              span.className = 'karaoke-word';
              span.textContent = part;
              span.dataset.start = charIndex;
              span.dataset.end = charIndex + part.length;
              
              if (globalLang !== 'vi-VN') {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'word-tooltip';
                  tooltip.textContent = "";
                  span.appendChild(tooltip);
                  span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
              }

              karaokeWords.push(span);
              fragment.appendChild(span);
              charIndex += part.length;
          }
      });

      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      
      if (currentMode.includes('listen') && currentMode !== 'read-only') {
        setTimeout(() => speak(text, highlightKaraoke), 300);
      }
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => {
          const start = parseInt(w.dataset.start);
          const end = parseInt(w.dataset.end);
          return charIndex >= start && charIndex < end;
      });
      if (word) word.classList.add('karaoke-active');
    }

    function normalizeText(text) {
        if (!text) return "";
        return text.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase();
    }

    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;
      const oWords = orig.split(/\s+/).filter(w => w);
      const iWords = input.replace(/ $/, ' \u00A0').split(/\s+/).filter(w => w);
      let html = '', correct = 0;
      
      iWords.forEach((w, i) => {
        if (i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else {
            const cleanTarget = normalizeText(oWords[i]);
            const cleanInput = normalizeText(w);
            if (cleanInput === cleanTarget) {
                correct++;
                html += `<span class="correct">${w}</span> `;
            } else html += `<span class="wrong">${w}</span> `;
        }
      });

      correctWords = correct;
      els.feedback.innerHTML = html || '<em>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const isContentMatch = normalizeText(input) === normalizeText(orig);
      if (isContentMatch) {
          els.next.disabled = false;
          els.next.style.opacity = '1';
          els.input.style.borderColor = 'var(--success-color)';
          els.input.style.boxShadow = '0 0 0 2px var(--success-color)';
          confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } }); // Small visual reward
      } else {
          els.next.disabled = true;
          els.next.style.opacity = '0.5';
          els.input.style.borderColor = '';
          els.input.style.boxShadow = '';
      }
    }

    function next() {
      const wordsInSegment = segments[currentIdx].trim().split(/\s+/).length;
      typedWords += wordsInSegment;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const m = s / 60;
      const wpm = m > 0 ? Math.round(typedWords / m) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      els.wpm.textContent = wpm;
      els.acc.textContent = acc + '%';
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      // C√¥ng th·ª©c ƒëi·ªÉm ƒë∆°n gi·∫£n: (WPM * 2) + Acc - Suggest
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";
      
      // === SAVE TO FIREBASE LEADERBOARD ===
      if (window.saveScoreToFirebase) {
          window.saveScoreToFirebase({
              wpm: wpm,
              acc: acc,
              score: score,
              sentences: totalSentences
          });
      }
      
      els.level.textContent = badge; els.levelBadge.textContent = 'ƒê·∫°t c·∫•p: ' + badge;
      els.score.textContent = score; els.wpm.textContent = wpm; els.acc.textContent = acc + '%';
      
      confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
      alert(`Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêI·ªÇM C·ªòNG TH√äM: ${score}\nT·ªïng ƒëi·ªÉm t√≠ch l≈©y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n BXH.`);
      
      // Chuy·ªÉn sang tab BXH ƒë·ªÉ xem k·∫øt qu·∫£
      document.querySelector('[data-tab="rankPanel"]').click();
    }

    function initSpeechRecognition() {
      if (recognition) { recognition.onend = null; recognition.stop(); }
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang;
      recognition.continuous = false;
      recognition.interimResults = true;
      
      recognition.onresult = (e) => {
        let finalTranscript = '';
        for (let i = e.resultIndex; i < e.results.length; ++i) {
             if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
        }
        
        const target = segments[currentIdx];
        if (finalTranscript) {
             const normTrans = normalizeText(finalTranscript);
             const normTarget = normalizeText(target);
             if (normTrans === normTarget || normTrans.includes(normTarget)) {
                 els.feedback.innerHTML = `<span class="correct">${finalTranscript}</span> (Ch√≠nh x√°c!)`;
                 els.next.disabled = false;
                 els.next.style.opacity = '1';
                 confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } });
                 setTimeout(next, 1000);
             } else els.feedback.innerHTML = `<span class="wrong">${finalTranscript}</span> (Th·ª≠ l·∫°i)`;
        }
      };
      
      recognition.onerror = (e) => {
        els.feedback.innerHTML = `<em>L·ªói mic (${e.error}). H√£y nh·∫•n l·∫°i.</em>`;
        els.micBtn.classList.remove('listening');
        isListening = false;
      };
      recognition.onend = () => { els.micBtn.classList.remove('listening'); isListening = false; };
      return true;
    }

    function setRandomText() {
        const library = SAMPLE_LIBRARY[globalLang] || SAMPLE_LIBRARY['vi-VN'];
        const randomText = library[Math.floor(Math.random() * library.length)];
        els.text.value = randomText;
        userHasEditedText = false;
        els.resetTextBtn.style.display = 'none';
    }

    // Event Listeners
    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);

    setupTabs(els.mainTabs(), els.tabContents());

    els.voiceSelect.addEventListener('change', () => {
        selectedVoice = voices.find(v => v.name === els.voiceSelect.value);
        if (selectedVoice) localStorage.setItem('voice', selectedVoice.name);
    });
    els.previewVoice.addEventListener('click', () => speak(globalLang === 'vi-VN' ? 'Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.' : 'Hello, this is a voice preview.'));
    speechSynthesis.onvoiceschanged = loadVoices;

    els.lang.addEventListener('change', () => {
      globalLang = els.lang.value;
      localStorage.setItem('lang', globalLang);
      loadVoices();
    });

    els.text.addEventListener('input', () => {
        userHasEditedText = true;
        els.resetTextBtn.style.display = 'inline-flex';
    });

    els.resetTextBtn.addEventListener('click', () => {
        els.text.value = '';
        els.resetTextBtn.style.display = 'none';
        els.text.focus();
    });

    els.randomTextBtn.addEventListener('click', setRandomText);

    els.start.addEventListener('click', () => {
      const text = els.text.value.trim();
      if (!text) return alert('Vui l√≤ng nh·∫≠p ƒëo·∫°n vƒÉn ho·∫∑c nh·∫•n n√∫t "L·∫•y b√†i m·∫´u"!');
      segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Kh√¥ng c√≥ ƒëo·∫°n h·ª£p l·ªá!');
      
      currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0; totalSentences = segments.length;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
      
      startTime = Date.now(); 
      if (timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
      
      // Chuy·ªÉn Tab Practice
      document.getElementById('setupPanel').classList.add('hidden');
      const practiceTab = document.getElementById('practiceArea');
      practiceTab.classList.remove('hidden');
      practiceTab.classList.add('animate__animated', 'animate__zoomIn');
      
      // Update Tab Navigation Active State
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
      initSpeechRecognition(); 
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); if (!els.next.disabled) next(); } });
    els.hint.addEventListener('click', () => {
      const origWords = segments[currentIdx].split(/\s+/).filter(w => w);
      const typedInput = els.input.value.trim();
      const typedCount = typedInput ? typedInput.split(/\s+/).length : 0;
      if (typedCount < origWords.length) {
        els.feedback.innerHTML += ` <span style="color:var(--info); font-weight:700;">‚Üí ${origWords[typedCount]}</span>`;
        hintsUsed++;
        els.input.focus();
      }
    });
    
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());

    els.modeBtns().forEach(btn => btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
        showSegment();
    }));

    els.micBtn.addEventListener('click', () => {
      if (!recognition) initSpeechRecognition();
      if (isListening) recognition.stop();
      else { 
          try {
              recognition.start(); els.micBtn.classList.add('listening'); isListening = true; 
              els.feedback.innerHTML = '<em>ƒêang nghe... H√£y ƒë·ªçc to!</em>'; 
          } catch(e) { initSpeechRecognition(); }
      }
    });

    initTheme(); 
    els.lang.value = globalLang;
    window.addEventListener('load', loadVoices);
  </script>
  
  <a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
    <span>Trang ch·ªß</span>
  </a>

  <style>
    .floating-home-btn {
        position: fixed; top: 20px; left: 20px; z-index: 1000;
        display: flex; align-items: center; gap: 10px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px; color: white; text-decoration: none;
        font-family: 'Poppins', sans-serif; font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease; overflow: hidden;
    }
    .floating-home-btn:hover {
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transform: translateY(2px); box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        border-color: transparent; color: #0f172a;
    }
    .floating-home-btn svg { width: 24px; height: 24px; transition: transform 0.3s ease; }
    .floating-home-btn:hover svg { transform: scale(1.1); }
    @media (max-width: 640px) {
        .floating-home-btn span { display: none; }
        .floating-home-btn { padding: 12px; border-radius: 50%; }
    }
  </style>
</body>
</html>
