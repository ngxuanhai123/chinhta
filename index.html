<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Aurora Edition (Firebase Sync)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, ƒë·ªìng b·ªô Firebase.">
  <meta name="theme-color" content="#f97316">
  
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      /* --- M√ÄU S·∫ÆC CH·ª¶ ƒê·∫†O (AURORA) --- */
      --bg-color: #fdfbf7;
      --glass-surface: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: 20px;
      
      --text: #2c1810;
      --text-dim: #78350f;
      
      --primary: #f97316;
      --primary-gradient: linear-gradient(135deg, #f97316 0%, #c2410c 100%);
      --primary-shadow: rgba(249, 115, 22, 0.3);
      
      --rank-gold: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
      --rank-silver: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
      --rank-bronze: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);

      --success: #10b981; 
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;
      --purple: #8b5cf6;

      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.05);
      --shadow-lg: 0 20px 40px -5px rgba(249, 115, 22, 0.15);
      --shadow-glow: 0 0 25px rgba(249, 115, 22, 0.4);
    }

    /* --- DARK MODE --- */
    [data-theme="dark"] {
      --bg-color: #0f172a;
      --glass-surface: rgba(15, 23, 42, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --primary: #fb923c;
      --primary-gradient: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* --- HOLIDAY MODE --- */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #dc2626 0%, #15803d 100%);
      --primary: #dc2626;
      --font-display: 'Mountains of Christmas', cursive;
    }
    [data-theme="holiday"] { --bg-color: #fff1f2; --text: #064e3b; }
    [data-theme="holiday-dark"] { --bg-color: #1a0505; --text: #ffe4e6; }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* --- AURORA BACKGROUND --- */
    .aurora-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      overflow: hidden; pointer-events: none;
    }
    .aurora-blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
      animation: auroraFloat 15s infinite alternate ease-in-out;
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #fdba74; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #fca5a5; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 30%; width: 40vw; height: 40vw; background: #c4b5fd; animation-delay: -8s; }
    
    [data-theme="dark"] .blob-1 { background: #431407; opacity: 0.4; }
    [data-theme="dark"] .blob-2 { background: #4c0519; opacity: 0.4; }
    [data-theme="dark"] .blob-3 { background: #1e1b4b; opacity: 0.4; }

    @keyframes auroraFloat {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, -30px) scale(1.1); }
    }
    
    .snowflake { position: fixed; top: -20px; z-index: 999; color: #fff; pointer-events: none; animation: fall linear forwards; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* --- LAYOUT --- */
    .container {
      max-width: 1000px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 24px;
      position: relative; z-index: 10; padding-top: 20px;
    }

    /* --- GLASS CARD --- */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      padding: 30px;
      transition: transform 0.3s ease;
    }

    header { text-align: center; position: relative; }
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3rem; font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 5px; letter-spacing: -1px;
    }
    .tagline { color: var(--text-dim); font-size: 1rem; font-weight: 500; }

    /* --- BUTTONS & CONTROLS --- */
    .icon-btn {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; transition: 0.3s;
    }
    .icon-btn:hover { background: var(--text); color: var(--bg-color); transform: rotate(15deg); }
    
    .theme-controls { position: absolute; top: 0; right: 0; display: flex; gap: 10px; }
    
    .tabs {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;
      background: rgba(255,255,255,0.2); padding: 5px; border-radius: 20px; width: fit-content; margin: 0 auto 20px;
      border: 1px solid var(--glass-border);
    }
    .tab {
      padding: 10px 30px; border-radius: 15px; border: none; background: transparent;
      color: var(--text-dim); font-weight: 600; cursor: pointer; transition: 0.3s;
    }
    .tab.active { background: var(--primary-gradient); color: white; box-shadow: var(--shadow-sm); }

    /* --- INPUTS & FORMS --- */
    select, textarea, input[type="text"] {
      width: 100%; padding: 15px;
      border: 2px solid var(--glass-border); border-radius: var(--input-radius);
      background: rgba(255,255,255,0.4); color: var(--text);
      font-family: var(--font-main); font-size: 1rem; transition: 0.3s;
    }
    select:focus, textarea:focus, input:focus {
      outline: none; border-color: var(--primary); background: rgba(255,255,255,0.8);
      box-shadow: 0 0 0 4px var(--primary-shadow);
    }
    [data-theme="dark"] select, [data-theme="dark"] input, [data-theme="dark"] textarea { background: rgba(0,0,0,0.3); }

    .start-btn {
      width: 100%; padding: 18px; margin-top: 20px;
      background: var(--primary-gradient); color: white;
      border: none; border-radius: var(--btn-radius);
      font-weight: 700; font-size: 1.2rem; cursor: pointer;
      box-shadow: var(--shadow-glow); text-transform: uppercase; letter-spacing: 1px;
      transition: transform 0.2s;
    }
    .start-btn:hover { transform: translateY(-3px); }

    /* --- GAME AREA --- */
    .segment-box {
      font-size: 1.5rem; line-height: 1.6; text-align: center;
      min-height: 140px; padding: 30px;
      background: rgba(255,255,255,0.3); border-radius: 20px;
      border: 2px dashed var(--primary); margin-bottom: 20px;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    .karaoke-word { padding: 4px 6px; border-radius: 6px; transition: 0.2s; position: relative; }
    .karaoke-active { background: var(--primary); color: white; transform: scale(1.1); z-index: 5; box-shadow: 0 5px 15px var(--primary-shadow); }
    
    .input-area { position: relative; margin: 20px 0; }
    #userInput { font-size: 1.4rem; padding-right: 60px; }
    .feedback { text-align: center; font-family: monospace; font-size: 1.1rem; min-height: 30px; margin-bottom: 20px; }
    .correct { color: var(--success); font-weight: bold; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* --- RANKING TABLE (NEW) --- */
    .rank-container { margin-top: 30px; }
    .rank-header { 
        display: flex; align-items: center; justify-content: space-between; 
        margin-bottom: 15px; border-bottom: 2px solid var(--glass-border); padding-bottom: 10px;
    }
    .rank-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .rank-table th { text-align: left; padding: 10px; color: var(--text-dim); font-size: 0.9rem; text-transform: uppercase; }
    .rank-table td { padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); }
    .rank-table tr td:first-child { border-radius: 12px 0 0 12px; font-weight: bold; text-align: center; width: 50px; }
    .rank-table tr td:last-child { border-radius: 0 12px 12px 0; font-weight: bold; color: var(--primary); text-align: right; }
    
    .rank-top-1 td { background: var(--rank-gold) !important; color: #78350f; border: none; }
    .rank-top-2 td { background: var(--rank-silver) !important; color: #424242; border: none; }
    .rank-top-3 td { background: var(--rank-bronze) !important; color: #fff; border: none; }

    /* --- USER AUTH --- */
    .user-profile {
        display: flex; align-items: center; gap: 10px; padding: 10px;
        background: rgba(255,255,255,0.3); border-radius: 50px; padding-right: 20px;
        border: 1px solid var(--glass-border); cursor: pointer; transition: 0.3s;
    }
    .user-profile:hover { background: rgba(255,255,255,0.5); }
    .avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; overflow: hidden;}
    .avatar img { width: 100%; height: 100%; object-fit: cover; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
    .stat-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid var(--glass-border); }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }
    .stat-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; }

    /* Modal */
    .modal-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-box {
        background: var(--bg-color); padding: 40px; border-radius: 32px; width: 90%; max-width: 400px;
        text-align: center; border: 1px solid var(--glass-border); box-shadow: var(--shadow-lg);
    }
    .google-btn {
        background: #fff; color: #333; border: 1px solid #ddd; width: 100%; padding: 12px;
        border-radius: 50px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;
        cursor: pointer; transition: 0.2s; margin-top: 15px;
    }
    .google-btn:hover { background: #f1f1f1; transform: scale(1.02); }

    @media (max-width: 768px) {
        .stat-grid { grid-template-columns: 1fr 1fr; }
        .logo h1 { font-size: 2.2rem; }
    }
  </style>
</head>
<body>

  <div class="aurora-container">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  <div id="snowContainer"></div>

  <div class="container">
    <header class="glass-card">
      <div class="theme-controls">
        <div id="userInfoDisplay" class="hidden">
           </div>
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô L·ªÖ H·ªôi">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="Giao di·ªán S√°ng/T·ªëi">üåó</button>
      </div>

      <div class="logo">
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8; font-weight:400">Aurora</span></h1>
        <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ƒê·ªìng b·ªô th·ªùi gian th·ª±c üöÄ</p>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">B·∫£ng X·∫øp H·∫°ng</button>
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        
        <div>
          <h3 style="color:var(--primary); margin-bottom:10px;">üåç Ng√¥n ng·ªØ</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">English (US)</option>
            <option value="id-ID">Bahasa Indonesia</option>
            <option value="es-ES">Espa√±ol</option>
          </select>
        </div>

        <div>
          <h3 style="color:var(--primary); margin-bottom:10px;">üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; gap:10px;">
             <select id="voiceSelect" style="flex:1"></select>
             <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:50px;">üîà</button>
          </div>
        </div>

        <div style="grid-column: 1/-1;">
          <h3 style="color:var(--primary); margin-bottom:10px;">üéÆ Ch·∫ø ƒë·ªô</h3>
          <div style="display:flex; gap:15px; flex-wrap:wrap;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="radio" name="mode" value="read-write" checked> Nh√¨n & G√µ
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="radio" name="mode" value="listen-write"> Nghe & G√µ
            </label>
             <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="radio" name="mode" value="read-only"> Luy·ªán ƒê·ªçc (Mic)
            </label>
          </div>
        </div>

        <div style="grid-column: 1/-1;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:var(--primary);">‚úçÔ∏è VƒÉn b·∫£n m·∫´u</h3>
                <button id="randomTextBtn" style="background:var(--purple); color:white; border:none; padding:5px 15px; border-radius:10px; cursor:pointer; font-size:0.9rem;">üé≤ L·∫•y b√†i ng·∫´u nhi√™n</button>
            </div>
            <textarea id="sampleText" rows="5" placeholder="Nh·∫≠p vƒÉn b·∫£n ho·∫∑c nh·∫•n n√∫t ng·∫´u nhi√™n..."></textarea>
        </div>
      </div>

      <button id="startBtn" class="start-btn">B·∫Øt ƒë·∫ßu ngay</button>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <div class="rank-container">
        <h2 style="text-align:center; font-family:var(--font-display); color:var(--primary); font-size:2rem; margin-bottom:20px;">üèÜ B·∫£ng v√†ng th√†nh t√≠ch</h2>
        
        <div class="stat-card" style="margin-bottom:30px; background:rgba(249, 115, 22, 0.1); border-color:var(--primary);">
            <div class="stat-label">K·∫øt qu·∫£ t·ªët nh·∫•t c·ªßa b·∫°n</div>
            <div class="stat-val" id="userBestWPM">0 WPM</div>
            <div style="font-size:0.9rem; color:var(--text-dim);" id="userBestDetail">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>

        <div style="overflow-x:auto;">
            <table class="rank-table" id="globalRankTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Th√†nh vi√™n</th>
                        <th style="text-align:right;">T·ªëc ƒë·ªô (WPM)</th>
                        <th style="text-align:right;">ƒêi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="rankTableBody">
                    <tr><td colspan="4" style="text-align:center; padding:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <button class="icon-btn" id="exitBtn" title="Tho√°t" style="border-radius:12px; width:auto; padding:0 15px; font-size:0.9rem;">‚¨Ö Quay l·∫°i</button>
        <div style="font-weight:bold; color:var(--primary);">
            <span id="currentIdxDisplay">1</span> / <span id="totalSegDisplay">10</span>
        </div>
      </div>

      <div class="segment-box" id="currentSegment"></div>
      
      <div id="micStatus" class="hidden" style="text-align:center; margin-bottom:15px;">
        <button id="micBtn" class="icon-btn" style="width:60px; height:60px; font-size:1.5rem; margin:0 auto; background:var(--danger); color:white; border:none;">üé§</button>
        <p style="font-size:0.8rem; margin-top:5px;">Nh·∫•n ƒë·ªÉ n√≥i</p>
      </div>

      <div class="input-area">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off">
        <button id="hintBtn" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; font-size:1.2rem; cursor:pointer;">üí°</button>
      </div>

      <div id="liveFeedback" class="feedback"></div>

      <div class="flex-center" style="gap:15px;">
        <button id="replayBtn" class="icon-btn" style="width:auto; padding:0 20px; border-radius:12px; font-size:1rem;">üîä Nghe l·∫°i</button>
        <button id="nextBtn" class="start-btn" style="width:auto; padding:10px 30px; margin:0; opacity:0.5; pointer-events:none;">Ti·∫øp theo ‚û°</button>
      </div>

      <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="liveWPM">0</div><div class="stat-label">WPM</div></div>
        <div class="stat-card"><div class="stat-val" id="liveAcc">100%</div><div class="stat-label">Ch√≠nh x√°c</div></div>
        <div class="stat-card"><div class="stat-val" id="liveScore">0</div><div class="stat-label">ƒêi·ªÉm</div></div>
        <div class="stat-card"><div class="stat-val" id="liveTime">0s</div><div class="stat-label">Th·ªùi gian</div></div>
      </div>
    </div>

  </div> <div class="modal-overlay" id="authModal">
    <div class="modal-box glass-card">
      <h2 style="color:var(--primary); margin-bottom:10px; font-family:var(--font-display);">Xin ch√†o! üëã</h2>
      <p style="color:var(--text-dim); margin-bottom:20px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† ƒëua top.</p>
      
      <button id="googleLoginBtn" class="google-btn">
         <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="G">
         ƒêƒÉng nh·∫≠p b·∫±ng Google
      </button>
      
      <div style="margin: 20px 0; font-size:0.8rem; opacity:0.6;">HO·∫∂C</div>
      
      <input type="text" id="guestNameInput" placeholder="Nh·∫≠p t√™n kh√°ch..." style="text-align:center;">
      <button id="guestLoginBtn" style="margin-top:10px; background:transparent; border:1px solid var(--text-dim); padding:8px 20px; border-radius:20px; cursor:pointer;">Ch∆°i v·ªõi t∆∞ c√°ch Kh√°ch</button>
    </div>
  </div>

  <script type="module">
    // --- 1. FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, query, orderByChild, limitToLast, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75",
      measurementId: "G-NCC6MG2HMM"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // --- 2. GAME VARIABLES ---
    let currentUser = null; // { uid, displayName, photoURL, isGuest }
    
    // Sample Data
    const SAMPLE_LIBRARY = {
        'vi-VN': [
            "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.",
            "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt, cho con tr√®o h√°i m·ªói ng√†y.",
            "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n, b·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non.",
            "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i nh·ªõ ch∆°i v∆°i.",
            "C√¥ng cha nh∆∞ n√∫i Th√°i S∆°n, nghƒ©a m·∫π nh∆∞ n∆∞·ªõc trong ngu·ªìn ch·∫£y ra."
        ],
        'en-US': [
            "The quick brown fox jumps over the lazy dog.",
            "To be or not to be, that is the question.",
            "All that glitters is not gold.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts."
        ],
        'es-ES': ["Caminante, no hay camino, se hace camino al andar.", "La vida es sue√±o."],
        'id-ID': ["Bhinneka Tunggal Ika.", "Merdeka atau mati!"]
    };

    // State
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timerInterval = null;
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let gameMode = 'read-write';
    let voices = [];
    let selectedVoice = null;
    let recognition = null;
    let isListening = false;

    // --- 3. DOM ELEMENTS ---
    const els = {
        authModal: document.getElementById('authModal'),
        googleBtn: document.getElementById('googleLoginBtn'),
        guestBtn: document.getElementById('guestLoginBtn'),
        guestInput: document.getElementById('guestNameInput'),
        userInfo: document.getElementById('userInfoDisplay'),
        
        panels: {
            setup: document.getElementById('setupPanel'),
            rank: document.getElementById('rankPanel'),
            game: document.getElementById('practiceArea')
        },
        tabs: document.querySelectorAll('.tab'),
        
        // Setup
        lang: document.getElementById('globalLang'),
        voice: document.getElementById('voiceSelect'),
        preview: document.getElementById('previewVoice'),
        text: document.getElementById('sampleText'),
        randomBtn: document.getElementById('randomTextBtn'),
        startBtn: document.getElementById('startBtn'),
        
        // Game
        segment: document.getElementById('currentSegment'),
        input: document.getElementById('userInput'),
        feedback: document.getElementById('liveFeedback'),
        nextBtn: document.getElementById('nextBtn'),
        replayBtn: document.getElementById('replayBtn'),
        hintBtn: document.getElementById('hintBtn'),
        exitBtn: document.getElementById('exitBtn'),
        micBtn: document.getElementById('micBtn'),
        micStatus: document.getElementById('micStatus'),
        
        // Stats
        wpm: document.getElementById('liveWPM'),
        acc: document.getElementById('liveAcc'),
        score: document.getElementById('liveScore'),
        time: document.getElementById('liveTime'),
        
        // Rank
        rankTable: document.getElementById('rankTableBody'),
        userBestWPM: document.getElementById('userBestWPM'),
        userBestDetail: document.getElementById('userBestDetail')
    };

    // --- 4. AUTH LOGIC ---
    function updateUserInfoUI() {
        if (!currentUser) {
            els.userInfo.classList.add('hidden');
            els.authModal.classList.add('show');
            return;
        }
        
        els.authModal.classList.remove('show');
        els.userInfo.classList.remove('hidden');
        
        const photo = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName)}&background=random`;
        
        els.userInfo.innerHTML = `
            <div class="user-profile" id="userProfileBtn">
                <div class="avatar"><img src="${photo}"></div>
                <span style="font-weight:600; font-size:0.9rem;">${currentUser.displayName}</span>
            </div>
        `;
        
        // Click to logout
        document.getElementById('userProfileBtn').onclick = () => {
            if(confirm('B·∫°n mu·ªën ƒëƒÉng xu·∫•t?')) {
                signOut(auth).then(() => {
                    currentUser = null;
                    localStorage.removeItem('hihiGuest');
                    location.reload();
                });
            }
        };
        
        loadUserBest();
    }

    els.googleBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => {
            alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
        });
    });

    els.guestBtn.addEventListener('click', () => {
        const name = els.guestInput.value.trim() || "Kh√°ch ·∫©n danh";
        currentUser = {
            uid: 'guest-' + Date.now(),
            displayName: name,
            photoURL: null,
            isGuest: true
        };
        localStorage.setItem('hihiGuest', JSON.stringify(currentUser));
        updateUserInfoUI();
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            updateUserInfoUI();
        } else {
            // Check local guest
            const localGuest = localStorage.getItem('hihiGuest');
            if (localGuest) {
                currentUser = JSON.parse(localGuest);
                updateUserInfoUI();
            } else {
                els.authModal.classList.add('show');
            }
        }
    });

    // --- 5. LEADERBOARD LOGIC (REALTIME) ---
    function loadLeaderboard() {
        const scoresRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(20));
        
        onValue(scoresRef, (snapshot) => {
            const data = [];
            snapshot.forEach((child) => {
                data.push(child.val());
            });
            // Firebase returns ascending, we need descending
            data.reverse();
            
            els.rankTable.innerHTML = '';
            data.forEach((item, index) => {
                const rankClass = index === 0 ? 'rank-top-1' : index === 1 ? 'rank-top-2' : index === 2 ? 'rank-top-3' : '';
                const row = `
                    <tr class="${rankClass}">
                        <td>${index + 1}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <img src="${item.photoURL || 'https://ui-avatars.com/api/?name=' + item.name}" style="width:24px; height:24px; border-radius:50%;">
                                ${item.name}
                            </div>
                        </td>
                        <td style="text-align:right;">${item.wpm}</td>
                        <td style="text-align:right;">${item.score}</td>
                    </tr>
                `;
                els.rankTable.innerHTML += row;
            });
        });
    }

    function loadUserBest() {
        if(!currentUser || currentUser.isGuest) return;
        const userRef = ref(db, 'leaderboard/' + currentUser.uid);
        onValue(userRef, (snap) => {
            const val = snap.val();
            if(val) {
                els.userBestWPM.textContent = val.wpm + " WPM";
                els.userBestDetail.textContent = `ƒêi·ªÉm cao: ${val.score} | C·∫≠p nh·∫≠t: ${new Date(val.timestamp).toLocaleDateString()}`;
            }
        }, { onlyOnce: true });
    }

    function saveScore(wpm, score, acc) {
        if (!currentUser) return;
        
        // Save history locally always
        const history = JSON.parse(localStorage.getItem('history') || '[]');
        history.push({ wpm, score, acc, date: new Date().toISOString() });
        localStorage.setItem('history', JSON.stringify(history));

        // If not guest, save to Firebase if it's a high score
        if (!currentUser.isGuest) {
            const userRef = ref(db, 'leaderboard/' + currentUser.uid);
            // Check current high score first
            onValue(userRef, (snap) => {
                const currentData = snap.val();
                if (!currentData || score > currentData.score) {
                    set(userRef, {
                        name: currentUser.displayName,
                        photoURL: currentUser.photoURL || '',
                        score: score,
                        wpm: wpm,
                        acc: acc,
                        timestamp: Date.now()
                    });
                }
            }, { onlyOnce: true });
        }
    }

    // --- 6. GAME LOGIC ---
    
    // Voice Setup
    function loadVoices() {
        const langCode = els.lang.value.split('-')[0];
        voices = speechSynthesis.getVoices().filter(v => v.lang.includes(langCode));
        els.voice.innerHTML = voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
        if(voices.length > 0) selectedVoice = voices[0];
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    els.lang.addEventListener('change', () => { loadVoices(); setRandomText(); });
    els.voice.addEventListener('change', () => { selectedVoice = voices.find(v => v.name === els.voice.value); });
    els.preview.addEventListener('click', () => {
        if(!selectedVoice) return;
        const ut = new SpeechSynthesisUtterance(els.lang.value === 'vi-VN' ? "Ch√†o b·∫°n, m√¨nh l√† tr·ª£ l√Ω ·∫£o." : "Hello, I am your virtual assistant.");
        ut.voice = selectedVoice;
        speechSynthesis.speak(ut);
    });

    // Random Text
    function setRandomText() {
        const lib = SAMPLE_LIBRARY[els.lang.value] || SAMPLE_LIBRARY['vi-VN'];
        els.text.value = lib[Math.floor(Math.random() * lib.length)];
    }
    els.randomBtn.addEventListener('click', setRandomText);

    // Start Game
    els.startBtn.addEventListener('click', () => {
        const rawText = els.text.value.trim();
        if(!rawText) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");
        
        segments = rawText.split(/(?<=[.!?])\s+/).filter(x => x.length > 0);
        currentIdx = 0;
        typedWords = 0;
        correctWords = 0;
        totalCorrectWords = 0;
        
        gameMode = document.querySelector('input[name="mode"]:checked').value;
        
        // Switch UI
        els.panels.setup.classList.add('hidden');
        els.panels.rank.classList.add('hidden');
        els.panels.game.classList.remove('hidden');
        document.getElementById('totalSegDisplay').textContent = segments.length;
        
        startTime = Date.now();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateStats, 1000);
        
        loadSegment();
    });

    function loadSegment() {
        const text = segments[currentIdx];
        document.getElementById('currentIdxDisplay').textContent = currentIdx + 1;
        
        // Reset UI State
        els.input.value = '';
        els.input.focus();
        els.nextBtn.style.opacity = '0.5';
        els.nextBtn.style.pointerEvents = 'none';
        els.feedback.innerHTML = '';
        els.hintBtn.style.display = 'block';
        
        // Mode handling
        if (gameMode === 'read-only') {
            els.input.style.display = 'none';
            els.micStatus.classList.remove('hidden');
            els.hintBtn.style.display = 'none';
            initSpeech();
        } else {
            els.input.style.display = 'block';
            els.micStatus.classList.add('hidden');
        }

        // Render HTML for Karaoke
        els.segment.innerHTML = text.split(' ').map(w => `<span class="karaoke-word">${w}</span>`).join(' ');

        if (gameMode !== 'read-only' && gameMode.includes('listen')) {
            setTimeout(() => speak(text), 500);
        }
    }

    function speak(text) {
        speechSynthesis.cancel();
        if(!selectedVoice) return;
        const ut = new SpeechSynthesisUtterance(text);
        ut.voice = selectedVoice;
        ut.rate = 0.9;
        
        // Karaoke Effect
        const words = document.querySelectorAll('.karaoke-word');
        let wordIndex = 0;
        ut.onboundary = (event) => {
             if (event.name === 'word') {
                 words.forEach(w => w.classList.remove('karaoke-active'));
                 // Simple mapping based on index approximation
                 const duration = text.length; 
                 // Better logic usually requires splitting text same as engine, but simple approximation:
                 if(words[wordIndex]) words[wordIndex].classList.add('karaoke-active');
                 wordIndex++;
             }
        };
        speechSynthesis.speak(ut);
    }

    // Input Logic
    els.input.addEventListener('input', () => {
        const target = segments[currentIdx];
        const current = els.input.value;
        
        // Diff checker (Simple)
        const targetWords = target.split(/\s+/);
        const inputWords = current.trim().split(/\s+/);
        let html = '';
        let correctCount = 0;
        
        inputWords.forEach((w, i) => {
            if (!targetWords[i]) return;
            // Remove punctuation for comparison
            const cleanT = targetWords[i].replace(/[.,!?;:]/g, '').toLowerCase();
            const cleanI = w.replace(/[.,!?;:]/g, '').toLowerCase();
            
            if (cleanT === cleanI) {
                html += `<span class="correct">${w}</span> `;
                correctCount++;
            } else {
                html += `<span class="wrong">${w}</span> `;
            }
        });
        
        els.feedback.innerHTML = html;
        correctWords = correctCount;

        // Check Complete
        if (current.replace(/\s/g,'').toLowerCase() === target.replace(/\s/g,'').toLowerCase()) {
            els.input.style.borderColor = 'var(--success)';
            els.nextBtn.style.opacity = '1';
            els.nextBtn.style.pointerEvents = 'all';
            playSound('success');
        }
    });

    els.nextBtn.addEventListener('click', () => {
        typedWords += segments[currentIdx].split(/\s+/).length;
        totalCorrectWords += correctWords;
        
        currentIdx++;
        if(currentIdx >= segments.length) {
            endGame();
        } else {
            loadSegment();
        }
    });

    els.replayBtn.addEventListener('click', () => {
        speak(segments[currentIdx]);
    });

    els.hintBtn.addEventListener('click', () => {
        const target = segments[currentIdx];
        const current = els.input.value;
        const nextWord = target.split(' ')[current.split(' ').length - 1];
        if(nextWord) els.input.value += nextWord + ' ';
        els.input.dispatchEvent(new Event('input'));
        els.input.focus();
    });

    // Mic Logic (Simple WebSpeech)
    function initSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Mic.");
        
        recognition = new SpeechRecognition();
        recognition.lang = els.lang.value;
        recognition.continuous = false;
        recognition.interimResults = true;
        
        recognition.onresult = (e) => {
            const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
            els.feedback.textContent = transcript;
            
            // Check correctness loosely
            const target = segments[currentIdx].toLowerCase().replace(/[.,!]/g,'');
            const heard = transcript.toLowerCase().replace(/[.,!]/g,'');
            
            if(heard.includes(target) || target.includes(heard)) {
                els.feedback.innerHTML += ' <span class="correct">‚úÖ</span>';
                els.nextBtn.style.opacity = '1';
                els.nextBtn.style.pointerEvents = 'all';
            }
        };
        
        recognition.onend = () => { isListening = false; els.micBtn.style.background = 'var(--danger)'; };
    }
    
    els.micBtn.addEventListener('click', () => {
        if(!isListening && recognition) {
            recognition.start();
            isListening = true;
            els.micBtn.style.background = 'var(--success)';
        } else if (recognition) {
            recognition.stop();
        }
    });

    function updateStats() {
        const elapsedMin = (Date.now() - startTime) / 1000 / 60;
        const wpm = elapsedMin > 0 ? Math.round(typedWords / elapsedMin) : 0;
        
        els.wpm.textContent = wpm;
        els.time.textContent = Math.round(elapsedMin * 60) + 's';
        
        // Estimate score
        const score = Math.round(wpm * 10 + totalCorrectWords * 5);
        els.score.textContent = score;
    }

    function endGame() {
        clearInterval(timerInterval);
        const finalWPM = parseInt(els.wpm.textContent);
        const finalScore = parseInt(els.score.textContent);
        
        saveScore(finalWPM, finalScore, 100); // 100% completion
        
        alert(`üéâ Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${finalWPM} WPM\nƒêi·ªÉm: ${finalScore}`);
        location.reload(); // Reload to reset cleanly
    }

    function playSound(type) {
        // Simple Audio placeholder
    }

    // --- 7. TABS & THEME ---
    els.tabs.forEach(t => {
        t.addEventListener('click', () => {
            els.tabs.forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            Object.values(els.panels).forEach(p => p.classList.add('hidden'));
            document.getElementById(t.dataset.tab).classList.remove('hidden');
            
            if(t.dataset.tab === 'rankPanel') loadLeaderboard();
        });
    });

    els.exitBtn.addEventListener('click', () => location.reload());

    // Theme logic
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    });

    const holidayBtn = document.getElementById('holidayBtn');
    holidayBtn.addEventListener('click', () => {
        const curr = document.body.getAttribute('data-theme');
        if(curr && curr.includes('holiday')) {
            document.body.setAttribute('data-theme', 'light');
            document.getElementById('snowContainer').innerHTML = '';
        } else {
            document.body.setAttribute('data-theme', 'holiday');
            createSnow();
        }
    });

    function createSnow() {
        const c = document.getElementById('snowContainer');
        c.innerHTML = '';
        for(let i=0; i<30; i++) {
            const d = document.createElement('div');
            d.className='snowflake';
            d.textContent='‚ùÑ';
            d.style.left = Math.random()*100 + 'vw';
            d.style.animationDuration = (Math.random()*3+2)+'s';
            d.style.opacity = Math.random();
            c.appendChild(d);
        }
    }

    // Initialize
    loadVoices();
    setRandomText();

  </script>
</body>
</html>
