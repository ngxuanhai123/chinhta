<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xuân Hải - Luyện Chính Tả</title>
  <meta name="description" content="Luyện chính tả tiếng Việt, tiếng Anh, tiếng Indonesia. Gõ nhanh, chính xác, theo dõi tiến độ.">
  <meta name="theme-color" content="#10b981">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgMjAgTDMwIDQwIEw0MCA1MCBMMzAgNjAgTTUwIDgwIEw3MCA2MCBMNjAgNTAgTDcwIDQwIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwYjk4MSIgc3Ryb2tlLXdpZHRoPSI4Ii8+PC9zdmc+">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgMjAgTDMwIDQwIEw0MCA1MCBMMzAgNjAgTTUwIDgwIEw3MCA2MCBMNjAgNTAgTDcwIDQwIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwYjk4MSIgc3Ryb2tlLXdpZHRoPSI4Ii8+PC9zdmc+">

  <!-- Font & Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
      --primary: #10b981; --primary-light: #34d399; --success: #10b981; --warning: #f59e0b;
      --danger: #ef4444; --hint: #8b5cf6; --glass: rgba(255, 255, 255, 0.7);
      --shadow: 0 20px 40px rgba(0,0,0,0.08); --radius: 28px;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-muted: #94a3b8; --border: #334155;
      --primary: #34d399; --primary-light: #6ee7b7; --glass: rgba(30, 41, 59, 0.6);
      --shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: var(--text); min-height: 100vh; padding: 24px; transition: var(--transition); }
    .container { max-width: 1300px; margin: 0 auto; display: flex; flex-direction: column; gap: 28px; min-height: 100vh; }

    /* === HUY HIỆU CẤP BẬC === */
    .rank-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem;
      margin-left: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }
    .rank-badge.bronze { background: linear-gradient(135deg, #cd7f32, #a97142); }
    .rank-badge.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); }
    .rank-badge.gold { background: linear-gradient(135deg, #ffd700, #ffb700); }
    .rank-badge.emerald { background: linear-gradient(135deg, #10b981, #34d399); }
    .rank-badge.diamond { background: linear-gradient(135deg, #8b5cf6, #c4b5fd); animation: shine 1.5s infinite; }

    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes shine {
      0% { box-shadow: 0 0 10px #fff; }
      50% { box-shadow: 0 0 20px #fff, 0 0 30px #8b5cf6; }
      100% { box-shadow: 0 0 10px #fff; }
    }

    /* === BẢNG XẾP HẠNG === */
    .rank-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--glass); border-radius: 16px; border: 1px solid var(--border); }
    .rank-position { font-size: 1.5rem; font-weight: 700; color: var(--primary); width: 50px; text-align: center; }
    .rank-medal { font-size: 1.8rem; }
    .rank-info { flex: 1; display: flex; align-items: center; gap: 8px; }
    .rank-name { font-weight: 600; font-size: 1.1rem; }
    .rank-score { color: var(--primary); font-weight: 700; }

    /* === KẾT QUẢ CUỐI BÀI === */
    .final-badge {
      display: flex; flex-direction: column; align-items: center; margin: 20px 0;
      animation: bounceIn 1s ease-out;
    }
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Giữ nguyên các style cũ... */
    /* (Dán toàn bộ style từ file trước vào đây nếu cần) */
    .hidden { display: none !important; }
    .install-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; z-index: 1000; border: 1px solid var(--border); max-width: 90%; font-size: 1rem; }
    .install-banner button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER, TABS, NAME INPUT, SETUP, PRACTICE... (GIỮ NGUYÊN) -->

    <!-- KẾT QUẢ SAU KHI HOÀN THÀNH (THÊM HUY HIỆU) -->
    <div id="finalResult" class="hidden" style="text-align:center; margin-top:32px;">
      <div class="final-badge">
        <div id="finalBadge" class="rank-badge diamond"></div>
        <h3 id="finalLevel" style="margin-top:12px; font-size:1.8rem; color:var(--primary);"></h3>
      </div>
      <p style="font-size:1.2rem; margin:16px 0;">Bạn đã đạt <strong id="finalScore">0</strong> điểm!</p>
    </div>

    <!-- RANKING PANEL (THÊM HUY HIỆU) -->
    <div id="rankingPanel" class="tab-content hidden">
      <div class="ranking-panel">
        <div class="ranking-tabs">
          <button class="ranking-tab active" data-rank="all">Tất Cả</button>
          <button class="ranking-tab" data-rank="week">Tuần Này</button>
          <button class="ranking-tab" data-rank="month">Tháng Này</button>
        </div>
        <div id="rankingList" class="ranking-list"></div>
      </div>
    </div>
  </div>

  <!-- PWA Install Banner -->
  <div class="install-banner hidden" id="installBanner">
    <span>Thêm vào màn hình chính để dùng như app!</span>
    <button id="installBtn">Cài đặt</button>
  </div>

  <script>
    // === FIREBASE CONFIG (CỦA BẠN) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75",
      measurementId: "G-NCC6MG2HMM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === HUY HIỆU CẤP BẬC ===
    const BADGES = [
      { name: "Mới bắt đầu", icon: "Seedling", class: "bronze", min: 0 },
      { name: "Trung bình", icon: "Leaf", class: "silver", min: 50 },
      { name: "Khá", icon: "Trophy", class: "gold", min: 100 },
      { name: "Giỏi", icon: "Gem", class: "emerald", min: 200 },
      { name: "Xuất sắc", icon: "Crown", class: "diamond", min: 350 }
    ];

    function getBadge(wpm) {
      for (let i = BADGES.length - 1; i >= 0; i--) {
        if (wpm >= BADGES[i].min) return BADGES[i];
      }
      return BADGES[0];
    }

    function createBadgeElement(badge) {
      const el = document.createElement('div');
      el.className = `rank-badge ${badge.class}`;
      el.textContent = badge.icon;
      el.title = badge.name;
      return el;
    }

    // === XẾP HẠNG (THÊM HUY HIỆU) ===
    function loadRanking(type = 'all') {
      const list = document.getElementById('rankingList');
      list.innerHTML = '<p>Đang tải bảng xếp hạng...</p>';
      let query = db.ref('scores').orderByChild('score').limitToLast(10);
      if (type === 'week') {
        const now = new Date();
        const week = `${now.getFullYear()}-W${String(Math.ceil((now.getDate() + now.getDay()) / 7)).padStart(2, '0')}`;
        query = db.ref('scores').orderByChild('week').equalTo(week).orderByChild('score').limitToLast(10);
      } else if (type === 'month') {
        const now = new Date();
        const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        query = db.ref('scores').orderByChild('month').equalTo(month).orderByChild('score').limitToLast(10);
      }

      query.once('value', snapshot => {
        const data = snapshot.val();
        const entries = data ? Object.values(data).reverse() : [];
        list.innerHTML = entries.length ? '' : '<p>Chưa có người chơi nào!</p>';
        entries.forEach((entry, i) => {
          const wpm = Math.round(entry.score / 3.5); // Ước lượng WPM từ điểm
          const badge = getBadge(wpm);
          const medal = i === 0 ? '1st place medal' : i === 1 ? '2nd place medal' : i === 2 ? '3rd place medal' : `${i + 1}`;
          const item = document.createElement('div');
          item.className = 'rank-item';
          item.innerHTML = `
            <div class="rank-position"><span class="rank-medal">${medal}</span></div>
            <div class="rank-info">
              <div class="rank-name">${entry.name}</div>
              ${createBadgeElement(badge).outerHTML}
            </div>
            <div class="rank-score">${entry.score} điểm</div>
          `;
          list.appendChild(item);
        });
      });
    }

    // === KẾT THÚC BÀI (HIỂN THỊ HUY HIỆU) ===
    function endPractice() {
      clearInterval(timer);
      const elapsed = (Date.now() - startTime) / 1000 / 60;
      const wpm = elapsed > 0 ? Math.round(typedWords / elapsed) : 0;
      const accuracy = typedWords > 0 ? Math.round((correctWords / typedWords) * 100) : 100;
      const score = calculateScore(wpm, accuracy);
      const badge = getBadge(wpm);

      // Lưu lịch sử + gửi Firebase
      history.push({ date: new Date().toLocaleString('vi-VN'), wpm, accuracy, score, badge: badge.name });
      localStorage.setItem('xuanHaiDictation', JSON.stringify(history));
      uploadScore(score);

      // Hiển thị kết quả + huy hiệu
      document.getElementById('finalLevel').textContent = badge.name;
      document.getElementById('finalScore').textContent = score;
      const badgeEl = document.getElementById('finalBadge');
      badgeEl.className = `rank-badge ${badge.class}`;
      badgeEl.textContent = badge.icon;
      document.getElementById('finalResult').classList.remove('hidden');

      alert(`Chúc mừng!\nCấp bậc: ${badge.name} ${badge.icon}\nĐiểm: ${score}`);
    }

    // [DÁN TOÀN BỘ SCRIPT LUYỆN TẬP TỪ FILE TRƯỚC VÀO ĐÂY]
    // ... (giữ nguyên phần logic luyện tập, chỉ thêm endPractice() ở trên)
  </script>
</body>
</html>
