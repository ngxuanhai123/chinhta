<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HiHi - Typing Aurora</title>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --glass-bg: rgba(15, 23, 42, 0.65);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      
      --primary: #38bdf8;
      --secondary: #e73c7e;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      
      --text-color: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.6);
      
      --radius: 24px;
      --font-main: 'Poppins', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--font-main);
      background: #0f172a;
      color: var(--text-color);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding-bottom: 110px; /* Space for bottom nav */
      overflow-x: hidden;
      position: relative;
    }

    /* --- BACKGROUND EFFECTS --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      opacity: 0.6;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .particle {
      position: absolute; border-radius: 50%; background: white;
      opacity: 0.3; animation: floatUp linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(105vh) scale(0); opacity: 0; }
      50% { opacity: 0.5; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    /* --- UI COMPONENTS --- */
    .view-container { width: 92%; max-width: 600px; z-index: 2; position: relative; padding-top: 20px; }
    .hidden { display: none !important; }

    /* Glass Panel */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      padding: 24px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }

    /* Inputs & Selects */
    .input-glass, select.input-glass, textarea.input-glass {
      width: 100%; padding: 16px; border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(0,0,0,0.3); color: white;
      font-size: 1rem; margin-bottom: 15px; font-family: var(--font-main);
      transition: 0.3s;
    }
    .input-glass:focus { background: rgba(0,0,0,0.5); border-color: var(--primary); box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
    option { background: #1e293b; color: white; }

    /* Buttons */
    .btn-primary {
      position: relative; overflow: hidden; border: none;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.3);
      color: white; font-weight: 700;
      padding: 15px 20px; border-radius: 20px;
      cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
      font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s;
    }
    .btn-primary:active { transform: scale(0.96); }
    .btn-primary:hover { background: rgba(255,255,255,0.25); border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.4); }
    
    .btn-small { padding: 8px 16px; font-size: 0.8rem; width: auto; display: inline-flex; margin-right: 5px; border-radius: 12px; }
    .btn-icon { width: 44px; height: 44px; border-radius: 50%; padding: 0; font-size: 1.2rem; }

    /* Header */
    header { margin-top: 20px; text-align: center; z-index: 10; width: 100%; }
    h1 { 
      font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; 
      background: linear-gradient(to right, #fff, #b3e5fc); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
      text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
    }
    .user-pill {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(0,0,0,0.4); padding: 6px 16px; border-radius: 30px;
      border: 1px solid var(--glass-border); margin-top: 10px; cursor: pointer;
    }
    .user-pill img { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--primary); }
    
    /* Navigation Bar */
    .tab-bar {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 450px; height: 75px;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 40px;
      display: flex; justify-content: space-around; align-items: center; z-index: 1000;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
    }
    .tab-item {
      color: rgba(255,255,255,0.4); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s;
      flex: 1; height: 100%; justify-content: center; border-radius: 40px;
    }
    .tab-item.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); transform: translateY(-5px); }
    .tab-item i { font-size: 1.4rem; margin-bottom: 6px; }

    /* --- GAME ELEMENTS --- */
    /* Karaoke Text */
    .segment-box {
      font-size: 1.5rem; line-height: 1.8; text-align: center; min-height: 120px;
      margin-bottom: 20px; color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .karaoke-word { padding: 2px 4px; border-radius: 6px; transition: 0.2s; display: inline-block; white-space: pre-wrap; }
    .karaoke-active { background: var(--primary); color: #000; transform: scale(1.1); box-shadow: 0 0 15px var(--primary); }

    /* Feedback */
    #liveFeedback { min-height: 30px; text-align: center; margin-bottom: 15px; font-family: 'Quicksand', sans-serif; }
    .correct { color: var(--success); text-shadow: 0 0 10px var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.8; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .stat-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid var(--glass-border); }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: block; }
    .stat-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; }

    /* --- FANCY LEADERBOARD --- */
    .lb-controls { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
    .lb-filter-btn { background: transparent; border: 1px solid var(--glass-border); color: var(--text-dim); padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
    .lb-filter-btn.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 700; box-shadow: 0 0 10px var(--primary); }
    
    .lb-list { display: flex; flex-direction: column; gap: 12px; }
    .lb-item {
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
      padding: 12px 16px; border-radius: 16px; position: relative; overflow: hidden;
    }
    
    /* Top 3 Effects */
    .lb-item.rank-1 { background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0.3)); border-color: rgba(251, 191, 36, 0.5); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
    .lb-item.rank-2 { border-color: rgba(148, 163, 184, 0.5); }
    .lb-item.rank-3 { border-color: rgba(180, 83, 9, 0.5); }

    .rank-badge { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 50%; margin-right: 12px; font-size: 0.9rem; }
    .rank-1 .rank-badge { background: #fbbf24; color: #000; box-shadow: 0 0 10px #fbbf24; }
    .rank-2 .rank-badge { background: #94a3b8; color: #000; }
    .rank-3 .rank-badge { background: #b45309; color: white; }
    .rank-other .rank-badge { background: rgba(255,255,255,0.1); color: var(--text-dim); }

    .player-info { flex: 1; display: flex; align-items: center; gap: 10px; }
    .player-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid white; }
    .player-name { font-weight: 600; font-size: 0.95rem; }
    
    .score-info { text-align: right; }
    .score-main { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
    .score-sub { font-size: 0.7rem; color: var(--text-dim); }

    /* --- MIC BUTTON --- */
    .mic-container { display: flex; justify-content: center; margin: 10px 0; }
    .mic-btn {
      width: 60px; height: 60px; border-radius: 50%; background: rgba(239, 68, 68, 0.2); 
      border: 1px solid var(--danger); color: var(--danger); font-size: 1.5rem; 
      display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
    }
    .mic-btn.listening { background: var(--success); color: white; border-color: var(--success); animation: pulseMic 1.5s infinite; box-shadow: 0 0 20px var(--success); }
    @keyframes pulseMic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* Modal */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal-overlay.show { opacity: 1; pointer-events: all; }
    .modal-card { width: 85%; max-width: 400px; background: #1e293b; border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; text-align: center; transform: translateY(20px); transition: 0.3s; }
    .modal-overlay.show .modal-card { transform: translateY(0); }

  </style>
</head>
<body>

  <div class="aurora-bg"></div>
  <div id="particles"></div>

  <header>
    <h1>HiHi<span style="font-size:0.5em; vertical-align: top; opacity:0.7; font-weight:300;">Aurora</span></h1>
    <div id="userProfileBtn" class="user-pill animate__animated animate__fadeInDown">
      <img id="headerAvatar" src="https://ui-avatars.com/api/?name=Guest&background=random" alt="User">
      <span id="headerName">Kh√°ch</span>
    </div>
  </header>

  <div class="view-container">

    <div id="tabHome" class="tab-content animate__animated animate__fadeIn">
      <div class="glass-panel">
        <h3 style="margin-bottom:15px; color:var(--primary);"><i class="fas fa-sliders-h"></i> C√†i ƒê·∫∑t Luy·ªán T·∫≠p</h3>
        
        <label style="font-size:0.8rem; color:var(--text-dim); margin-left:5px;">Ng√¥n ng·ªØ</label>
        <select id="globalLang" class="input-glass">
            <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en-US">üá∫üá∏ Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">üáÆüá© Indonesia</option>
            <option value="es-ES">üá™üá∏ T√¢y Ban Nha</option>
            <option value="it-IT">üáÆüáπ √ù</option>
            <option value="la-VA">üèõÔ∏è Latin</option>
        </select>

        <label style="font-size:0.8rem; color:var(--text-dim); margin-left:5px;">Ch·∫ø ƒë·ªô</label>
        <select id="gameMode" class="input-glass">
            <option value="read-write">‚úçÔ∏è Nh√¨n & Ch√©p</option>
            <option value="listen-write">üéß Nghe & Ch√©p</option>
            <option value="read-listen-write">üî• Nghe - Nh√¨n - Ch√©p</option>
            <option value="read-only">üé§ Luy·ªán ƒê·ªçc (Mic)</option>
        </select>

        <label style="font-size:0.8rem; color:var(--text-dim); margin-left:5px;">Gi·ªçng ƒë·ªçc AI</label>
        <div style="display:flex; gap:10px;">
            <select id="voiceSelect" class="input-glass" style="flex:1;"></select>
            <button id="previewVoice" class="btn-primary btn-small btn-icon" style="width:50px;"><i class="fas fa-volume-up"></i></button>
        </div>

        <label style="font-size:0.8rem; color:var(--text-dim); margin-left:5px;">VƒÉn b·∫£n m·∫´u</label>
        <textarea id="sampleText" class="input-glass" rows="4" placeholder="Nh·∫≠p vƒÉn b·∫£n ho·∫∑c ch·ªçn b√†i m·∫´u..."></textarea>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="randomTextBtn" class="btn-primary btn-small" style="background:var(--secondary); border:none;"><i class="fas fa-dice"></i> M·∫´u Ng·∫´u Nhi√™n</button>
            <button id="resetTextBtn" class="btn-primary btn-small" style="background:rgba(255,255,255,0.1); border:none; display:none;"><i class="fas fa-undo"></i> X√≥a</button>
        </div>

        <button id="startBtn" class="btn-primary" style="background: var(--primary); font-size:1.1rem; box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);">
            B·∫Øt ƒê·∫ßu Ngay <i class="fas fa-rocket"></i>
        </button>
      </div>
    </div>

    <div id="tabPractice" class="tab-content hidden animate__animated animate__fadeIn">
      <div class="glass-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button id="backHomeBtn" class="btn-primary btn-small" style="width:auto; padding:5px 10px;"><i class="fas fa-arrow-left"></i></button>
            <div style="font-weight:700; color:var(--primary);">Ti·∫øn ƒë·ªô: <span id="progressText">0%</span></div>
        </div>
        
        <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; margin-bottom:20px;">
            <div id="progressFill" style="height:100%; width:0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s;"></div>
        </div>

        <div id="currentSegment" class="segment-box"></div>
        
        <div id="fullTranslation" style="text-align:center; font-style:italic; color:var(--warning); font-size:0.9rem; margin-bottom:15px; min-height:20px;"></div>

        <div id="micControl" class="mic-container hidden">
            <button id="micBtn" class="mic-btn"><i class="fas fa-microphone"></i></button>
        </div>

        <div style="position:relative;">
            <input type="text" id="userInput" class="input-glass" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off" style="font-size:1.2rem; padding-right:50px;">
            <button id="hintBtn" style="position:absolute; right:10px; top:15%; background:none; border:none; color:var(--warning); font-size:1.2rem; cursor:pointer;"><i class="fas fa-lightbulb"></i></button>
        </div>

        <div id="liveFeedback"></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button id="replayBtn" class="btn-primary btn-small"><i class="fas fa-redo"></i> Nghe L·∫°i</button>
            <button id="nextBtn" class="btn-primary btn-small" disabled style="background:var(--success); border-color:transparent;">Ti·∫øp Theo <i class="fas fa-forward"></i></button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="liveWpm">0</span>
                <span class="stat-label">WPM</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="liveScore">0</span>
                <span class="stat-label">ƒêi·ªÉm</span>
            </div>
        </div>
      </div>
    </div>

    <div id="tabLeaderboard" class="tab-content hidden animate__animated animate__fadeIn">
      <div class="glass-panel">
        <h3 style="text-align:center; margin-bottom:20px; text-transform:uppercase; letter-spacing:2px; color:var(--warning);"><i class="fas fa-trophy"></i> B·∫£ng X·∫øp H·∫°ng</h3>
        
        <div class="lb-controls">
            <button class="lb-filter-btn active" id="lbWeekly">Tu·∫ßn N√†y</button>
            <button class="lb-filter-btn" id="lbMonthly">Th√°ng N√†y</button>
        </div>

        <div id="leaderboardList" class="lb-list">
            <div style="text-align:center; padding:20px; color:var(--text-dim);">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
      </div>
    </div>

    <div id="tabProfile" class="tab-content hidden animate__animated animate__fadeIn">
       <div class="glass-panel" style="text-align:center;">
           <img id="profileAvatarBig" src="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); margin-bottom:10px;">
           <h2 id="profileNameBig">User</h2>
           <button id="logoutBtn" class="btn-primary btn-small" style="width:auto; margin-top:10px; background:rgba(248, 113, 113, 0.2); color:var(--danger); border-color:var(--danger);">ƒêƒÉng Xu·∫•t</button>
       </div>

       <div class="glass-panel">
           <h4 style="margin-bottom:15px; border-left:3px solid var(--secondary); padding-left:10px;">Th·ªëng K√™ C√° Nh√¢n</h4>
           <div class="stats-grid">
               <div class="stat-card">
                   <span class="stat-val" id="statMaxWpm">0</span>
                   <span class="stat-label">WPM Cao Nh·∫•t</span>
               </div>
               <div class="stat-card">
                   <span class="stat-val" id="statGames">0</span>
                   <span class="stat-label">B√†i ƒê√£ Luy·ªán</span>
               </div>
               <div class="stat-card" style="grid-column: 1/-1">
                   <span class="stat-val" id="statTotalScore">0</span>
                   <span class="stat-label">T·ªïng ƒêi·ªÉm T√≠ch L≈©y</span>
               </div>
           </div>
           <div style="margin-top:20px; height:200px;">
               <canvas id="statsChart"></canvas>
           </div>
       </div>
    </div>

  </div>
  <div class="tab-bar">
    <div class="tab-item active" data-target="tabHome">
        <i class="fas fa-gamepad"></i> <span>Luy·ªán</span>
    </div>
    <div class="tab-item" data-target="tabLeaderboard">
        <i class="fas fa-crown"></i> <span>Top BXH</span>
    </div>
    <div class="tab-item" data-target="tabProfile">
        <i class="fas fa-chart-pie"></i> <span>H·ªì S∆°</span>
    </div>
  </div>

  <div id="loginModal" class="modal-overlay show">
      <div class="modal-card">
          <h2 style="color:var(--primary); margin-bottom:10px;">Ch√†o M·ª´ng!</h2>
          <p style="color:var(--text-dim); margin-bottom:30px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† leo b·∫£ng x·∫øp h·∫°ng c√πng m·ªçi ng∆∞·ªùi.</p>
          
          <button id="googleLoginBtn" class="btn-primary" style="background:white; color:#333; margin-bottom:15px;">
              <i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p Google
          </button>
          <button id="skipLoginBtn" class="btn-primary" style="background:transparent; font-size:0.9rem; opacity:0.7;">
              Ch∆°i ·∫®n Danh
          </button>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75",
      measurementId: "G-NCC6MG2HMM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // --- VARIABLES ---
    let currentUser = null;
    let personalHistory = [];
    const wordCache = {};
    
    // Game State
    let segments = [];
    let currentIdx = 0;
    let typedWords = 0, correctWords = 0, totalCorrectWords = 0, hintsUsed = 0;
    let startTime = 0;
    let timerInterval = null;
    let isListening = false;
    let recognition = null;
    
    // UI Elements Map
    const els = {
        // Tabs
        tabItems: document.querySelectorAll('.tab-item'),
        tabContents: document.querySelectorAll('.tab-content'),
        
        // Login
        modal: document.getElementById('loginModal'),
        btnLogin: document.getElementById('googleLoginBtn'),
        btnSkip: document.getElementById('skipLoginBtn'),
        btnLogout: document.getElementById('logoutBtn'),
        
        // Header
        headerName: document.getElementById('headerName'),
        headerAvatar: document.getElementById('headerAvatar'),
        profileName: document.getElementById('profileNameBig'),
        profileAvatar: document.getElementById('profileAvatarBig'),

        // Setup
        lang: document.getElementById('globalLang'),
        mode: document.getElementById('gameMode'),
        voiceSelect: document.getElementById('voiceSelect'),
        btnPreviewVoice: document.getElementById('previewVoice'),
        textInput: document.getElementById('sampleText'),
        btnRandom: document.getElementById('randomTextBtn'),
        btnReset: document.getElementById('resetTextBtn'),
        btnStart: document.getElementById('startBtn'),

        // Game
        segmentBox: document.getElementById('currentSegment'),
        userInput: document.getElementById('userInput'),
        feedback: document.getElementById('liveFeedback'),
        progressFill: document.getElementById('progressFill'),
        progressText: document.getElementById('progressText'),
        fullTrans: document.getElementById('fullTranslation'),
        liveWpm: document.getElementById('liveWpm'),
        liveScore: document.getElementById('liveScore'),
        btnReplay: document.getElementById('replayBtn'),
        btnNext: document.getElementById('nextBtn'),
        btnHint: document.getElementById('hintBtn'),
        btnBack: document.getElementById('backHomeBtn'),
        micContainer: document.getElementById('micControl'),
        micBtn: document.getElementById('micBtn'),

        // Leaderboard
        lbList: document.getElementById('leaderboardList'),
        lbWeek: document.getElementById('lbWeekly'),
        lbMonth: document.getElementById('lbMonthly'),

        // Stats
        statMaxWpm: document.getElementById('statMaxWpm'),
        statGames: document.getElementById('statGames'),
        statTotalScore: document.getElementById('statTotalScore'),
        chartCanvas: document.getElementById('statsChart')
    };

    // --- SOUND SYSTEM (Web Audio API) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        
        if (type === 'click') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        }
        else if (type === 'correct') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(now); osc.stop(now + 0.15);
        }
        else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        }
        else if (type === 'success') {
            // Arpeggio
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = freq;
                g.gain.setValueAtTime(0.05, now + i*0.1);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.3);
                o.start(now + i*0.1); o.stop(now + i*0.1 + 0.3);
            });
        }
    }

    // --- PARTICLES ---
    function createParticles() {
      const container = document.getElementById('particles');
      for(let i=0; i<15; i++) {
          const p = document.createElement('div');
          p.className = 'particle';
          p.style.left = Math.random() * 100 + '%';
          p.style.width = Math.random() * 5 + 2 + 'px';
          p.style.height = p.style.width;
          p.style.animationDuration = Math.random() * 10 + 10 + 's';
          p.style.animationDelay = Math.random() * 5 + 's';
          container.appendChild(p);
      }
    }
    createParticles();

    // --- NAVIGATION LOGIC ---
    els.tabItems.forEach(item => {
        item.addEventListener('click', () => {
            playSound('click');
            els.tabItems.forEach(t => t.classList.remove('active'));
            item.classList.add('active');
            
            const target = item.dataset.target;
            els.tabContents.forEach(c => {
                if (c.id === target) {
                    c.classList.remove('hidden');
                    c.classList.add('animate__fadeIn');
                } else {
                    c.classList.add('hidden');
                }
            });
            if (target === 'tabLeaderboard') fetchLeaderboard('weekly');
            if (target === 'tabProfile') renderChart();
        });
    });

    els.btnBack.addEventListener('click', () => {
        document.querySelector('[data-target="tabHome"]').click();
        stopGame();
    });

    // --- AUTH LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            els.modal.classList.remove('show');
            const name = user.displayName || "·∫®n danh";
            const ava = user.photoURL || `https://ui-avatars.com/api/?name=${name}`;
            
            els.headerName.textContent = name;
            els.headerAvatar.src = ava;
            els.profileName.textContent = name;
            els.profileAvatar.src = ava;

            // Sync Profile
            set(ref(db, 'users/' + user.uid + '/profile'), {
                name: name, photo: ava, lastLogin: new Date().toISOString()
            });

            loadUserHistory(user.uid);
        } else {
            currentUser = null;
            els.modal.classList.add('show');
        }
    });

    els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider));
    els.btnSkip.addEventListener('click', () => signInAnonymously(auth));
    els.btnLogout.addEventListener('click', () => signOut(auth));

    // --- HELPER FUNCTIONS ---
    function getWeekId() {
        const d = new Date();
        const onejan = new Date(d.getFullYear(), 0, 1);
        const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
        return `${d.getFullYear()}-W${week}`;
    }
    function getMonthId() { const d = new Date(); return `${d.getFullYear()}-M${d.getMonth() + 1}`; }

    // --- DATABASE ---
    function loadUserHistory(uid) {
        onValue(ref(db, `users/${uid}/stats`), (snap) => {
            const stats = snap.val() || { maxWPM: 0, totalScore: 0, games: 0 };
            els.statMaxWpm.textContent = stats.maxWPM;
            els.statGames.textContent = stats.games;
            els.statTotalScore.textContent = stats.totalScore;
        });

        const historyRef = query(ref(db, `history/${uid}`), limitToLast(10));
        onValue(historyRef, (snapshot) => {
            const data = snapshot.val();
            personalHistory = data ? Object.values(data) : [];
        });
    }

    // --- FANCY LEADERBOARD RENDER ---
    function fetchLeaderboard(type) {
        const timeId = type === 'weekly' ? getWeekId() : getMonthId();
        const lbPath = `leaderboard/${type}/${timeId}`;
        
        els.lbList.innerHTML = '<div style="text-align:center; padding:20px;">ƒêang t·∫£i...</div>';

        get(ref(db, lbPath)).then(snapshot => {
            const data = snapshot.val();
            if (!data) {
                els.lbList.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>';
                return;
            }

            const arr = Object.keys(data).map(uid => ({
                uid, score: data[uid].score, details: data[uid].details
            })).sort((a, b) => b.score - a.score).slice(0, 20);

            let html = '';
            arr.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                const animDelay = index * 0.1;
                
                html += `
                    <div class="lb-item ${rankClass} animate__animated animate__fadeInUp" style="animation-delay:${animDelay}s">
                        <div class="rank-badge">${rank <= 3 ? '<i class="fas fa-crown"></i>' : rank}</div>
                        <div class="player-info">
                            <img src="${item.details.photo || 'https://ui-avatars.com/api/?name=User'}" class="player-avatar">
                            <span class="player-name">${item.details.name}</span>
                        </div>
                        <div class="score-info">
                            <div class="score-main">${item.score}</div>
                            <div class="score-sub">${item.details.wpm} WPM</div>
                        </div>
                    </div>
                `;
            });
            els.lbList.innerHTML = html;
        });
    }

    els.lbWeek.addEventListener('click', () => { els.lbWeek.classList.add('active'); els.lbMonth.classList.remove('active'); fetchLeaderboard('weekly'); playSound('click'); });
    els.lbMonth.addEventListener('click', () => { els.lbMonth.classList.add('active'); els.lbWeek.classList.remove('active'); fetchLeaderboard('monthly'); playSound('click'); });

    // --- CHART ---
    function renderChart() {
        const ctx = els.chartCanvas.getContext('2d');
        if (window.myChart) window.myChart.destroy();
        
        const labels = personalHistory.map((_, i) => i + 1);
        const data = personalHistory.map(h => h.wpm);
        
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'WPM',
                    data: data,
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { display: false } },
                    y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- GAME ENGINE ---
    const LIBRARY = {
        'vi-VN': ["TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.", "S√¥ng n√∫i n∆∞·ªõc Nam vua Nam ·ªü. R√†nh r√†nh ƒë·ªãnh ph·∫≠n t·∫°i s√°ch tr·ªùi.", "C√¥ng cha nh∆∞ n√∫i Th√°i S∆°n. Nghƒ©a m·∫π nh∆∞ n∆∞·ªõc trong ngu·ªìn ch·∫£y ra."],
        'en-US': ["The quick brown fox jumps over the lazy dog.", "To be, or not to be, that is the question."],
        'es-ES': ["En un lugar de la Mancha, de cuyo nombre no quiero acordarme."]
    };

    function loadVoices() {
        const lang = els.lang.value;
        const voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(lang.split('-')[0]));
        els.voiceSelect.innerHTML = voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    els.lang.addEventListener('change', loadVoices);

    els.btnRandom.addEventListener('click', () => {
        const lib = LIBRARY[els.lang.value] || LIBRARY['vi-VN'];
        els.textInput.value = lib[Math.floor(Math.random() * lib.length)];
        playSound('click');
        els.btnReset.style.display = 'inline-flex';
    });
    els.btnReset.addEventListener('click', () => { els.textInput.value = ''; els.btnReset.style.display = 'none'; });

    els.btnStart.addEventListener('click', () => {
        const text = els.textInput.value.trim();
        if(!text) return alert("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!");
        
        segments = text.split(/(?<=[.!?])\s+/).filter(s => s.trim());
        if(segments.length === 0) segments = [text];
        
        playSound('success'); // Start sound
        
        // Switch Tab
        els.tabContents.forEach(c => c.classList.add('hidden'));
        document.getElementById('tabPractice').classList.remove('hidden');
        
        startGame();
    });

    function startGame() {
        currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; startTime = Date.now();
        const mode = els.mode.value;
        
        els.micContainer.classList.toggle('hidden', mode !== 'read-only');
        els.userInput.style.display = mode === 'read-only' ? 'none' : 'block';
        els.userInput.focus();
        
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const m = (Date.now() - startTime) / 1000 / 60;
            const wpm = m > 0 ? Math.round(typedWords / m) : 0;
            els.liveWpm.textContent = wpm;
            els.liveScore.textContent = Math.round(wpm * 2 + (totalCorrectWords/ (typedWords || 1)) * 100);
        }, 1000);
        
        showSegment();
    }

    function stopGame() {
        clearInterval(timerInterval);
        if(recognition) recognition.stop();
        speechSynthesis.cancel();
    }

    function showSegment() {
        const text = segments[currentIdx];
        const mode = els.mode.value;
        
        // Reset UI
        els.userInput.value = ''; 
        els.userInput.classList.remove('correct-input', 'error-input');
        els.btnNext.disabled = true;
        els.btnNext.style.background = 'var(--glass-bg)';
        els.feedback.innerHTML = '...';
        
        // Render Karaoke
        els.segmentBox.innerHTML = text.split(' ').map((w, i) => `<span class="karaoke-word" id="word-${i}">${w} </span>`).join('');
        
        // Translation (Fake async)
        if(els.lang.value !== 'vi-VN') {
            els.fullTrans.textContent = "ƒêang d·ªãch...";
            fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${els.lang.value.split('-')[0]}|vi`)
            .then(r => r.json()).then(d => els.fullTrans.textContent = d.responseData.translatedText || text);
        } else els.fullTrans.textContent = '';

        if(mode.includes('listen') || mode === 'read-only') {
            setTimeout(() => speak(text), 500);
        }
    }

    function speak(text) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = els.lang.value;
        const vName = els.voiceSelect.value;
        if(vName) u.voice = speechSynthesis.getVoices().find(v => v.name === vName);
        
        u.onboundary = (e) => {
            if(e.name === 'word') {
                const words = text.substring(0, e.charIndex).split(' ').length;
                document.querySelectorAll('.karaoke-word').forEach(el => el.classList.remove('karaoke-active'));
                const target = document.getElementById(`word-${words}`);
                if(target) target.classList.add('karaoke-active');
            }
        };
        speechSynthesis.speak(u);
    }

    function checkInput() {
        const target = segments[currentIdx];
        const input = els.userInput.value;
        const normTarget = target.replace(/[.,!?;]/g, '').toLowerCase().trim();
        const normInput = input.replace(/[.,!?;]/g, '').toLowerCase().trim();
        
        // Basic feedback logic
        if(normTarget.startsWith(normInput)) {
            els.userInput.style.borderColor = 'var(--success)';
            if(input.endsWith(' ')) playSound('correct'); 
        } else {
            els.userInput.style.borderColor = 'var(--danger)';
        }

        if(normInput === normTarget) {
            playSound('success');
            els.btnNext.disabled = false;
            els.btnNext.style.background = 'var(--success)';
            els.feedback.innerHTML = '<span class="correct">Ch√≠nh x√°c! Tuy·ªát v·ªùi.</span>';
            
            // Stats update
            const wc = target.split(' ').length;
            typedWords += wc;
            totalCorrectWords += wc;
            
            // Progress
            const pct = Math.round(((currentIdx + 1) / segments.length) * 100);
            els.progressFill.style.width = pct + '%';
            els.progressText.textContent = pct + '%';
        }
    }

    els.userInput.addEventListener('input', checkInput);
    els.btnNext.addEventListener('click', () => {
        currentIdx++;
        if(currentIdx >= segments.length) finishGame();
        else showSegment();
    });
    els.btnReplay.addEventListener('click', () => speak(segments[currentIdx]));
    els.btnHint.addEventListener('click', () => {
        const words = segments[currentIdx].split(' ');
        const inputWords = els.userInput.value.trim().split(' ');
        if(inputWords.length < words.length) {
            els.userInput.value += (els.userInput.value ? ' ' : '') + words[inputWords.length - (els.userInput.value ? 0 : 1)];
            checkInput();
        }
    });

    // Mic Logic
    els.micBtn.addEventListener('click', () => {
        if(!recognition) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£!");
            recognition = new SR();
            recognition.lang = els.lang.value;
            recognition.continuous = false;
            recognition.interimResults = true;
            
            recognition.onresult = (e) => {
                const trans = Array.from(e.results).map(r => r[0].transcript).join('');
                els.feedback.textContent = trans;
                if(e.results[0].isFinal) {
                    const normTrans = trans.toLowerCase().replace(/[.,!?]/g, '');
                    const normTarget = segments[currentIdx].toLowerCase().replace(/[.,!?]/g, '');
                    if(normTrans.includes(normTarget) || normTarget.includes(normTrans)) {
                        playSound('success');
                        els.btnNext.disabled = false;
                        els.btnNext.style.background = 'var(--success)';
                    }
                }
            };
            recognition.onend = () => { isListening = false; els.micBtn.classList.remove('listening'); };
        }
        
        if(isListening) { recognition.stop(); }
        else { recognition.start(); isListening = true; els.micBtn.classList.add('listening'); }
    });

    function finishGame() {
        stopGame();
        playSound('success');
        const finalWpm = parseInt(els.liveWpm.textContent);
        const finalScore = parseInt(els.liveScore.textContent);
        
        if(currentUser) {
            // Save to History
            push(ref(db, `history/${currentUser.uid}`), {
                date: new Date().toISOString(), wpm: finalWpm, score: finalScore
            });
            // Update Max
            get(ref(db, `users/${currentUser.uid}/stats`)).then(s => {
                const stats = s.val() || { maxWPM: 0, totalScore: 0, games: 0 };
                set(ref(db, `users/${currentUser.uid}/stats`), {
                    games: stats.games + 1,
                    totalScore: stats.totalScore + finalScore,
                    maxWPM: Math.max(stats.maxWPM, finalWpm)
                });
                // Leaderboard
                const wId = getWeekId(); const mId = getMonthId();
                const updateLB = (path) => {
                    get(ref(db, path)).then(snap => {
                        if((snap.val() || 0) < finalScore) {
                            set(ref(db, path), finalScore);
                            set(ref(db, path.replace('score', 'details')), {
                                name: currentUser.displayName, photo: currentUser.photoURL, wpm: finalWpm
                            });
                        }
                    });
                }
                updateLB(`leaderboard/weekly/${wId}/${currentUser.uid}/score`);
                updateLB(`leaderboard/monthly/${mId}/${currentUser.uid}/score`);
            });
        }

        alert(`Ho√†n th√†nh!\nWPM: ${finalWpm}\nƒêi·ªÉm: ${finalScore}`);
        document.querySelector('[data-target="tabLeaderboard"]').click();
    }

    // Init
    loadVoices();
  </script>
</body>
</html>
