<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xuân Hải - Luyện Chính Tả</title>
  <meta name="description" content="Luyện gõ chính tả với giọng đọc tùy chỉnh, nghe thử trước, AI tự động, xếp hạng toàn cầu.">
  <meta name="theme-color" content="#10b981">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgMjAgTDMwIDQwIEw0MCA1MCBMMzAgNjAgTTUwIDgwIEw3MCA2MCBMNjAgNTAgTDcwIDQwIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwYjk4MSIgc3Ryb2tlLXdpZHRoPSI4Ii8+PC9zdmc+">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgMjAgTDMwIDQwIEw0MCA1MCBMMzAgNjAgTTUwIDgwIEw3MCA2MCBMNjAgNTAgTDcwIDQwIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwYjk4MSIgc3Ryb2tlLXdpZHRoPSI4Ii8+PC9zdmc+">

  <!-- Font & Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
      --primary: #10b981; --primary-light: #34d399; --success: #10b981; --warning: #f59e0b;
      --danger: #ef4444; --hint: #8b5cf6; --glass: rgba(255, 255, 255, 0.7);
      --shadow: 0 20px 40px rgba(0,0,0,0.08); --radius: 28px;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-muted: #94a3b8; --border: #334155;
      --primary: #34d399; --primary-light: #6ee7b7; --glass: rgba(30, 41, 59, 0.6);
      --shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: var(--text); min-height: 100vh; padding: 24px; transition: var(--transition); }
    .container { max-width: 1300px; margin: 0 auto; display: flex; flex-direction: column; gap: 28px; min-height: 100vh; }

    /* HEADER */
    header { background: var(--card); border-radius: var(--radius); padding: 36px 32px; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); backdrop-filter: blur(12px); position: relative; overflow: hidden; min-height: 180px; }
    header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7); }
    .logo { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
    .logo svg { width: 64px; height: 64px; fill: var(--primary); flex-shrink: 0; }
    .logo h1 { font-size: 2.8rem; font-weight: 700; background: linear-gradient(90deg, #10b981, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; line-height: 1.2; }
    header p { color: var(--text-muted); font-size: 1.25rem; font-weight: 500; margin-top: 8px; }
    .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--glass); border: 1px solid var(--border); width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); z-index: 10; }
    .theme-toggle:hover { transform: scale(1.1); }

    /* TAB NAV */
    .tab-nav { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
    .tab-btn { padding: 12px 24px; background: var(--glass); border: 1px solid var(--border); border-radius: 16px; font-weight: 600; cursor: pointer; transition: var(--transition); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* NAME INPUT */
    .name-input { margin-bottom: 20px; text-align: center; }
    .name-input input { padding: 12px 16px; width: 240px; border: 2px solid var(--border); border-radius: 12px; font-size: 1.1rem; text-align: center; }

    /* SETUP PANEL */
    .setup-panel { background: var(--card); border-radius: var(--radius); padding: 40px 36px; box-shadow: var(--shadow); border: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 32px; min-height: 420px; }
    @media (max-width: 900px) { .setup-panel { grid-template-columns: 1fr; } }
    .setup-card { background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; padding: 24px; border: 1px solid var(--border); transition: var(--transition); }
    .setup-card:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(16, 185, 129, 0.15); }
    .setup-card h3 { display: flex; align-items: center; gap: 14px; color: var(--primary); font-weight: 600; margin-bottom: 18px; font-size: 1.2rem; }
    .setup-card h3 svg { width: 26px; height: 26px; fill: var(--primary); }
    select, textarea { width: 100%; padding: 16px 18px; border: 2px solid var(--border); border-radius: 16px; font-size: 1.1rem; background: var(--card); color: var(--text); transition: var(--transition); }
    select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.2); }
    .radio-group { display: grid; gap: 14px; }
    .radio-item { display: flex; align-items: center; gap: 14px; padding: 16px; border-radius: 14px; background: var(--glass); border: 1px solid var(--border); cursor: pointer; transition: var(--transition); font-size: 1.05rem; }
    .radio-item:hover { background: rgba(16, 185, 129, 0.1); border-color: var(--primary); }
    .radio-item input { accent-color: var(--primary); }
    .start-btn { grid-column: 1 / -1; margin-top: 20px; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; font-weight: 700; font-size: 1.3rem; border-radius: 18px; border: none; cursor: pointer; box-shadow: 0 10px 24px rgba(16, 185, 129, 0.35); transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 14px; }
    .start-btn:hover { transform: translateY(-4px); box-shadow: 0 14px 32px rgba(16, 185, 129, 0.45); }

    /* AI GENERATOR BUTTON */
    .ai-generator {
      background: linear-gradient(135deg, #7c3aed, #c4b5fd);
      color: white; padding: 18px; border-radius: 18px; text-align: center;
      cursor: pointer; font-weight: 700; margin-top: 16px; box-shadow: 0 8px 20px rgba(139,92,246,0.3);
      transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 12px;
    }
    .ai-generator:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(139,92,246,0.4); }
    .ai-generator svg { width: 28px; height: 28px; fill: white; }

    /* AI MODAL */
    .ai-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .ai-modal.show { opacity: 1; pointer-events: auto; }
    .ai-modal-content { background: var(--card); border-radius: var(--radius); padding: 32px; width: 90%; max-width: 600px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
    .ai-close { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted); }
    .ai-input-group { margin-bottom: 20px; }
    .ai-input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
    .ai-input-group input, .ai-input-group select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 14px; font-size: 1.1rem; }
    .ai-generate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #7c3aed, #c4b5fd); color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 1.2rem; cursor: pointer; margin-top: 16px; }
    .ai-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* VOICE PREVIEW BUTTON */
    .voice-preview {
      display: flex; align-items: center; gap: 8px; margin-top: 8px;
      padding: 10px 14px; background: var(--glass); border-radius: 12px;
      font-size: 0.95rem; cursor: pointer; transition: var(--transition);
    }
    .voice-preview:hover { background: rgba(16, 185, 129, 0.15); }
    .voice-preview svg { width: 20px; height: 20px; fill: var(--primary); }

    /* PRACTICE AREA */
    #practiceArea { background: var(--card); border-radius: var(--radius); padding: 36px; box-shadow: var(--shadow); border: 1px solid var(--border); flex: 1; display: flex; flex-direction: column; gap: 28px; }
    .progress-container { background: var(--glass); padding: 18px; border-radius: 18px; border: 1px solid var(--border); }
    .progress-bar { height: 18px; background: var(--border); border-radius: 9px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); width: 0; border-radius: 9px; transition: width 0.5s ease; }
    .segment-box { background: var(--glass); backdrop-filter: blur(12px); padding: 32px; border-radius: 22px; border: 2px dashed var(--primary); font-size: 1.5rem; line-height: 1.9; text-align: center; min-height: 140px; color: var(--text); font-weight: 500; }
    .segment-box.listening { color: var(--text-muted); font-style: italic; border-style: dashed; background: rgba(16, 185, 129, 0.05); }
    .input-area { position: relative; margin: 24px 0; }
    #userInput { width: 100%; padding: 20px 70px 20px 24px; font-size: 1.4rem; border: 3px solid var(--border); border-radius: 20px; background: var(--card); color: var(--text); transition: var(--transition); }
    #userInput:focus { border-color: var(--primary); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.25); }
    .hint-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: var(--hint); color: white; width: 52px; height: 52px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 6px 18px rgba(139, 92, 246, 0.35); transition: var(--transition); }
    .hint-btn:hover { transform: translateY(-50%) scale(1.12); }
    #liveFeedback { margin-top: 18px; padding: 18px; background: var(--glass); border-radius: 18px; border: 1px solid var(--border); font-family: 'Courier New', monospace; font-size: 1.25rem; min-height: 60px; white-space: pre-wrap; word-break: break-word; }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; }
    .action-bar { display: flex; flex-wrap: wrap; gap: 18px; justify-content: center; margin: 32px 0; }
    .action-btn { padding: 16px 32px; border: none; border-radius: 18px; font-weight: 600; font-size: 1.15rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 12px; min-width: 150px; justify-content: center; }
    .btn-replay { background: var(--warning); color: white; }
    .btn-hint { background: var(--hint); color: white; }
    .btn-next { background: var(--primary); color: white; }
    .btn-reset { background: var(--danger); color: white; }
    .action-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.22); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 18px; margin-top: 24px; }
    .stat-card { background: var(--glass); backdrop-filter: blur(10px); padding: 22px; border-radius: 20px; text-align: center; border: 1px solid var(--border); }
    .stat-card h4 { font-size: 1rem; color: var(--text-muted); margin-bottom: 10px; }
    .stat-card .value { font-size: 2.2rem; font-weight: 700; color: var(--primary); }
    .level-badge { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: 32px; font-weight: 700; font-size: 1.1rem; background: linear-gradient(135deg, #10b981, #34d399); color: white; margin: 24px auto; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35); }
    .level-1 { background: linear-gradient(135deg, #94a3b8, #cbd5e1); }
    .level-2 { background: linear-gradient(135deg, #fbbf24, #fde68a); }
    .level-3 { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
    .level-4 { background: linear-gradient(135deg, #10b981, #34d399); }
    .level-5 { background: linear-gradient(135deg, #8b5cf6, #c4b5fd); }
    canvas { margin-top: 28px; border-radius: 20px; background: var(--card); padding: 22px; border: 1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

    .rank-badge { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; margin-left: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
    .rank-badge.bronze { background: linear-gradient(135deg, #cd7f32, #a97142); }
    .rank-badge.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); }
    .rank-badge.gold { background: linear-gradient(135deg, #ffd700, #ffb700); }
    .rank-badge.emerald { background: linear-gradient(135deg, #10b981, #34d399); }
    .rank-badge.diamond { background: linear-gradient(135deg, #8b5cf6, #c4b5fd); animation: shine 1.5s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes shine { 0% { box-shadow: 0 0 10px #fff; } 50% { box-shadow: 0 0 20px #fff, 0 0 30px #8b5cf6; } 100% { box-shadow: 0 0 10px #fff; } }

    .final-badge { display: flex; flex-direction: column; align-items: center; margin: 20px 0; animation: bounceIn 1s ease-out; }
    @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.1); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }

    .ranking-panel { background: var(--card); border-radius: var(--radius); padding: 32px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .ranking-tabs { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center; }
    .ranking-tab { padding: 10px 20px; background: var(--glass); border-radius: 12px; font-weight: 600; cursor: pointer; transition: var(--transition); }
    .ranking-tab.active { background: var(--primary); color: white; }
    .ranking-list { display: grid; gap: 16px; }
    .rank-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--glass); border-radius: 16px; border: 1px solid var(--border); }
    .rank-position { font-size: 1.5rem; font-weight: 700; color: var(--primary); width: 50px; text-align: center; }
    .rank-medal { font-size: 1.8rem; }
    .rank-info { flex: 1; display: flex; align-items: center; gap: 8px; }
    .rank-name { font-weight: 600; font-size: 1.1rem; }
    .rank-score { color: var(--primary); font-weight: 700; }

    .hidden { display: none !important; }
    .install-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; z-index: 1000; border: 1px solid var(--border); max-width: 90%; font-size: 1rem; }
    .install-banner button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div class="logo">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <path d="M50 20 L30 40 L40 50 L30 60 L50 80 L70 60 L60 50 L70 40 Z" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <path d="M25 45 Q20 50 25 55 M75 45 Q80 50 75 55" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <path d="M35 35 Q30 30 35 25 M65 35 Q70 30 65 25" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <rect x="38" y="48" width="24" height="3" rx="1.5" fill="currentColor"/>
          <rect x="38" y="53" width="18" height="3" rx="1.5" fill="currentColor"/>
          <rect x="38" y="58" width="20" height="3" rx="1.5" fill="currentColor"/>
        </svg>
        <h1>Xuân Hải</h1>
      </div>
      <p>Luyện Chính Tả - Đúng chữ đúng lời, viết nên tương lai.</p>
      <button class="theme-toggle" id="themeToggle">
        <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg>
      </button>
    </header>

    <!-- TAB NAVIGATION -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="setup">Luyện Tập</button>
      <button class="tab-btn" data-tab="ranking">Xếp Hạng</button>
    </div>

    <!-- NAME INPUT -->
    <div class="name-input">
      <input type="text" id="playerName" placeholder="Nhập tên của bạn..." maxlength="20" />
    </div>

    <!-- SETUP PANEL -->
    <div id="setupPanel" class="tab-content">
      <div class="setup-card">
        <h3>Ngôn ngữ toàn cục</h3>
        <select id="globalLanguage">
          <option value="vi-VN">Tiếng Việt</option>
          <option value="en-US">Tiếng Anh</option>
          <option value="id-ID">Tiếng Indonesia</option>
        </select>
      </div>

      <div class="setup-card">
        <h3>Chọn chế độ</h3>
        <div class="radio-group">
          <label class="radio-item"><input type="radio" name="mode" value="read-write" checked> Đọc - Viết</label>
          <label class="radio-item"><input type="radio" name="mode" value="listen-write"> Nghe - Viết</label>
          <label class="radio-item"><input type="radio" name="mode" value="read-listen-write"> Đọc + Nghe</label>
        </div>
      </div>

      <div class="setup-card" style="grid-column:1/-1;">
        <h3>Đoạn văn luyện tập</h3>
        <textarea id="sampleText" rows="5" placeholder="Dán hoặc nhập đoạn văn cần luyện..."></textarea>
        <div class="ai-generator" id="openAiModal">
          <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1 17h2v-2h-2v2zm2-4h-2V7h2v8z"/></svg>
          Tạo đoạn văn
        </div>
        <button class="start-btn" id="startBtn">Bắt đầu luyện tập ngay</button>
      </div>
    </div>

    <!-- AI MODAL -->
    <div class="ai-modal" id="aiModal">
      <div class="ai-modal-content">
        <button class="ai-close" id="closeAiModal">×</button>
        <h3 style="text-align:center; margin-bottom:24px; color:var(--primary);">Tạo Đoạn Văn</h3>
        <div class="ai-input-group">
          <label>Chủ đề</label>
          <input type="text" id="aiTopic" placeholder="Ví dụ: Môi trường, Công nghệ, Gia đình..." />
        </div>
        <div class="ai-input-group">
          <label>Số câu</label>
          <select id="aiSentences">
            <option value="3">3 câu (ngắn)</option>
            <option value="5" selected>5 câu (trung bình)</option>
            <option value="8">8 câu (dài)</option>
          </select>
        </div>
        <div class="ai-input-group">
          <label>Giọng đọc</label>
          <select id="aiVoice"></select>
          <div class="voice-preview" id="previewVoice">
            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            Nghe thử giọng này
          </div>
        </div>
        <div class="ai-input-group">
          <label>Tốc độ</label>
          <select id="aiRate">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1.0x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2.0x</option>
          </select>
        </div>
        <button class="ai-generate-btn" id="generateAiBtn">Tạo ngay</button>
        <div id="aiResult" style="margin-top:20px; padding:16px; background:var(--glass); border-radius:14px; min-height:60px; display:none;"></div>
      </div>
    </div>

    <!-- PRACTICE AREA -->
    <div id="practiceArea" class="tab-content hidden">
      <div class="progress-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-weight:600; font-size:1.1rem;">
          <span>Tiến độ</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="input-area">
        <input type="text" id="userInput" placeholder="Gõ lại đoạn văn ở đây..." />
        <button class="hint-btn" id="hintBtn">?</button>
      </div>
      <div id="liveFeedback"><em>Nhập để bắt đầu...</em></div>

      <div class="action-bar">
        <button class="action-btn btn-replay" id="replayBtn">Nghe lại</button>
        <button class="action-btn btn-hint" id="showHintBtn">Gợi ý</button>
        <button class="action-btn btn-next" id="nextBtn">Tiếp theo</button>
        <button class="action-btn btn-reset" id="resetBtn">Làm lại</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><h4>Thời gian</h4><div class="value" id="time">0s</div></div>
        <div class="stat-card"><h4>Tốc độ (WPM)</h4><div class="value" id="wpm">0</div></div>
        <div class="stat-card"><h4>Độ chính xác</h4><div class="value" id="accuracy">100%</div></div>
        <div class="stat-card"><h4>Cấp độ</h4><div class="value" id="level">Mới bắt đầu</div></div>
      </div>

      <div style="text-align:center;">
        <div class="level-badge level-1" id="levelBadge">Mới bắt đầu</div>
        <div style="margin-top:14px; color:var(--text-muted); font-size:1.1rem;">
          Điểm: <strong id="score" style="color:var(--primary); font-size:1.5rem;">0</strong>
        </div>
      </div>

      <canvas id="progressChart"></canvas>
    </div>

    <!-- FINAL RESULT -->
    <div id="finalResult" class="hidden" style="text-align:center; margin-top:32px;">
      <div class="final-badge">
        <div id="finalBadge" class="rank-badge bronze">Seedling</div>
        <h3 id="finalLevel" style="margin-top:12px; font-size:1.8rem; color:var(--primary);">Mới bắt đầu</h3>
      </div>
      <p style="font-size:1.2rem; margin:16px 0;">Bạn đã đạt <strong id="finalScore">0</strong> điểm!</p>
    </div>

    <!-- RANKING PANEL -->
    <div id="rankingPanel" class="tab-content hidden">
      <div class="ranking-panel">
        <div class="ranking-tabs">
          <button class="ranking-tab active" data-rank="all">Tất Cả</button>
          <button class="ranking-tab" data-rank="week">Tuần Này</button>
          <button class="ranking-tab" data-rank="month">Tháng Này</button>
        </div>
        <div id="rankingList" class="ranking-list"></div>
      </div>
    </div>
  </div>

  <!-- PWA Install Banner -->
  <div class="install-banner hidden" id="installBanner">
    <span>Thêm vào màn hình chính để dùng như app!</span>
    <button id="installBtn">Cài đặt</button>
  </div>

  <script>
    // === FIREBASE & GROQ ===
    const firebaseConfig = { apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc", authDomain: "xh-chinhta.firebaseapp.com", databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com", projectId: "xh-chinhta", storageBucket: "xh-chinhta.firebasestorage.app", messagingSenderId: "535611478192", appId: "1:535611478192:web:c45475177c8dcef8ef6b75" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const GROQ_API_KEY = "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";
    const GROQ_MODEL = "llama-3.3-70b-versatile";

    // === NGÔN NGỮ TOÀN CỤC ===
    const globalLangSelect = document.getElementById('globalLanguage');
    let globalLang = localStorage.getItem('globalLang') || 'vi-VN';
    globalLangSelect.value = globalLang;
    globalLangSelect.addEventListener('change', () => {
      globalLang = globalLangSelect.value;
      localStorage.setItem('globalLang', globalLang);
      loadVoices();
    });

    // === GIỌNG ĐỌC & TỐC ĐỘ ===
    let voices = [], selectedVoice = null, speechRate = 1;
    const voiceSelect = document.getElementById('aiVoice');
    const rateSelect = document.getElementById('aiRate');
    const previewBtn = document.getElementById('previewVoice');

    function loadVoices() {
      voices = speechSynthesis.getVoices().filter(v => v.lang.includes(globalLang.split('-')[0]));
      voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>Không có giọng</option>';
      if (voices.length > 0) {
        const saved = localStorage.getItem('selectedVoice');
        const voice = voices.find(v => v.name === saved) || voices[0];
        voiceSelect.value = voice.name;
        selectedVoice = voice;
      }
    }
    voiceSelect.addEventListener('change', () => {
      selectedVoice = voices.find(v => v.name === voiceSelect.value);
      localStorage.setItem('selectedVoice', selectedVoice.name);
    });
    rateSelect.addEventListener('change', () => speechRate = parseFloat(rateSelect.value));
    previewBtn.addEventListener('click', () => {
      if (selectedVoice) {
        const test = globalLang === 'vi-VN' ? 'Xin chào, đây là giọng đọc thử.' : globalLang === 'en-US' ? 'Hello, this is a voice preview.' : 'Halo, ini adalah pratinjau suara.';
        speak(test);
      }
    });
    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 100);

    function speak(text) {
      if ('speechSynthesis' in window && selectedVoice) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = selectedVoice;
        utterance.rate = speechRate;
        utterance.lang = globalLang;
        window.speechSynthesis.speak(utterance);
      }
    }

    // === AI MODAL + TỰ ĐỘNG ĐIỀN ===
    const aiModal = document.getElementById('aiModal');
    const openAiModal = document.getElementById('openAiModal');
    const closeAiModal = document.getElementById('closeAiModal');
    const generateAiBtn = document.getElementById('generateAiBtn');
    const aiResult = document.getElementById('aiResult');
    const sampleText = document.getElementById('sampleText');

    openAiModal.onclick = () => { aiModal.classList.add('show'); loadVoices(); };
    closeAiModal.onclick = () => aiModal.classList.remove('show');
    aiModal.onclick = (e) => { if (e.target === aiModal) aiModal.classList.remove('show'); };

    generateAiBtn.onclick = async () => {
      const topic = document.getElementById('aiTopic').value.trim() || "một chủ đề thú vị";
      const sentences = document.getElementById('aiSentences').value;
      const langName = globalLang === 'vi-VN' ? 'Tiếng Việt' : globalLang === 'en-US' ? 'Tiếng Anh' : 'Tiếng Indonesia';
      const prompt = `Viết một đoạn văn ngắn ${langName} khoảng ${sentences} câu về chủ đề: "${topic}". Chỉ trả về đoạn văn, không giải thích.`;

      generateAiBtn.disabled = true;
      generateAiBtn.textContent = "Đang tạo...";
      aiResult.style.display = 'none';

      try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: GROQ_MODEL, messages: [{ role: "user", content: prompt }], max_tokens: 800, temperature: 0.7 })
        });

        if (!res.ok) throw new Error(`Lỗi ${res.status}`);
        const data = await res.json();
        const text = data.choices?.[0]?.message?.content?.trim() || "Không tạo được nội dung.";

        sampleText.value = text;
        aiResult.textContent = text;
        aiResult.style.display = 'block';
        aiModal.classList.remove('show');
        alert("Đoạn văn đã được tạo và tự động điền!");
      } catch (err) {
        aiResult.textContent = `Lỗi: ${err.message}`;
        aiResult.style.display = 'block';
      } finally {
        generateAiBtn.disabled = false;
        generateAiBtn.textContent = "Tạo ngay";
      }
    };

    // === TÊN NGƯỜI CHƠI ===
    const playerNameInput = document.getElementById('playerName');
    let playerName = localStorage.getItem('playerName') || '';
    playerNameInput.value = playerName;
    playerNameInput.addEventListener('change', () => {
      playerName = playerNameInput.value.trim() || 'Người chơi ẩn danh';
      localStorage.setItem('playerName', playerName);
    });

    // === PWA ===
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBanner.classList.remove('hidden'); });
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') installBanner.classList.add('hidden');
      deferredPrompt = null;
    });

    // === TAB NAVIGATION ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(btn.dataset.tab + 'Panel').classList.remove('hidden');
      });
    });

    // === HUY HIỆU, XẾP HẠNG, LUYỆN TẬP (HOÀN CHỈNH) ===
    const BADGES = [
      { name: "Mới bắt đầu", icon: "Seedling", class: "bronze", min: 0 },
      { name: "Trung bình", icon: "Leaf", class: "silver", min: 50 },
      { name: "Khá", icon: "Trophy", class: "gold", min: 100 },
      { name: "Giỏi", icon: "Gem", class: "emerald", min: 200 },
      { name: "Xuất sắc", icon: "Crown", class: "diamond", min: 350 }
    ];

    function getBadge(wpm) {
      for (let i = BADGES.length - 1; i >= 0; i--) if (wpm >= BADGES[i].min) return BADGES[i];
      return BADGES[0];
    }

    function createBadgeElement(badge) {
      const el = document.createElement('div');
      el.className = `rank-badge ${badge.class}`;
      el.textContent = badge.icon;
      el.title = badge.name;
      return el;
    }

    function uploadScore(score, wpm) {
      if (!playerName) playerName = 'Người chơi ẩn danh';
      const now = new Date();
      const record = { name: playerName, score, wpm, timestamp: now.toISOString(), week: `${now.getFullYear()}-W${String(Math.ceil((now.getDate() + now.getDay()) / 7)).padStart(2, '0')}`, month: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}` };
      db.ref('scores').push(record);
    }

    function loadRanking(type = 'all') {
      const list = document.getElementById('rankingList');
      list.innerHTML = '<p>Đang tải...</p>';
      let query = db.ref('scores').orderByChild('score').limitToLast(10);
      if (type === 'week') {
        const now = new Date();
        const week = `${now.getFullYear()}-W${String(Math.ceil((now.getDate() + now.getDay()) / 7)).padStart(2, '0')}`;
        query = db.ref('scores').orderByChild('week').equalTo(week).orderByChild('score').limitToLast(10);
      } else if (type === 'month') {
        const now = new Date();
        const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        query = db.ref('scores').orderByChild('month').equalTo(month).orderByChild('score').limitToLast(10);
      }

      query.once('value', snapshot => {
        const data = snapshot.val();
        const entries = data ? Object.values(data).reverse() : [];
        list.innerHTML = entries.length ? '' : '<p>Chưa có người chơi nào!</p>';
        entries.forEach((entry, i) => {
          const badge = getBadge(entry.wpm || 0);
          const medal = i === 0 ? '1st place medal' : i === 1 ? '2nd place medal' : i === 2 ? '3rd place medal' : `${i + 1}`;
          const item = document.createElement('div');
          item.className = 'rank-item';
          item.innerHTML = `
            <div class="rank-position"><span class="rank-medal">${medal}</span></div>
            <div class="rank-info">
              <div class="rank-name">${entry.name}</div>
              ${createBadgeElement(badge).outerHTML}
            </div>
            <div class="rank-score">${entry.score} điểm (${entry.wpm} WPM)</div>
          `;
          list.appendChild(item);
        });
      });
    }

    document.querySelectorAll('.ranking-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        loadRanking(tab.dataset.rank);
      });
    });
    loadRanking();

    // === LOGIC LUYỆN TẬP ===
    let segments = [], currentIdx = 0, startTime, timer;
    let typedWords = 0, correctWords = 0, hintsUsed = 0;
    let history = JSON.parse(localStorage.getItem('xuanHaiDictation') || '[]');
    let chart;

    const startBtn = document.getElementById('startBtn');
    const setupPanel = document.getElementById('setupPanel');
    const practiceArea = document.getElementById('practiceArea');
    const currentSegment = document.getElementById('currentSegment');
    const userInput = document.getElementById('userInput');
    const liveFeedback = document.getElementById('liveFeedback');
    const hintBtn = document.getElementById('hintBtn');
    const showHintBtn = document.getElementById('showHintBtn');
    const replayBtn = document.getElementById('replayBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const timeEl = document.getElementById('time');
    const wpmEl = document.getElementById('wpm');
    const accuracyEl = document.getElementById('accuracy');
    const levelEl = document.getElementById('level');
    const levelBadge = document.getElementById('levelBadge');
    const scoreEl = document.getElementById('score');
    const themeToggle = document.getElementById('themeToggle');

    function getMode() { return document.querySelector('input[name="mode"]:checked').value; }

    function splitText(text) {
      return text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
    }

    function cleanText(str) { return str.replace(/[.,!?:;'"“”()[\]{}]/g, '').trim(); }
    function normalize(str) { return cleanText(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    function updateLiveFeedback() {
      const original = segments[currentIdx];
      const input = userInput.value;
      const wordsOrig = cleanText(original).split(/\s+/).filter(w => w);
      const wordsIn = cleanText(input).split(/\s+/).filter(w => w);

      let html = '', correct = 0;
      wordsIn.forEach((word, i) => {
        if (i >= wordsOrig.length) html += `<span class="wrong">${word}</span> `;
        else {
          const match = normalize(word) === normalize(wordsOrig[i]);
          if (match) correct++;
          html += `<span class="${match ? 'correct' : 'wrong'}">${word}</span> `;
        }
      });
      correctWords = correct;
      liveFeedback.innerHTML = html || '<em>Nhập để bắt đầu...</em>';
    }

    function showHint() {
      const words = cleanText(segments[currentIdx]).split(/\s+/).filter(w => w);
      const typed = cleanText(userInput.value).split(/\s+/).filter(w => w);
      const nextIdx = typed.length;
      if (nextIdx < words.length) {
        liveFeedback.innerHTML += ` <span style="color:var(--hint); font-weight:700;">→ ${words[nextIdx]}</span>`;
        hintsUsed++;
      }
    }

    function showCurrentSegment() {
      const mode = getMode();
      const text = segments[currentIdx];
      currentSegment.textContent = mode === 'listen-write' ? 'Nghe và gõ lại...' : text;
      currentSegment.classList.toggle('listening', mode === 'listen-write');
      userInput.value = ''; liveFeedback.innerHTML = '<em>Bắt đầu gõ...</em>'; userInput.focus();
      if (mode.includes('listen')) setTimeout(() => speak(text), 600);
    }

    function nextSegment() {
      typedWords += cleanText(segments[currentIdx]).split(/\s+/).filter(w => w).length;
      currentIdx++;
      const progress = (currentIdx / segments.length) * 100;
      progressFill.style.width = progress + '%';
      progressText.textContent = Math.round(progress) + '%';
      if (currentIdx >= segments.length) endPractice(); else showCurrentSegment();
    }

    function calculateScore(wpm, accuracy) {
      return Math.max(0, Math.round(wpm * 2 + accuracy * 1.5 - hintsUsed * 5));
    }

    function endPractice() {
      clearInterval(timer);
      const elapsed = (Date.now() - startTime) / 1000 / 60;
      const wpm = elapsed > 0 ? Math.round(typedWords / elapsed) : 0;
      const accuracy = typedWords > 0 ? Math.round((correctWords / typedWords) * 100) : 100;
      const score = calculateScore(wpm, accuracy);
      const badge = getBadge(wpm);

      history.push({ date: new Date().toLocaleString('vi-VN'), wpm, accuracy, score, badge: badge.name });
      if (history.length > 100) history.shift();
      localStorage.setItem('xuanHaiDictation', JSON.stringify(history));
      updateChart();

      levelEl.textContent = badge.name;
      levelBadge.textContent = badge.name;
      levelBadge.className = `level-badge ${badge.class === 'bronze' ? 'level-1' : badge.class === 'silver' ? 'level-2' : badge.class === 'gold' ? 'level-3' : badge.class === 'emerald' ? 'level-4' : 'level-5'}`;
      scoreEl.textContent = score;

      document.getElementById('finalLevel').textContent = badge.name;
      document.getElementById('finalScore').textContent = score;
      const badgeEl = document.getElementById('finalBadge');
      badgeEl.className = `rank-badge ${badge.class}`;
      badgeEl.textContent = badge.icon;
      document.getElementById('finalResult').classList.remove('hidden');

      uploadScore(score, wpm);

      alert(`Chúc mừng!\nCấp bậc: ${badge.name} ${badge.icon}\nTốc độ: ${wpm} WPM\nĐộ chính xác: ${accuracy}%\nĐiểm: ${score}\nĐã gửi lên bảng xếp hạng!`);
    }

    function updateStats() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = elapsed / 60;
      const wpm = mins > 0 ? Math.round(typedWords / mins) : 0;
      const acc = typedWords > 0 ? Math.round((correctWords / typedWords) * 100) : 100;
      timeEl.textContent = `${elapsed}s`;
      wpmEl.textContent = wpm;
      accuracyEl.textContent = `${acc}%`;
    }

    function updateChart() {
      const recent = history.slice(-10);
      const labels = recent.map((_, i) => `Lần ${history.length - 10 + i + 1}`);
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('progressChart'), {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Tốc độ (WPM)', data: recent.map(h => h.wpm), borderColor: '#10b981', tension: 0.4 },
          { label: 'Điểm', data: recent.map(h => h.score), borderColor: '#34d399', tension: 0.4 }
        ]},
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }

    startBtn.addEventListener('click', () => {
      const text = sampleText.value.trim();
      if (!text) return alert('Vui lòng nhập đoạn văn mẫu!');
      segments = splitText(text);
      if (!segments.length) return alert('Không tìm thấy đoạn hợp lệ!');

      currentIdx = 0; typedWords = 0; correctWords = 0; hintsUsed = 0;
      startTime = Date.now(); timer = setInterval(updateStats, 500);

      setupPanel.classList.add('hidden');
      practiceArea.classList.remove('hidden');
      showCurrentSegment();
    });

    userInput.addEventListener('input', updateLiveFeedback);
    userInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); nextSegment(); } });
    hintBtn.addEventListener('click', showHint);
    showHintBtn.addEventListener('click', showHint);
    replayBtn.addEventListener('click', () => speak(segments[currentIdx]));
    nextBtn.addEventListener('click', nextSegment);
    resetBtn.addEventListener('click', () => location.reload());

    themeToggle.addEventListener('click', () => {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
      themeToggle.innerHTML = isDark
        ? `<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg>`
        : `<svg viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m8.66-14.66l-.7.7M4.34 19.34l-.7.7M21 12h-1M5 12H4m15.36-5.36l-.7-.7M6.34 17.66l-.7-.7"/></svg>`;
    });

    window.addEventListener('load', () => { updateChart(); });
  </script>
  <!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ABc nhấp nháy nhiều màu</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #111;
      margin: 0;
    }

    .blink-multi {
      font-family: Arial, Helvetica, sans-serif;
      /* Hai animation chạy đồng thời: đổi màu + nhấp nháy */
      animation: colorCycle 2.5s linear infinite, blink 0.8s steps(1, end) infinite;
    }

    @keyframes colorCycle {
      0%   { color: #ff3b3b; }   /* đỏ */
      16%  { color: #ff9f1c; }   /* cam */
      33%  { color: #ffe347; }   /* vàng */
      50%  { color: #2ecc71; }   /* xanh lá */
      66%  { color: #1e90ff; }   /* xanh dương */
      83%  { color: #8a2be2; }   /* tím */
      100% { color: #ff3b3b; }   /* quay lại đỏ */
    }

    @keyframes blink {
      0%, 49%   { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="blink-multi">Luyện Chính Tả - code này Hải viết cho vui thôi hén, Kỉ niệm 13/10/2025</div>
</body>
</html>

</body>
</html>



