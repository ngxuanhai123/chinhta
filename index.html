<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HiHi - Aurora Typing Master</title>
  <meta name="description" content="Luyện gõ chuẩn, nghe rõ, đọc to – phong cách Aurora Science.">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      
      --primary-gradient: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      --accent-color: #00d2ff;
      --success-color: #00e676;
      --error-color: #ff5252;
      --warning-color: #f59e0b;
      --text-color: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.6);
      
      --radius: 24px;
      --font-main: 'Poppins', sans-serif;
    }

    /* DARK MODE (Default for Aurora) */
    body {
      font-family: var(--font-main);
      background: #0f172a;
      color: var(--text-color);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding-bottom: 60px;
      overflow-x: hidden;
      position: relative;
    }

    /* --- AURORA BACKGROUND --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      opacity: 0.6;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* PARTICLES */
    .particle {
      position: absolute; border-radius: 50%; background: white;
      opacity: 0.3; animation: floatUp linear infinite; z-index: -1;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      50% { opacity: 0.5; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    /* --- GLASS COMPONENT --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .container {
      width: 95%; max-width: 900px;
      margin-top: 40px; z-index: 10;
      display: flex; flex-direction: column; gap: 24px;
    }

    /* --- HEADER --- */
    header { text-align: center; margin-bottom: 10px; position: relative; }
    h1 {
      font-size: 2.8rem; font-weight: 800; margin: 0;
      background: linear-gradient(to right, #fff, #b3e5fc);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
    }
    .tagline { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; font-weight: 300; }

    /* --- CONTROLS --- */
    .top-controls {
        position: absolute; top: 0; right: 0; display: flex; gap: 10px;
    }
    .icon-btn {
        width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--glass-border);
        background: rgba(255,255,255,0.1); color: white; cursor: pointer;
        display: flex; align-items: center; justify-content: center; transition: 0.3s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(15deg); }

    /* --- TABS --- */
    .tabs {
        display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;
    }
    .tab-btn {
        background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
        padding: 10px 24px; border-radius: 30px; color: var(--text-dim);
        font-weight: 600; cursor: pointer; transition: 0.3s;
    }
    .tab-btn.active {
        background: var(--primary-gradient); color: white;
        box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); border-color: transparent;
    }

    /* --- INPUTS --- */
    .input-glass {
        width: 100%; padding: 14px 18px; border-radius: 16px;
        border: 1px solid var(--glass-border);
        background: rgba(0,0,0,0.3); color: white;
        font-size: 1rem; font-family: var(--font-main); transition: 0.3s;
    }
    .input-glass:focus {
        background: rgba(0,0,0,0.5); border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(0, 210, 255, 0.1); outline: none;
    }
    select.input-glass option { background: #0f172a; color: white; }

    /* --- BUTTONS --- */
    .btn-primary {
        background: var(--primary-gradient); color: white;
        border: none; padding: 16px 32px; border-radius: 18px;
        font-weight: 700; font-size: 1.1rem; cursor: pointer;
        transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        box-shadow: 0 8px 20px rgba(0, 210, 255, 0.3); width: 100%;
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 210, 255, 0.5); }
    .btn-primary:active { transform: scale(0.98); }

    .btn-action {
        padding: 10px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
        transition: 0.2s; color: white; display: flex; align-items: center; gap: 8px;
    }
    .btn-warning { background: rgba(245, 158, 11, 0.8); }
    .btn-success { background: rgba(0, 230, 118, 0.8); }
    .btn-danger { background: rgba(255, 82, 82, 0.8); }
    .btn-info { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); }

    /* --- SETUP GRID --- */
    .setup-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 10px;
    }
    .setup-item h3 { font-size: 0.95rem; margin-bottom: 10px; color: var(--accent-color); text-transform: uppercase; }

    /* --- PRACTICE AREA --- */
    .segment-box {
        font-size: 1.5rem; line-height: 1.8; text-align: center;
        min-height: 140px; padding: 30px; margin-bottom: 20px;
        background: rgba(0,0,0,0.2); border-radius: 20px;
        border: 1px dashed rgba(255,255,255,0.3);
        display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }

    .karaoke-word {
        padding: 4px 8px; border-radius: 8px; transition: 0.2s;
    }
    .karaoke-active {
        background: var(--accent-color); color: #000; font-weight: 700;
        transform: scale(1.1); box-shadow: 0 0 15px var(--accent-color);
    }

    #userInput {
        font-size: 1.3rem; padding: 20px; text-align: center;
        background: rgba(255,255,255,0.05);
    }

    .feedback-area {
        min-height: 30px; text-align: center; margin-top: 10px; font-family: monospace; font-size: 1.1rem;
    }
    .correct-text { color: var(--success-color); text-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }
    .wrong-text { color: var(--error-color); text-decoration: line-through; opacity: 0.6; }

    /* --- STATS & PROGRESS --- */
    .progress-container { margin: 20px 0; }
    .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--success-color); width: 0%; transition: 0.3s; box-shadow: 0 0 10px var(--success-color); }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px; }
    .stat-card {
        background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center;
        border: 1px solid var(--glass-border);
    }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--accent-color); }
    .stat-label { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; }

    /* --- FOOTER --- */
    footer { margin-top: 40px; opacity: 0.6; font-size: 0.85rem; text-align: center; }
    .heart-icon { color: #ff5252; animation: beat 1s infinite; display: inline-block; }
    @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .mic-btn {
        width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.05); color: white; font-size: 2rem; cursor: pointer;
        display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
        transition: 0.3s;
    }
    .mic-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); }
    .mic-btn.listening {
        background: var(--error-color); border-color: transparent;
        animation: pulseMic 1.5s infinite; box-shadow: 0 0 20px var(--error-color);
    }
    @keyframes pulseMic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

  </style>
</head>
<body onload="initApp()">

  <div class="aurora-bg"></div>
  <div id="particles"></div>

  <div class="container">
    <header>
      <div class="top-controls">
        <button class="icon-btn" onclick="toggleMute()" id="muteBtn"><i class="fas fa-volume-up"></i></button>
        <button class="icon-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
      </div>
      <h1>HiHi <span style="font-size: 0.4em; vertical-align: super; background:var(--success-color); padding: 2px 6px; border-radius: 4px; color: black;">PRO</span></h1>
      <div class="tagline">Aurora Typing Master & Language Trainer</div>
    </header>

    <div class="glass-panel" style="padding: 10px;">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('setup')">Cấu Hình</button>
            <button class="tab-btn" onclick="switchTab('stats')">Thành Tích</button>
        </div>
    </div>

    <div id="view-setup" class="glass-panel animate__animated animate__fadeIn" style="padding: 30px;">
        <div class="setup-grid">
            <div class="setup-item">
                <h3><i class="fas fa-globe"></i> Ngôn ngữ</h3>
                <select id="globalLang" class="input-glass" onchange="loadVoices()">
                    <option value="vi-VN">Tiếng Việt</option>
                    <option value="en-US">English (US)</option>
                    <option value="es-ES">Español</option>
                    <option value="ja-JP">日本語 (Japanese)</option>
                    <option value="fr-FR">Français</option>
                </select>
            </div>
            
            <div class="setup-item">
                <h3><i class="fas fa-gamepad"></i> Chế độ</h3>
                <select id="gameMode" class="input-glass">
                    <option value="read-write">Nhìn & Gõ (Cổ điển)</option>
                    <option value="listen-write">Nghe & Gõ (Chính tả)</option>
                    <option value="read-listen-write">Nghe - Nhìn - Gõ</option>
                    <option value="read-only">Luyện nói (Mic)</option>
                </select>
            </div>

            <div class="setup-item">
                <h3><i class="fas fa-robot"></i> Giọng đọc AI</h3>
                <div style="display: flex; gap: 8px;">
                    <select id="voiceSelect" class="input-glass" style="flex:1"></select>
                    <select id="voiceRate" class="input-glass" style="width: 80px;">
                        <option value="0.8">0.8x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.2">1.2x</option>
                    </select>
                    <button class="btn-action btn-info" onclick="previewVoice()"><i class="fas fa-play"></i></button>
                </div>
            </div>

            <div class="setup-item" style="grid-column: 1/-1;">
                <h3><i class="fas fa-file-alt"></i> Nội dung luyện tập</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn-action btn-info" style="font-size:0.8rem;" onclick="setRandomText()"><i class="fas fa-dice"></i> Lấy bài mẫu</button>
                    <button class="btn-action btn-info" style="font-size:0.8rem;" onclick="clearText()"><i class="fas fa-eraser"></i> Xóa</button>
                </div>
                <textarea id="sampleText" class="input-glass" rows="5" placeholder="Nhập văn bản của bạn hoặc chọn bài mẫu..."></textarea>
            </div>
        </div>

        <button class="btn-primary" style="margin-top: 20px;" onclick="startPractice()">
            <i class="fas fa-rocket"></i> BẮT ĐẦU LUYỆN TẬP
        </button>
    </div>

    <div id="view-stats" class="glass-panel animate__animated animate__fadeIn hidden" style="padding: 30px;">
        <h2 style="text-align: center; margin-bottom: 20px;">Lịch sử đấu</h2>
        <div style="height: 300px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 10px;">
            <canvas id="statsChart"></canvas>
        </div>
        <div class="stats-row" id="bestStatsDisplay">
            </div>
    </div>

    <div id="view-practice" class="glass-panel animate__animated animate__zoomIn hidden" style="padding: 30px; position: relative;">
        <button class="icon-btn" style="position: absolute; top: 15px; right: 15px; background: rgba(255,82,82,0.2);" onclick="stopPractice()">
            <i class="fas fa-times"></i>
        </button>

        <div class="progress-container">
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                <span>Tiến độ</span>
                <span id="progressTxt">0%</span>
            </div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div id="segmentBox" class="segment-box"></div>

        <div id="micControl" class="hidden">
            <button id="micBtn" class="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <div style="text-align:center; font-size:0.9rem; opacity:0.8;">Nhấn mic và đọc to đoạn văn trên</div>
        </div>

        <div id="inputArea">
            <input type="text" id="userInput" class="input-glass" autocomplete="off" placeholder="Gõ lại nội dung tại đây..." oninput="handleInput()" onkeydown="checkEnter(event)">
            <div id="feedback" class="feedback-area"></div>
        </div>

        <div style="display:flex; justify-content:center; gap: 15px; margin-top: 20px;">
            <button class="btn-action btn-warning" onclick="speakCurrent()"><i class="fas fa-volume-up"></i> Nghe lại</button>
            <button class="btn-action btn-info" onclick="useHint()"><i class="fas fa-lightbulb"></i> Gợi ý</button>
            <button id="btnNext" class="btn-action btn-success" onclick="nextSegment()" disabled>Tiếp theo <i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-val" id="liveWpm">0</div>
                <div class="stat-label">WPM</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="liveAcc">100%</div>
                <div class="stat-label">Chính xác</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="liveTime">0s</div>
                <div class="stat-label">Thời gian</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="liveScore">0</div>
                <div class="stat-label">Điểm</div>
            </div>
        </div>
    </div>

    <footer>
        App được Hải viết bằng cả trái tim <span class="heart-icon">❤️</span>
    </footer>

  </div>

<script>
/* -------------------------------------------------------------------------
   AUDIO ENGINE (NO MP3 FILES NEEDED)
   ------------------------------------------------------------------------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let masterGain = null;
let isMuted = false;

function initAudio() {
    if(!masterGain) {
        masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
    }
    if(audioCtx.state === 'suspended') audioCtx.resume();
}

function playTone(freq, type, duration, vol=0.1) {
    if(isMuted) return;
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(masterGain);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

const SFX = {
    TYPE: () => playTone(800 + Math.random()*200, 'sine', 0.1, 0.05),
    ERROR: () => { playTone(150, 'sawtooth', 0.2, 0.1); playTone(100, 'sawtooth', 0.2, 0.1); },
    SUCCESS: () => { 
        [523, 659, 783].forEach((f,i) => setTimeout(() => playTone(f, 'triangle', 0.3, 0.1), i*50));
    },
    CLICK: () => playTone(600, 'sine', 0.1, 0.05),
    WIN: () => {
        [523, 659, 783, 1046, 1318].forEach((f,i) => setTimeout(() => playTone(f, 'square', 0.6, 0.1), i*80));
    }
};

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
}

/* -------------------------------------------------------------------------
   APP LOGIC
   ------------------------------------------------------------------------- */
// Sample Data
const SAMPLE_TEXTS = {
    'vi-VN': [
        "Trăm năm trong cõi người ta, chữ tài chữ mệnh khéo là ghét nhau. Trải qua một cuộc bể dâu, những điều trông thấy mà đau đớn lòng.",
        "Sông núi nước Nam vua Nam ở. Rành rành định phận tại sách trời. Cớ sao lũ giặc sang xâm phạm? Chúng bay sẽ bị đánh tơi bời.",
        "Mùa thu Hà Nội, mùa thu Hà Nội, nhớ những con đường vắng vẻ, nhớ những hàng cây già, nhớ những cơn mưa bất chợt."
    ],
    'en-US': [
        "The quick brown fox jumps over the lazy dog. Programming is the art of telling another human what one wants the computer to do.",
        "To be or not to be, that is the question. Whether 'tis nobler in the mind to suffer the slings and arrows of outrageous fortune."
    ],
    'es-ES': [
        "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que vivía un hidalgo de los de lanza en astillero."
    ]
};

// Global State
let config = { lang: 'vi-VN', mode: 'read-write', rate: 1.0 };
let session = { segments: [], idx: 0, startTime: 0, timer: null, typed: 0, correct: 0, hints: 0 };
let voices = [];
let selectedVoice = null;
let history = JSON.parse(localStorage.getItem('hihi_history') || '[]');
let recognition = null;
let isListening = false;

// --- INITIALIZATION ---
function initApp() {
    createParticles();
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
    renderChart();
    
    // Default text
    document.getElementById('sampleText').value = SAMPLE_TEXTS['vi-VN'][0];
}

function createParticles() {
    const container = document.getElementById('particles');
    for(let i=0; i<20; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.width = Math.random() * 4 + 2 + 'px';
        p.style.height = p.style.width;
        p.style.animationDuration = Math.random() * 10 + 10 + 's';
        p.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(p);
    }
}

// --- TABS & NAVIGATION ---
function switchTab(tabId) {
    SFX.CLICK();
    document.getElementById('view-setup').classList.add('hidden');
    document.getElementById('view-stats').classList.add('hidden');
    document.getElementById('view-practice').classList.add('hidden');
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    if(tabId === 'setup') {
        document.getElementById('view-setup').classList.remove('hidden');
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
    } else {
        document.getElementById('view-stats').classList.remove('hidden');
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        renderChart();
    }
}

// --- VOICE & TTS ---
function loadVoices() {
    const lang = document.getElementById('globalLang').value;
    const allVoices = speechSynthesis.getVoices();
    voices = allVoices.filter(v => v.lang.startsWith(lang.split('-')[0]));
    
    // Fallback logic
    if(voices.length === 0) voices = allVoices.filter(v => v.lang.includes('en'));

    const select = document.getElementById('voiceSelect');
    select.innerHTML = voices.map((v, i) => `<option value="${i}">${v.name}</option>`).join('');
    selectedVoice = voices[0];
}

function speakCurrent(text = null) {
    const txt = text || session.segments[session.idx];
    if(!txt) return;
    
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = config.lang;
    u.rate = parseFloat(document.getElementById('voiceRate').value);
    
    // Get selected voice
    const vIdx = document.getElementById('voiceSelect').value;
    if(voices[vIdx]) u.voice = voices[vIdx];

    // Karaoke Effect integration
    u.onboundary = (e) => {
        if (e.name === 'word') highlightKaraoke(e.charIndex);
    };

    speechSynthesis.speak(u);
}

function previewVoice() {
    const txt = config.lang === 'vi-VN' ? "Xin chào, tôi là trợ lý ảo của bạn." : "Hello, I am your virtual assistant.";
    speakCurrent(txt);
}

// --- TEXT MANAGEMENT ---
function setRandomText() {
    SFX.CLICK();
    const lang = document.getElementById('globalLang').value;
    const pool = SAMPLE_TEXTS[lang] || SAMPLE_TEXTS['en-US'];
    document.getElementById('sampleText').value = pool[Math.floor(Math.random() * pool.length)];
}
function clearText() {
    SFX.CLICK();
    document.getElementById('sampleText').value = '';
    document.getElementById('sampleText').focus();
}

// --- PRACTICE SESSION ---
function startPractice() {
    const text = document.getElementById('sampleText').value.trim();
    if(!text) return alert("Vui lòng nhập nội dung!");

    SFX.CLICK();
    config.lang = document.getElementById('globalLang').value;
    config.mode = document.getElementById('gameMode').value;
    
    // Smart split by sentence
    session.segments = text.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
    session.idx = 0;
    session.startTime = Date.now();
    session.typed = 0;
    session.correct = 0;
    session.hints = 0;
    
    if(session.timer) clearInterval(session.timer);
    session.timer = setInterval(updateLiveStats, 1000);
    
    // UI Switch
    document.getElementById('view-setup').classList.add('hidden');
    document.getElementById('view-practice').classList.remove('hidden');
    document.getElementById('view-practice').classList.remove('animate__zoomOut');
    document.getElementById('view-practice').classList.add('animate__zoomIn');
    
    // Setup Mode UI
    const isReadOnly = config.mode === 'read-only';
    document.getElementById('inputArea').style.display = isReadOnly ? 'none' : 'block';
    document.getElementById('micControl').classList.toggle('hidden', !isReadOnly);
    
    renderSegment();
}

function stopPractice() {
    SFX.CLICK();
    if(session.timer) clearInterval(session.timer);
    speechSynthesis.cancel();
    if(recognition) recognition.stop();
    
    document.getElementById('view-practice').classList.remove('animate__zoomIn');
    document.getElementById('view-practice').classList.add('animate__zoomOut');
    setTimeout(() => {
        document.getElementById('view-practice').classList.add('hidden');
        document.getElementById('view-setup').classList.remove('hidden');
    }, 300);
}

function renderSegment() {
    const txt = session.segments[session.idx];
    const box = document.getElementById('segmentBox');
    const input = document.getElementById('userInput');
    
    // Reset state
    input.value = '';
    input.disabled = false;
    document.getElementById('feedback').innerHTML = '';
    document.getElementById('btnNext').disabled = true;
    document.getElementById('btnNext').classList.remove('animate__pulse');
    
    // Render Karaoke HTML
    box.innerHTML = txt.split(' ').map(w => `<span class="karaoke-word">${w}</span>`).join(' ');
    
    // Mode Logic
    if(config.mode === 'listen-write') {
        box.style.filter = 'blur(5px)';
        setTimeout(() => speakCurrent(), 500);
    } else if(config.mode === 'read-listen-write') {
        box.style.filter = 'none';
        setTimeout(() => speakCurrent(), 500);
    } else {
        box.style.filter = 'none';
    }
    
    if(config.mode !== 'read-only') input.focus();
    updateProgress();
}

function highlightKaraoke(charIndex) {
    const txt = session.segments[session.idx];
    // Simple estimation mapping charIndex to word index
    // Note: Accurate mapping requires complex logic, this is a visual approximation
    const words = txt.split(' ');
    let currentLen = 0;
    let targetIdx = 0;
    
    for(let i=0; i<words.length; i++) {
        if(currentLen + words[i].length >= charIndex) {
            targetIdx = i;
            break;
        }
        currentLen += words[i].length + 1; // +1 for space
    }
    
    const spans = document.querySelectorAll('.karaoke-word');
    spans.forEach(s => s.classList.remove('karaoke-active'));
    if(spans[targetIdx]) spans[targetIdx].classList.add('karaoke-active');
}

// --- INPUT HANDLING ---
function handleInput() {
    SFX.TYPE();
    const input = document.getElementById('userInput');
    const target = session.segments[session.idx];
    const val = input.value;
    
    // Visual diff logic
    const tWords = target.split(' ');
    const vWords = val.trim().split(/\s+/);
    
    let html = '';
    let isMatch = true;
    
    vWords.forEach((w, i) => {
        if(!tWords[i]) return;
        // Strip punctuation for comparison
        const cleanW = w.toLowerCase().replace(/[.,!?;:]/g, '');
        const cleanT = tWords[i].toLowerCase().replace(/[.,!?;:]/g, '');
        
        if(cleanW === cleanT) {
            html += `<span class="correct-text">${w}</span> `;
        } else {
            html += `<span class="wrong-text">${w}</span> `;
            isMatch = false;
        }
    });
    
    if(val.length < target.length) isMatch = false;
    
    document.getElementById('feedback').innerHTML = html;
    
    if(isMatch) {
        onSegmentSuccess();
    }
}

function checkEnter(e) {
    if(e.key === 'Enter' && !document.getElementById('btnNext').disabled) {
        nextSegment();
    }
}

function useHint() {
    SFX.CLICK();
    session.hints++;
    const input = document.getElementById('userInput');
    const target = session.segments[session.idx];
    const currentWords = input.value.trim().split(/\s+/);
    const targetWords = target.split(' ');
    
    if(input.value.trim() === '') {
        input.value = targetWords[0];
    } else if (currentWords.length < targetWords.length) {
        input.value += ' ' + targetWords[currentWords.length];
    }
    handleInput();
    input.focus();
}

function onSegmentSuccess() {
    if(document.getElementById('btnNext').disabled) {
        SFX.SUCCESS();
        const input = document.getElementById('userInput');
        input.disabled = true; // Prevent further typing
        input.style.borderColor = 'var(--success-color)';
        
        const btnNext = document.getElementById('btnNext');
        btnNext.disabled = false;
        btnNext.classList.add('animate__animated', 'animate__pulse', 'animate__infinite');
        
        // Add stats
        session.correct += session.segments[session.idx].split(' ').length;
    }
}

function nextSegment() {
    SFX.CLICK();
    session.idx++;
    if(session.idx >= session.segments.length) {
        finishSession();
    } else {
        renderSegment();
    }
}

// --- MIC / SPEECH RECOGNITION ---
function toggleMic() {
    if(!('webkitSpeechRecognition' in window)) return alert("Trình duyệt không hỗ trợ Mic!");
    
    const btn = document.getElementById('micBtn');
    
    if(isListening) {
        recognition.stop();
        return;
    }
    
    recognition = new webkitSpeechRecognition();
    recognition.lang = config.lang;
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
        isListening = true;
        btn.classList.add('listening');
    };
    
    recognition.onend = () => {
        isListening = false;
        btn.classList.remove('listening');
    };
    
    recognition.onresult = (e) => {
        let transcript = Array.from(e.results)
            .map(result => result[0])
            .map(result => result.transcript)
            .join('');
            
        document.getElementById('feedback').innerHTML = `<span style="color:var(--accent-color)">${transcript}</span>`;
        
        const target = session.segments[session.idx].toLowerCase().replace(/[.,!?;:]/g, '');
        const cleanTrans = transcript.toLowerCase().replace(/[.,!?;:]/g, '');
        
        if(cleanTrans.includes(target)) {
            document.getElementById('btnNext').disabled = false;
            SFX.SUCCESS();
            recognition.stop();
        }
    };
    
    recognition.start();
}

// --- STATS & CHART ---
function updateLiveStats() {
    const now = Date.now();
    const diffMin = (now - session.startTime) / 60000;
    const words = session.typed + document.getElementById('userInput').value.split(' ').length;
    
    const wpm = diffMin > 0 ? Math.round(words / diffMin) : 0;
    const time = Math.round(diffMin * 60);
    
    document.getElementById('liveWpm').innerText = wpm;
    document.getElementById('liveTime').innerText = time + 's';
    
    // Calc score
    const score = Math.round(wpm * 10 - session.hints * 5);
    document.getElementById('liveScore').innerText = score > 0 ? score : 0;
}

function updateProgress() {
    const pct = Math.round((session.idx / session.segments.length) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressTxt').innerText = pct + '%';
}

function finishSession() {
    SFX.WIN();
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    
    const stats = {
        date: new Date().toLocaleDateString(),
        wpm: document.getElementById('liveWpm').innerText,
        score: document.getElementById('liveScore').innerText
    };
    
    history.push(stats);
    if(history.length > 10) history.shift();
    localStorage.setItem('hihi_history', JSON.stringify(history));
    
    alert(`Hoàn thành xuất sắc!\nTốc độ: ${stats.wpm} WPM\nĐiểm: ${stats.score}`);
    stopPractice();
    switchTab('stats');
}

function renderChart() {
    const ctx = document.getElementById('statsChart').getContext('2d');
    const labels = history.map((_, i) => `Lần ${i+1}`);
    const data = history.map(h => h.wpm);
    
    if(window.myChart) window.myChart.destroy();
    
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tốc độ gõ (WPM)',
                data: data,
                borderColor: '#00d2ff',
                backgroundColor: 'rgba(0, 210, 255, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                x: { grid: { color: 'rgba(255,255,255,0.1)' } }
            },
            plugins: {
                legend: { labels: { color: 'white' } }
            }
        }
    });
}

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
}

</script>
</body>
</html>
