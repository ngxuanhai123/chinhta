<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HiHi Sync - Ultimate Typing</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&family=Poppins:wght@300;400;600;700;800&family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root {
    --glass-bg: rgba(255, 255, 255, 0.15);
    --glass-border: rgba(255, 255, 255, 0.3);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --accent-color: #00d2ff;
    --success-color: #00e676;
    --error-color: #ff5252;
    --text-color: #ffffff;
    --radius: 24px;
    --font-main: 'Poppins', 'Be Vietnam Pro', sans-serif;
  }

  body.dark-mode {
    --glass-bg: rgba(15, 23, 42, 0.75);
    --glass-border: rgba(255, 255, 255, 0.1);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: var(--font-main);
    background: #0f172a;
    color: var(--text-color);
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding-bottom: 110px;
    overflow-x: hidden;
    position: relative;
  }

  /* --- AURORA BACKGROUND --- */
  .aurora-bg {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
    background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    opacity: 0.8;
  }
  
  body.dark-mode .aurora-bg {
    background: linear-gradient(-45deg, #020024, #090979, #1a0b2e, #001f3f);
    background-size: 400% 400%;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* PARTICLES */
  .particle {
    position: absolute; border-radius: 50%; background: white;
    opacity: 0.3; animation: floatUp linear infinite; z-index: -1;
  }
  @keyframes floatUp {
    0% { transform: translateY(100vh) scale(0); opacity: 0; }
    50% { opacity: 0.5; }
    100% { transform: translateY(-10vh) scale(1); opacity: 0; }
  }

  /* --- GLASS COMPONENT --- */
  .glass-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    margin-bottom: 20px;
  }

  .btn-primary {
    position: relative; overflow: hidden; border: none;
    background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
    border: 1px solid rgba(255,255,255,0.5);
    color: white; font-weight: 800; padding: 16px 24px; border-radius: 20px;
    cursor: pointer; width: 100%; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2); transition: all 0.2s;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  .btn-primary:active { transform: scale(0.96); }

  .input-glass {
    width: 100%; padding: 14px; border-radius: 16px;
    border: 1px solid var(--glass-border);
    background: rgba(0,0,0,0.3); color: white;
    font-size: 1rem; margin-bottom: 15px; font-family: var(--font-main);
  }
  .input-glass:focus { background: rgba(0,0,0,0.5); border-color: #fff; }
  textarea.input-glass { min-height: 120px; resize: vertical; }

  /* --- LAYOUT --- */
  header { margin: 40px 0 20px 0; text-align: center; width: 100%; padding: 0 20px; z-index: 2; }
  h1 { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: white; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

  .view-container { width: 92%; max-width: 600px; z-index: 2; position: relative; padding-bottom: 20px; }

  /* --- CHINH TA SPECIFIC STYLES --- */
  .segment-box {
      font-size: 1.4rem; line-height: 1.8; text-align: center;
      min-height: 140px; padding: 25px;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
  }
  
  .karaoke-word {
      padding: 4px 6px; border-radius: 6px; transition: 0.2s; position: relative;
      display: inline-block; white-space: pre-wrap;
  }
  .karaoke-active {
      background: #fbbf24; color: #000 !important; transform: scale(1.15);
      box-shadow: 0 0 25px #fbbf24; z-index: 10; font-weight: bold;
      border-radius: 8px;
  }
  
  .correct { color: #4ade80; font-weight: 700; text-shadow: 0 0 10px rgba(74, 222, 128, 0.4); }
  .wrong { color: #f87171; text-decoration: line-through; opacity: 0.7; }
  
  .mic-btn {
      width: 70px; height: 70px; border-radius: 50%;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
      color: white; font-size: 2rem; display: flex; align-items: center; justify-content: center;
      cursor: pointer; margin: 0 auto 20px; transition: 0.3s;
  }
  .mic-btn.listening { background: #ef4444; animation: pulseMic 1.5s infinite; border-color: transparent; }
  @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
  .stat-card {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      padding: 10px 5px; border-radius: 12px; text-align: center;
  }
  .stat-num { font-size: 1.2rem; font-weight: 800; display: block; }
  .stat-label { font-size: 0.65rem; opacity: 0.8; text-transform: uppercase; }

  /* Tab Bar */
  .tab-bar {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: 95%; max-width: 400px; height: 65px;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.2); border-radius: 40px;
    display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    box-shadow: 0 15px 40px rgba(0,0,0,0.5);
  }
  .tab-item {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: 600; transition: 0.3s;
  }
  .tab-item i { font-size: 1.4rem; margin-bottom: 4px; transition: 0.3s; }
  .tab-item.active { color: #38bdf8; }
  .tab-item.active i { transform: translateY(-5px); text-shadow: 0 0 10px rgba(56, 189, 248, 0.8); }

  /* Leaderboard Podium */
  .leaderboard-row {
    display: grid; grid-template-columns: 30px 45px 1fr auto; 
    align-items: center; gap: 10px; padding: 12px 15px; 
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .rank-num { font-weight: 700; color: #94a3b8; text-align: center; }
  .lb-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
  .lb-score { font-weight: 800; color: #34d399; }

  /* User Badge */
  .user-badge {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.3); margin-bottom: 20px;
    cursor: pointer; transition: 0.2s; width: fit-content; margin: 0 auto 20px auto;
  }

  /* Login Overlay */
  #view-login {
      position: fixed; inset: 0; z-index: 5000;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(15px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; text-align: center;
  }
  
  /* Toast */
  #toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%);
    background: rgba(0,0,0,0.9); color: white; padding: 12px 25px; border-radius: 50px;
    font-weight: 600; z-index: 6000; transition: transform 0.4s;
    display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.2);
  }
  #toast.show { transform: translateX(-50%) translateY(20px); }

</style>
</head>
<body onload="initApp()" class="dark-mode">

<div class="aurora-bg"></div>
<div id="particles"></div>

<header>
  <h1>HiHi Sync</h1>
  <div style="font-size:0.85rem; opacity:0.8; font-weight: 600;">Luy·ªán Ch√≠nh T·∫£ & Gi·ªçng N√≥i</div>
</header>

<div id="view-login">
    <div style="font-size:3rem; margin-bottom:10px;">üîê</div>
    <h2 style="color:white; margin-bottom:10px;">Y√™u c·∫ßu ƒëƒÉng nh·∫≠p</h2>
    <p style="color:rgba(255,255,255,0.7); margin-bottom:30px; max-width:300px;">
        Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Google ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† tham gia b·∫£ng x·∫øp h·∫°ng.
    </p>
    <button class="btn-primary" onclick="loginGoogle()" style="max-width:250px;">
        <i class="fab fa-google"></i> &nbsp; ƒêƒÉng nh·∫≠p Google
    </button>
</div>

<div id="appContainer" style="width: 100%; display: flex; justify-content: center;">

  <div id="view-home" class="view-container animate__animated animate__fadeIn" style="display:none;">
    
    <div id="userProfile" class="user-badge" onclick="logoutGoogle()">
        <img id="userImg" src="" class="lb-avatar" alt="Avt">
        <div>
            <div id="userName" style="font-weight: 700; font-size: 0.9rem;">User</div>
            <div style="font-size: 0.7rem; opacity: 0.9;">Nh·∫•n ƒë·ªÉ ƒëƒÉng xu·∫•t</div>
        </div>
    </div>

    <div class="glass-panel" style="padding: 24px;">
        <h3 style="margin-bottom:15px; color:#60A5FA;"><i class="fas fa-sliders-h"></i> C·∫•u h√¨nh luy·ªán t·∫≠p</h3>
        
        <label style="font-size:0.85rem; opacity:0.8; margin-bottom:5px; display:block;">Ng√¥n ng·ªØ</label>
        <select id="globalLang" class="input-glass">
            <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en-US">üá∫üá∏ Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">üáÆüá© Ti·∫øng Indonesia</option>
            <option value="la-VA">üáªüá¶ Ti·∫øng Latin</option>
        </select>

        <label style="font-size:0.85rem; opacity:0.8; margin-bottom:5px; display:block;">Ch·∫ø ƒë·ªô</label>
        <select id="gameMode" class="input-glass">
            <option value="read-write">üëÅÔ∏è Nh√¨n & Ch√©p (G√µ l·∫°i)</option>
            <option value="listen-write">üëÇ Nghe & Ch√©p (Ch√≠nh t·∫£)</option>
            <option value="read-listen-write">üß† Nghe - Nh√¨n - Ch√©p</option>
            <option value="read-only">üé§ Luy·ªán ƒê·ªçc (D√πng Mic)</option>
        </select>

        <label style="font-size:0.85rem; opacity:0.8; margin-bottom:5px; display:block;">Gi·ªçng ƒë·ªçc AI</label>
        <div style="display:flex; gap:10px;">
             <select id="voiceSelect" class="input-glass" style="margin-bottom:0;"></select>
             <button class="btn-primary" style="width:auto; padding:0 15px;" onclick="previewVoice()"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>

    <div class="glass-panel" style="padding: 24px;">
        <h3 style="margin-bottom:15px; color:#FBBF24;"><i class="fas fa-pen-nib"></i> N·ªôi dung luy·ªán</h3>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
             <button class="btn-primary" style="font-size:0.8rem; background:rgba(59, 130, 246, 0.5);" onclick="setRandomText()">
                <i class="fas fa-random"></i> B√†i m·∫´u ng·∫´u nhi√™n
             </button>
             <button class="btn-primary" style="font-size:0.8rem; width:50px; background:rgba(239, 68, 68, 0.5);" onclick="clearText()">
                <i class="fas fa-trash"></i>
             </button>
        </div>
        
        <textarea id="sampleText" class="input-glass" placeholder="Nh·∫≠p vƒÉn b·∫£n c·ªßa b·∫°n ho·∫∑c ch·ªçn b√†i m·∫´u..."></textarea>
    </div>

    <button class="btn-primary animate__animated animate__pulse animate__infinite" onclick="startGame()">
        <i class="fas fa-play"></i> &nbsp; B·∫ÆT ƒê·∫¶U LUY·ªÜN T·∫¨P
    </button>
    <div style="height:50px;"></div>
  </div>

  <div id="view-practice" class="view-container animate__animated animate__fadeIn" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <button onclick="navTo('view-home')" style="background:none; border:none; color:white;"><i class="fas fa-arrow-left"></i> Tho√°t</button>
        <div style="font-weight:700; color:#38bdf8;">Ti·∫øn ƒë·ªô: <span id="progressTxt">0%</span></div>
    </div>

    <div class="glass-panel" style="padding: 0; overflow: hidden; position: relative;">
        <div style="height:5px; background:rgba(255,255,255,0.1); width:100%;">
            <div id="progressBar" style="height:100%; background:#38bdf8; width:0%; transition:width 0.3s;"></div>
        </div>
        <div id="currentSegment" class="segment-box">
            </div>
    </div>

    <div id="micArea" class="hidden" style="text-align:center;">
        <button id="micBtn" class="mic-btn"><i class="fas fa-microphone"></i></button>
        <div style="opacity:0.7; font-size:0.8rem; margin-bottom:15px;">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</div>
    </div>

    <div id="inputArea">
        <input type="text" id="userInput" class="input-glass" placeholder="G√µ l·∫°i n·ªôi dung..." autocomplete="off" style="font-size:1.2rem; padding:18px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
             <button onclick="speakCurrent()" style="background:none; border:none; color:#fbbf24;"><i class="fas fa-volume-up"></i> Nghe l·∫°i</button>
             <button onclick="useHint()" style="background:none; border:none; color:#a78bfa;"><i class="fas fa-lightbulb"></i> G·ª£i √Ω</button>
        </div>
    </div>

    <div id="feedback" style="min-height:30px; text-align:center; margin-bottom:20px; font-style:italic; opacity:0.8;"></div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-num" id="statTime">0s</span>
            <span class="stat-label">Th·ªùi gian</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="statWPM">0</span>
            <span class="stat-label">WPM</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="statAcc">100%</span>
            <span class="stat-label">Ch√≠nh x√°c</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="statScore" style="color:#fbbf24">0</span>
            <span class="stat-label">ƒêi·ªÉm</span>
        </div>
    </div>

    <button id="nextBtn" class="btn-primary" style="margin-top:20px; background:#34d399;" disabled onclick="nextSegment()">
        Ti·∫øp theo <i class="fas fa-arrow-right"></i>
    </button>
    <div style="height:50px;"></div>
  </div>

  <div id="view-leaderboard" class="view-container animate__animated animate__fadeIn" style="display:none;">
    <h2 style="text-align:center; color:#fbbf24; text-shadow:0 0 10px rgba(251, 191, 36, 0.5); margin-bottom:10px;">
        <i class="fas fa-trophy"></i> B·∫£ng X·∫øp H·∫°ng
    </h2>
    <div style="text-align:center; font-size:0.8rem; opacity:0.7; margin-bottom:20px;">
        Th√°ng hi·ªán t·∫°i ‚Ä¢ Reset ng√†y 1 h√†ng th√°ng
    </div>

    <div class="glass-panel" style="padding: 0;">
        <div style="display: grid; grid-template-columns: 30px 45px 1fr auto; padding: 12px 15px; background: rgba(255,255,255,0.05); font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">
             <div style="text-align:center">#</div>
             <div></div>
             <div>Th√†nh vi√™n</div>
             <div style="text-align:right">ƒêi·ªÉm</div>
        </div>
        <div id="lbContent">
            <div style="text-align:center; padding:30px; opacity:0.6;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>
        </div>
    </div>
    <div style="height:50px;"></div>
  </div>

</div>

<div class="tab-bar">
  <div class="tab-item active" data-target="view-home" onclick="navTo('view-home')">
    <i class="fas fa-home"></i> <span>Home</span>
  </div>
  <div class="tab-item" data-target="view-practice" onclick="navTo('view-practice')">
    <i class="fas fa-keyboard"></i> <span>Luy·ªán t·∫≠p</span>
  </div>
  <div class="tab-item" data-target="view-leaderboard" onclick="navTo('view-leaderboard')">
    <i class="fas fa-trophy"></i> <span>X·∫øp h·∫°ng</span>
  </div>
</div>

<div id="toast"><span id="toast-icon"></span> <span id="toast-msg">Th√¥ng b√°o</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, onValue, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtaVYb_72YvoGzvcERJZypUGS-u3skz2M",
  authDomain: "tuvung-88e8d.firebaseapp.com",
  databaseURL: "https://tuvung-88e8d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tuvung-88e8d",
  storageBucket: "tuvung-88e8d.firebasestorage.app",
  messagingSenderId: "722559465686",
  appId: "1:722559465686:web:bae1a77791205d372db177"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

window.currentUser = null;

// --- AUTH LOGIC ---
window.loginGoogle = () => {
    signInWithPopup(auth, provider).catch(e => showToast("L·ªói ƒëƒÉng nh·∫≠p: " + e.message, 'error'));
};

window.logoutGoogle = () => {
    if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
        signOut(auth).then(() => window.location.reload());
    }
};

onAuthStateChanged(auth, (user) => {
    const loginView = document.getElementById('view-login');
    const homeView = document.getElementById('view-home');
    
    if (user) {
        window.currentUser = { uid: user.uid, name: user.displayName, photo: user.photoURL };
        loginView.style.display = 'none';
        homeView.style.display = 'block';
        
        document.getElementById('userImg').src = user.photoURL;
        document.getElementById('userName').innerText = user.displayName;
        
        loadLeaderboard(); // Start syncing leaderboard
    } else {
        window.currentUser = null;
        loginView.style.display = 'flex';
        document.querySelectorAll('.view-container').forEach(el => {
            if(el.id !== 'view-login') el.style.display = 'none';
        });
    }
});

// --- HELPER FUNCTIONS ---
function getMonthKey() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
}

function showToast(msg, type='info') {
    const el = document.getElementById('toast');
    const txt = document.getElementById('toast-msg');
    const icon = document.getElementById('toast-icon');
    
    if(type==='success') { icon.innerHTML = '<i class="fas fa-check-circle" style="color:#4ade80"></i>'; el.style.border = "1px solid #4ade80"; }
    else if(type==='error') { icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color:#f87171"></i>'; el.style.border = "1px solid #f87171"; }
    else { icon.innerHTML = '<i class="fas fa-info-circle" style="color:#60a5fa"></i>'; el.style.border = "1px solid #60a5fa"; }
    
    txt.innerText = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

// --- LEADERBOARD LOGIC ---
function loadLeaderboard() {
    const monthKey = getMonthKey();
    const lbRef = query(ref(db, `leaderboard/${monthKey}`), orderByChild('score'), limitToLast(20));
    
    onValue(lbRef, (snapshot) => {
        const lbContent = document.getElementById('lbContent');
        const data = [];
        snapshot.forEach(child => data.push(child.val()));
        data.reverse();

        if (data.length === 0) {
            lbContent.innerHTML = '<div style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†y.</div>';
            return;
        }

        let html = '';
        data.forEach((u, i) => {
            const isMe = window.currentUser && u.name === window.currentUser.name ? 'background:rgba(59, 130, 246, 0.15);' : '';
            html += `
                <div class="leaderboard-row animate__animated animate__fadeIn" style="${isMe}">
                    <div class="rank-num" style="color:${i===0?'#fbbf24':i===1?'#e5e7eb':i===2?'#b45309':'#94a3b8'}">${i+1}</div>
                    <img src="${u.photo||'https://via.placeholder.com/35'}" class="lb-avatar">
                    <div style="font-weight:600; font-size:0.9rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${u.name} <br> <span style="font-size:0.7rem; font-weight:400; opacity:0.7;">${u.wpm} WPM</span>
                    </div>
                    <div class="lb-score">${u.score}</div>
                </div>
            `;
        });
        lbContent.innerHTML = html;
    });
}

// --- SAVE SCORE LOGIC ---
window.saveScore = (wpm, acc, score, sentences) => {
    if(!window.currentUser) return;
    const uid = window.currentUser.uid;
    const monthKey = getMonthKey();
    const userRef = ref(db, `leaderboard/${monthKey}/${uid}`);

    runTransaction(userRef, (curr) => {
        if (!curr) {
            return {
                name: window.currentUser.name,
                photo: window.currentUser.photo,
                score: score, wpm: wpm, acc: acc, sentences: sentences
            };
        } else {
            return {
                name: window.currentUser.name,
                photo: window.currentUser.photo,
                score: (curr.score || 0) + score,
                sentences: (curr.sentences || 0) + sentences,
                wpm: Math.max(curr.wpm || 0, wpm),
                acc: Math.max(curr.acc || 0, acc)
            };
        }
    }).then(() => showToast(`ƒê√£ l∆∞u: +${score} ƒëi·ªÉm!`, 'success'));
}
</script>

<script>
// --- GAME APP LOGIC ---
const SAMPLE_LIBRARY = {
    'vi-VN': [
        "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i.",
        "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau.",
        "M·ªói nƒÉm hoa ƒë√†o n·ªü, l·∫°i th·∫•y √¥ng ƒë·ªì gi√†.",
        "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt, cho con tr√®o h√°i m·ªói ng√†y."
    ],
    'en-US': [
        "The quick brown fox jumps over the lazy dog.",
        "To be or not to be, that is the question.",
        "Success is not final, failure is not fatal."
    ],
    'id-ID': [
        "Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia.",
        "Satu Nusa, Satu Bangsa, Satu Bahasa."
    ],
    'la-VA': [
        "Veni, vidi, vici.",
        "Cogito, ergo sum."
    ]
};

let segments = [];
let currentIdx = 0;
let typedWords = 0;
let correctWords = 0;
let totalCorrect = 0;
let startTime = 0;
let timerInt = null;
let currentMode = 'read-write';
let recognition = null;
let isListening = false;
let voices = [];
let selectedVoice = null;
let globalLang = 'vi-VN';

function initApp() {
    createParticles();
    // Load voices
    window.speechSynthesis.onvoiceschanged = () => {
        voices = window.speechSynthesis.getVoices();
        populateVoices();
    };
    setTimeout(populateVoices, 1000);
}

function createParticles() {
    const container = document.getElementById('particles');
    for(let i=0; i<15; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.width = Math.random() * 5 + 2 + 'px';
        p.style.height = p.style.width;
        p.style.animationDuration = Math.random() * 10 + 10 + 's';
        p.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(p);
    }
}

// --- NAVIGATION ---
window.navTo = function(viewId) {
    document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');
    const target = document.getElementById(viewId);
    target.style.display = 'block';
    target.classList.remove('animate__fadeIn');
    void target.offsetWidth; target.classList.add('animate__fadeIn');
    
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab-item[data-target="${viewId}"]`)?.classList.add('active');
}

// --- SETUP FUNCTIONS ---
window.setRandomText = () => {
    globalLang = document.getElementById('globalLang').value;
    const lib = SAMPLE_LIBRARY[globalLang] || SAMPLE_LIBRARY['vi-VN'];
    const txt = lib[Math.floor(Math.random() * lib.length)];
    document.getElementById('sampleText').value = txt;
}

window.clearText = () => document.getElementById('sampleText').value = '';

function populateVoices() {
    const langCode = document.getElementById('globalLang').value.split('-')[0];
    const avail = voices.filter(v => v.lang.startsWith(langCode));
    const sel = document.getElementById('voiceSelect');
    sel.innerHTML = avail.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    if(avail.length > 0) selectedVoice = avail[0];
}

window.previewVoice = () => {
    const vName = document.getElementById('voiceSelect').value;
    selectedVoice = voices.find(v => v.name === vName);
    const u = new SpeechSynthesisUtterance("Test voice");
    if(selectedVoice) u.voice = selectedVoice;
    window.speechSynthesis.speak(u);
}

// --- GAME LOGIC ---
window.startGame = () => {
    const raw = document.getElementById('sampleText').value.trim();
    if(!raw) return alert("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ho·∫∑c ch·ªçn b√†i m·∫´u!");
    
    segments = raw.split(/(?<=[.!?])\s+|\n+/).filter(s => s.trim());
    currentIdx = 0;
    currentMode = document.getElementById('gameMode').value;
    globalLang = document.getElementById('globalLang').value;
    
    // Stats reset
    typedWords = 0; totalCorrect = 0;
    
    // UI Setup
    document.getElementById('inputArea').style.display = currentMode === 'read-only' ? 'none' : 'block';
    document.getElementById('micArea').style.display = currentMode === 'read-only' ? 'block' : 'none';
    
    window.navTo('view-practice');
    startTimer();
    showSegment();
}

function showSegment() {
    const seg = segments[currentIdx];
    const box = document.getElementById('currentSegment');
    const input = document.getElementById('userInput');
    const nextBtn = document.getElementById('nextBtn');
    
    input.value = '';
    nextBtn.disabled = true;
    nextBtn.style.opacity = '0.5';
    correctWords = 0;
    
    // HTML render
    if(currentMode === 'listen-write') {
        box.innerHTML = '<i class="fas fa-headphones" style="font-size:3rem; opacity:0.5;"></i><br>Nghe v√† ch√©p l·∫°i...';
        speakCurrent();
    } else {
        const words = seg.split(/\s+/);
        box.innerHTML = words.map(w => `<span class="karaoke-word">${w}</span>`).join(' ');
        if(currentMode === 'read-listen-write') setTimeout(speakCurrent, 500);
    }
}

window.speakCurrent = () => {
    if(currentMode === 'read-only') return; // Read mode uses user voice
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(segments[currentIdx]);
    u.lang = globalLang;
    if(selectedVoice) u.voice = selectedVoice;
    
    // Karaoke highlight
    if(currentMode !== 'listen-write') {
        u.onboundary = (e) => {
             if(e.name === 'word') {
                 const words = document.querySelectorAll('.karaoke-word');
                 words.forEach(w => w.classList.remove('karaoke-active'));
                 // Simple mapping based on index approximation
                 const idx = Math.floor(e.charIndex / segments[currentIdx].length * words.length);
                 if(words[idx]) words[idx].classList.add('karaoke-active');
             }
        };
    }
    window.speechSynthesis.speak(u);
}

// Typing Logic
document.getElementById('userInput').addEventListener('input', (e) => {
    const target = segments[currentIdx];
    const val = e.target.value;
    const fb = document.getElementById('feedback');
    
    const targetWords = target.split(/\s+/);
    const inputWords = val.trim().split(/\s+/);
    
    let html = '';
    let correct = 0;
    
    inputWords.forEach((w, i) => {
        if(!w) return;
        if(i < targetWords.length) {
            const cleanT = targetWords[i].replace(/[.,!?;:"()]/g, "").toLowerCase();
            const cleanI = w.replace(/[.,!?;:"()]/g, "").toLowerCase();
            if(cleanT === cleanI) {
                html += `<span class="correct">${w}</span> `;
                correct++;
            } else {
                html += `<span class="wrong">${w}</span> `;
            }
        }
    });
    
    fb.innerHTML = html;
    correctWords = correct;
    
    // Check completion
    const normTarget = target.replace(/\s+/g, ' ').trim();
    const normVal = val.replace(/\s+/g, ' ').trim();
    
    if(normVal.toLowerCase() === normTarget.toLowerCase()) {
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').style.opacity = '1';
        e.target.style.borderColor = '#4ade80';
    } else {
        e.target.style.borderColor = 'rgba(255,255,255,0.3)';
    }
});

// Mic Logic (Read-Only Mode)
document.getElementById('micBtn').addEventListener('click', () => {
    if(!recognition) initRecognition();
    if(isListening) {
        recognition.stop();
        document.getElementById('micBtn').classList.remove('listening');
        isListening = false;
    } else {
        recognition.start();
        document.getElementById('micBtn').classList.add('listening');
        isListening = true;
    }
});

function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Mic!");
    
    recognition = new SpeechRecognition();
    recognition.lang = globalLang;
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onresult = (e) => {
        const trans = Array.from(e.results).map(r => r[0].transcript).join('');
        document.getElementById('feedback').innerHTML = `<span style="color:#fbbf24">${trans}</span>`;
        
        const target = segments[currentIdx].toLowerCase().replace(/[.,!?;:]/g,'');
        const attempt = trans.toLowerCase().replace(/[.,!?;:]/g,'');
        
        if(attempt.includes(target) || target.includes(attempt) && attempt.length > target.length*0.8) {
             document.getElementById('nextBtn').disabled = false;
             document.getElementById('nextBtn').style.opacity = '1';
             document.getElementById('feedback').innerHTML = `<span class="correct">${trans}</span> (Ch√≠nh x√°c!)`;
             confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
        }
    };
    recognition.onend = () => {
        document.getElementById('micBtn').classList.remove('listening');
        isListening = false;
    };
}

// Next Logic
window.nextSegment = () => {
    // Calc stats for current segment
    const words = segments[currentIdx].split(/\s+/).length;
    typedWords += words;
    totalCorrect += words; // Assume correct if passed
    
    currentIdx++;
    if(currentIdx < segments.length) {
        showSegment();
    } else {
        endGame();
    }
    
    updateStatsDisplay();
    document.getElementById('userInput').style.borderColor = 'rgba(255,255,255,0.3)';
    document.getElementById('feedback').innerHTML = '';
}

function startTimer() {
    startTime = Date.now();
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(() => {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('statTime').innerText = diff + 's';
    }, 1000);
}

function updateStatsDisplay() {
    const diffMin = (Date.now() - startTime) / 1000 / 60;
    const wpm = diffMin > 0 ? Math.round(typedWords / diffMin) : 0;
    document.getElementById('statWPM').innerText = wpm;
    
    const pct = Math.round((currentIdx / segments.length) * 100);
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressTxt').innerText = pct + '%';
}

function endGame() {
    clearInterval(timerInt);
    const diffMin = (Date.now() - startTime) / 1000 / 60;
    const wpm = Math.round(typedWords / diffMin) || 0;
    const acc = 100; // Simplified for completion
    const score = Math.round(wpm * 2 + (typedWords * 5));
    
    document.getElementById('statScore').innerText = score;
    
    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
    alert(`Ho√†n th√†nh!\nWPM: ${wpm}\nƒêi·ªÉm: ${score}`);
    
    // Save to Firebase
    window.saveScore(wpm, acc, score, segments.length);
    
    window.navTo('view-leaderboard');
}

window.useHint = () => {
    const input = document.getElementById('userInput');
    const target = segments[currentIdx];
    const currentLen = input.value.length;
    input.value = target.substring(0, currentLen + 5);
    input.focus();
}

</script>

<a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
    <span>Trang ch·ªß</span>
</a>

<style>
    .floating-home-btn {
        position: fixed; top: 20px; left: 20px; z-index: 1000;
        display: flex; align-items: center; gap: 10px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px; color: white; text-decoration: none;
        font-family: 'Poppins', sans-serif; font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease; overflow: hidden;
    }
    .floating-home-btn:hover {
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transform: translateY(2px); box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        border-color: transparent; color: #0f172a;
    }
    .floating-home-btn svg { width: 24px; height: 24px; transition: transform 0.3s ease; }
    .floating-home-btn:hover svg { transform: scale(1.1); }
    @media (max-width: 640px) {
        .floating-home-btn span { display: none; }
        .floating-home-btn { padding: 12px; border-radius: 50%; }
    }
</style>
</body>
</html>
