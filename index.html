<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ (Firebase Sync)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, rank tu·∫ßn th√°ng.">
  <meta name="theme-color" content="#f97316">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- M√ÄU S·∫ÆC M·ªöI: CAM & TR·∫ÆNG (DEFAULT) --- */
      --bg-gradient: radial-gradient(at 0% 0%, hsla(27, 96%, 95%, 1) 0, transparent 50%), 
                     radial-gradient(at 50% 100%, hsla(35, 100%, 96%, 1) 0, transparent 50%), 
                     radial-gradient(at 100% 0%, hsla(15, 90%, 95%, 1) 0, transparent 50%);
      --bg-color: #fffbf7;
      
      --glass-surface: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(249, 115, 22, 0.25);
      --glass-blur: 24px;

      --text: #431407;
      --text-dim: #9a3412;
      
      --primary-gradient: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --primary-shadow: rgba(249, 115, 22, 0.4);
      --primary: #f97316;
      
      --success: #16a34a; 
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;
      --purple: #8b5cf6;
      --purple-shadow: rgba(139, 92, 246, 0.4);

      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-sm: 0 4px 6px -1px rgba(249, 115, 22, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(249, 115, 22, 0.15), 0 8px 10px -6px rgba(249, 115, 22, 0.1);
      --shadow-glow: 0 0 20px rgba(249, 115, 22, 0.3);
    }

    /* --- DARK MODE --- */
    [data-theme="dark"] {
      --bg-color: #0f172a;
      --bg-gradient: radial-gradient(at 0% 0%, hsla(222, 47%, 11%, 1) 0, transparent 50%), 
                     radial-gradient(at 100% 100%, hsla(222, 47%, 15%, 1) 0, transparent 50%);
      --glass-surface: rgba(30, 41, 59, 0.85);
      --glass-border: rgba(255, 255, 255, 0.15);
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      --primary: #fb923c;
      --primary-gradient: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    }

    /* --- HOLIDAY MODE --- */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #d42f2f 0%, #108538 100%);
      --primary-shadow: rgba(212, 47, 47, 0.4);
      --primary: #d42f2f;
      --font-display: 'Mountains of Christmas', cursive;
    }
    [data-theme="holiday"] {
      --bg-color: #fef2f2;
      --bg-gradient: radial-gradient(circle at 50% 0%, #fee2e2 0%, transparent 60%);
      --glass-surface: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(220, 38, 38, 0.2);
      --text: #14532d; --text-dim: #b91c1c;
    }
    [data-theme="holiday-dark"] {
      --bg-color: #1a0505;
      --glass-surface: rgba(40, 10, 10, 0.85);
      --glass-border: rgba(255, 215, 0, 0.2);
      --text: #ffe4e6; --text-dim: #fca5a5;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* Aurora BG */
    .aurora-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; pointer-events: none; }
    .aurora-blob { position: absolute; filter: blur(80px); opacity: 0.5; animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #fb923c; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #fbbf24; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #fca5a5; animation-delay: -10s; }
    [data-theme*="holiday"] .blob-1 { background: #dc2626; opacity: 0.4; }
    [data-theme*="holiday"] .blob-2 { background: #15803d; opacity: 0.4; }
    [data-theme="dark"] .blob-1 { background: #7c2d12; opacity: 0.2; }
    @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, 40px) scale(1.1); } }

    .snowflake { position: fixed; top: -10px; z-index: 999; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none; animation: fall linear forwards; display: none; }
    [data-theme*="holiday"] .snowflake { display: block; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 32px; position: relative; z-index: 10; padding-top: 40px; }

    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    header { padding: 40px 30px; text-align: center; position: relative; overflow: hidden; }
    header::before { content: ''; position: absolute; top:0; left:0; right:0; height: 6px; background: var(--primary-gradient); }
    
    .logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
    .logo svg { width: 50px; height: 50px; fill: url(#grad1); animation: floatLogo 6s ease-in-out infinite; }
    .logo h1 { font-family: var(--font-display); font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.1; }
    .tagline { color: var(--text-dim); font-size: 1.1rem; font-weight: 500; }
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px) rotate(2deg)} }

    .theme-toggle-wrapper { position: absolute; top: 20px; right: 20px; display: flex; gap: 12px; }
    .icon-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: var(--shadow-sm); font-size: 1.2rem; }
    .icon-btn:hover { background: var(--text); color: var(--bg-color); transform: rotate(15deg); }
    
    #logoutBtn { color: var(--danger); }
    [data-theme*="holiday"] #holidayBtn { background: #d42f2f; color: #fff; border-color: #fbbf24; }

    /* --- TABS --- */
    .tabs { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; background: var(--glass-surface); padding: 8px; border-radius: 24px; border: 1px solid var(--glass-border); margin: 0 auto; box-shadow: var(--shadow-sm); width: fit-content; }
    .tab { padding: 10px 24px; border-radius: 16px; border: none; background: transparent; color: var(--text-dim); font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.3s; font-family: var(--font-main); }
    .tab.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px var(--primary-shadow); }

    .user-info-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
    .user-name { font-weight: 700; color: var(--primary); font-family: var(--font-display); font-size: 1.2rem; }

    /* --- SETUP GRID --- */
    .setup-grid { padding: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
    .setup-item { background: rgba(255,255,255,0.05); border-radius: var(--input-radius); padding: 24px; border: 1px solid var(--glass-border); }
    .setup-item h3 { font-size: 1.1rem; margin-bottom: 16px; color: var(--primary); font-weight: 700; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    
    select, textarea, input[type="text"] { width: 100%; padding: 14px 16px; border: 2px solid var(--glass-border); border-radius: var(--input-radius); background: rgba(255,255,255,0.6); color: var(--text); font-family: var(--font-main); font-size: 1rem; transition: 0.3s; }
    [data-theme="dark"] select, [data-theme="dark"] textarea { background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.2); }
    select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-shadow); }

    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; color: var(--text); }
    .radio-label:has(input:checked) { background: rgba(249, 115, 22, 0.15); border-color: var(--primary); font-weight: 600; }
    input[type="radio"] { accent-color: var(--primary); width: 18px; height: 18px; }

    .start-btn { grid-column: 1/-1; margin-top: 10px; padding: 20px; background: var(--primary-gradient); color: white; font-weight: 700; font-size: 1.25rem; border: none; border-radius: var(--btn-radius); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 20px var(--primary-shadow); transition: transform 0.3s; text-transform: uppercase; letter-spacing: 1px; }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); }

    .btn-small-action { font-size: 0.85rem; padding: 6px 12px; border-radius: 10px; cursor: pointer; border: none; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .reset-text-btn { color: var(--info); background: rgba(14, 165, 233, 0.1); display: none; }
    .random-text-btn { background: var(--purple); color: white; animation: pulsePurple 2s infinite; }
    @keyframes pulsePurple { 0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); } 70% { box-shadow: 0 0 0 6px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    /* --- PRACTICE AREA --- */
    #practiceArea, #rankPanel, #leaderboardPanel { padding: 40px; }
    .mode-switcher { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .mode-btn { padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border); background: transparent; color: var(--text); font-weight: 600; cursor: pointer; transition: 0.3s; }
    .mode-btn.active { background: var(--text); color: var(--bg-color); border-color: transparent; }

    .progress-box { margin-bottom: 20px; }
    .progress-bar { height: 12px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    [data-theme="dark"] .progress-bar { background: rgba(255,255,255,0.1); }
    .progress-fill { height: 100%; background: var(--primary-gradient); width: 0; border-radius: 10px; transition: width 0.5s ease; }

    .segment-box { font-size: 1.6rem; line-height: 1.8; text-align: center; min-height: 160px; padding: 40px; background: rgba(255,255,255,0.5); border-radius: 20px; border: 2px dashed var(--primary); margin-bottom: 24px; color: var(--text); font-weight: 600; }
    [data-theme="dark"] .segment-box { background: rgba(0,0,0,0.2); border-color: var(--text-dim); }
    
    .karaoke-word { padding: 4px 6px; border-radius: 8px; transition: 0.2s; position: relative; display: inline-block; white-space: pre-wrap; }
    .karaoke-active { background: var(--primary); color: white !important; transform: scale(1.1); box-shadow: 0 4px 12px var(--primary-shadow); z-index: 10; }
    .word-tooltip { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; z-index: 15; }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput { font-size: 1.5rem; padding: 20px 60px 20px 24px; border-radius: 24px; border: 2px solid var(--glass-border); box-shadow: var(--shadow-sm); }
    .hint-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 12px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    #liveFeedback { font-family: 'Courier New', monospace; font-size: 1.2rem; min-height: 50px; margin-bottom: 30px; color: var(--text-dim); text-align: center; }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    .action-row { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .action-btn { padding: 16px 32px; border-radius: 16px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .btn-replay { background: var(--warning); }
    .btn-next { background: var(--success); }
    .btn-reset { background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); }
    
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px; }
    .stat-item { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 16px; border-radius: 16px; text-align: center; }
    .stat-item h4 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-item .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }
    .level-badge { display: inline-block; padding: 8px 24px; border-radius: 30px; background: var(--primary-gradient); color: white; font-weight: 700; box-shadow: var(--shadow-glow); margin-top: 20px; }

    /* --- LEADERBOARD --- */
    .leaderboard-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .lb-btn { padding: 8px 16px; border-radius: 12px; border: 1px solid var(--glass-border); background: transparent; color: var(--text); cursor: pointer; font-weight: 600; }
    .lb-btn.active { background: var(--primary); color: white; border-color: transparent; }
    
    .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .rank-table th { text-align: left; padding: 12px; color: var(--text-dim); border-bottom: 2px solid var(--glass-border); }
    .rank-table td { padding: 14px 12px; border-bottom: 1px solid var(--glass-border); vertical-align: middle; }
    .rank-num { font-weight: 800; font-family: var(--font-display); font-size: 1.2rem; width: 40px; display: inline-block; text-align: center; }
    .rank-1 { color: #f59e0b; font-size: 1.5rem; } /* Gold */
    .rank-2 { color: #94a3b8; font-size: 1.4rem; } /* Silver */
    .rank-3 { color: #b45309; font-size: 1.3rem; } /* Bronze */
    
    .player-cell { display: flex; align-items: center; gap: 10px; }
    .player-avatar-small { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }

    /* --- MODAL --- */
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content { background: var(--bg-color); border: 1px solid var(--glass-border); padding: 40px; border-radius: 32px; width: 90%; max-width: 450px; text-align: center; box-shadow: var(--shadow-lg); color: var(--text); }
    .modal h3 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 24px; color: var(--primary); }
    
    .google-btn { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: white; color: #333; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; margin-bottom: 15px; }
    .google-btn:hover { background: #f1f5f9; transform: translateY(-2px); }
    .google-icon { width: 20px; height: 20px; }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
      #userInput { font-size: 1.2rem; }
    }
    .hidden { display: none !important; }
    .mic-btn { width: 70px; height: 70px; border-radius: 50%; background: var(--danger); color: white; font-size: 2rem; border: none; cursor: pointer; margin: 0 auto 20px; display: block; transition: 0.3s; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4); }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    .svg-defs { width: 0; height: 0; position: absolute; }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  
  <div id="snowContainer"></div>
  
  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán S√°ng/T·ªëi">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <button class="icon-btn hidden" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">Firebase</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & Leo Rank c√πng b·∫°n b√® üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™</button>
      <button class="tab" data-tab="leaderboardPanel">B·∫£ng X·∫øp H·∫°ng</button>
    </div>

    <div class="user-info-bar">
      <img id="displayAvatar" src="https://ui-avatars.com/api/?name=Guest" class="user-avatar" alt="Avatar">
      <span id="displayName" class="user-name">Kh√°ch</span>
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ luy·ªán</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
            <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
            <option value="it-IT">Ti·∫øng √ù</option>
            <option value="la-VA">Ti·∫øng Latin</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <h3>
            <span>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</span>
            <div style="display:flex; gap:10px;">
                <button id="randomTextBtn" class="btn-small-action random-text-btn">üé≤ B√†i m·∫´u ng·∫´u nhi√™n</button>
                <button id="resetTextBtn" class="btn-small-action reset-text-btn">üîÑ Ho√†n t√°c</button>
            </div>
          </h3>
          <textarea id="sampleText" rows="6" spellcheck="false" placeholder="Ch·ªçn b√†i m·∫´u ho·∫∑c t·ª± nh·∫≠p..."></textarea>
        </div>

        <button class="start-btn" id="startBtn">
          <svg style="width:24px;height:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display); margin-bottom:20px;">L·ªãch S·ª≠ C·ªßa B·∫°n</h2>
      <div id="personalStats">
        <div class="stats-row" id="personalStatsRow">
          <div class="stat-item"><h4>WPM Max</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c TB</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>S·ªë b√†i t·∫≠p</h4><div class="val" id="personalGames">0</div></div> 
          <div class="stat-item"><h4>T·ªïng ƒêi·ªÉm</h4><div class="val" id="personalTotalScore">0</div></div>
        </div>
        <div style="margin-top: 40px; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px;">
             <canvas id="personalChart"></canvas>
        </div>
      </div>
    </div>

    <div id="leaderboardPanel" class="tab-content glass-card hidden">
        <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display);">B·∫£ng X·∫øp H·∫°ng</h2>
        <div class="leaderboard-toggle">
            <button class="lb-btn active" id="lbWeeklyBtn">Tu·∫ßn N√†y</button>
            <button class="lb-btn" id="lbMonthlyBtn">Th√°ng N√†y</button>
        </div>
        <div id="leaderboardContainer" style="overflow-x:auto;">
            <table class="rank-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Th√†nh vi√™n</th>
                        <th>WPM</th>
                        <th>ƒêi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:20px; color:var(--text-dim);">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√†nh t√≠ch v√† ƒëua top.</p>
        
        <button class="google-btn" id="loginGoogleBtn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon" alt="G">
            ƒêƒÉng nh·∫≠p b·∫±ng Google
        </button>

        <p style="font-size:0.8rem; margin-top:10px;">Ho·∫∑c</p>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">Ch∆°i ·∫©n danh</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div class="action-row">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
      </div>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem;">
        HiHi App <span style="color:red">‚ù§Ô∏è</span> - Phi√™n b·∫£n Firebase
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBWknPoFq6ny8F_CpeYMu_3N6QEVM3s9Pc",
      authDomain: "xh-chinhta.firebaseapp.com",
      databaseURL: "https://xh-chinhta-default-rtdb.firebaseio.com",
      projectId: "xh-chinhta",
      storageBucket: "xh-chinhta.firebasestorage.app",
      messagingSenderId: "535611478192",
      appId: "1:535611478192:web:c45475177c8dcef8ef6b75",
      measurementId: "G-NCC6MG2HMM"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let personalHistory = [];

    // --- HELPER TIME ---
    function getWeekId() {
        const d = new Date();
        const year = d.getFullYear();
        const onejan = new Date(year, 0, 1);
        const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
        return `${year}-W${week}`;
    }
    function getMonthId() {
        const d = new Date();
        return `${d.getFullYear()}-M${d.getMonth() + 1}`;
    }

    // --- AUTH LOGIC ---
    const els = {
        loginModal: document.getElementById('loginModal'),
        loginGoogle: document.getElementById('loginGoogleBtn'),
        skipLogin: document.getElementById('skipLoginBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        displayName: document.getElementById('displayName'),
        displayAvatar: document.getElementById('displayAvatar'),
        lbWeekly: document.getElementById('lbWeeklyBtn'),
        lbMonthly: document.getElementById('lbMonthlyBtn'),
        lbBody: document.getElementById('leaderboardBody')
    };

    // Listen Auth State
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            els.loginModal.classList.remove('show');
            els.logoutBtn.classList.remove('hidden');
            els.displayName.textContent = user.displayName || "·∫®n danh";
            els.displayAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'Guest'}`;
            
            // Sync Profile
            set(ref(db, 'users/' + user.uid + '/profile'), {
                name: user.displayName || "·∫®n danh",
                photo: user.photoURL || "",
                lastLogin: new Date().toISOString()
            });

            // Load Data
            loadUserHistory(user.uid);
        } else {
            currentUser = null;
            els.logoutBtn.classList.add('hidden');
            els.displayName.textContent = "Kh√°ch";
            els.displayAvatar.src = "https://ui-avatars.com/api/?name=Guest";
            els.loginModal.classList.add('show');
            personalHistory = [];
            renderPersonalStats();
        }
    });

    els.loginGoogle.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(err => {
            alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
            console.error(err);
        });
    });

    els.skipLogin.addEventListener('click', () => {
        signInAnonymously(auth).catch(err => console.error(err));
    });

    els.logoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // --- DATABASE LOGIC ---
    
    // Save Game Result
    window.saveGameResult = function(wpm, acc, score, badge) {
        if (!currentUser) return;
        const uid = currentUser.uid;
        
        // 1. Save History
        const newRecord = {
            date: new Date().toISOString(),
            wpm, acc, score, badge
        };
        push(ref(db, `history/${uid}`), newRecord);

        // 2. Update Personal Max (Atomic check ideally, simplified here)
        // We just fetch current max and update if higher
        get(ref(db, `users/${uid}/stats`)).then(snap => {
            const stats = snap.val() || { maxWPM: 0, totalScore: 0, games: 0 };
            const updates = {
                games: stats.games + 1,
                totalScore: stats.totalScore + score,
                maxWPM: Math.max(stats.maxWPM, wpm)
            };
            set(ref(db, `users/${uid}/stats`), updates);

            // 3. Update Leaderboard (Weekly & Monthly)
            // Save the Highest Score of the week/month for the user
            const weekId = getWeekId();
            const monthId = getMonthId();
            
            // Logic: Overwrite if new score is higher? Or Accumulate? 
            // Usually Leaderboard is "Highest Score in a single run" OR "Total Accumulated".
            // Let's do **Highest Single Run Score** for simplicity and skill measure.
            
            const updateLeaderboard = (path, currentScore) => {
                 get(ref(db, path)).then(s => {
                     const existing = s.val() || 0;
                     if (currentScore > existing) {
                         set(ref(db, path), currentScore);
                         // Also save extra details for display
                         set(ref(db, path.replace('score', 'details')), {
                             name: currentUser.displayName || "·∫®n danh",
                             photo: currentUser.photoURL || "",
                             wpm: wpm
                         });
                     }
                 });
            };

            updateLeaderboard(`leaderboard/weekly/${weekId}/${uid}/score`, score);
            updateLeaderboard(`leaderboard/monthly/${monthId}/${uid}/score`, score);
        });
    };

    // Load History
    function loadUserHistory(uid) {
        const historyRef = query(ref(db, `history/${uid}`), limitToLast(20));
        onValue(historyRef, (snapshot) => {
            const data = snapshot.val();
            personalHistory = data ? Object.values(data) : [];
            renderPersonalStats();
        });
        
        // Load aggregate stats
        onValue(ref(db, `users/${uid}/stats`), (snap) => {
            const stats = snap.val();
            if(stats) {
                document.getElementById('personalGames').textContent = stats.games;
                document.getElementById('personalTotalScore').textContent = stats.totalScore;
                document.getElementById('personalWPM').textContent = stats.maxWPM;
            }
        });
    }

    // --- LEADERBOARD DISPLAY ---
    function fetchLeaderboard(type) {
        const timeId = type === 'weekly' ? getWeekId() : getMonthId();
        const lbPath = `leaderboard/${type}/${timeId}`;
        
        els.lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr>';
        
        // We need to query by score. 
        // Note: Structure is { uid: { score: 100, details: {...} } }
        // Firebase sorting is tricky with nested objects. 
        // For this demo, we fetch the whole node and sort in JS (fine for small apps).
        
        get(ref(db, lbPath)).then(snapshot => {
            const data = snapshot.val();
            if (!data) {
                els.lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu cho th·ªùi gian n√†y.</td></tr>';
                return;
            }

            const arr = Object.keys(data).map(uid => ({
                uid,
                score: data[uid].score,
                details: data[uid].details
            }));

            // Sort Descending
            arr.sort((a, b) => b.score - a.score);

            let html = '';
            arr.slice(0, 20).forEach((item, index) => {
                const rank = index + 1;
                let rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
                
                html += `
                    <tr>
                        <td><span class="rank-num ${rankClass}">${rank}</span></td>
                        <td>
                            <div class="player-cell">
                                <img src="${item.details.photo || 'https://ui-avatars.com/api/?name=' + item.details.name}" class="player-avatar-small">
                                <span>${item.details.name}</span>
                            </div>
                        </td>
                        <td style="font-weight:bold;">${item.details.wpm}</td>
                        <td style="font-weight:800; color:var(--primary);">${item.score}</td>
                    </tr>
                `;
            });
            els.lbBody.innerHTML = html;
        });
    }

    els.lbWeekly.addEventListener('click', () => {
        els.lbWeekly.classList.add('active');
        els.lbMonthly.classList.remove('active');
        fetchLeaderboard('weekly');
    });

    els.lbMonthly.addEventListener('click', () => {
        els.lbMonthly.classList.add('active');
        els.lbWeekly.classList.remove('active');
        fetchLeaderboard('monthly');
    });

    // --- CHART RENDER ---
    window.renderPersonalStats = function() {
        // Calculate Avg Acc
        if (personalHistory.length > 0) {
            const totalAcc = personalHistory.reduce((sum, h) => sum + h.acc, 0);
            document.getElementById('personalAcc').textContent = Math.round(totalAcc / personalHistory.length) + '%';
        }

        const ctx = document.getElementById('personalChart').getContext('2d');
        if (window.myChart) window.myChart.destroy();
        
        const recent = personalHistory.slice(-10); // Last 10
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: recent.map((_, i) => `L·∫ßn ${i+1}`),
                datasets: [
                    { label: 'WPM', data: recent.map(h => h.wpm), borderColor: '#f97316', tension: 0.4, fill: true, backgroundColor: 'rgba(249, 115, 22, 0.2)' },
                    { label: 'ƒêi·ªÉm', data: recent.map(h => h.score), borderColor: '#ea580c', tension: 0.4 }
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // Load initial LB
    fetchLeaderboard('weekly');

  </script>

  <script>
    // === 1. TH∆Ø VI·ªÜN D·ªÆ LI·ªÜU ƒêA NG√îN NG·ªÆ KH·ªîNG L·ªí ===
    const SAMPLE_LIBRARY = {
        'vi-VN': [
          "S√¥ng M√£ xa r·ªìi T√¢y Ti·∫øn ∆°i! Nh·ªõ v·ªÅ r·ª´ng n√∫i, nh·ªõ ch∆°i v∆°i. S√†i Khao s∆∞∆°ng l·∫•p ƒëo√†n qu√¢n m·ªèi, M∆∞·ªùng L√°t hoa v·ªÅ trong ƒë√™m h∆°i.",
          "M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ ta? M∆∞·ªùi lƒÉm nƒÉm ·∫•y thi·∫øt tha m·∫∑n n·ªìng. M√¨nh v·ªÅ m√¨nh c√≥ nh·ªõ kh√¥ng, Nh√¨n c√¢y nh·ªõ n√∫i, nh√¨n s√¥ng nh·ªõ ngu·ªìn?",
          "B·ªóng nh·∫≠n ra h∆∞∆°ng ·ªïi, Ph·∫£ v√†o trong gi√≥ se, S∆∞∆°ng ch√πng ch√¨nh qua ng√µ, H√¨nh nh∆∞ thu ƒë√£ v·ªÅ.",
          "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau. Tr·∫£i qua m·ªôt cu·ªôc b·ªÉ d√¢u, nh·ªØng ƒëi·ªÅu tr√¥ng th·∫•y m√† ƒëau ƒë·ªõn l√≤ng.",
          "S√¥ng n√∫i n∆∞·ªõc Nam vua Nam ·ªü. R√†nh r√†nh ƒë·ªãnh ph·∫≠n t·∫°i s√°ch tr·ªùi. C·ªõ sao l≈© gi·∫∑c sang x√¢m ph·∫°m? Ch√∫ng bay s·∫Ω b·ªã ƒë√°nh t∆°i b·ªùi.",
          "Th√¢n em v·ª´a tr·∫Øng l·∫°i v·ª´a tr√≤n. B·∫£y n·ªïi ba ch√¨m v·ªõi n∆∞·ªõc non. R·∫Øn n√°t m·∫∑c d·∫ßu tay k·∫ª n·∫∑n. M√† em v·∫´n gi·ªØ t·∫•m l√≤ng son.",
          "M·ªói nƒÉm hoa ƒë√†o n·ªü. L·∫°i th·∫•y √¥ng ƒë·ªì gi√†. B√†y m·ª±c t√†u gi·∫•y ƒë·ªè. B√™n ph·ªë ƒë√¥ng ng∆∞·ªùi qua.",
          "Qu√™ h∆∞∆°ng l√† ch√πm kh·∫ø ng·ªçt. Cho con tr√®o h√°i m·ªói ng√†y. Qu√™ h∆∞∆°ng l√† ƒë∆∞·ªùng ƒëi h·ªçc. Con v·ªÅ r·ª£p b∆∞·ªõm v√†ng bay.",
          "B∆∞·ªõc t·ªõi ƒê√®o Ngang b√≥ng x·∫ø t√†. C·ªè c√¢y chen ƒë√° l√° chen hoa. Lom khom d∆∞·ªõi n√∫i ti√™m v√†i ch√∫. L√°c ƒë√°c b√™n s√¥ng ch·ª£ m·∫•y nh√†.",
          "Sao anh kh√¥ng v·ªÅ ch∆°i th√¥n Vƒ©? Nh√¨n n·∫Øng h√†ng cau n·∫Øng m·ªõi l√™n. V∆∞·ªùn ai m∆∞·ªõt qu√° xanh nh∆∞ ng·ªçc, L√° tr√∫c che ngang m·∫∑t ch·ªØ ƒëi·ªÅn.",
          "C√¥ng cha nh∆∞ n√∫i Th√°i S∆°n. Nghƒ©a m·∫π nh∆∞ n∆∞·ªõc trong ngu·ªìn ch·∫£y ra. M·ªôt l√≤ng th·ªù m·∫π k√≠nh cha. Cho tr√≤n ch·ªØ hi·∫øu m·ªõi l√† ƒë·∫°o con.",
          "M·∫∑t tr·ªùi xu·ªëng bi·ªÉn nh∆∞ h√≤n l·ª≠a. S√≥ng ƒë√£ c√†i then ƒë√™m s·∫≠p c·ª≠a. ƒêo√†n thuy·ªÅn ƒë√°nh c√° l·∫°i ra kh∆°i. C√¢u h√°t cƒÉng bu·ªìm c√πng gi√≥ kh∆°i.",
          "Vi·ªát Nam ƒë·∫•t n∆∞·ªõc ta ∆°i. M√™nh m√¥ng bi·ªÉn l√∫a ƒë√¢u tr·ªùi ƒë·∫πp h∆°n. C√°nh c√≤ bay l·∫£ r·∫≠p r·ªùn. M√¢y m·ªù che ƒë·ªânh Tr∆∞·ªùng S∆°n s·ªõm chi·ªÅu.",
          "Anh ƒëi anh nh·ªõ qu√™ nh√†. Nh·ªõ canh rau mu·ªëng nh·ªõ c√† d·∫ßm t∆∞∆°ng. Nh·ªõ ai d√£i n·∫Øng d·∫ßm s∆∞∆°ng. Nh·ªõ ai t√°t n∆∞·ªõc b√™n ƒë∆∞·ªùng h√¥m nao."
        ],
        'en-US': [
            "The quick brown fox jumps over the lazy dog. Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Two roads diverged in a yellow wood, and sorry I could not travel both. And be one traveler, long I stood and looked down one as far as I could.",
            "I wandered lonely as a cloud that floats on high o'er vales and hills, when all at once I saw a crowd, a host, of golden daffodils.",
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer the slings and arrows of outrageous fortune.",
            "It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife."
        ],
        'id-ID': [
            "Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia yang tertulis pada lambang negara Garuda Pancasila. Maknanya adalah berbeda-beda tetapi tetap satu.",
            "Kami putra dan putri Indonesia, mengaku bertumpah darah yang satu, tanah air Indonesia. Kami putra dan putri Indonesia, mengaku berbangsa yang satu, bangsa Indonesia.",
            "Aku. Kalau sampai waktuku, 'Ku mau tak seorang 'kan merayu. Tidak juga kau. Tak perlu sedu sedan itu."
        ],
        'es-ES': [
            "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que viv√≠a un hidalgo de los de lanza en astillero.",
            "Caminante, no hay camino, se hace camino al andar. Al andar se hace el camino, y al volver la vista atr√°s se ve la senda que nunca se ha de volver a pisar."
        ],
        'it-IT': [
            "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura, ch√© la diritta via era smarrita.",
            "L'amor che move il sole e l'altre stelle."
        ],
        'la-VA': [
            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",
            "Veni, vidi, vici. Alea iacta est. Carpe diem, quam minimum credula postero."
        ]
    };

    // === VARS ===
    const wordCache = {}; 
    let typedWords = 0, correctWords = 0, totalCorrectWords = 0, hintsUsed = 0, totalSentences = 0;
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;

    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      resetTextBtn: document.getElementById('resetTextBtn'),
      randomTextBtn: document.getElementById('randomTextBtn'),
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      levelBadge: document.getElementById('levelBadge'),
      score: document.getElementById('score'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
    };

    // === THEME ===
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }
    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';
        if (themeMode === 'holiday') body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        else body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
        if (themeMode === 'holiday') createSnowflakes(); else document.getElementById('snowContainer').innerHTML = '';
    }
    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }
    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        const base = localStorage.getItem('baseTheme') || 'light';
        applyTheme(nextState ? 'holiday' : base);
    }
    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'light');
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHoliday ? 'holiday' : localStorage.getItem('baseTheme'));
    }

    // === TABS ===
    els.mainTabs().forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.dataset.tab;
            els.mainTabs().forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            els.tabContents().forEach(c => c.classList.toggle('hidden', c.id !== targetId));
            if (btn.dataset.tab === 'rankPanel' && window.renderPersonalStats) window.renderPersonalStats();
        });
    });

    // === VOICES ===
    function loadVoices() {
      const targetCode = globalLang.split('-')[0]; 
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(targetCode));
      if (voices.length === 0 && (globalLang.startsWith('la') || globalLang.startsWith('id'))) {
          voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en') || v.lang.startsWith('es'));
      }
      els.voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>Kh√¥ng t√¨m th·∫•y gi·ªçng</option>';
      const saved = localStorage.getItem('voice');
      selectedVoice = voices.find(v => v.name === saved) || voices[0];
      if (selectedVoice) els.voiceSelect.value = selectedVoice.name;
    }
    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      currentUtterance.lang = globalLang;
      if (onWord) currentUtterance.onboundary = (e) => { if (e.name === 'word') onWord(e.charIndex, e.charLength); };
      speechSynthesis.speak(currentUtterance);
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    // === GAME LOGIC ===
    async function translateFull(text, src) {
      if (!text.trim() || globalLang === 'vi-VN') return text;
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch { return text; }
    }
    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const cleanWord = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!cleanWord) return;
        if (wordCache[cleanWord]) { targetElement.textContent = wordCache[cleanWord]; return; }
        try {
            const src = globalLang.split('-')[0];
            targetElement.textContent = "..."; 
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanWord)}&langpair=${src}|vi`);
            const data = await res.json();
            const result = data.responseData.translatedText;
            if (result) { wordCache[cleanWord] = result; targetElement.textContent = result; } else { targetElement.textContent = "?"; }
        } catch (e) { targetElement.textContent = "?"; }
    }

    function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      const isReadOnly = currentMode === 'read-only';
      els.input.style.display = isReadOnly ? 'none' : 'block';
      els.hint.style.display = isReadOnly ? 'none' : 'flex';
      els.feedback.style.display = 'block';
      els.feedback.innerHTML = '<em>Nh·∫≠p ho·∫∑c ƒë·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const srcLang = globalLang.split('-')[0];
      if (globalLang !== 'vi-VN') {
          els.fullTrans.innerHTML = '<em>ƒêang d·ªãch...</em>';
          translateFull(text, srcLang).then(trans => els.fullTrans.textContent = 'T·∫°m d·ªãch: ' + trans);
      } else els.fullTrans.textContent = '';

      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      const fragment = document.createDocumentFragment();
      const parts = text.split(/(\s+)/);
      let charIndex = 0;
      karaokeWords = [];

      parts.forEach(part => {
          if (!part) return;
          if (/^\s+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
          } else {
              const span = document.createElement('span');
              span.className = 'karaoke-word';
              span.textContent = part;
              span.dataset.start = charIndex;
              span.dataset.end = charIndex + part.length;
              if (globalLang !== 'vi-VN') {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'word-tooltip';
                  tooltip.textContent = "";
                  span.appendChild(tooltip);
                  span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
              }
              karaokeWords.push(span);
              fragment.appendChild(span);
              charIndex += part.length;
          }
      });
      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      if (currentMode.includes('listen') && currentMode !== 'read-only') setTimeout(() => speak(text, highlightKaraoke), 300);
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => {
          const start = parseInt(w.dataset.start);
          const end = parseInt(w.dataset.end);
          return charIndex >= start && charIndex < end;
      });
      if (word) word.classList.add('karaoke-active');
    }

    function normalizeText(text) {
        if (!text) return "";
        return text.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase();
    }

    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;
      const oWords = orig.split(/\s+/).filter(w => w);
      const iWords = input.replace(/ $/, ' \u00A0').split(/\s+/).filter(w => w);
      let html = '', correct = 0;
      
      iWords.forEach((w, i) => {
        if (i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else {
            const cleanTarget = normalizeText(oWords[i]);
            const cleanInput = normalizeText(w);
            if (cleanInput === cleanTarget) { correct++; html += `<span class="correct">${w}</span> `; }
            else html += `<span class="wrong">${w}</span> `;
        }
      });
      correctWords = correct;
      els.feedback.innerHTML = html || '<em>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      if (normalizeText(input) === normalizeText(orig)) {
          els.next.disabled = false;
          els.input.style.borderColor = 'var(--success)';
          els.input.style.boxShadow = '0 0 0 4px rgba(16,185,129,0.25)';
      } else {
          els.next.disabled = true;
          els.input.style.borderColor = '';
          els.input.style.boxShadow = '';
      }
    }

    function next() {
      const wordsInSegment = segments[currentIdx].trim().split(/\s+/).length;
      typedWords += wordsInSegment;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const m = s / 60;
      const wpm = m > 0 ? Math.round(typedWords / m) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      els.wpm.textContent = wpm;
      els.acc.textContent = acc + '%';
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";

      els.levelBadge.textContent = 'ƒê·∫°t c·∫•p: ' + badge;
      els.score.textContent = score; els.wpm.textContent = wpm; els.acc.textContent = acc + '%';
      
      // CALL FIREBASE SAVE (Defined in module script)
      if (window.saveGameResult) window.saveGameResult(wpm, acc, score, badge);
      
      alert(`Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêi·ªÉm: ${score}\nC·∫•p: ${badge}`);
    }

    function initSpeechRecognition() {
      if (recognition) { recognition.onend = null; recognition.stop(); }
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang;
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.onresult = (e) => {
        let finalTranscript = '';
        let interimTranscript = '';
        for (let i = e.resultIndex; i < e.results.length; ++i) {
             if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
             else interimTranscript += e.results[i][0].transcript;
        }
        const target = segments[currentIdx];
        els.feedback.innerHTML = `<span style="color:var(--primary)">${finalTranscript || interimTranscript}</span>`;
        if (finalTranscript) {
             const normTrans = normalizeText(finalTranscript);
             const normTarget = normalizeText(target);
             if (normTrans === normTarget || normTrans.includes(normTarget)) {
                 els.feedback.innerHTML = `<span class="correct">${finalTranscript}</span> (Ch√≠nh x√°c!)`;
                 els.next.disabled = false;
                 setTimeout(next, 1000);
             } else {
                 els.feedback.innerHTML = `<span class="wrong">${finalTranscript}</span> (Th·ª≠ l·∫°i)`;
             }
        }
      };
      recognition.onerror = (e) => { els.micBtn.classList.remove('listening'); isListening = false; };
      recognition.onend = () => { els.micBtn.classList.remove('listening'); isListening = false; };
      return true;
    }

    function setRandomText() {
        const library = SAMPLE_LIBRARY[globalLang] || SAMPLE_LIBRARY['vi-VN'];
        els.text.value = library[Math.floor(Math.random() * library.length)];
        els.resetTextBtn.style.display = 'none';
    }

    // === LISTENERS ===
    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);
    
    els.voiceSelect.addEventListener('change', () => {
        const voiceName = els.voiceSelect.value;
        selectedVoice = voices.find(v => v.name === voiceName);
        if (selectedVoice) localStorage.setItem('voice', selectedVoice.name);
    });
    els.previewVoice.addEventListener('click', () => speak(globalLang === 'vi-VN' ? 'Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.' : 'Hello, this is a voice preview.'));

    els.lang.addEventListener('change', () => {
      globalLang = els.lang.value;
      localStorage.setItem('lang', globalLang);
      loadVoices();
    });

    els.text.addEventListener('input', () => els.resetTextBtn.style.display = 'inline-flex');
    els.resetTextBtn.addEventListener('click', () => { els.text.value = ''; els.resetTextBtn.style.display = 'none'; els.text.focus(); });
    els.randomTextBtn.addEventListener('click', () => {
        setRandomText();
        els.text.style.transition = 'none';
        els.text.style.backgroundColor = 'var(--purple-shadow)';
        setTimeout(() => { els.text.style.transition = '0.3s'; els.text.style.backgroundColor = ''; }, 200);
    });

    els.start.addEventListener('click', () => {
      const text = els.text.value.trim();
      if (!text) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung!');
      segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Kh√¥ng c√≥ ƒëo·∫°n h·ª£p l·ªá!');
      
      currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0; totalSentences = segments.length;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
      startTime = Date.now(); 
      if (timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('practiceArea').classList.remove('hidden');
      initSpeechRecognition(); 
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); if (!els.next.disabled) next(); } });
    els.hint.addEventListener('click', () => {
      const origWords = segments[currentIdx].split(/\s+/).filter(w => w);
      const typedInput = els.input.value.trim();
      const typedCount = typedInput ? typedInput.split(/\s+/).length : 0;
      if (typedCount < origWords.length) {
        els.feedback.innerHTML += ` <span style="color:var(--info); font-weight:700;">‚Üí ${origWords[typedCount]}</span>`;
        hintsUsed++;
        els.input.focus();
      }
    });
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());

    els.modeBtns().forEach(btn => btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
        showSegment();
    }));

    els.micBtn.addEventListener('click', () => {
      if (!recognition) initSpeechRecognition();
      if (isListening) recognition.stop();
      else { 
          try { recognition.start(); els.micBtn.classList.add('listening'); isListening = true; els.feedback.innerHTML = '<em>ƒêang nghe...</em>'; } 
          catch(e) { initSpeechRecognition(); }
      }
    });

    initTheme(); 
    els.lang.value = globalLang;
    window.addEventListener('load', loadVoices);
  </script>
</body>
</html>
