<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ (Multi-Lang Final)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke.">
  <meta name="theme-color" content="#f97316">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- M√ÄU S·∫ÆC M·ªöI: CAM & TR·∫ÆNG (DEFAULT) --- */
      --bg-gradient: radial-gradient(at 0% 0%, hsla(27, 96%, 95%, 1) 0, transparent 50%), 
                     radial-gradient(at 50% 100%, hsla(35, 100%, 96%, 1) 0, transparent 50%), 
                     radial-gradient(at 100% 0%, hsla(15, 90%, 95%, 1) 0, transparent 50%);
      --bg-color: #fffbf7; /* Nh·∫π nh√†ng h∆°n */
      
      --glass-surface: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(249, 115, 22, 0.25);
      --glass-blur: 24px;

      --text: #431407;
      --text-dim: #9a3412;
      
      --primary-gradient: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --primary-shadow: rgba(249, 115, 22, 0.4);
      --primary: #f97316;
      
      --success: #16a34a; 
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;

      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-sm: 0 4px 6px -1px rgba(249, 115, 22, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(249, 115, 22, 0.15), 0 8px 10px -6px rgba(249, 115, 22, 0.1);
      --shadow-glow: 0 0 20px rgba(249, 115, 22, 0.3);
    }

    /* --- DARK MODE --- */
    [data-theme="dark"] {
      --bg-color: #0f172a;
      --bg-gradient: radial-gradient(at 0% 0%, hsla(222, 47%, 11%, 1) 0, transparent 50%), 
                     radial-gradient(at 100% 100%, hsla(222, 47%, 15%, 1) 0, transparent 50%);
      --glass-surface: rgba(30, 41, 59, 0.85); /* ƒê·∫≠m h∆°n ƒë·ªÉ d·ªÖ ƒë·ªçc ch·ªØ */
      --glass-border: rgba(255, 255, 255, 0.15);
      
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      
      --primary: #fb923c; /* Cam s√°ng h∆°n tr√™n n·ªÅn t·ªëi */
      --primary-gradient: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
      
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    }

    /* --- HOLIDAY BASE --- */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #d42f2f 0%, #108538 100%); /* ƒê·ªè sang Xanh */
      --primary-shadow: rgba(212, 47, 47, 0.4);
      --primary: #d42f2f;
      --font-display: 'Mountains of Christmas', cursive;
    }

    /* Holiday Light */
    [data-theme="holiday"] {
      --bg-color: #fef2f2;
      --bg-gradient: radial-gradient(circle at 50% 0%, #fee2e2 0%, transparent 60%);
      --glass-surface: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(220, 38, 38, 0.2);
      --text: #14532d; /* Xanh l√° ƒë·∫≠m */
      --text-dim: #b91c1c; /* ƒê·ªè ƒë·∫≠m */
    }

    /* Holiday Dark */
    [data-theme="holiday-dark"] {
      --bg-color: #1a0505;
      --glass-surface: rgba(40, 10, 10, 0.85);
      --glass-border: rgba(255, 215, 0, 0.2); /* V√†ng gold */
      --text: #ffe4e6;
      --text-dim: #fca5a5;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* Aurora Background Effect */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1; overflow: hidden; pointer-events: none;
    }
    .aurora-blob {
      position: absolute; filter: blur(80px); opacity: 0.5;
      animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #fb923c; animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #fbbf24; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #fca5a5; animation-delay: -10s; }
    
    [data-theme*="holiday"] .blob-1 { background: #dc2626; opacity: 0.4; }
    [data-theme*="holiday"] .blob-2 { background: #15803d; opacity: 0.4; }
    [data-theme*="holiday"] .blob-3 { background: #fbbf24; opacity: 0.3; } /* Gold */
    
    [data-theme="dark"] .blob-1 { background: #7c2d12; opacity: 0.2; }
    [data-theme="dark"] .blob-2 { background: #9a3412; opacity: 0.2; }
    [data-theme="dark"] .blob-3 { background: #451a03; opacity: 0.2; }

    @keyframes floatBlob {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(20px, 40px) scale(1.1); }
    }

    .snowflake {
      position: fixed; top: -10px; z-index: 999; color: #fff; 
      text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none;
      animation: fall linear forwards; display: none;
    }
    [data-theme*="holiday"] .snowflake { display: block; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    .container {
      max-width: 1100px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 32px;
      position: relative; z-index: 10;
      padding-top: 40px;
    }

    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    header {
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: ''; position: absolute; top:0; left:0; right:0; height: 6px;
      background: var(--primary-gradient);
    }
    
    .logo {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      margin-bottom: 8px;
    }
    .logo svg { width: 50px; height: 50px; fill: url(#grad1); animation: floatLogo 6s ease-in-out infinite; }
    
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      line-height: 1.1;
    }
    .tagline {
      color: var(--text-dim); font-size: 1.1rem; font-weight: 500;
    }
    
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px) rotate(2deg)} }

    .theme-toggle-wrapper {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: var(--glass-surface); color: var(--text);
      border: 1px solid var(--glass-border); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s; box-shadow: var(--shadow-sm);
      font-size: 1.2rem;
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--text); color: var(--bg-color); }
    
    #logoutBtn { color: var(--danger); }
    #logoutBtn:hover { background: var(--danger); color: white; }
    #holidayBtn { color: #16a34a; }
    [data-theme*="holiday"] #holidayBtn { background: #d42f2f; color: #fff; border-color: #fbbf24; }

    .tabs {
      display: inline-flex; background: var(--glass-surface);
      padding: 6px; border-radius: 20px; border: 1px solid var(--glass-border);
      margin: 0 auto; position: relative;
      box-shadow: var(--shadow-sm);
    }
    .tab {
      padding: 12px 32px; border-radius: 14px; border: none;
      background: transparent; color: var(--text-dim);
      font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: 0.3s; font-family: var(--font-main);
    }
    .tab.active {
      background: var(--primary-gradient); color: white;
      box-shadow: 0 4px 12px var(--primary-shadow);
    }

    .name-box { text-align: center; margin-bottom: 10px; }
    .name-box input {
      background: transparent; border: none; border-bottom: 2px solid var(--glass-border);
      text-align: center; font-size: 1.2rem; color: var(--text); font-weight: 700;
      width: 300px; padding: 8px; font-family: var(--font-display);
    }
    .name-box input:focus { outline: none; border-color: var(--primary); }

    .setup-grid {
      padding: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;
    }
    .setup-item {
      background: rgba(255,255,255,0.05); border-radius: var(--input-radius);
      padding: 24px; border: 1px solid var(--glass-border);
    }
    .setup-item h3 {
      font-size: 1.1rem; margin-bottom: 16px; color: var(--primary);
      display: flex; align-items: center; gap: 8px; font-weight: 700;
    }
    
    select, textarea, input[type="text"] {
      width: 100%; padding: 14px 16px;
      border: 2px solid var(--glass-border); border-radius: var(--input-radius);
      background: rgba(255,255,255,0.6); color: var(--text); 
      font-family: var(--font-main); font-size: 1rem; transition: 0.3s;
    }
    [data-theme="dark"] select, [data-theme="dark"] textarea, [data-theme="dark"] input[type="text"] {
       background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.2);
    }

    select:focus, textarea:focus, input[type="text"]:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-shadow);
    }

    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent; color: var(--text);
    }
    .radio-label:hover { background: rgba(249, 115, 22, 0.1); }
    .radio-label:has(input:checked) {
      background: rgba(249, 115, 22, 0.15); border-color: var(--primary); font-weight: 600;
    }
    input[type="radio"] { accent-color: var(--primary); width: 18px; height: 18px; }

    .start-btn {
      grid-column: 1/-1;
      margin-top: 10px; padding: 20px;
      background: var(--primary-gradient);
      color: white; font-weight: 700; font-size: 1.25rem;
      border: none; border-radius: var(--btn-radius);
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 10px 20px var(--primary-shadow);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-transform: uppercase; letter-spacing: 1px;
    }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 30px var(--primary-shadow); }
    .start-btn:active { transform: translateY(-1px); }

    .reset-text-btn {
        margin-top: 8px; font-size: 0.85rem; color: var(--info); 
        background: transparent; border: none; cursor: pointer; text-decoration: underline;
        display: none; /* Hi·ªán khi ng∆∞·ªùi d√πng ƒë√£ s·ª≠a text */
    }
    .reset-text-btn:hover { color: var(--primary); }

    #practiceArea, #rankPanel { padding: 40px; }
    
    .mode-switcher { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .mode-btn {
      padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border);
      background: transparent; color: var(--text); font-weight: 600; cursor: pointer;
      transition: 0.3s; font-size: 0.9rem;
    }
    .mode-btn.active { background: var(--text); color: var(--bg-color); border-color: transparent; }

    .progress-box { margin-bottom: 20px; }
    .progress-bar {
      height: 12px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
    }
    [data-theme="dark"] .progress-bar { background: rgba(255,255,255,0.1); }
    .progress-fill {
      height: 100%; background: var(--primary-gradient); width: 0;
      border-radius: 10px; transition: width 0.5s ease;
    }

    .segment-box {
      font-size: 1.6rem; line-height: 1.8; text-align: center;
      min-height: 160px; padding: 40px;
      background: rgba(255,255,255,0.5); border-radius: 20px;
      border: 2px dashed var(--primary); margin-bottom: 24px;
      color: var(--text); font-weight: 600;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    [data-theme="dark"] .segment-box { background: rgba(0,0,0,0.2); border-color: var(--text-dim); }
    
    .karaoke-word {
      padding: 4px 6px; border-radius: 8px; transition: 0.2s; position: relative;
      display: inline-block; white-space: pre-wrap;
    }
    .karaoke-active {
      background: var(--primary); color: white !important; transform: scale(1.1);
      box-shadow: 0 4px 12px var(--primary-shadow); z-index: 10;
    }
    .word-tooltip {
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
        background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px;
        font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.2s;
        white-space: nowrap; z-index: 15;
    }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput {
      font-size: 1.5rem; padding: 20px 60px 20px 24px;
      border-radius: 24px; border: 2px solid var(--glass-border);
      box-shadow: var(--shadow-sm);
    }
    .hint-btn {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--primary); color: white; border: none; font-weight: bold;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    #liveFeedback {
      font-family: 'Courier New', monospace; font-size: 1.2rem;
      min-height: 50px; margin-bottom: 30px; color: var(--text-dim);
    }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    .action-row { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .action-btn {
      padding: 16px 32px; border-radius: 16px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: 0.3s;
      color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }

    .btn-replay { background: var(--warning); }
    .btn-next { background: var(--success); }
    .btn-reset { background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); }
    
    .stats-row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px;
    }
    .stat-item {
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: 16px; text-align: center;
    }
    .stat-item h4 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-item .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }

    .level-badge {
      display: inline-block; padding: 8px 24px; border-radius: 30px;
      background: var(--primary-gradient); color: white; font-weight: 700;
      box-shadow: var(--shadow-glow); margin-top: 20px;
    }

    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-color); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 32px; width: 90%; max-width: 450px;
      text-align: center; box-shadow: var(--shadow-lg); color: var(--text);
    }
    .modal h3 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 24px; color: var(--primary); }

    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
      #userInput { font-size: 1.2rem; }
    }

    .hidden { display: none !important; }
    .mic-btn {
      width: 70px; height: 70px; border-radius: 50%; background: var(--danger); color: white;
      font-size: 2rem; border: none; cursor: pointer; margin: 0 auto 20px; display: block;
      transition: 0.3s; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    .svg-defs { width: 0; height: 0; position: absolute; }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  
  <div id="snowContainer"></div>
  
  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán S√°ng/T·ªëi">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">Final</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ngo·∫°i ng·ªØ phong c√°ch m·ªõi üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™</button>
    </div>

    <div class="name-box">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20" readonly />
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ luy·ªán</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">Ti·∫øng Anh (M·ªπ)</option>
            <option value="id-ID">Ti·∫øng Indonesia</option>
            <option value="es-ES">Ti·∫øng T√¢y Ban Nha</option>
            <option value="it-IT">Ti·∫øng √ù</option>
            <option value="la-VA">Ti·∫øng Latin</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                    <option value="1.50">1.50x (R·∫•t nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <h3>
            ‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o
            <button id="resetTextBtn" class="reset-text-btn">üîÑ Kh√¥i ph·ª•c m·∫´u</button>
          </h3>
          <textarea id="sampleText" rows="4" spellcheck="false" placeholder="Nh·∫≠p ho·∫∑c d√°n ƒëo·∫°n vƒÉn b·∫°n mu·ªën luy·ªán v√†o ƒë√¢y..."></textarea>
          <div style="font-size:0.85rem; color:var(--text-dim); margin-top:5px; font-style:italic;">
             *G·ª£i √Ω: N·∫øu b·∫°n t·ª± nh·∫≠p vƒÉn b·∫£n, h·ªá th·ªëng s·∫Ω gi·ªØ nguy√™n n·ªôi dung c·ªßa b·∫°n khi ƒë·ªïi ng√¥n ng·ªØ.
          </div>
        </div>

        <button class="start-btn" id="startBtn">
          <svg style="width:24px;height:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display);">Th√†nh T√≠ch C√° Nh√¢n</h2>
      <div id="personalStats">
        <div class="stats-row" id="personalStatsRow">
          <div class="stat-item"><h4>WPM Max</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>S·ªë c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
          <div class="stat-item"><h4>ƒêi·ªÉm cao</h4><div class="val"id="personalScore">0</div></div>
        </div>
        <div style="text-align:center; margin-top:20px;"><span class="level-badge" id="personalBadge">H·∫°ng: T√¢n binh</span></div>
        <div style="margin-top: 40px; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px;">
             <canvas id="personalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:20px; color:var(--text-dim);">Nh·∫≠p t√™n ƒë·ªÉ l∆∞u l·∫°i chi·∫øn t√≠ch nh√©.</p>
        <input type="text" id="usernameInput" placeholder="T√™n c·ªßa b·∫°n..." maxlength="20" style="margin-bottom:20px; text-align:center;" />
        <div style="display:flex; gap:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">B·ªè qua</button>
          <button class="action-btn btn-next" id="loginBtn" style="flex:1; justify-content:center; background:var(--primary-gradient);">V√†o ngay</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback" style="text-align:center;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div class="action-row">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
        <div id="level" class="hidden"></div> </div>
      <canvas id="mainChart" class="hidden"></canvas>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem;">
      <p>¬© 2026 HiHi App. Fixed Edition</p>
    </footer>
  </div>

  <script>
    // === 1. D·ªÆ LI·ªÜU M·∫™U ƒêA NG√îN NG·ªÆ ===
    const SAMPLE_TEXTS = {
        'vi-VN': "TrƒÉm nƒÉm trong c√µi ng∆∞·ªùi ta, ch·ªØ t√†i ch·ªØ m·ªánh kh√©o l√† gh√©t nhau. Tr·∫£i qua m·ªôt cu·ªôc b·ªÉ d√¢u, nh·ªØng ƒëi·ªÅu tr√¥ng th·∫•y m√† ƒëau ƒë·ªõn l√≤ng.",
        'en-US': "The quick brown fox jumps over the lazy dog. Success is not final, failure is not fatal: it is the courage to continue that counts.",
        'id-ID': "Bhinneka Tunggal Ika adalah semboyan bangsa Indonesia yang tertulis pada lambang negara Garuda Pancasila. Maknanya adalah berbeda-beda tetapi tetap satu.",
        'es-ES': "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que viv√≠a un hidalgo de los de lanza en astillero.",
        'it-IT': "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura, ch√© la diritta via era smarrita. Ahi quanto a dir qual era √® cosa dura.",
        'la-VA': "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua."
    };

    // === 2. C·∫§U H√åNH & BI·∫æN ===
    const coolNicknames = [
      "Chi·∫øn Binh B√†n Ph√≠m", "Vua G√µ Ch·ªØ", "Th·∫ßn T·ªëc", "HiHi Pro", "Ninja Luy·ªán G√µ",
      "Si√™u Anh H√πng G√µ", "Chuy√™n Gia Ch√≠nh T·∫£", "Ng∆∞·ªùi B·∫°n C·ªßa Ch·ªØ", "ƒê√¥i Tay V√†ng"
    ];
    const wordCache = {}; 

    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let hintsUsed = 0;
    let totalSentences = 0; 
    
    let personalHistory = JSON.parse(localStorage.getItem('personalHistory')) || [];
    let bestStats = JSON.parse(localStorage.getItem('bestStats')) || null;
    let personalChart;
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let playerName = '';
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;
    
    let userHasEditedText = false; // Flag ki·ªÉm tra ng∆∞·ªùi d√πng ƒë√£ s·ª≠a text ch∆∞a

    // === 3. CH·ªåN PH·∫¶N T·ª¨ (DOM) ===
    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      resetTextBtn: document.getElementById('resetTextBtn'),
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      playerName: document.getElementById('playerName'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
      personalStatsRow: document.getElementById('personalStatsRow'),
      personalWPM: document.getElementById('personalWPM'),
      personalAcc: document.getElementById('personalAcc'),
      personalScore: document.getElementById('personalScore'),
      personalSentences: document.getElementById('personalSentences'),
      personalBadge: document.getElementById('personalBadge'),
      personalChart: document.getElementById('personalChart'),
      loginModal: document.getElementById('loginModal'),
      usernameInput: document.getElementById('usernameInput'),
      loginBtn: document.getElementById('loginBtn'),
      skipLoginBtn: document.getElementById('skipLoginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      logoutBtnWrapper: document.getElementById('logoutBtnWrapper')
    };

    // === 4. ƒê·ªäNH NGHƒ®A H√ÄM ===

    // === H·ªÜ TH·ªêNG T√ÄI KHO·∫¢N ===
    function handleLogin(name) {
      if (!name) return;
      playerName = name;
      localStorage.setItem('hihiUser', JSON.stringify({ name: playerName }));
      els.playerName.value = playerName;
      els.playerName.readOnly = true;
      els.loginModal.classList.remove('show');
      els.logoutBtnWrapper.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('hihiUser');
      playerName = '';
      els.playerName.value = '';
      els.playerName.readOnly = true;
      els.logoutBtnWrapper.classList.add('hidden');
      els.loginModal.classList.add('show');
      els.usernameInput.value = '';
    }

    function checkLogin() {
      const user = localStorage.getItem('hihiUser');
      if (user) handleLogin(JSON.parse(user).name);
      else els.loginModal.classList.add('show');
    }
    
    // === CH·ª¶ ƒê·ªÄ & GI√ÅNG SINH ===
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';

        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        } else {
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        }

        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
        
        if (themeMode === 'holiday') createSnowflakes();
        else document.getElementById('snowContainer').innerHTML = '';
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        
        const base = localStorage.getItem('baseTheme') || 'light';
        applyTheme(nextState ? 'holiday' : base);
    }

    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'light');
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        const base = localStorage.getItem('baseTheme');
        applyTheme(isHoliday ? 'holiday' : base);
    }

    // === TABS ===
    function setupTabs(tabButtons, tabContents) {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.tab;
                tabButtons.forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.toggle('hidden', c.id !== targetId));
                if (btn.dataset.tab === 'rankPanel') renderPersonalStats();
            });
        });
    }

    function renderPersonalStats() {
      if (bestStats) {
        els.personalWPM.textContent = bestStats.wpm;
        els.personalAcc.textContent = bestStats.acc + '%';
        els.personalScore.textContent = bestStats.score;
        els.personalSentences.textContent = bestStats.sentences || 0;
        els.personalBadge.textContent = bestStats.badge;
      }
      
      const ctx = els.personalChart.getContext('2d');
      if (personalChart) personalChart.destroy();
      const recentHistory = [...personalHistory].reverse();
      
      personalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: recentHistory.map((_,i) => `L·∫ßn ${i+1}`),
          datasets: [
            { label: 'WPM', data: recentHistory.map(h=>h.wpm), borderColor: '#f97316', tension: 0.4, fill: true, backgroundColor: 'rgba(249, 115, 22, 0.2)' },
            { label: 'ƒêi·ªÉm', data: recentHistory.map(h=>h.score), borderColor: '#ea580c', tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // === GI·ªåNG ƒê·ªåC ===
    function loadVoices() {
      const targetCode = globalLang.split('-')[0]; 
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(targetCode));
      
      // Fallback
      if (voices.length === 0 && (globalLang.startsWith('la') || globalLang.startsWith('id'))) {
          voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en') || v.lang.startsWith('es') || v.lang.startsWith('it'));
      }

      els.voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>Kh√¥ng t√¨m th·∫•y gi·ªçng ph√π h·ª£p</option>';
      const saved = localStorage.getItem('voice');
      selectedVoice = voices.find(v => v.name === saved) || voices[0];
      if (selectedVoice) els.voiceSelect.value = selectedVoice.name;
    }

    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      currentUtterance.lang = globalLang;
      if (onWord) {
        currentUtterance.onboundary = (e) => {
          if (e.name === 'word') onWord(e.charIndex, e.charLength);
        };
      }
      speechSynthesis.speak(currentUtterance);
    }
    
    // === D·ªäCH THU·∫¨T ===
    async function translateFull(text, src) {
      if (!text.trim() || globalLang === 'vi-VN') return text;
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch { return text; }
    }

    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const cleanWord = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!cleanWord) return;

        if (wordCache[cleanWord]) {
            targetElement.textContent = wordCache[cleanWord];
            return;
        }

        try {
            const src = globalLang.split('-')[0];
            targetElement.textContent = "..."; 
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanWord)}&langpair=${src}|vi`);
            const data = await res.json();
            const result = data.responseData.translatedText;
            
            if (result) {
                wordCache[cleanWord] = result;
                targetElement.textContent = result;
            } else {
                targetElement.textContent = "?";
            }
        } catch (e) {
            targetElement.textContent = "?";
        }
    }

    // === HI·ªÇN TH·ªä ƒêO·∫†N VƒÇN ===
    async function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      const isReadOnly = currentMode === 'read-only';
      els.input.style.display = isReadOnly ? 'none' : 'block';
      els.hint.style.display = isReadOnly ? 'none' : 'flex';
      els.feedback.style.display = 'block';
      els.feedback.innerHTML = '<em>Nh·∫≠p ho·∫∑c ƒë·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const srcLang = globalLang.split('-')[0];
      
      if (globalLang !== 'vi-VN') {
          els.fullTrans.innerHTML = '<em>ƒêang d·ªãch...</em>';
          translateFull(text, srcLang).then(trans => {
              els.fullTrans.textContent = 'T·∫°m d·ªãch: ' + trans;
          });
      } else {
          els.fullTrans.textContent = '';
      }

      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      const fragment = document.createDocumentFragment();
      const parts = text.split(/(\s+)/);
      
      let charIndex = 0;
      karaokeWords = [];

      parts.forEach(part => {
          if (!part) return;
          
          if (/^\s+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
          } else {
              const span = document.createElement('span');
              span.className = 'karaoke-word';
              span.textContent = part;
              span.dataset.start = charIndex;
              span.dataset.end = charIndex + part.length;
              
              if (globalLang !== 'vi-VN') {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'word-tooltip';
                  tooltip.textContent = "";
                  span.appendChild(tooltip);
                  span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
              }

              karaokeWords.push(span);
              fragment.appendChild(span);
              charIndex += part.length;
          }
      });

      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      
      if (currentMode.includes('listen') && currentMode !== 'read-only') {
        setTimeout(() => speak(text, highlightKaraoke), 300);
      }
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => {
          const start = parseInt(w.dataset.start);
          const end = parseInt(w.dataset.end);
          return charIndex >= start && charIndex < end;
      });
      if (word) word.classList.add('karaoke-active');
    }

    // H√†m chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh (C·∫£i ti·∫øn)
    function normalizeText(text) {
        if (!text) return "";
        return text.trim()
                   .replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '') // Lo·∫°i b·ªè d·∫•u c√¢u
                   .replace(/\s+/g, ' ') // G·ªôp kho·∫£ng tr·∫Øng
                   .toLowerCase();
    }

    // === X·ª¨ L√ù G√ï PH√çM & FEEDBACK ===
    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;

      const oWords = orig.split(/\s+/).filter(w => w);
      const iWords = input.replace(/ $/, ' \u00A0').split(/\s+/).filter(w => w);
      
      let html = '', correct = 0;
      
      iWords.forEach((w, i) => {
        if (i >= oWords.length) {
            html += `<span class="wrong">${w}</span> `;
        } else {
            const cleanTarget = normalizeText(oWords[i]);
            const cleanInput = normalizeText(w);
            
            if (cleanInput === cleanTarget) {
                correct++;
                html += `<span class="correct">${w}</span> `;
            } else {
                html += `<span class="wrong">${w}</span> `;
            }
        }
      });

      correctWords = correct;
      els.feedback.innerHTML = html || '<em>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      // ƒêi·ªÅu ki·ªán ho√†n th√†nh (so s√°nh chu·ªói ƒë√£ chu·∫©n h√≥a)
      const isContentMatch = normalizeText(input) === normalizeText(orig);

      if (isContentMatch) {
          els.next.disabled = false;
          els.input.style.borderColor = 'var(--success)';
          els.input.style.boxShadow = '0 0 0 4px rgba(16,185,129,0.25)';
      } else {
          els.next.disabled = true;
          els.input.style.borderColor = '';
          els.input.style.boxShadow = '';
      }
    }

    function next() {
      const wordsInSegment = segments[currentIdx].trim().split(/\s+/).length;
      typedWords += wordsInSegment;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const m = s / 60;
      const wpm = m > 0 ? Math.round(typedWords / m) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      els.wpm.textContent = wpm;
      els.acc.textContent = acc + '%';
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";

      const name = playerName.trim() || '·∫®n danh';
      const entry = { name, date: new Date().toISOString(), wpm, acc, score, badge, sentences: totalSentences };
      
      personalHistory.push(entry);
      if (personalHistory.length > 10) personalHistory.shift();
      localStorage.setItem('personalHistory', JSON.stringify(personalHistory));
      
      if (!bestStats || entry.score > bestStats.score) {
          bestStats = entry;
          localStorage.setItem('bestStats', JSON.stringify(bestStats));
      }

      els.level.textContent = badge; els.levelBadge.textContent = 'ƒê·∫°t c·∫•p: ' + badge;
      els.score.textContent = score; els.wpm.textContent = wpm; els.acc.textContent = acc + '%';
      
      renderPersonalStats();
      alert(`Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêi·ªÉm: ${score}\nC·∫•p: ${badge}`);
    }

    function initSpeechRecognition() {
      if (recognition) { recognition.onend = null; recognition.stop(); }
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
      
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang; // Quan tr·ªçng: C·∫≠p nh·∫≠t ng√¥n ng·ªØ
      recognition.continuous = false; // Ng·∫Øt t·ª´ng c√¢u ƒë·ªÉ ch√≠nh x√°c h∆°n
      recognition.interimResults = true; // Hi·ªán k·∫øt qu·∫£ t·∫°m th·ªùi
      
      recognition.onresult = (e) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = e.resultIndex; i < e.results.length; ++i) {
             if (e.results[i].isFinal) {
               finalTranscript += e.results[i][0].transcript;
             } else {
               interimTranscript += e.results[i][0].transcript;
             }
        }
        
        const target = segments[currentIdx];
        const displaySafe = finalTranscript || interimTranscript;

        // Feedback tr·ª±c quan
        els.feedback.innerHTML = `<span style="color:var(--primary)">${displaySafe}</span>`;

        if (finalTranscript) {
             const normTrans = normalizeText(finalTranscript);
             const normTarget = normalizeText(target);
             
             // So s√°nh ƒë·ªô t∆∞∆°ng ƒë·ªìng
             if (normTrans === normTarget || normTrans.includes(normTarget)) {
                 els.feedback.innerHTML = `<span class="correct">${finalTranscript}</span> (Ch√≠nh x√°c!)`;
                 els.next.disabled = false;
                 // T·ª± ƒë·ªông next sau 1s n·∫øu ƒë√∫ng
                 setTimeout(next, 1000);
             } else {
                 els.feedback.innerHTML = `<span class="wrong">${finalTranscript}</span> (Th·ª≠ l·∫°i)`;
             }
        }
      };
      
      recognition.onerror = (e) => {
        console.error(e);
        els.feedback.innerHTML = `<em>L·ªói mic (${e.error}). H√£y nh·∫•n l·∫°i.</em>`;
        els.micBtn.classList.remove('listening');
        isListening = false;
      };
      
      recognition.onend = () => { 
          els.micBtn.classList.remove('listening'); 
          isListening = false;
          // N·∫øu ch∆∞a xong v√† ƒëang ·ªü ch·∫ø ƒë·ªô ƒë·ªçc, c√≥ th·ªÉ t·ª± b·∫≠t l·∫°i n·∫øu mu·ªën (optional)
      };
      
      return true;
    }

    // === 5. S·ª∞ KI·ªÜN ===
    els.loginBtn.addEventListener('click', () => {
      const name = els.usernameInput.value.trim();
      if (name) handleLogin(name); else alert('Vui l√≤ng nh·∫≠p t√™n!');
    });
    els.skipLoginBtn.addEventListener('click', () => handleLogin(coolNicknames[Math.floor(Math.random() * coolNicknames.length)]));
    els.logoutBtn.addEventListener('click', handleLogout);

    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);

    setupTabs(els.mainTabs(), els.tabContents());

    els.voiceSelect.addEventListener('change', () => {
        const voiceName = els.voiceSelect.value;
        selectedVoice = voices.find(v => v.name === voiceName);
        if (selectedVoice) localStorage.setItem('voice', selectedVoice.name);
    });
    els.previewVoice.addEventListener('click', () => speak(globalLang === 'vi-VN' ? 'Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.' : 'Hello, this is a voice preview.'));
    speechSynthesis.onvoiceschanged = loadVoices;

    // Logic ƒê·ªïi ng√¥n ng·ªØ & X·ª≠ l√Ω Textarea
    els.lang.addEventListener('change', () => {
      globalLang = els.lang.value;
      localStorage.setItem('lang', globalLang);
      
      // N·∫øu user ch∆∞a s·ª≠a text, t·ª± ƒë·ªông ƒë·ªïi text m·∫´u
      if (!userHasEditedText) {
          els.text.value = SAMPLE_TEXTS[globalLang] || "";
      }
      loadVoices();
    });

    // Ph√°t hi·ªán ng∆∞·ªùi d√πng t·ª± s·ª≠a text
    els.text.addEventListener('input', () => {
        userHasEditedText = true;
        els.resetTextBtn.style.display = 'inline-block';
    });

    // N√∫t kh√¥i ph·ª•c text m·∫´u
    els.resetTextBtn.addEventListener('click', () => {
        userHasEditedText = false;
        els.text.value = SAMPLE_TEXTS[globalLang] || "";
        els.resetTextBtn.style.display = 'none';
        els.text.focus();
    });

    els.start.addEventListener('click', () => {
      const text = els.text.value.trim();
      if (!text) return alert('Nh·∫≠p ƒëo·∫°n vƒÉn!');
      // T√°ch c√¢u th√¥ng minh h∆°n
      segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Kh√¥ng c√≥ ƒëo·∫°n h·ª£p l·ªá!');
      
      currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0; totalSentences = segments.length;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
      
      startTime = Date.now(); 
      if (timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('practiceArea').classList.remove('hidden');
      initSpeechRecognition(); // Kh·ªüi t·∫°o l·∫°i mic v·ªõi ng√¥n ng·ªØ m·ªõi
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); if (!els.next.disabled) next(); } });
    els.hint.addEventListener('click', () => {
      const origWords = segments[currentIdx].split(/\s+/).filter(w => w);
      const typedInput = els.input.value.trim();
      const typedCount = typedInput ? typedInput.split(/\s+/).length : 0;

      if (typedCount < origWords.length) {
        const nextWord = origWords[typedCount];
        els.feedback.innerHTML += ` <span style="color:var(--info); font-weight:700;">‚Üí ${nextWord}</span>`;
        hintsUsed++;
        els.input.focus();
      }
    });
    
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());

    els.modeBtns().forEach(btn => btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
        showSegment();
    }));

    els.micBtn.addEventListener('click', () => {
      if (!recognition) initSpeechRecognition();
      if (isListening) {
          recognition.stop();
      } else { 
          try {
              recognition.start(); 
              els.micBtn.classList.add('listening'); 
              isListening = true; 
              els.feedback.innerHTML = '<em>ƒêang nghe... H√£y ƒë·ªçc to!</em>'; 
          } catch(e) {
              console.error(e);
              initSpeechRecognition(); // Th·ª≠ kh·ªüi t·∫°o l·∫°i n·∫øu l·ªói
          }
      }
    });

    // === 6. KH·ªûI CH·∫†Y ===
    initTheme(); 
    els.lang.value = globalLang;
    els.text.value = SAMPLE_TEXTS[globalLang] || SAMPLE_TEXTS['vi-VN']; // Set text ban ƒë·∫ßu
    
    window.addEventListener('load', () => {
      checkLogin();
      renderPersonalStats();
      loadVoices();
    });
  </script>
</body>
</html>

